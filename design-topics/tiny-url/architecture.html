<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Shortener - System Architecture</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
        }
        .architecture-diagram {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        .component {
            background: #ecf0f1;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 15px;
            margin: 10px;
            display: inline-block;
            min-width: 150px;
            text-align: center;
        }
        .component.client { background: #e8f8f5; border-color: #1abc9c; }
        .component.lb { background: #fef5e7; border-color: #f39c12; }
        .component.app { background: #ebf5fb; border-color: #3498db; }
        .component.cache { background: #fdecea; border-color: #e74c3c; }
        .component.db { background: #f4ecf7; border-color: #9b59b6; }
        .component.storage { background: #eafaf1; border-color: #27ae60; }

        .arrow {
            display: inline-block;
            margin: 0 10px;
            color: #7f8c8d;
            font-size: 24px;
        }
        .layer {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
        }
        .tech-stack {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        .tech-badge {
            background: #3498db;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        .note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        code {
            font-family: 'Courier New', monospace;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #3498db;
            color: white;
        }
        tr:nth-child(even) {
            background: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>üîó URL Shortener - System Architecture</h1>

    <div class="note">
        <strong>System Goal:</strong> Design a scalable URL shortening service (like Bitly, TinyURL) that can handle millions of URLs and billions of redirects with low latency.
    </div>

    <h2>üìä High-Level Architecture</h2>
    <div class="architecture-diagram">
        <div class="layer">
            <h3>Client Layer</h3>
            <div class="component client">Web Browser</div>
            <div class="component client">Mobile App</div>
            <div class="component client">API Client</div>
        </div>

        <div style="text-align: center; font-size: 30px; color: #95a5a6;">‚¨á</div>

        <div class="layer">
            <h3>Edge Layer</h3>
            <div class="component lb">DNS</div>
            <div class="component lb">CDN (CloudFront)</div>
            <div class="component lb">Load Balancer (ALB)</div>
        </div>

        <div style="text-align: center; font-size: 30px; color: #95a5a6;">‚¨á</div>

        <div class="layer">
            <h3>Application Layer</h3>
            <div class="component app">API Gateway</div>
            <div class="component app">URL Service</div>
            <div class="component app">Analytics Service</div>
            <div class="component app">Auth Service</div>
        </div>

        <div style="text-align: center; font-size: 30px; color: #95a5a6;">‚¨á</div>

        <div class="layer">
            <h3>Cache Layer</h3>
            <div class="component cache">Redis Cluster</div>
            <div class="component cache">Memcached</div>
        </div>

        <div style="text-align: center; font-size: 30px; color: #95a5a6;">‚¨á</div>

        <div class="layer">
            <h3>Data Layer</h3>
            <div class="component db">PostgreSQL Primary</div>
            <div class="component db">Read Replicas (3x)</div>
            <div class="component storage">S3 (Analytics)</div>
        </div>
    </div>

    <h2>üèóÔ∏è Component Details</h2>

    <h3>1. API Gateway</h3>
    <div class="tech-stack">
        <span class="tech-badge">Kong</span>
        <span class="tech-badge">AWS API Gateway</span>
        <span class="tech-badge">NGINX</span>
    </div>
    <ul>
        <li><strong>Rate Limiting:</strong> 100 requests/minute per IP</li>
        <li><strong>Authentication:</strong> API key validation</li>
        <li><strong>SSL Termination:</strong> HTTPS encryption</li>
        <li><strong>Request Routing:</strong> Route to appropriate service</li>
    </ul>

    <h3>2. URL Service</h3>
    <div class="tech-stack">
        <span class="tech-badge">Node.js</span>
        <span class="tech-badge">Python (FastAPI)</span>
        <span class="tech-badge">Go</span>
    </div>
    <ul>
        <li><strong>URL Shortening:</strong> Generate short codes using Base62 encoding</li>
        <li><strong>URL Retrieval:</strong> Fetch original URL and redirect</li>
        <li><strong>Custom URLs:</strong> Validate and reserve custom short codes</li>
        <li><strong>Validation:</strong> Check URL format and safety</li>
    </ul>

    <pre><code>// Base62 Encoding Algorithm
function base62Encode(num) {
    const charset = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
    let result = "";
    while (num > 0) {
        result = charset[num % 62] + result;
        num = Math.floor(num / 62);
    }
    return result || "0";
}

// Example: ID 125 ‚Üí "2B", ID 1000000 ‚Üí "4c92"
</code></pre>

    <h3>3. Cache Layer (Redis)</h3>
    <div class="tech-stack">
        <span class="tech-badge">Redis Cluster</span>
        <span class="tech-badge">ElastiCache</span>
    </div>
    <ul>
        <li><strong>Hot URL Caching:</strong> Cache 20% of URLs that get 80% of traffic</li>
        <li><strong>Cache Strategy:</strong> Cache-aside pattern</li>
        <li><strong>TTL:</strong> No expiration (URLs don't change)</li>
        <li><strong>Hit Ratio Target:</strong> > 90%</li>
    </ul>

    <h3>4. Database (PostgreSQL)</h3>
    <div class="tech-stack">
        <span class="tech-badge">PostgreSQL 14+</span>
        <span class="tech-badge">Amazon RDS</span>
    </div>
    <ul>
        <li><strong>Primary:</strong> Handles all writes</li>
        <li><strong>Read Replicas:</strong> 3-5 replicas for read scaling</li>
        <li><strong>Replication:</strong> Asynchronous (acceptable for this use case)</li>
        <li><strong>Backup:</strong> Daily snapshots, PITR enabled</li>
    </ul>

    <pre><code>-- Database Schema
CREATE TABLE urls (
    id BIGSERIAL PRIMARY KEY,
    short_code VARCHAR(7) UNIQUE NOT NULL,
    long_url TEXT NOT NULL,
    user_id BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP,
    click_count INTEGER DEFAULT 0,
    INDEX idx_short_code (short_code),
    INDEX idx_user_id (user_id)
);

CREATE TABLE analytics (
    id BIGSERIAL PRIMARY KEY,
    short_code VARCHAR(7) NOT NULL,
    clicked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ip_address VARCHAR(45),
    user_agent TEXT,
    referrer TEXT,
    INDEX idx_short_code_time (short_code, clicked_at)
);
</code></pre>

    <h2>üîÑ Data Flow</h2>

    <h3>Create Short URL Flow</h3>
    <table>
        <tr>
            <th>Step</th>
            <th>Component</th>
            <th>Action</th>
            <th>Latency</th>
        </tr>
        <tr>
            <td>1</td>
            <td>Client</td>
            <td>POST /api/shorten with long URL</td>
            <td>-</td>
        </tr>
        <tr>
            <td>2</td>
            <td>Load Balancer</td>
            <td>Route to available app server</td>
            <td>< 1ms</td>
        </tr>
        <tr>
            <td>3</td>
            <td>URL Service</td>
            <td>Validate URL format</td>
            <td>< 1ms</td>
        </tr>
        <tr>
            <td>4</td>
            <td>Database</td>
            <td>Insert record, get auto-increment ID</td>
            <td>5-10ms</td>
        </tr>
        <tr>
            <td>5</td>
            <td>URL Service</td>
            <td>Generate short code: base62(ID)</td>
            <td>< 1ms</td>
        </tr>
        <tr>
            <td>6</td>
            <td>Client</td>
            <td>Return short URL</td>
            <td>-</td>
        </tr>
    </table>
    <p><strong>Total Latency:</strong> ~10-15ms</p>

    <h3>Redirect Flow (Read-Heavy)</h3>
    <table>
        <tr>
            <th>Step</th>
            <th>Component</th>
            <th>Action</th>
            <th>Latency</th>
        </tr>
        <tr>
            <td>1</td>
            <td>Client</td>
            <td>GET /{short_code}</td>
            <td>-</td>
        </tr>
        <tr>
            <td>2</td>
            <td>Load Balancer</td>
            <td>Route request</td>
            <td>< 1ms</td>
        </tr>
        <tr>
            <td>3</td>
            <td>URL Service</td>
            <td>Check Redis cache</td>
            <td>< 1ms</td>
        </tr>
        <tr>
            <td>4a</td>
            <td>Cache Hit (90%)</td>
            <td>Return long URL from cache</td>
            <td>< 1ms</td>
        </tr>
        <tr>
            <td>4b</td>
            <td>Cache Miss (10%)</td>
            <td>Query database read replica</td>
            <td>5-10ms</td>
        </tr>
        <tr>
            <td>5</td>
            <td>URL Service</td>
            <td>Store in cache for future hits</td>
            <td>< 1ms</td>
        </tr>
        <tr>
            <td>6</td>
            <td>URL Service</td>
            <td>Async: Queue analytics event</td>
            <td>non-blocking</td>
        </tr>
        <tr>
            <td>7</td>
            <td>Client</td>
            <td>302 Redirect to long URL</td>
            <td>-</td>
        </tr>
    </table>
    <p><strong>Cache Hit Latency:</strong> ~2-3ms</p>
    <p><strong>Cache Miss Latency:</strong> ~10-15ms</p>

    <h2>üöÄ Scalability Features</h2>

    <h3>Horizontal Scaling</h3>
    <ul>
        <li><strong>Application Servers:</strong> Stateless, auto-scaling group (2-20 instances)</li>
        <li><strong>Read Replicas:</strong> Add replicas as read load increases</li>
        <li><strong>Cache Cluster:</strong> Redis cluster with multiple shards</li>
    </ul>

    <h3>Performance Optimizations</h3>
    <table>
        <tr>
            <th>Optimization</th>
            <th>Technique</th>
            <th>Impact</th>
        </tr>
        <tr>
            <td>Caching</td>
            <td>Redis with no expiration</td>
            <td>90% cache hit rate, < 3ms latency</td>
        </tr>
        <tr>
            <td>Database Reads</td>
            <td>5 read replicas</td>
            <td>5x read capacity</td>
        </tr>
        <tr>
            <td>Connection Pooling</td>
            <td>PgBouncer</td>
            <td>Reduce connection overhead</td>
        </tr>
        <tr>
            <td>Async Analytics</td>
            <td>Message queue (SQS)</td>
            <td>Non-blocking redirects</td>
        </tr>
        <tr>
            <td>CDN</td>
            <td>CloudFront for static assets</td>
            <td>Reduced origin load</td>
        </tr>
    </table>

    <h3>Database Sharding (for 10x scale)</h3>
    <pre><code>// Partition by short_code hash
shard_id = hash(short_code) % num_shards

Example with 10 shards:
- Shard 0: short_codes where hash % 10 == 0
- Shard 1: short_codes where hash % 10 == 1
- ...
- Shard 9: short_codes where hash % 10 == 9

Each shard: 1-10M URLs
Total capacity: 100M URLs per shard set
</code></pre>

    <h2>üõ°Ô∏è Reliability & Availability</h2>

    <h3>Multi-AZ Deployment</h3>
    <ul>
        <li><strong>Load Balancers:</strong> Deployed in 3 availability zones</li>
        <li><strong>App Servers:</strong> Distributed across 3 AZs (min 1 per AZ)</li>
        <li><strong>Database:</strong> Primary in AZ-1, replicas in AZ-2 and AZ-3</li>
        <li><strong>Redis:</strong> Cluster mode with multi-AZ replication</li>
    </ul>

    <h3>Failure Handling</h3>
    <table>
        <tr>
            <th>Failure Scenario</th>
            <th>Impact</th>
            <th>Recovery</th>
        </tr>
        <tr>
            <td>App Server Crash</td>
            <td>Load balancer removes from pool</td>
            <td>Automatic (health checks)</td>
        </tr>
        <tr>
            <td>Redis Failure</td>
            <td>Higher DB load, slower responses</td>
            <td>Failover to replica (< 30s)</td>
        </tr>
        <tr>
            <td>DB Primary Failure</td>
            <td>Writes blocked temporarily</td>
            <td>Promote replica to primary (< 60s)</td>
        </tr>
        <tr>
            <td>AZ Failure</td>
            <td>Reduced capacity (33%)</td>
            <td>Traffic routes to healthy AZs</td>
        </tr>
    </table>

    <h2>üìà Monitoring & Observability</h2>

    <h3>Key Metrics</h3>
    <ul>
        <li><strong>Application:</strong> Request rate, error rate, latency (p50, p95, p99)</li>
        <li><strong>Cache:</strong> Hit ratio, eviction rate, memory usage</li>
        <li><strong>Database:</strong> Connection count, query time, replication lag</li>
        <li><strong>Business:</strong> URLs created, redirects served, most popular URLs</li>
    </ul>

    <h3>Alerting Thresholds</h3>
    <table>
        <tr>
            <th>Metric</th>
            <th>Warning</th>
            <th>Critical</th>
        </tr>
        <tr>
            <td>API Latency (p95)</td>
            <td>> 50ms</td>
            <td>> 100ms</td>
        </tr>
        <tr>
            <td>Error Rate</td>
            <td>> 0.5%</td>
            <td>> 1%</td>
        </tr>
        <tr>
            <td>Cache Hit Ratio</td>
            <td>< 85%</td>
            <td>< 80%</td>
        </tr>
        <tr>
            <td>DB Replication Lag</td>
            <td>> 10s</td>
            <td>> 30s</td>
        </tr>
    </table>

    <div class="note">
        <strong>Tech Stack Summary:</strong>
        <br>‚Ä¢ Frontend: React/Vue.js
        <br>‚Ä¢ Backend: Node.js/Python FastAPI/Go
        <br>‚Ä¢ Cache: Redis Cluster (ElastiCache)
        <br>‚Ä¢ Database: PostgreSQL (RDS) with read replicas
        <br>‚Ä¢ Load Balancer: AWS ALB
        <br>‚Ä¢ CDN: CloudFront
        <br>‚Ä¢ Queue: AWS SQS (for analytics)
        <br>‚Ä¢ Monitoring: CloudWatch, Datadog, or Prometheus/Grafana
    </div>

</body>
</html>
