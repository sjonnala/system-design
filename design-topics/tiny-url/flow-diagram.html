<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Shortener - Flow Diagrams</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
            background: #ecf0f1;
            padding: 10px 15px;
            border-left: 5px solid #3498db;
        }
        .flow-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        .sequence-diagram {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            background: #fafafa;
            border-radius: 8px;
        }
        .sequence-step {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border-left: 4px solid #3498db;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .sequence-step.cache-hit { border-left-color: #27ae60; }
        .sequence-step.cache-miss { border-left-color: #e74c3c; }
        .sequence-step.async { border-left-color: #f39c12; }

        .step-number {
            background: #3498db;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .step-content {
            flex-grow: 1;
        }
        .component-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        .action {
            color: #555;
        }
        .latency {
            background: #e8f8f5;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            color: #16a085;
            margin-left: 10px;
        }
        .arrow-down {
            text-align: center;
            color: #95a5a6;
            font-size: 24px;
            margin: -10px 0;
        }
        .decision-box {
            background: #fff3cd;
            border: 2px dashed #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        .parallel-flows {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .flow-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #3498db;
        }
        .flow-box.success { border-color: #27ae60; }
        .flow-box.error { border-color: #e74c3c; }

        .metrics-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
        }
        .metrics-table th,
        .metrics-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .metrics-table th {
            background: #3498db;
            color: white;
        }
        .metrics-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        .note {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .swimlane {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 10px;
            margin: 20px 0;
            background: white;
            padding: 20px;
            border-radius: 8px;
        }
        .swimlane-header {
            font-weight: bold;
            background: #3498db;
            color: white;
            padding: 10px;
            border-radius: 4px;
        }
        .swimlane-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .action-box {
            background: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid #3498db;
        }
    </style>
</head>
<body>
    <h1>üîÑ URL Shortener - Flow Diagrams</h1>

    <h2>üìù Flow 1: Create Short URL</h2>
    <div class="flow-container">
        <div class="sequence-diagram">
            <div class="sequence-step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <div class="component-name">Client</div>
                    <div class="action">POST /api/shorten {"long_url": "https://example.com/very/long/url"}</div>
                </div>
            </div>

            <div class="arrow-down">‚¨á</div>

            <div class="sequence-step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <div class="component-name">Load Balancer (ALB)</div>
                    <div class="action">SSL termination, health check, route to available app server</div>
                    <span class="latency">< 1ms</span>
                </div>
            </div>

            <div class="arrow-down">‚¨á</div>

            <div class="sequence-step">
                <div class="step-number">3</div>
                <div class="step-content">
                    <div class="component-name">API Gateway</div>
                    <div class="action">Rate limiting check (100 req/min), API key validation</div>
                    <span class="latency">< 1ms</span>
                </div>
            </div>

            <div class="arrow-down">‚¨á</div>

            <div class="sequence-step">
                <div class="step-number">4</div>
                <div class="step-content">
                    <div class="component-name">URL Service</div>
                    <div class="action">Validate URL format, check length, verify not malicious</div>
                    <span class="latency">1-2ms</span>
                </div>
            </div>

            <div class="arrow-down">‚¨á</div>

            <div class="decision-box">
                Custom short code requested?
            </div>

            <div class="parallel-flows">
                <div class="flow-box">
                    <h4>‚ùå No Custom Code</h4>
                    <ol>
                        <li>Insert into database</li>
                        <li>Get auto-increment ID</li>
                        <li>Generate: base62(ID)</li>
                        <li>Example: ID 12345 ‚Üí "3D7"</li>
                    </ol>
                </div>
                <div class="flow-box">
                    <h4>‚úÖ Custom Code</h4>
                    <ol>
                        <li>Check if code available</li>
                        <li>Validate format (4-15 chars)</li>
                        <li>Reserve if available</li>
                        <li>Return error if taken</li>
                    </ol>
                </div>
            </div>

            <div class="arrow-down">‚¨á</div>

            <div class="sequence-step">
                <div class="step-number">5</div>
                <div class="step-content">
                    <div class="component-name">PostgreSQL (Primary)</div>
                    <div class="action">INSERT INTO urls (short_code, long_url, user_id, created_at) VALUES (...)</div>
                    <span class="latency">5-10ms</span>
                </div>
            </div>

            <div class="arrow-down">‚¨á</div>

            <div class="sequence-step">
                <div class="step-number">6</div>
                <div class="step-content">
                    <div class="component-name">URL Service</div>
                    <div class="action">Construct short URL: "https://short.ly/{short_code}"</div>
                    <span class="latency">< 1ms</span>
                </div>
            </div>

            <div class="arrow-down">‚¨á</div>

            <div class="sequence-step">
                <div class="step-number">7</div>
                <div class="step-content">
                    <div class="component-name">Response to Client</div>
                    <div class="action">201 Created: {"short_url": "https://short.ly/3D7", "short_code": "3D7"}</div>
                </div>
            </div>
        </div>

        <div class="note">
            <strong>Total Latency:</strong> 10-15ms<br>
            <strong>Success Rate:</strong> 99.9%<br>
            <strong>Throughput:</strong> ~80 writes/second
        </div>
    </div>

    <h2>üîÄ Flow 2: Redirect to Original URL (Cache Hit - 90% of traffic)</h2>
    <div class="flow-container">
        <div class="sequence-diagram">
            <div class="sequence-step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <div class="component-name">Client / Browser</div>
                    <div class="action">GET https://short.ly/3D7</div>
                </div>
            </div>

            <div class="arrow-down">‚¨á</div>

            <div class="sequence-step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <div class="component-name">Load Balancer</div>
                    <div class="action">Route to app server (round-robin)</div>
                    <span class="latency">< 1ms</span>
                </div>
            </div>

            <div class="arrow-down">‚¨á</div>

            <div class="sequence-step cache-hit">
                <div class="step-number">3</div>
                <div class="step-content">
                    <div class="component-name">URL Service ‚Üí Redis Cache</div>
                    <div class="action">GET url:3D7 ‚Üí CACHE HIT! Returns long URL</div>
                    <span class="latency">< 1ms</span>
                </div>
            </div>

            <div class="arrow-down">‚¨á</div>

            <div class="sequence-step async">
                <div class="step-number">4</div>
                <div class="step-content">
                    <div class="component-name">URL Service (Async)</div>
                    <div class="action">Queue analytics event to SQS (non-blocking)</div>
                    <span class="latency">non-blocking</span>
                </div>
            </div>

            <div class="arrow-down">‚¨á</div>

            <div class="sequence-step cache-hit">
                <div class="step-number">5</div>
                <div class="step-content">
                    <div class="component-name">Response to Client</div>
                    <div class="action">302 Found, Location: https://example.com/very/long/url</div>
                    <span class="latency">Total: 2-3ms</span>
                </div>
            </div>

            <div class="arrow-down">‚¨á</div>

            <div class="sequence-step">
                <div class="step-number">6</div>
                <div class="step-content">
                    <div class="component-name">Browser</div>
                    <div class="action">Automatically redirect to original URL</div>
                </div>
            </div>
        </div>

        <div class="note">
            <strong>Cache Hit Scenario (90% of traffic)</strong><br>
            Total Latency: 2-3ms<br>
            Database: Not touched!<br>
            Throughput: ~8,000 requests/second
        </div>
    </div>

    <h2>üíæ Flow 3: Redirect to Original URL (Cache Miss - 10% of traffic)</h2>
    <div class="flow-container">
        <div class="sequence-diagram">
            <div class="sequence-step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <div class="component-name">Client</div>
                    <div class="action">GET https://short.ly/abc123</div>
                </div>
            </div>

            <div class="arrow-down">‚¨á</div>

            <div class="sequence-step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <div class="component-name">Load Balancer</div>
                    <div class="action">Route to app server</div>
                    <span class="latency">< 1ms</span>
                </div>
            </div>

            <div class="arrow-down">‚¨á</div>

            <div class="sequence-step cache-miss">
                <div class="step-number">3</div>
                <div class="step-content">
                    <div class="component-name">URL Service ‚Üí Redis Cache</div>
                    <div class="action">GET url:abc123 ‚Üí CACHE MISS!</div>
                    <span class="latency">< 1ms</span>
                </div>
            </div>

            <div class="arrow-down">‚¨á</div>

            <div class="sequence-step cache-miss">
                <div class="step-number">4</div>
                <div class="step-content">
                    <div class="component-name">URL Service ‚Üí Database Read Replica</div>
                    <div class="action">SELECT long_url FROM urls WHERE short_code = 'abc123'</div>
                    <span class="latency">5-10ms</span>
                </div>
            </div>

            <div class="arrow-down">‚¨á</div>

            <div class="decision-box">
                URL Found?
            </div>

            <div class="parallel-flows">
                <div class="flow-box success">
                    <h4>‚úÖ URL Found</h4>
                    <ol>
                        <li>Store in Redis cache (SET url:abc123)</li>
                        <li>TTL: No expiration</li>
                        <li>Queue analytics event</li>
                        <li>Return 302 redirect</li>
                    </ol>
                </div>
                <div class="flow-box error">
                    <h4>‚ùå URL Not Found</h4>
                    <ol>
                        <li>URL doesn't exist</li>
                        <li>or expired</li>
                        <li>Return 404 Not Found</li>
                        <li>Show error page</li>
                    </ol>
                </div>
            </div>

            <div class="arrow-down">‚¨á</div>

            <div class="sequence-step">
                <div class="step-number">5</div>
                <div class="step-content">
                    <div class="component-name">URL Service ‚Üí Redis</div>
                    <div class="action">SET url:abc123 "https://example.com/..." (no TTL)</div>
                    <span class="latency">1-2ms</span>
                </div>
            </div>

            <div class="arrow-down">‚¨á</div>

            <div class="sequence-step">
                <div class="step-number">6</div>
                <div class="step-content">
                    <div class="component-name">Response to Client</div>
                    <div class="action">302 Found, Location: https://example.com/...</div>
                    <span class="latency">Total: 10-15ms</span>
                </div>
            </div>
        </div>

        <div class="note">
            <strong>Cache Miss Scenario (10% of traffic)</strong><br>
            Total Latency: 10-15ms<br>
            Database: Read replica used (doesn't impact writes)<br>
            Future requests: Will be cache hits!
        </div>
    </div>

    <h2>üìä Flow 4: Analytics Processing (Async)</h2>
    <div class="flow-container">
        <div class="sequence-diagram">
            <div class="sequence-step async">
                <div class="step-number">1</div>
                <div class="step-content">
                    <div class="component-name">URL Service</div>
                    <div class="action">On redirect: Queue analytics event to SQS</div>
                    <span class="latency">non-blocking</span>
                </div>
            </div>

            <div class="arrow-down">‚¨á</div>

            <div class="sequence-step async">
                <div class="step-number">2</div>
                <div class="step-content">
                    <div class="component-name">SQS Queue</div>
                    <div class="action">Store event: {short_code, timestamp, ip, user_agent, referrer}</div>
                </div>
            </div>

            <div class="arrow-down">‚¨á</div>

            <div class="sequence-step async">
                <div class="step-number">3</div>
                <div class="step-content">
                    <div class="component-name">Analytics Worker (Lambda/EC2)</div>
                    <div class="action">Poll queue (batch size: 100 events)</div>
                    <span class="latency">every 5 seconds</span>
                </div>
            </div>

            <div class="arrow-down">‚¨á</div>

            <div class="sequence-step async">
                <div class="step-number">4</div>
                <div class="step-content">
                    <div class="component-name">Analytics Worker</div>
                    <div class="action">Batch INSERT into analytics table</div>
                    <span class="latency">10-20ms per batch</span>
                </div>
            </div>

            <div class="arrow-down">‚¨á</div>

            <div class="sequence-step async">
                <div class="step-number">5</div>
                <div class="step-content">
                    <div class="component-name">Analytics Worker</div>
                    <div class="action">Update click_count in urls table (aggregate)</div>
                    <span class="latency">5-10ms</span>
                </div>
            </div>

            <div class="arrow-down">‚¨á</div>

            <div class="sequence-step async">
                <div class="step-number">6</div>
                <div class="step-content">
                    <div class="component-name">Analytics Worker</div>
                    <div class="action">Optional: Stream to S3/data warehouse for deep analytics</div>
                </div>
            </div>
        </div>

        <div class="note">
            <strong>Why Async?</strong><br>
            ‚Ä¢ Doesn't block redirect response (fast user experience)<br>
            ‚Ä¢ Can batch writes (better database performance)<br>
            ‚Ä¢ Can retry failed writes<br>
            ‚Ä¢ Separates hot path (redirect) from cold path (analytics)
        </div>
    </div>

    <h2>‚ö†Ô∏è Error Handling Flows</h2>

    <div class="flow-container">
        <h3>Scenario 1: Database Primary Down</h3>
        <div class="sequence-diagram">
            <div class="sequence-step error">
                <div class="step-number">!</div>
                <div class="step-content">
                    <div class="component-name">Detection</div>
                    <div class="action">Health check fails, primary database unresponsive</div>
                </div>
            </div>
            <div class="arrow-down">‚¨á</div>
            <div class="sequence-step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <div class="component-name">RDS Automatic Failover</div>
                    <div class="action">Promote read replica to primary (30-60 seconds)</div>
                </div>
            </div>
            <div class="arrow-down">‚¨á</div>
            <div class="sequence-step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <div class="component-name">Impact</div>
                    <div class="action">Writes blocked for 30-60s, reads continue normally (cache + replicas)</div>
                </div>
            </div>
        </div>
    </div>

    <div class="flow-container">
        <h3>Scenario 2: Redis Cache Failure</h3>
        <div class="sequence-diagram">
            <div class="sequence-step error">
                <div class="step-number">!</div>
                <div class="step-content">
                    <div class="component-name">Detection</div>
                    <div class="action">Redis connection timeout or error</div>
                </div>
            </div>
            <div class="arrow-down">‚¨á</div>
            <div class="sequence-step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <div class="component-name">Graceful Degradation</div>
                    <div class="action">Skip cache, query database directly for all requests</div>
                </div>
            </div>
            <div class="arrow-down">‚¨á</div>
            <div class="sequence-step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <div class="component-name">Impact</div>
                    <div class="action">Latency increases from 3ms ‚Üí 15ms, but service continues</div>
                </div>
            </div>
        </div>
        <div class="warning">
            System remains operational, just slower. Read replicas handle increased load.
        </div>
    </div>

    <h2>üìà Performance Metrics by Flow</h2>

    <table class="metrics-table">
        <tr>
            <th>Flow</th>
            <th>Latency (p50)</th>
            <th>Latency (p95)</th>
            <th>Latency (p99)</th>
            <th>Throughput</th>
        </tr>
        <tr>
            <td>Create Short URL</td>
            <td>12ms</td>
            <td>20ms</td>
            <td>50ms</td>
            <td>80 req/s</td>
        </tr>
        <tr>
            <td>Redirect (Cache Hit)</td>
            <td>2ms</td>
            <td>3ms</td>
            <td>5ms</td>
            <td>8,000 req/s</td>
        </tr>
        <tr>
            <td>Redirect (Cache Miss)</td>
            <td>12ms</td>
            <td>18ms</td>
            <td>25ms</td>
            <td>800 req/s</td>
        </tr>
        <tr>
            <td>Analytics Processing</td>
            <td>N/A (async)</td>
            <td>N/A</td>
            <td>N/A</td>
            <td>10K events/s</td>
        </tr>
    </table>

    <h2>üéØ Key Takeaways</h2>

    <div class="flow-container">
        <ul>
            <li><strong>Read-Heavy System:</strong> 100:1 read-to-write ratio, optimize for redirects</li>
            <li><strong>Caching is Critical:</strong> 90% cache hit rate reduces database load by 10x</li>
            <li><strong>Async Analytics:</strong> Keeps redirect latency low (< 3ms cache hit)</li>
            <li><strong>Graceful Degradation:</strong> System works even if cache fails (just slower)</li>
            <li><strong>Base62 Encoding:</strong> Simple, collision-free short code generation</li>
            <li><strong>Multi-AZ Deployment:</strong> High availability through redundancy</li>
        </ul>
    </div>

</body>
</html>
