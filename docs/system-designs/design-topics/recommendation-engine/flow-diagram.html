<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recommendation Engine Flow Diagrams</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1700px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            font-size: 2.5em;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: #e2e8f0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: #6366f1;
            color: white;
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .diagram-container {
            display: none;
            margin-top: 30px;
        }

        .diagram-container.active {
            display: block;
        }

        .flow-description {
            background: #e0e7ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 5px solid #6366f1;
        }

        .flow-description h3 {
            color: #4338ca;
            margin-bottom: 10px;
        }

        .flow-description ol {
            margin-left: 20px;
            line-height: 2;
            color: #1e293b;
        }

        .flow-description ol li {
            margin: 8px 0;
        }

        .flow-description strong {
            color: #6366f1;
        }

        .metrics-panel {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde047 100%);
            border-radius: 15px;
            border: 2px solid #fbbf24;
        }

        .component {
            cursor: pointer;
            transition: all 0.3s;
        }

        .component:hover {
            filter: drop-shadow(0 0 10px rgba(99, 102, 241, 0.5));
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ü§ñ Recommendation Engine Flow Diagrams</h1>
        <p style="color: #64748b; margin-top: 10px;">Interactive ML Pipeline Visualization</p>

        <div class="tabs">
            <button class="tab active" onclick="showDiagram('realtime')">‚ö° Real-time Inference</button>
            <button class="tab" onclick="showDiagram('training')">üéì Model Training Pipeline</button>
            <button class="tab" onclick="showDiagram('feature')">üîß Feature Engineering</button>
            <button class="tab" onclick="showDiagram('full')">üèóÔ∏è Full System Flow</button>
        </div>
    </div>

    <!-- Real-time Inference Flow -->
    <div id="realtime-diagram" class="diagram-container active">
        <svg viewBox="0 0 1600 1400" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#6366f1" />
                </marker>
                <linearGradient id="grad-client" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-api" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#22d3ee;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#06b6d4;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-service" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#84cc16;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#65a30d;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-cache" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#f472b6;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-candidate" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#c084fc;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#a855f7;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-ranking" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />
                </linearGradient>
            </defs>

            <text x="800" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Real-time Recommendation Inference Flow
            </text>

            <!-- User -->
            <g class="component">
                <rect x="650" y="70" width="300" height="80" rx="10" fill="url(#grad-client)" stroke="#2563eb" stroke-width="2"/>
                <text x="800" y="105" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üë§ User</text>
                <text x="800" y="125" font-size="12" text-anchor="middle" fill="white">Requests: "Show me recommendations"</text>
            </g>

            <path d="M 800 150 L 800 190" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
            <text x="820" y="175" font-size="11" fill="#4338ca" font-weight="600">GET /api/recommendations</text>

            <!-- API Gateway -->
            <g class="component">
                <rect x="650" y="190" width="300" height="80" rx="10" fill="url(#grad-api)" stroke="#0891b2" stroke-width="2"/>
                <text x="800" y="225" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üö™ API Gateway</text>
                <text x="800" y="245" font-size="11" text-anchor="middle" fill="white">Auth | Rate Limit | Routing</text>
            </g>

            <path d="M 800 270 L 800 310" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Cache Check -->
            <g class="component">
                <path d="M 800 340 L 900 390 L 800 440 L 700 390 Z" fill="#fef3c7" stroke="#f59e0b" stroke-width="3"/>
                <text x="800" y="385" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Cache</text>
                <text x="800" y="403" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Hit?</text>
            </g>

            <!-- Cache Hit Path -->
            <path d="M 900 390 L 1100 390" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>
            <text x="960" y="380" font-size="12" fill="#059669" font-weight="700">YES (70%)</text>

            <g class="component">
                <rect x="1100" y="350" width="200" height="80" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="3"/>
                <text x="1200" y="380" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">‚úÖ Return Cached</text>
                <text x="1200" y="400" font-size="11" text-anchor="middle" fill="#065f46">Latency: ~5ms</text>
            </g>

            <path d="M 1200 350 L 1200 150" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="8,4"/>

            <!-- Cache Miss Path -->
            <path d="M 800 440 L 800 500" stroke="#ef4444" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>
            <text x="730" y="475" font-size="12" fill="#dc2626" font-weight="700">NO (30%)</text>

            <!-- Recommendation Service -->
            <g class="component">
                <rect x="600" y="500" width="400" height="100" rx="10" fill="url(#grad-service)" stroke="#4d7c0f" stroke-width="2"/>
                <text x="800" y="535" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üéØ Recommendation Service</text>
                <text x="800" y="555" font-size="12" text-anchor="middle" fill="white">Orchestrator - Two-stage pipeline</text>
                <text x="800" y="575" font-size="11" text-anchor="middle" fill="white">Stage 1: Generate candidates | Stage 2: Rank</text>
            </g>

            <path d="M 800 600 L 800 650" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Feature Store -->
            <g class="component">
                <rect x="250" y="650" width="220" height="100" rx="10" fill="#fde047" stroke="#eab308" stroke-width="2"/>
                <text x="360" y="685" font-size="14" font-weight="bold" text-anchor="middle" fill="#713f12">üóÉÔ∏è Feature Store</text>
                <text x="360" y="705" font-size="11" text-anchor="middle" fill="#713f12">User features</text>
                <text x="360" y="720" font-size="11" text-anchor="middle" fill="#713f12">Item features</text>
                <text x="360" y="735" font-size="11" text-anchor="middle" fill="#713f12">Context features</text>
            </g>

            <!-- Candidate Generation -->
            <g class="component">
                <rect x="500" y="650" width="280" height="100" rx="10" fill="url(#grad-candidate)" stroke="#9333ea" stroke-width="2"/>
                <text x="640" y="685" font-size="15" font-weight="bold" text-anchor="middle" fill="white">üîç Candidate Generation</text>
                <text x="640" y="705" font-size="11" text-anchor="middle" fill="white">Vector ANN Search (FAISS)</text>
                <text x="640" y="720" font-size="11" text-anchor="middle" fill="white">Retrieve top 500-1000 items</text>
                <text x="640" y="735" font-size="10" text-anchor="middle" fill="white">Latency: 20-30ms</text>
            </g>

            <!-- Model Serving -->
            <g class="component">
                <rect x="810" y="650" width="220" height="100" rx="10" fill="url(#grad-ranking)" stroke="#d97706" stroke-width="2"/>
                <text x="920" y="685" font-size="14" font-weight="bold" text-anchor="middle" fill="white">ü§ñ Model Serving</text>
                <text x="920" y="705" font-size="11" text-anchor="middle" fill="white">TF Serving</text>
                <text x="920" y="720" font-size="11" text-anchor="middle" fill="white">Two-tower model</text>
                <text x="920" y="735" font-size="11" text-anchor="middle" fill="white">XGBoost ranker</text>
            </g>

            <!-- Arrows to candidate gen -->
            <path d="M 470 700 L 500 700" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <text x="475" y="690" font-size="10" fill="#4338ca">features</text>

            <!-- Arrow from candidate to ranking -->
            <path d="M 780 700 L 810 700" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
            <text x="785" y="690" font-size="10" fill="#4338ca">500 candidates</text>

            <!-- Ranking Service -->
            <g class="component">
                <rect x="550" y="790" width="500" height="110" rx="10" fill="linear-gradient(135deg, #fecaca 0%, #f87171 100%)" stroke="#dc2626" stroke-width="2"/>
                <text x="800" y="825" font-size="16" font-weight="bold" text-anchor="middle" fill="white">‚öñÔ∏è Ranking Service</text>
                <text x="800" y="845" font-size="12" text-anchor="middle" fill="white">Score each candidate with ML model</text>
                <text x="800" y="865" font-size="11" text-anchor="middle" fill="white">Input: Features (user, item, context) | Output: Ranked top 10-50</text>
                <text x="800" y="880" font-size="10" text-anchor="middle" fill="white">Latency: 50-70ms</text>
            </g>

            <path d="M 640 750 L 650 790" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 920 750 L 900 790" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Post-processing -->
            <g class="component">
                <rect x="600" y="940" width="400" height="100" rx="10" fill="linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%)" stroke="#3b82f6" stroke-width="2"/>
                <text x="800" y="975" font-size="15" font-weight="bold" text-anchor="middle" fill="#1e3a8a">üé® Post-processing</text>
                <text x="800" y="995" font-size="11" text-anchor="middle" fill="#1e3a8a">‚úì Diversity filter (avoid similar items)</text>
                <text x="800" y="1010" font-size="11" text-anchor="middle" fill="#1e3a8a">‚úì Business rules (promoted content)</text>
                <text x="800" y="1025" font-size="11" text-anchor="middle" fill="#1e3a8a">‚úì Deduplication | Personalization</text>
            </g>

            <path d="M 800 900 L 800 940" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Cache Write -->
            <g class="component">
                <rect x="1070" y="940" width="180" height="100" rx="10" fill="url(#grad-cache)" stroke="#db2777" stroke-width="2"/>
                <text x="1160" y="975" font-size="13" font-weight="bold" text-anchor="middle" fill="white">üíæ Update Cache</text>
                <text x="1160" y="995" font-size="10" text-anchor="middle" fill="white">Redis SET</text>
                <text x="1160" y="1010" font-size="10" text-anchor="middle" fill="white">key: user:123:recs</text>
                <text x="1160" y="1025" font-size="10" text-anchor="middle" fill="white">TTL: 15 minutes</text>
            </g>

            <path d="M 1000 990 L 1070 990" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>

            <!-- Response -->
            <g class="component">
                <rect x="600" y="1080" width="400" height="100" rx="10" fill="linear-gradient(135deg, #86efac 0%, #22c55e 100%)" stroke="#16a34a" stroke-width="3"/>
                <text x="800" y="1115" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üì§ API Response</text>
                <text x="800" y="1135" font-size="12" text-anchor="middle" fill="white">Top 20 Recommendations</text>
                <text x="800" y="1155" font-size="11" text-anchor="middle" fill="white">Total Latency: &lt;100ms (P95)</text>
            </g>

            <path d="M 800 1040 L 800 1080" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Return to user -->
            <path d="M 600 1130 L 450 1130 L 450 110 L 650 110" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="8,4"/>
            <text x="380" y="650" font-size="13" fill="#059669" font-weight="700" transform="rotate(-90 380 650)">‚Üê Response to User</text>

            <!-- Step numbers -->
            <circle cx="800" cy="110" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="800" y="117" font-size="14" font-weight="bold" text-anchor="middle" fill="white">1</text>

            <circle cx="800" cy="230" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="800" y="237" font-size="14" font-weight="bold" text-anchor="middle" fill="white">2</text>

            <circle cx="800" cy="550" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="800" y="557" font-size="14" font-weight="bold" text-anchor="middle" fill="white">3</text>

            <circle cx="640" cy="700" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="640" y="707" font-size="14" font-weight="bold" text-anchor="middle" fill="white">4</text>

            <circle cx="800" cy="845" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="800" y="852" font-size="14" font-weight="bold" text-anchor="middle" fill="white">5</text>

            <circle cx="800" cy="990" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="800" y="997" font-size="14" font-weight="bold" text-anchor="middle" fill="white">6</text>

            <!-- Async Event Logging -->
            <g class="component">
                <rect x="100" y="500" width="180" height="80" rx="10" fill="linear-gradient(135deg, #fda4af 0%, #fb7185 100%)" stroke="#e11d48" stroke-width="2"/>
                <text x="190" y="530" font-size="12" font-weight="bold" text-anchor="middle" fill="white">üìä Event Logger</text>
                <text x="190" y="548" font-size="10" text-anchor="middle" fill="white">(Async, non-blocking)</text>
                <text x="190" y="563" font-size="9" text-anchor="middle" fill="white">Log: served recs</text>
            </g>

            <path d="M 600 550 L 280 550" stroke="#e11d48" stroke-width="2" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>
            <text x="420" y="540" font-size="10" fill="#e11d48">async log to Kafka</text>

        </svg>

        <div class="flow-description">
            <h3>‚ö° Real-time Recommendation Inference Steps</h3>
            <ol>
                <li><strong>User Request:</strong> User requests recommendations via API: <code>GET /api/recommendations?user_id=123&context=home</code></li>
                <li><strong>API Gateway:</strong> Validates JWT token, checks rate limits (100 req/min), routes to recommendation service</li>
                <li><strong>Cache Check:</strong> Redis cache lookup for pre-computed recommendations
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li><strong>Cache Hit (70%):</strong> Return cached results immediately (~5ms latency) ‚úÖ</li>
                        <li><strong>Cache Miss (30%):</strong> Generate fresh recommendations ‚Üì</li>
                    </ul>
                </li>
                <li><strong>Candidate Generation:</strong> Retrieve 500-1000 candidate items using:
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Vector similarity search (FAISS ANN) on user embeddings</li>
                        <li>Collaborative filtering signals</li>
                        <li>Trending/popular items</li>
                        <li>Latency: 20-30ms</li>
                    </ul>
                </li>
                <li><strong>Ranking:</strong> Score and rank candidates using ML model
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Fetch features from Feature Store (user, item, context)</li>
                        <li>Model inference (Two-tower or XGBoost ranker)</li>
                        <li>Output: Top 10-50 ranked items</li>
                        <li>Latency: 50-70ms</li>
                    </ul>
                </li>
                <li><strong>Post-processing:</strong> Apply business logic and filters
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Diversity: Ensure variety in categories/topics</li>
                        <li>Business rules: Insert promoted/sponsored content</li>
                        <li>Deduplication: Remove already seen/purchased items</li>
                    </ul>
                </li>
                <li><strong>Response & Caching:</strong> Return top 20 recommendations to user, cache results (TTL: 15 min)</li>
                <li><strong>Async Logging:</strong> Log served recommendations to Kafka for analytics (non-blocking)</li>
            </ol>
            <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 5px;">
                <strong>üéØ Performance Target:</strong> P95 latency &lt;100ms | Cache hit rate 70-85% | Throughput: 10K QPS
            </div>
        </div>
    </div>

    <!-- Model Training Pipeline -->
    <div id="training-diagram" class="diagram-container">
        <svg viewBox="0 0 1600 1100" xmlns="http://www.w3.org/2000/svg">
            <text x="800" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Offline Model Training Pipeline
            </text>

            <!-- Data Lake -->
            <g class="component">
                <rect x="300" y="70" width="250" height="100" rx="10" fill="linear-gradient(135deg, #fde68a 0%, #fbbf24 100%)" stroke="#f59e0b" stroke-width="2"/>
                <text x="425" y="105" font-size="15" font-weight="bold" text-anchor="middle" fill="#713f12">‚òÅÔ∏è Data Lake (S3)</text>
                <text x="425" y="125" font-size="11" text-anchor="middle" fill="#713f12">Raw Events (Parquet)</text>
                <text x="425" y="140" font-size="10" text-anchor="middle" fill="#713f12">10B interactions/day</text>
                <text x="425" y="155" font-size="10" text-anchor="middle" fill="#713f12">730 TB/year</text>
            </g>

            <!-- Cassandra -->
            <g class="component">
                <rect x="600" y="70" width="250" height="100" rx="10" fill="linear-gradient(135deg, #d8b4fe 0%, #a78bfa 100%)" stroke="#7c3aed" stroke-width="2"/>
                <text x="725" y="105" font-size="15" font-weight="bold" text-anchor="middle" fill="white">üíø Cassandra</text>
                <text x="725" y="125" font-size="11" text-anchor="middle" fill="white">Recent Interactions</text>
                <text x="725" y="140" font-size="10" text-anchor="middle" fill="white">Last 90 days</text>
            </g>

            <!-- PostgreSQL -->
            <g class="component">
                <rect x="900" y="70" width="250" height="100" rx="10" fill="linear-gradient(135deg, #99f6e4 0%, #2dd4bf 100%)" stroke="#14b8a6" stroke-width="2"/>
                <text x="1025" y="105" font-size="15" font-weight="bold" text-anchor="middle" fill="#134e4a">üóÑÔ∏è PostgreSQL</text>
                <text x="1025" y="125" font-size="11" text-anchor="middle" fill="#134e4a">Item Metadata</text>
                <text x="1025" y="140" font-size="10" text-anchor="middle" fill="#134e4a">User Profiles</text>
            </g>

            <!-- Arrows down -->
            <path d="M 425 170 L 425 230" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 725 170 L 725 230" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 1025 170 L 1025 230" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Spark ETL -->
            <g class="component">
                <rect x="400" y="230" width="700" height="110" rx="10" fill="linear-gradient(135deg, #86efac 0%, #22c55e 100%)" stroke="#16a34a" stroke-width="2"/>
                <text x="750" y="265" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üîß Apache Spark ETL Pipeline</text>
                <text x="750" y="285" font-size="12" text-anchor="middle" fill="white">Daily Batch Job (scheduled at 2 AM UTC)</text>
                <text x="750" y="305" font-size="11" text-anchor="middle" fill="white">‚úì Data cleaning | ‚úì Deduplication | ‚úì Filtering | ‚úì Join datasets</text>
                <text x="750" y="325" font-size="11" text-anchor="middle" fill="white">Processing time: ~2 hours for 10B events</text>
            </g>

            <path d="M 750 340 L 750 390" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Feature Engineering -->
            <g class="component">
                <rect x="400" y="390" width="700" height="130" rx="10" fill="linear-gradient(135deg, #fde047 0%, #facc15 100%)" stroke="#eab308" stroke-width="2"/>
                <text x="750" y="425" font-size="16" font-weight="bold" text-anchor="middle" fill="#713f12">‚öôÔ∏è Feature Engineering</text>
                <text x="750" y="450" font-size="12" text-anchor="middle" fill="#713f12"><strong>User Features:</strong> Lifetime purchases, category prefs, avg dwell time, embeddings</text>
                <text x="750" y="470" font-size="12" text-anchor="middle" fill="#713f12"><strong>Item Features:</strong> Popularity, CTR, conversion rate, content embeddings</text>
                <text x="750" y="490" font-size="12" text-anchor="middle" fill="#713f12"><strong>Interaction Features:</strong> User-item affinity scores, time-based patterns</text>
                <text x="750" y="510" font-size="11" text-anchor="middle" fill="#713f12">Output: Training dataset (positive + negative samples)</text>
            </g>

            <path d="M 750 520 L 750 570" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Training Data Split -->
            <g class="component">
                <rect x="250" y="570" width="220" height="90" rx="10" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                <text x="360" y="600" font-size="13" font-weight="bold" text-anchor="middle" fill="#1e3a8a">üìä Train Set (80%)</text>
                <text x="360" y="620" font-size="10" text-anchor="middle" fill="#1e3a8a">8B samples</text>
                <text x="360" y="635" font-size="10" text-anchor="middle" fill="#1e3a8a">Historical data</text>
            </g>

            <g class="component">
                <rect x="520" y="570" width="220" height="90" rx="10" fill="#fce7f3" stroke="#ec4899" stroke-width="2"/>
                <text x="630" y="600" font-size="13" font-weight="bold" text-anchor="middle" fill="#831843">üìä Validation (10%)</text>
                <text x="630" y="620" font-size="10" text-anchor="middle" fill="#831843">1B samples</text>
                <text x="630" y="635" font-size="10" text-anchor="middle" fill="#831843">Hyperparameter tuning</text>
            </g>

            <g class="component">
                <rect x="790" y="570" width="220" height="90" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                <text x="900" y="600" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">üìä Test Set (10%)</text>
                <text x="900" y="620" font-size="10" text-anchor="middle" fill="#92400e">1B samples</text>
                <text x="900" y="635" font-size="10" text-anchor="middle" fill="#92400e">Final evaluation</text>
            </g>

            <path d="M 750 520 L 360 570" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 750 520 L 630 570" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 750 520 L 900 570" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Model Training -->
            <g class="component">
                <rect x="450" y="710" width="600" height="140" rx="10" fill="linear-gradient(135deg, #fda4af 0%, #fb7185 100%)" stroke="#e11d48" stroke-width="2"/>
                <text x="750" y="745" font-size="17" font-weight="bold" text-anchor="middle" fill="white">üéì Distributed Model Training</text>
                <text x="750" y="770" font-size="12" text-anchor="middle" fill="white">Infrastructure: 8x NVIDIA A100 GPUs | Data Parallelism</text>
                <text x="750" y="790" font-size="12" text-anchor="middle" fill="white"><strong>Models:</strong> Two-Tower DNN | XGBoost Ranker | Matrix Factorization | Transformers</text>
                <text x="750" y="810" font-size="11" text-anchor="middle" fill="white">Training time: 6-12 hours | Experiment tracking: MLflow</text>
                <text x="750" y="830" font-size="11" text-anchor="middle" fill="white">Hyperparameter tuning: Optuna (Bayesian optimization)</text>
            </g>

            <path d="M 360 660 L 550 710" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <path d="M 750 850 L 750 910" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Evaluation & Deployment -->
            <g class="component">
                <rect x="200" y="910" width="300" height="110" rx="10" fill="linear-gradient(135deg, #c4b5fd 0%, #8b5cf6 100%)" stroke="#7c3aed" stroke-width="2"/>
                <text x="350" y="945" font-size="15" font-weight="bold" text-anchor="middle" fill="white">‚úÖ Model Evaluation</text>
                <text x="350" y="965" font-size="11" text-anchor="middle" fill="white">Offline: NDCG, Precision@K, Recall@K</text>
                <text x="350" y="980" font-size="11" text-anchor="middle" fill="white">Validation AUC > 0.75</text>
                <text x="350" y="995" font-size="11" text-anchor="middle" fill="white">A/B test setup: 5% traffic</text>
            </g>

            <g class="component">
                <rect x="550" y="910" width="300" height="110" rx="10" fill="linear-gradient(135deg, #86efac 0%, #22c55e 100%)" stroke="#16a34a" stroke-width="2"/>
                <text x="700" y="945" font-size="15" font-weight="bold" text-anchor="middle" fill="white">üöÄ Model Deployment</text>
                <text x="700" y="965" font-size="11" text-anchor="middle" fill="white">Export to TensorFlow SavedModel</text>
                <text x="700" y="980" font-size="11" text-anchor="middle" fill="white">Upload to Model Registry</text>
                <text x="700" y="995" font-size="11" text-anchor="middle" fill="white">Deploy to TF Serving cluster</text>
            </g>

            <g class="component">
                <rect x="900" y="910" width="300" height="110" rx="10" fill="linear-gradient(135deg, #fecaca 0%, #f87171 100%)" stroke="#dc2626" stroke-width="2"/>
                <text x="1050" y="945" font-size="15" font-weight="bold" text-anchor="middle" fill="white">üìä A/B Testing</text>
                <text x="1050" y="965" font-size="11" text-anchor="middle" fill="white">Online metrics: CTR, conversion</text>
                <text x="1050" y="980" font-size="11" text-anchor="middle" fill="white">Statistical significance test</text>
                <text x="1050" y="995" font-size="11" text-anchor="middle" fill="white">Gradual rollout: 5% ‚Üí 100%</text>
            </g>

            <path d="M 750 850 L 350 910" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 750 850 L 700 910" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 750 850 L 1050 910" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

        </svg>

        <div class="flow-description">
            <h3>üéì Offline Model Training Pipeline Steps</h3>
            <ol>
                <li><strong>Data Collection:</strong> Aggregate data from multiple sources
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Data Lake (S3): Historical interaction events (Parquet format)</li>
                        <li>Cassandra: Recent 90 days of user interactions</li>
                        <li>PostgreSQL: Item metadata, user profiles</li>
                    </ul>
                </li>
                <li><strong>ETL Pipeline (Spark):</strong> Process raw data into clean datasets
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Data cleaning: Remove bots, invalid events, duplicates</li>
                        <li>Filtering: Apply business logic (e.g., exclude test users)</li>
                        <li>Joins: Combine user, item, and interaction data</li>
                        <li>Schedule: Daily at 2 AM UTC via Apache Airflow</li>
                    </ul>
                </li>
                <li><strong>Feature Engineering:</strong> Create ML-ready features
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>User features: Lifetime purchases, category preferences, engagement metrics</li>
                        <li>Item features: Popularity (CTR, views), freshness, content embeddings</li>
                        <li>Interaction features: User-item affinity, time-based patterns</li>
                        <li>Negative sampling: Generate 4 negative samples per positive (1:4 ratio)</li>
                    </ul>
                </li>
                <li><strong>Train/Val/Test Split:</strong> 80% / 10% / 10% split with stratification</li>
                <li><strong>Distributed Training:</strong> Train models on GPU cluster
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Two-Tower Model: User & item encoders with dot product similarity</li>
                        <li>XGBoost Ranker: Gradient boosted trees with LambdaRank objective</li>
                        <li>Matrix Factorization: ALS for collaborative filtering baseline</li>
                        <li>Training time: 6-12 hours | Hyperparameter tuning with Optuna</li>
                    </ul>
                </li>
                <li><strong>Evaluation:</strong> Offline metrics on test set
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>NDCG@10, Precision@10, Recall@10, AUC-ROC</li>
                        <li>Acceptance criteria: NDCG > 0.6, AUC > 0.75</li>
                    </ul>
                </li>
                <li><strong>Deployment:</strong> Export model and deploy to production
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Save to Model Registry (versioned, with metadata)</li>
                        <li>Deploy to TensorFlow Serving cluster</li>
                        <li>Canary deployment: Start with 5% traffic</li>
                    </ul>
                </li>
                <li><strong>A/B Testing:</strong> Validate online performance
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Metrics: CTR, conversion rate, engagement time, revenue</li>
                        <li>Statistical significance: t-test, p-value < 0.05</li>
                        <li>Gradual rollout: 5% ‚Üí 25% ‚Üí 50% ‚Üí 100% over 2 weeks</li>
                    </ul>
                </li>
            </ol>
            <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 5px;">
                <strong>üîÑ Update Frequency:</strong> Models retrained weekly (full) + daily (incremental updates)
            </div>
        </div>
    </div>

    <!-- Feature Engineering Flow -->
    <div id="feature-diagram" class="diagram-container">
        <svg viewBox="0 0 1600 1000" xmlns="http://www.w3.org/2000/svg">
            <text x="800" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Feature Engineering Pipeline (Real-time + Batch)
            </text>

            <!-- Real-time Stream -->
            <g class="component">
                <rect x="100" y="80" width="300" height="80" rx="10" fill="linear-gradient(135deg, #fecaca 0%, #f87171 100%)" stroke="#dc2626" stroke-width="2"/>
                <text x="250" y="115" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üìä Real-time Events</text>
                <text x="250" y="135" font-size="11" text-anchor="middle" fill="white">Kafka: 100K events/sec</text>
            </g>

            <path d="M 400 120 L 500 120" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <g class="component">
                <rect x="500" y="80" width="400" height="80" rx="10" fill="linear-gradient(135deg, #c084fc 0%, #a855f7 100%)" stroke="#9333ea" stroke-width="2"/>
                <text x="700" y="115" font-size="14" font-weight="bold" text-anchor="middle" fill="white">‚ö° Flink/Spark Streaming</text>
                <text x="700" y="135" font-size="11" text-anchor="middle" fill="white">Windowed aggregations (5-min, 1-hour)</text>
            </g>

            <path d="M 900 120 L 1000 120" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <g class="component">
                <rect x="1000" y="80" width="300" height="80" rx="10" fill="linear-gradient(135deg, #f472b6 0%, #ec4899 100%)" stroke="#db2777" stroke-width="2"/>
                <text x="1150" y="115" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üíæ Redis (Real-time Features)</text>
                <text x="1150" y="135" font-size="11" text-anchor="middle" fill="white">Session counters, trending</text>
            </g>

            <!-- Batch Path -->
            <g class="component">
                <rect x="100" y="250" width="300" height="80" rx="10" fill="linear-gradient(135deg, #fde68a 0%, #fbbf24 100%)" stroke="#f59e0b" stroke-width="2"/>
                <text x="250" y="285" font-size="14" font-weight="bold" text-anchor="middle" fill="#713f12">‚òÅÔ∏è Historical Data (S3)</text>
                <text x="250" y="305" font-size="11" text-anchor="middle" fill="#713f12">Parquet files, 730TB/year</text>
            </g>

            <path d="M 400 290 L 500 290" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <g class="component">
                <rect x="500" y="250" width="400" height="80" rx="10" fill="linear-gradient(135deg, #86efac 0%, #22c55e 100%)" stroke="#16a34a" stroke-width="2"/>
                <text x="700" y="285" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üîß Spark Batch Jobs</text>
                <text x="700" y="305" font-size="11" text-anchor="middle" fill="white">Daily aggregations, complex features</text>
            </g>

            <path d="M 900 290 L 1000 290" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <g class="component">
                <rect x="1000" y="250" width="300" height="80" rx="10" fill="linear-gradient(135deg, #fde047 0%, #facc15 100%)" stroke="#eab308" stroke-width="2"/>
                <text x="1150" y="285" font-size="14" font-weight="bold" text-anchor="middle" fill="#713f12">üóÉÔ∏è Feature Store (Batch)</text>
                <text x="1150" y="305" font-size="11" text-anchor="middle" fill="#713f12">Feast: Historical features</text>
            </g>

            <!-- Merge -->
            <path d="M 1150 160 L 1150 420" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 1150 330 L 1150 420" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <g class="component">
                <rect x="900" y="420" width="500" height="110" rx="10" fill="linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%)" stroke="#3b82f6" stroke-width="2"/>
                <text x="1150" y="455" font-size="16" font-weight="bold" text-anchor="middle" fill="#1e3a8a">üéØ Unified Feature Store</text>
                <text x="1150" y="475" font-size="12" text-anchor="middle" fill="#1e3a8a">Real-time features (Redis) + Batch features (DynamoDB/S3)</text>
                <text x="1150" y="495" font-size="11" text-anchor="middle" fill="#1e3a8a">Point-in-time correctness | Feature versioning</text>
                <text x="1150" y="515" font-size="11" text-anchor="middle" fill="#1e3a8a">Latency: &lt;5ms (online) | Feast SDK for access</text>
            </g>

            <!-- Example Features -->
            <g class="component">
                <rect x="100" y="600" width="450" height="350" rx="10" fill="#f8fafc" stroke="#cbd5e0" stroke-width="2"/>
                <text x="325" y="635" font-size="15" font-weight="bold" text-anchor="middle" fill="#2d3748">üìä User Features (200+ dimensions)</text>

                <text x="120" y="670" font-size="12" font-weight="bold" fill="#4338ca">Real-time (Redis):</text>
                <text x="140" y="690" font-size="10" fill="#4a5568">‚Ä¢ Session duration (current session)</text>
                <text x="140" y="705" font-size="10" fill="#4a5568">‚Ä¢ Items viewed last 5 minutes</text>
                <text x="140" y="720" font-size="10" fill="#4a5568">‚Ä¢ Click rate (last hour)</text>
                <text x="140" y="735" font-size="10" fill="#4a5568">‚Ä¢ Trending category affinity</text>

                <text x="120" y="765" font-size="12" font-weight="bold" fill="#16a34a">Batch (Feature Store):</text>
                <text x="140" y="785" font-size="10" fill="#4a5568">‚Ä¢ Lifetime purchases (count, avg value)</text>
                <text x="140" y="800" font-size="10" fill="#4a5568">‚Ä¢ Category preferences (top 10)</text>
                <text x="140" y="815" font-size="10" fill="#4a5568">‚Ä¢ Avg session duration (30 days)</text>
                <text x="140" y="830" font-size="10" fill="#4a5568">‚Ä¢ Purchase frequency (7d, 30d, 90d)</text>
                <text x="140" y="845" font-size="10" fill="#4a5568">‚Ä¢ User embeddings (128-dim vector)</text>
                <text x="140" y="860" font-size="10" fill="#4a5568">‚Ä¢ Demographic: age, gender, location</text>
                <text x="140" y="875" font-size="10" fill="#4a5568">‚Ä¢ Device preferences (mobile, desktop)</text>
                <text x="140" y="890" font-size="10" fill="#4a5568">‚Ä¢ Time patterns (peak hours, days)</text>
                <text x="140" y="905" font-size="10" fill="#4a5568">‚Ä¢ Churn risk score</text>
                <text x="140" y="920" font-size="10" fill="#4a5568">‚Ä¢ LTV (customer lifetime value)</text>
            </g>

            <g class="component">
                <rect x="600" y="600" width="450" height="350" rx="10" fill="#f8fafc" stroke="#cbd5e0" stroke-width="2"/>
                <text x="825" y="635" font-size="15" font-weight="bold" text-anchor="middle" fill="#2d3748">üì¶ Item Features (150+ dimensions)</text>

                <text x="620" y="670" font-size="12" font-weight="bold" fill="#4338ca">Real-time (Redis):</text>
                <text x="640" y="690" font-size="10" fill="#4a5568">‚Ä¢ Views last 5 minutes (trending)</text>
                <text x="640" y="705" font-size="10" fill="#4a5568">‚Ä¢ Velocity (clicks/views ratio)</text>
                <text x="640" y="720" font-size="10" fill="#4a5568">‚Ä¢ Current inventory status</text>

                <text x="620" y="750" font-size="12" font-weight="bold" fill="#16a34a">Batch (Feature Store):</text>
                <text x="640" y="770" font-size="10" fill="#4a5568">‚Ä¢ Total views (7d, 30d, all-time)</text>
                <text x="640" y="785" font-size="10" fill="#4a5568">‚Ä¢ CTR (click-through rate)</text>
                <text x="640" y="800" font-size="10" fill="#4a5568">‚Ä¢ Conversion rate (purchases/views)</text>
                <text x="640" y="815" font-size="10" fill="#4a5568">‚Ä¢ Average rating (1-5 stars)</text>
                <text x="640" y="830" font-size="10" fill="#4a5568">‚Ä¢ Number of ratings/reviews</text>
                <text x="640" y="845" font-size="10" fill="#4a5568">‚Ä¢ Item embeddings (128-dim vector)</text>
                <text x="640" y="860" font-size="10" fill="#4a5568">‚Ä¢ Category, subcategory, tags</text>
                <text x="640" y="875" font-size="10" fill="#4a5568">‚Ä¢ Price, discount percentage</text>
                <text x="640" y="890" font-size="10" fill="#4a5568">‚Ä¢ Freshness (days since published)</text>
                <text x="640" y="905" font-size="10" fill="#4a5568">‚Ä¢ Seasonality score</text>
                <text x="640" y="920" font-size="10" fill="#4a5568">‚Ä¢ Similar item clusters</text>
            </g>

            <g class="component">
                <rect x="1100" y="600" width="400" height="200" rx="10" fill="#f8fafc" stroke="#cbd5e0" stroke-width="2"/>
                <text x="1300" y="635" font-size="15" font-weight="bold" text-anchor="middle" fill="#2d3748">üåç Context Features</text>

                <text x="1120" y="670" font-size="12" font-weight="bold" fill="#7c3aed">Session Context:</text>
                <text x="1140" y="690" font-size="10" fill="#4a5568">‚Ä¢ Time of day (hour, minute)</text>
                <text x="1140" y="705" font-size="10" fill="#4a5568">‚Ä¢ Day of week</text>
                <text x="1140" y="720" font-size="10" fill="#4a5568">‚Ä¢ Device type (mobile, desktop, TV)</text>
                <text x="1140" y="735" font-size="10" fill="#4a5568">‚Ä¢ OS (iOS, Android, Windows)</text>
                <text x="1140" y="750" font-size="10" fill="#4a5568">‚Ä¢ Browser type</text>
                <text x="1140" y="765" font-size="10" fill="#4a5568">‚Ä¢ Location (country, city)</text>
                <text x="1140" y="780" font-size="10" fill="#4a5568">‚Ä¢ Page context (home, search, category)</text>
            </g>

        </svg>

        <div class="flow-description">
            <h3>üîß Feature Engineering Pipeline</h3>
            <p style="margin-bottom: 15px; line-height: 1.8;">
                The feature engineering pipeline operates in two modes: <strong>real-time</strong> (for low-latency features)
                and <strong>batch</strong> (for complex aggregations). Both feed into a unified Feature Store.
            </p>
            <ol>
                <li><strong>Real-time Stream Processing:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Events from Kafka (100K events/sec)</li>
                        <li>Flink/Spark Streaming: Windowed aggregations (5-min, 1-hour windows)</li>
                        <li>Store in Redis: Session features, trending scores, real-time counters</li>
                        <li>Latency: Features available within seconds</li>
                    </ul>
                </li>
                <li><strong>Batch Processing:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Daily Spark jobs on S3 data lake (730TB historical data)</li>
                        <li>Complex aggregations: 7-day, 30-day, 90-day rolling windows</li>
                        <li>Feature computation: User LTV, churn prediction, item popularity trends</li>
                        <li>Store in Feature Store (Feast): Versioned, point-in-time correct</li>
                    </ul>
                </li>
                <li><strong>Unified Feature Store:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Combines real-time (Redis) + batch (S3/DynamoDB) features</li>
                        <li>Provides single API for feature retrieval (Feast SDK)</li>
                        <li>Ensures training-serving consistency</li>
                        <li>Feature versioning for reproducibility</li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <!-- Full System Flow -->
    <div id="full-diagram" class="diagram-container">
        <svg viewBox="0 0 1600 900" xmlns="http://www.w3.org/2000/svg">
            <text x="800" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Complete End-to-End Recommendation System
            </text>

            <text x="100" y="80" font-size="13" font-weight="bold" fill="#64748b">USER LAYER</text>
            <rect x="250" y="60" width="600" height="60" rx="8" fill="url(#grad-client)" stroke="#2563eb" stroke-width="2"/>
            <text x="550" y="95" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üë• Users (Web, Mobile, TV, API)</text>

            <path d="M 550 120 L 550 170" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <text x="100" y="190" font-size="13" font-weight="bold" fill="#64748b">API LAYER</text>
            <rect x="250" y="170" width="600" height="60" rx="8" fill="url(#grad-api)" stroke="#0891b2" stroke-width="2"/>
            <text x="550" y="205" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üö™ API Gateway + Load Balancer</text>

            <path d="M 550 230 L 550 280" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <text x="100" y="300" font-size="13" font-weight="bold" fill="#64748b">SERVICE LAYER</text>
            <rect x="200" y="280" width="200" height="60" rx="8" fill="url(#grad-service)" stroke="#4d7c0f" stroke-width="2"/>
            <text x="300" y="315" font-size="12" font-weight="bold" text-anchor="middle" fill="white">üéØ Rec Service</text>

            <rect x="450" y="280" width="200" height="60" rx="8" fill="linear-gradient(135deg, #fecaca 0%, #f87171 100%)" stroke="#dc2626" stroke-width="2"/>
            <text x="550" y="315" font-size="12" font-weight="bold" text-anchor="middle" fill="white">üìä Event Tracker</text>

            <rect x="700" y="280" width="200" height="60" rx="8" fill="linear-gradient(135deg, #fed7aa 0%, #fb923c 100%)" stroke="#ea580c" stroke-width="2"/>
            <text x="800" y="315" font-size="12" font-weight="bold" text-anchor="middle" fill="white">üë§ User Service</text>

            <path d="M 300 340 L 300 390" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 550 340 L 550 460" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <text x="100" y="410" font-size="13" font-weight="bold" fill="#64748b">ML LAYER</text>
            <rect x="150" y="390" width="130" height="60" rx="8" fill="url(#grad-candidate)" stroke="#9333ea" stroke-width="2"/>
            <text x="215" y="420" font-size="11" font-weight="bold" text-anchor="middle" fill="white">üîç Candidate Gen</text>

            <rect x="310" y="390" width="130" height="60" rx="8" fill="url(#grad-ranking)" stroke="#d97706" stroke-width="2"/>
            <text x="375" y="420" font-size="11" font-weight="bold" text-anchor="middle" fill="white">‚öñÔ∏è Ranking</text>

            <rect x="470" y="390" width="130" height="60" rx="8" fill="linear-gradient(135deg, #fde047 0%, #facc15 100%)" stroke="#eab308" stroke-width="2"/>
            <text x="535" y="420" font-size="11" font-weight="bold" text-anchor="middle" fill="white">üóÉÔ∏è Feature Store</text>

            <path d="M 215 450 L 215 520" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 375 450 L 375 520" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <text x="100" y="480" font-size="13" font-weight="bold" fill="#64748b">MESSAGE QUEUE</text>
            <rect x="250" y="460" width="600" height="50" rx="8" fill="linear-gradient(135deg, #fca5a5 0%, #ef4444 100%)" stroke="#b91c1c" stroke-width="2"/>
            <text x="550" y="490" font-size="13" font-weight="bold" text-anchor="middle" fill="white">üì¨ Apache Kafka / Kinesis (Event Streaming)</text>

            <text x="100" y="540" font-size="13" font-weight="bold" fill="#64748b">DATA LAYER</text>
            <rect x="150" y="520" width="150" height="70" rx="8" fill="url(#grad-cache)" stroke="#db2777" stroke-width="2"/>
            <text x="225" y="550" font-size="11" font-weight="bold" text-anchor="middle" fill="white">üíæ Redis Cache</text>

            <rect x="330" y="520" width="150" height="70" rx="8" fill="linear-gradient(135deg, #99f6e4 0%, #2dd4bf 100%)" stroke="#14b8a6" stroke-width="2"/>
            <text x="405" y="550" font-size="11" font-weight="bold" text-anchor="middle" fill="white">üóÑÔ∏è PostgreSQL</text>

            <rect x="510" y="520" width="150" height="70" rx="8" fill="linear-gradient(135deg, #d8b4fe 0%, #a78bfa 100%)" stroke="#7c3aed" stroke-width="2"/>
            <text x="585" y="550" font-size="11" font-weight="bold" text-anchor="middle" fill="white">üíø Cassandra</text>

            <rect x="690" y="520" width="150" height="70" rx="8" fill="linear-gradient(135deg, #fde68a 0%, #fbbf24 100%)" stroke="#f59e0b" stroke-width="2"/>
            <text x="765" y="550" font-size="11" font-weight="bold" text-anchor="middle" fill="white">‚òÅÔ∏è S3 Data Lake</text>

            <path d="M 550 510 L 585 520" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 550 510 L 765 520" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <text x="100" y="640" font-size="13" font-weight="bold" fill="#64748b">ML PIPELINE</text>
            <rect x="200" y="620" width="180" height="60" rx="8" fill="linear-gradient(135deg, #86efac 0%, #22c55e 100%)" stroke="#16a34a" stroke-width="2"/>
            <text x="290" y="650" font-size="11" font-weight="bold" text-anchor="middle" fill="white">üîß Data Prep (Spark)</text>

            <rect x="420" y="620" width="180" height="60" rx="8" fill="linear-gradient(135deg, #fda4af 0%, #fb7185 100%)" stroke="#e11d48" stroke-width="2"/>
            <text x="510" y="650" font-size="11" font-weight="bold" text-anchor="middle" fill="white">üéì Model Training</text>

            <rect x="640" y="620" width="180" height="60" rx="8" fill="linear-gradient(135deg, #c4b5fd 0%, #8b5cf6 100%)" stroke="#7c3aed" stroke-width="2"/>
            <text x="730" y="650" font-size="11" font-weight="bold" text-anchor="middle" fill="white">‚úÖ Evaluation</text>

            <path d="M 765 590 L 290 620" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>
            <path d="M 380 620 L 420 650" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 600 650 L 640 650" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <text x="100" y="740" font-size="13" font-weight="bold" fill="#64748b">MONITORING</text>
            <rect x="250" y="720" width="600" height="60" rx="8" fill="linear-gradient(135deg, #d1fae5 0%, #6ee7b7 100%)" stroke="#10b981" stroke-width="2"/>
            <text x="550" y="755" font-size="13" font-weight="bold" text-anchor="middle" fill="#065f46">üìà Monitoring: Prometheus, Grafana, ELK, Jaeger</text>

            <!-- Monitoring arrows -->
            <path d="M 300 340 L 250 720" stroke="#10b981" stroke-width="1" fill="none" stroke-dasharray="3,3"/>
            <path d="M 550 340 L 550 720" stroke="#10b981" stroke-width="1" fill="none" stroke-dasharray="3,3"/>
            <path d="M 800 340 L 850 720" stroke="#10b981" stroke-width="1" fill="none" stroke-dasharray="3,3"/>

            <!-- Data flow annotations -->
            <text x="950" y="320" font-size="11" fill="#6366f1" font-weight="600">Real-time Flow ‚Üí</text>
            <text x="950" y="340" font-size="10" fill="#4a5568">1. User requests recs</text>
            <text x="950" y="355" font-size="10" fill="#4a5568">2. Check cache (70% hit)</text>
            <text x="950" y="370" font-size="10" fill="#4a5568">3. Generate candidates (500)</text>
            <text x="950" y="385" font-size="10" fill="#4a5568">4. Rank with ML model</text>
            <text x="950" y="400" font-size="10" fill="#4a5568">5. Return top 20</text>

            <text x="950" y="430" font-size="11" fill="#f59e0b" font-weight="600">Batch Flow ‚Üì</text>
            <text x="950" y="450" font-size="10" fill="#4a5568">1. Collect events (Kafka)</text>
            <text x="950" y="465" font-size="10" fill="#4a5568">2. Store in data lake (S3)</text>
            <text x="950" y="480" font-size="10" fill="#4a5568">3. Daily ETL (Spark)</text>
            <text x="950" y="495" font-size="10" fill="#4a5568">4. Train models (GPU)</text>
            <text x="950" y="510" font-size="10" fill="#4a5568">5. A/B test & deploy</text>

        </svg>

        <div class="flow-description">
            <h3>üèóÔ∏è Complete End-to-End System Overview</h3>
            <p style="line-height: 1.8;">
                This diagram shows the complete recommendation system with all components working together.
                The system follows a <strong>Lambda architecture</strong> pattern with separate real-time and batch processing paths.
            </p>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px;">
                <div style="background: #f0f9ff; padding: 15px; border-radius: 10px; border-left: 4px solid #0284c7;">
                    <h4 style="color: #075985; margin-bottom: 8px;">‚ö° Real-time Path (Inference)</h4>
                    <p style="font-size: 0.9em; color: #0c4a6e; line-height: 1.6;">
                        User ‚Üí API Gateway ‚Üí Recommendation Service ‚Üí Candidate Generation (FAISS) ‚Üí
                        Ranking (ML Model) ‚Üí Post-processing ‚Üí Cache ‚Üí Response (&lt;100ms)
                    </p>
                </div>
                <div style="background: #fef3c7; padding: 15px; border-radius: 10px; border-left: 4px solid #f59e0b;">
                    <h4 style="color: #92400e; margin-bottom: 8px;">üîÑ Batch Path (Training)</h4>
                    <p style="font-size: 0.9em; color: #78350f; line-height: 1.6;">
                        Events ‚Üí Kafka ‚Üí S3 Data Lake ‚Üí Spark ETL ‚Üí Feature Engineering ‚Üí
                        Model Training (GPU) ‚Üí Evaluation ‚Üí A/B Testing ‚Üí Deployment (weekly)
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Metrics Panel -->
    <div class="metrics-panel">
        <h2 style="margin-bottom: 15px; color: #92400e;">‚ö° System Performance Metrics</h2>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
            <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #6366f1;">
                <div style="font-size: 1.4em; font-weight: 700; color: #6366f1;">10K QPS</div>
                <div style="font-size: 0.85em; color: #4a5568; margin-top: 5px;">Peak Recommendation Requests</div>
            </div>
            <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #10b981;">
                <div style="font-size: 1.4em; font-weight: 700; color: #10b981;">&lt;100ms</div>
                <div style="font-size: 0.85em; color: #4a5568; margin-top: 5px;">P95 Latency (end-to-end)</div>
            </div>
            <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                <div style="font-size: 1.4em; font-weight: 700; color: #f59e0b;">75%</div>
                <div style="font-size: 0.85em; color: #4a5568; margin-top: 5px;">Cache Hit Rate</div>
            </div>
            <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #ef4444;">
                <div style="font-size: 1.4em; font-weight: 700; color: #ef4444;">3-5%</div>
                <div style="font-size: 0.85em; color: #4a5568; margin-top: 5px;">Target CTR (Click-Through Rate)</div>
            </div>
        </div>
    </div>

</div>

<script>
    function showDiagram(type) {
        document.querySelectorAll('.diagram-container').forEach(d => {
            d.classList.remove('active');
        });

        document.querySelectorAll('.tab').forEach(t => {
            t.classList.remove('active');
        });

        document.getElementById(type + '-diagram').classList.add('active');
        event.target.classList.add('active');
    }

    document.querySelectorAll('.component').forEach(comp => {
        comp.addEventListener('mouseenter', function() {
            this.style.filter = 'drop-shadow(0 0 15px rgba(99, 102, 241, 0.6))';
        });

        comp.addEventListener('mouseleave', function() {
            this.style.filter = 'none';
        });
    });
</script>
</body>
</html>
