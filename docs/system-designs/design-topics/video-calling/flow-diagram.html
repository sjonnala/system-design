<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Calling Flow Diagram</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        .header h1 {
            font-size: 2.5em;
            color: #2d3748;
            margin-bottom: 10px;
        }
        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 12px 30px;
            background: #e2e8f0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }
        .tab.active { background: #6366f1; color: white; }
        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .diagram-container { display: none; margin-top: 30px; }
        .diagram-container.active { display: block; }
        svg { width: 100%; height: auto; }
        .component { cursor: pointer; transition: all 0.3s; }
        .component:hover { filter: drop-shadow(0 0 10px rgba(99, 102, 241, 0.5)); }
        .flow-arrow { animation: dash 20s linear infinite; }
        @keyframes dash { to { stroke-dashoffset: -1000; } }
        .flow-description {
            background: #e0e7ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 5px solid #6366f1;
        }
        .flow-description h3 { color: #4338ca; margin-bottom: 10px; }
        .flow-description ol {
            margin-left: 20px;
            line-height: 2;
            color: #1e293b;
        }
        .flow-description strong { color: #6366f1; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üé• Video Calling Flow Diagram</h1>
        <p style="color: #64748b; margin-top: 10px;">Interactive WebRTC Flow Visualization</p>
        <div class="tabs">
            <button class="tab active" onclick="showDiagram('p2p')">üìû 1-on-1 Call (P2P)</button>
            <button class="tab" onclick="showDiagram('group')">üë• Group Call (SFU)</button>
            <button class="tab" onclick="showDiagram('join')">üöÄ Call Join Flow</button>
            <button class="tab" onclick="showDiagram('full')">üèóÔ∏è Full Architecture</button>
        </div>
    </div>

    <!-- 1-on-1 P2P Call Flow -->
    <div id="p2p-diagram" class="diagram-container active">
        <svg viewBox="0 0 1400 1100" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#6366f1" />
                </marker>
            </defs>
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                1-on-1 Video Call: WebRTC Signaling Flow
            </text>
            
            <!-- Caller -->
            <rect x="100" y="80" width="200" height="80" rx="10" fill="#60a5fa" stroke="#2563eb" stroke-width="2"/>
            <text x="200" y="120" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üì± Caller (Alice)</text>
            
            <!-- Signaling Server -->
            <rect x="600" y="80" width="200" height="80" rx="10" fill="#f87171" stroke="#dc2626" stroke-width="2"/>
            <text x="700" y="120" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üì° Signaling Server</text>
            
            <!-- Callee -->
            <rect x="1100" y="80" width="200" height="80" rx="10" fill="#818cf8" stroke="#4f46e5" stroke-width="2"/>
            <text x="1200" y="120" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üì± Callee (Bob)</text>

            <!-- Flow Steps -->
            <path d="M 300 120 L 600 120" stroke="#6366f1" stroke-width="3" marker-end="url(#arrowhead)"/>
            <text x="450" y="110" font-size="12" fill="#4338ca" font-weight="600">1. Call initiate</text>

            <path d="M 800 120 L 1100 120" stroke="#6366f1" stroke-width="3" marker-end="url(#arrowhead)"/>
            <text x="950" y="110" font-size="12" fill="#4338ca" font-weight="600">2. Ring notification</text>

            <path d="M 1100 140 L 800 140" stroke="#10b981" stroke-width="3" marker-end="url(#arrowhead)"/>
            <text x="950" y="155" font-size="12" fill="#059669" font-weight="600">3. Accept call</text>

            <!-- SDP Offer -->
            <path d="M 300 200 L 600 200" stroke="#6366f1" stroke-width="3" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>
            <text x="400" y="190" font-size="12" fill="#4338ca" font-weight="600">4. SDP Offer</text>
            <rect x="320" y="210" width="260" height="100" rx="5" fill="#fef3c7" stroke="#f59e0b"/>
            <text x="330" y="230" font-size="10" fill="#78350f" font-weight="bold">SDP Offer (Alice's capabilities):</text>
            <text x="330" y="250" font-size="9" fill="#78350f">‚Ä¢ Video: H.264, VP8, VP9</text>
            <text x="330" y="265" font-size="9" fill="#78350f">‚Ä¢ Audio: Opus</text>
            <text x="330" y="280" font-size="9" fill="#78350f">‚Ä¢ ICE candidates (local IPs)</text>
            <text x="330" y="295" font-size="9" fill="#78350f">‚Ä¢ DTLS fingerprint</text>

            <path d="M 800 230 L 1100 230" stroke="#6366f1" stroke-width="3" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>
            <text x="920" y="220" font-size="12" fill="#4338ca" font-weight="600">5. Forward Offer</text>

            <!-- SDP Answer -->
            <path d="M 1100 330 L 800 330" stroke="#10b981" stroke-width="3" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>
            <text x="920" y="320" font-size="12" fill="#059669" font-weight="600">6. SDP Answer</text>
            <rect x="820" y="340" width="260" height="100" rx="5" fill="#d1fae5" stroke="#10b981"/>
            <text x="830" y="360" font-size="10" fill="#065f46" font-weight="bold">SDP Answer (Bob's capabilities):</text>
            <text x="830" y="380" font-size="9" fill="#065f46">‚Ä¢ Agreed codec: H.264</text>
            <text x="830" y="395" font-size="9" fill="#065f46">‚Ä¢ Audio: Opus</text>
            <text x="830" y="410" font-size="9" fill="#065f46">‚Ä¢ ICE candidates</text>
            <text x="830" y="425" font-size="9" fill="#065f46">‚Ä¢ DTLS fingerprint</text>

            <path d="M 600 360 L 300 360" stroke="#10b981" stroke-width="3" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>
            <text x="420" y="350" font-size="12" fill="#059669" font-weight="600">7. Forward Answer</text>

            <!-- ICE Candidates Exchange -->
            <path d="M 300 480 L 600 480" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>
            <text x="380" y="470" font-size="11" fill="#92400e" font-weight="600">8. ICE Candidates ‚Üí</text>

            <path d="M 800 480 L 1100 480" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>
            
            <path d="M 1100 500 L 800 500" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>
            <text x="880" y="490" font-size="11" fill="#92400e" font-weight="600">‚Üê ICE Candidates</text>

            <path d="M 600 500 L 300 500" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>

            <!-- STUN Server -->
            <rect x="600" y="550" width="200" height="60" rx="10" fill="#fcd34d" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="585" font-size="14" font-weight="bold" text-anchor="middle" fill="#78350f">üåê STUN Server</text>

            <path d="M 200 160 L 650 550" stroke="#f59e0b" stroke-width="2" stroke-dasharray="2,2"/>
            <path d="M 1200 160 L 750 550" stroke="#f59e0b" stroke-width="2" stroke-dasharray="2,2"/>
            <text x="400" y="350" font-size="10" fill="#92400e">Discover public IP</text>
            <text x="900" y="350" font-size="10" fill="#92400e">Discover public IP</text>

            <!-- P2P Connection -->
            <rect x="500" y="700" width="400" height="100" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="3"/>
            <text x="700" y="735" font-size="18" font-weight="bold" text-anchor="middle" fill="#065f46">‚úÖ Direct P2P Connection Established</text>
            <text x="700" y="760" font-size="13" text-anchor="middle" fill="#065f46">Encrypted with DTLS-SRTP</text>
            <text x="700" y="780" font-size="12" text-anchor="middle" fill="#065f46">Video + Audio + DataChannel</text>

            <path d="M 300 400 L 700 700" stroke="#10b981" stroke-width="5" marker-end="url(#arrowhead)"/>
            <path d="M 1100 400 L 700 700" stroke="#10b981" stroke-width="5" marker-end="url(#arrowhead)"/>

            <!-- Bandwidth Info -->
            <rect x="100" y="850" width="1200" height="150" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="885" font-size="16" font-weight="bold" text-anchor="middle" fill="#92400e">üìä Bandwidth Usage (1-on-1 HD Call)</text>
            <text x="120" y="915" font-size="13" fill="#78350f"><strong>Upload (each person):</strong> 2.5 Mbps (720p video) + 50 Kbps (audio) = 2.55 Mbps</text>
            <text x="120" y="940" font-size="13" fill="#78350f"><strong>Download (each person):</strong> 2.5 Mbps (720p video) + 50 Kbps (audio) = 2.55 Mbps</text>
            <text x="120" y="965" font-size="13" fill="#78350f"><strong>Total per person:</strong> ~5 Mbps (symmetric)</text>
            <text x="120" y="990" font-size="12" fill="#78350f" font-style="italic">Note: P2P is efficient for 1-on-1, but doesn't scale to groups (n¬≤ connections)</text>
        </svg>

        <div class="flow-description">
            <h3>üìû 1-on-1 Call Setup Flow (WebRTC P2P)</h3>
            <ol>
                <li><strong>Call Initiate:</strong> Alice clicks "Call Bob" ‚Üí Client sends request to signaling server</li>
                <li><strong>Ring Notification:</strong> Signaling server notifies Bob via WebSocket</li>
                <li><strong>Accept Call:</strong> Bob clicks "Accept" ‚Üí sends acceptance to server</li>
                <li><strong>SDP Offer:</strong> Alice creates offer (supported codecs, resolutions) ‚Üí sends to Bob via server</li>
                <li><strong>SDP Answer:</strong> Bob creates answer (agrees on codec, resolution) ‚Üí sends to Alice</li>
                <li><strong>ICE Candidates:</strong> Both sides discover network paths:
                    <ul style="margin-left: 20px;">
                        <li>Query STUN server for public IP</li>
                        <li>Gather local network interfaces</li>
                        <li>Exchange candidates via signaling server</li>
                    </ul>
                </li>
                <li><strong>Connectivity Check:</strong> WebRTC tries all candidate pairs to find best path</li>
                <li><strong>P2P Connection:</strong> Direct peer-to-peer media flow established (encrypted with DTLS-SRTP)</li>
                <li><strong>Media Streaming:</strong> Audio + Video streams flow directly between Alice and Bob</li>
            </ol>
            <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 5px;">
                <strong>üéØ Why P2P for 1-on-1?</strong> Lowest latency (~50ms), no server bandwidth cost, scales perfectly for two people!
            </div>
        </div>
    </div>

    <!-- Group Call Flow (SFU) -->
    <div id="group-diagram" class="diagram-container">
        <svg viewBox="0 0 1400 1000" xmlns="http://www.w3.org/2000/svg">
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Group Video Call: SFU-Based Architecture
            </text>

            <!-- Participants -->
            <rect x="100" y="100" width="150" height="70" rx="10" fill="#60a5fa" stroke="#2563eb" stroke-width="2"/>
            <text x="175" y="140" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üë§ User 1</text>

            <rect x="100" y="250" width="150" height="70" rx="10" fill="#60a5fa" stroke="#2563eb" stroke-width="2"/>
            <text x="175" y="290" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üë§ User 2</text>

            <rect x="100" y="400" width="150" height="70" rx="10" fill="#60a5fa" stroke="#2563eb" stroke-width="2"/>
            <text x="175" y="440" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üë§ User 3</text>

            <rect x="100" y="550" width="150" height="70" rx="10" fill="#60a5fa" stroke="#2563eb" stroke-width="2"/>
            <text x="175" y="590" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üë§ User N</text>

            <!-- SFU Server -->
            <rect x="550" y="300" width="300" height="150" rx="15" fill="#84cc16" stroke="#4d7c0f" stroke-width="3"/>
            <text x="700" y="360" font-size="20" font-weight="bold" text-anchor="middle" fill="white">üé¨ SFU Server</text>
            <text x="700" y="385" font-size="13" text-anchor="middle" fill="white">(Selective Forwarding Unit)</text>
            <text x="700" y="410" font-size="12" text-anchor="middle" fill="white">‚Ä¢ Forwards streams (no mixing)</text>
            <text x="700" y="430" font-size="12" text-anchor="middle" fill="white">‚Ä¢ Handles simulcast</text>

            <!-- Arrows: Upload to SFU -->
            <path d="M 250 135 L 550 350" stroke="#6366f1" stroke-width="4" marker-end="url(#arrowhead)"/>
            <text x="350" y="220" font-size="11" fill="#4338ca" font-weight="600">Upload: 2.5 Mbps</text>

            <path d="M 250 285 L 550 360" stroke="#6366f1" stroke-width="4" marker-end="url(#arrowhead)"/>
            <text x="350" y="310" font-size="11" fill="#4338ca" font-weight="600">Upload: 2.5 Mbps</text>

            <path d="M 250 435 L 550 390" stroke="#6366f1" stroke-width="4" marker-end="url(#arrowhead)"/>
            <text x="350" y="420" font-size="11" fill="#4338ca" font-weight="600">Upload: 2.5 Mbps</text>

            <path d="M 250 585 L 550 420" stroke="#6366f1" stroke-width="4" marker-end="url(#arrowhead)"/>
            <text x="350" y="520" font-size="11" fill="#4338ca" font-weight="600">Upload: 2.5 Mbps</text>

            <!-- Arrows: Download from SFU -->
            <path d="M 850 350 L 1150 135" stroke="#10b981" stroke-width="4" marker-end="url(#arrowhead)"/>
            <text x="950" y="220" font-size="11" fill="#059669" font-weight="600">Download: (N-1) streams</text>

            <path d="M 850 360 L 1150 285" stroke="#10b981" stroke-width="4" marker-end="url(#arrowhead)"/>
            <path d="M 850 390 L 1150 435" stroke="#10b981" stroke-width="4" marker-end="url(#arrowhead)"/>
            <path d="M 850 420 L 1150 585" stroke="#10b981" stroke-width="4" marker-end="url(#arrowhead)"/>

            <!-- Receiving participants -->
            <rect x="1150" y="100" width="150" height="70" rx="10" fill="#818cf8" stroke="#4f46e5" stroke-width="2"/>
            <text x="1225" y="140" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üì∫ Receives 3 streams</text>

            <rect x="1150" y="250" width="150" height="70" rx="10" fill="#818cf8" stroke="#4f46e5" stroke-width="2"/>
            <text x="1225" y="290" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üì∫ Receives 3 streams</text>

            <rect x="1150" y="400" width="150" height="70" rx="10" fill="#818cf8" stroke="#4f46e5" stroke-width="2"/>
            <text x="1225" y="440" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üì∫ Receives 3 streams</text>

            <rect x="1150" y="550" width="150" height="70" rx="10" fill="#818cf8" stroke="#4f46e5" stroke-width="2"/>
            <text x="1225" y="590" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üì∫ Receives 3 streams</text>

            <!-- Bandwidth Calculation -->
            <rect x="100" y="700" width="1200" height="200" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="735" font-size="16" font-weight="bold" text-anchor="middle" fill="#92400e">üìä Bandwidth Analysis (10-person meeting)</text>
            
            <text x="120" y="765" font-size="13" fill="#78350f" font-weight="bold">Per User:</text>
            <text x="140" y="790" font-size="12" fill="#78350f">‚Ä¢ Upload: 2.5 Mbps (1 stream to SFU)</text>
            <text x="140" y="810" font-size="12" fill="#78350f">‚Ä¢ Download: 9 √ó 2.5 Mbps = 22.5 Mbps (Gallery view)</text>
            <text x="140" y="830" font-size="12" fill="#78350f">‚Ä¢ Download: 1 √ó 2.5 Mbps = 2.5 Mbps (Speaker view, thumbnails low-res)</text>

            <text x="120" y="860" font-size="13" fill="#78350f" font-weight="bold">SFU Server:</text>
            <text x="140" y="880" font-size="12" fill="#78350f">‚Ä¢ Total bandwidth: 10 users √ó 2.5 Mbps (in) + 90 streams √ó 2.5 Mbps (out) = 250 Mbps</text>
        </svg>

        <div class="flow-description">
            <h3>üë• Group Call Flow (SFU Architecture)</h3>
            <p style="margin-bottom: 15px; line-height: 1.8;">
                For group calls (3+ people), peer-to-peer doesn't scale. With 10 people, each person would need 9 upload streams
                (bandwidth √ó 9) and 9 download streams. Instead, SFU (Selective Forwarding Unit) acts as a router.
            </p>
            <strong>How SFU Works:</strong>
            <ol>
                <li><strong>Each user uploads 1 stream</strong> to SFU (2.5 Mbps for HD)</li>
                <li><strong>SFU forwards</strong> that stream to all other participants (no mixing, no re-encoding)</li>
                <li><strong>User downloads (N-1) streams</strong> from SFU</li>
                <li><strong>Simulcast:</strong> User uploads multiple quality tiers (360p, 720p, 1080p) ‚Üí SFU selects best for each receiver</li>
                <li><strong>Selective Forwarding:</strong> Gallery view = all streams, Speaker view = 1 HD + thumbnails</li>
            </ol>
            <strong>Benefits:</strong>
            <ul style="margin-left: 20px;">
                <li>‚úÖ Constant upload (2.5 Mbps) regardless of group size</li>
                <li>‚úÖ Server doesn't decode/encode (low CPU)</li>
                <li>‚úÖ Adaptive quality per receiver</li>
                <li>‚úÖ Scalable to 50-100 participants</li>
            </ul>
        </div>
    </div>

    <!-- Call Join Flow -->
    <div id="join-diagram" class="diagram-container">
        <svg viewBox="0 0 1400 900" xmlns="http://www.w3.org/2000/svg">
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Call Join Flow: From Click to Video Streaming
            </text>

            <text x="100" y="80" font-size="14" fill="#64748b" font-weight="600">Time ‚Üí</text>

            <!-- Timeline -->
            <line x1="200" y1="100" x2="1300" y2="100" stroke="#cbd5e0" stroke-width="3"/>

            <!-- Step 1: User clicks join -->
            <circle cx="250" cy="100" r="20" fill="#60a5fa" stroke="#2563eb" stroke-width="3"/>
            <text x="250" y="107" font-size="14" font-weight="bold" text-anchor="middle" fill="white">1</text>
            <rect x="200" y="130" width="150" height="100" rx="10" fill="#bfdbfe" stroke="#2563eb" stroke-width="2"/>
            <text x="275" y="165" font-size="13" font-weight="bold" text-anchor="middle" fill="#1e40af">User Clicks Join</text>
            <text x="215" y="190" font-size="10" text-anchor="start" fill="#1e40af">‚Ä¢ Request camera/mic</text>
            <text x="215" y="205" font-size="10" text-anchor="start" fill="#1e40af">‚Ä¢ Permissions prompt</text>
            <text x="215" y="220" font-size="10" text-anchor="start" fill="#1e40af">Time: 0ms</text>

            <!-- Step 2: Authentication -->
            <circle cx="450" cy="100" r="20" fill="#f472b6" stroke="#db2777" stroke-width="3"/>
            <text x="450" y="107" font-size="14" font-weight="bold" text-anchor="middle" fill="white">2</text>
            <rect x="400" y="130" width="150" height="100" rx="10" fill="#fbcfe8" stroke="#db2777" stroke-width="2"/>
            <text x="475" y="165" font-size="13" font-weight="bold" text-anchor="middle" fill="#831843">Auth & Validate</text>
            <text x="415" y="190" font-size="10" text-anchor="start" fill="#831843">‚Ä¢ JWT validation</text>
            <text x="415" y="205" font-size="10" text-anchor="start" fill="#831843">‚Ä¢ Meeting exists?</text>
            <text x="415" y="220" font-size="10" text-anchor="start" fill="#831843">Time: ~100ms</text>

            <!-- Step 3: WebSocket connect -->
            <circle cx="650" cy="100" r="20" fill="#f87171" stroke="#dc2626" stroke-width="3"/>
            <text x="650" y="107" font-size="14" font-weight="bold" text-anchor="middle" fill="white">3</text>
            <rect x="600" y="130" width="150" height="100" rx="10" fill="#fecaca" stroke="#dc2626" stroke-width="2"/>
            <text x="675" y="165" font-size="13" font-weight="bold" text-anchor="middle" fill="#991b1b">WebSocket Connect</text>
            <text x="615" y="190" font-size="10" text-anchor="start" fill="#991b1b">‚Ä¢ Signaling channel</text>
            <text x="615" y="205" font-size="10" text-anchor="start" fill="#991b1b">‚Ä¢ Join room</text>
            <text x="615" y="220" font-size="10" text-anchor="start" fill="#991b1b">Time: ~200ms</text>

            <!-- Step 4: Get participant list -->
            <circle cx="850" cy="100" r="20" fill="#facc15" stroke="#f59e0b" stroke-width="3"/>
            <text x="850" y="107" font-size="14" font-weight="bold" text-anchor="middle" fill="white">4</text>
            <rect x="800" y="130" width="150" height="100" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
            <text x="875" y="165" font-size="13" font-weight="bold" text-anchor="middle" fill="#78350f">Get Participants</text>
            <text x="815" y="190" font-size="10" text-anchor="start" fill="#78350f">‚Ä¢ Who's in meeting</text>
            <text x="815" y="205" font-size="10" text-anchor="start" fill="#78350f">‚Ä¢ SFU endpoint</text>
            <text x="815" y="220" font-size="10" text-anchor="start" fill="#78350f">Time: ~250ms</text>

            <!-- Step 5: ICE/SDP -->
            <circle cx="1050" cy="100" r="20" fill="#818cf8" stroke="#6366f1" stroke-width="3"/>
            <text x="1050" y="107" font-size="14" font-weight="bold" text-anchor="middle" fill="white">5</text>
            <rect x="1000" y="130" width="150" height="100" rx="10" fill="#c7d2fe" stroke="#6366f1" stroke-width="2"/>
            <text x="1075" y="165" font-size="13" font-weight="bold" text-anchor="middle" fill="#4338ca">ICE + SDP</text>
            <text x="1015" y="190" font-size="10" text-anchor="start" fill="#4338ca">‚Ä¢ SDP offer/answer</text>
            <text x="1015" y="205" font-size="10" text-anchor="start" fill="#4338ca">‚Ä¢ ICE candidates</text>
            <text x="1015" y="220" font-size="10" text-anchor="start" fill="#4338ca">Time: ~500ms</text>

            <!-- Step 6: Media streaming -->
            <circle cx="1250" cy="100" r="20" fill="#10b981" stroke="#059669" stroke-width="3"/>
            <text x="1250" y="107" font-size="14" font-weight="bold" text-anchor="middle" fill="white">6</text>
            <rect x="1200" y="130" width="150" height="100" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="2"/>
            <text x="1275" y="165" font-size="13" font-weight="bold" text-anchor="middle" fill="#065f46">‚úÖ Streaming!</text>
            <text x="1215" y="190" font-size="10" text-anchor="start" fill="#065f46">‚Ä¢ Video/audio flows</text>
            <text x="1215" y="205" font-size="10" text-anchor="start" fill="#065f46">‚Ä¢ DTLS-SRTP encrypted</text>
            <text x="1215" y="220" font-size="10" text-anchor="start" fill="#065f46">Time: ~800ms</text>

            <!-- Total time -->
            <rect x="400" y="300" width="600" height="80" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="3"/>
            <text x="700" y="335" font-size="18" font-weight="bold" text-anchor="middle" fill="#92400e">‚è±Ô∏è Total Time to Join: ~800ms - 1 second</text>
            <text x="700" y="360" font-size="13" text-anchor="middle" fill="#78350f">From click to seeing video (optimized flow)</text>

            <!-- Detailed breakdown -->
            <rect x="100" y="450" width="1200" height="350" rx="10" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
            <text x="700" y="485" font-size="16" font-weight="bold" text-anchor="middle" fill="#4338ca">üîç Detailed Breakdown & Optimizations</text>
            
            <text x="120" y="520" font-size="13" fill="#1e293b" font-weight="bold">Parallel Operations (reduce latency):</text>
            <text x="140" y="545" font-size="12" fill="#1e293b">1. Request camera/mic + Authenticate (parallel) ‚Üí saves 100ms</text>
            <text x="140" y="565" font-size="12" fill="#1e293b">2. WebSocket connect + Get participant list (parallel) ‚Üí saves 50ms</text>
            <text x="140" y="585" font-size="12" fill="#1e293b">3. Start ICE while receiving SDP ‚Üí saves 200ms</text>

            <text x="120" y="620" font-size="13" fill="#1e293b" font-weight="bold">Network Optimizations:</text>
            <text x="140" y="645" font-size="12" fill="#1e293b">‚Ä¢ Use HTTP/2 or WebSocket for signaling (avoid connection setup overhead)</text>
            <text x="140" y="665" font-size="12" fill="#1e293b">‚Ä¢ Cache STUN/TURN servers (avoid DNS lookup)</text>
            <text x="140" y="685" font-size="12" fill="#1e293b">‚Ä¢ Trickle ICE: Start with first candidate, don't wait for all</text>

            <text x="120" y="720" font-size="13" fill="#1e293b" font-weight="bold">Perceived Performance:</text>
            <text x="140" y="745" font-size="12" fill="#1e293b">‚Ä¢ Show "Connecting..." UI immediately (user feels faster)</text>
            <text x="140" y="765" font-size="12" fill="#1e293b">‚Ä¢ Display self-view camera preview while connecting</text>
            <text x="140" y="785" font-size="12" fill="#1e293b">‚Ä¢ Progressive enhancement: Show audio first, then video</text>
        </svg>

        <div class="flow-description">
            <h3>üöÄ Call Join Flow Optimization</h3>
            <p style="margin-bottom: 15px; line-height: 1.8;">
                User experience is critical for video calling. Every millisecond counts. The goal is to get from
                "click Join" to "seeing video" in under 1 second.
            </p>
            <strong>Key Optimizations:</strong>
            <ul style="margin-left: 20px; line-height: 1.8;">
                <li><strong>Parallel Processing:</strong> Don't wait for auth to request camera</li>
                <li><strong>Trickle ICE:</strong> Send candidates as discovered (don't wait for all)</li>
                <li><strong>Connection Pooling:</strong> Reuse WebSocket connections</li>
                <li><strong>Regional SFUs:</strong> Route to nearest SFU (low latency)</li>
                <li><strong>Progressive Loading:</strong> Audio first, then video</li>
            </ul>
        </div>
    </div>

    <!-- Full System Architecture -->
    <div id="full-diagram" class="diagram-container">
        <svg viewBox="0 0 1600 1200" xmlns="http://www.w3.org/2000/svg">
            <text x="800" y="35" font-size="28" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Complete Video Calling System Architecture
            </text>

            <!-- Simplified full architecture diagram showing all components -->
            <rect x="200" y="100" width="1200" height="1000" rx="15" fill="#f8fafc" stroke="#cbd5e0" stroke-width="2"/>
            
            <!-- Client Layer -->
            <text x="220" y="140" font-size="14" font-weight="bold" fill="#64748b">CLIENT LAYER</text>
            <rect x="300" y="160" width="120" height="60" rx="8" fill="#60a5fa" stroke="#2563eb" stroke-width="2"/>
            <text x="360" y="195" font-size="12" font-weight="bold" text-anchor="middle" fill="white">Web</text>
            
            <rect x="450" y="160" width="120" height="60" rx="8" fill="#60a5fa" stroke="#2563eb" stroke-width="2"/>
            <text x="510" y="195" font-size="12" font-weight="bold" text-anchor="middle" fill="white">Mobile</text>
            
            <rect x="600" y="160" width="120" height="60" rx="8" fill="#60a5fa" stroke="#2563eb" stroke-width="2"/>
            <text x="660" y="195" font-size="12" font-weight="bold" text-anchor="middle" fill="white">Desktop</text>

            <!-- Load Balancer -->
            <text x="220" y="300" font-size="14" font-weight="bold" fill="#64748b">EDGE LAYER</text>
            <rect x="400" y="320" width="400" height="60" rx="8" fill="#818cf8" stroke="#6366f1" stroke-width="2"/>
            <text x="600" y="355" font-size="13" font-weight="bold" text-anchor="middle" fill="white">üåê Global Load Balancer (Geographic Routing)</text>

            <path d="M 510 220 L 600 320" stroke="#6366f1" stroke-width="3" marker-end="url(#arrowhead)"/>

            <!-- Signaling Servers -->
            <text x="220" y="460" font-size="14" font-weight="bold" fill="#64748b">SIGNALING</text>
            <rect x="300" y="480" width="180" height="70" rx="8" fill="#f87171" stroke="#dc2626" stroke-width="2"/>
            <text x="390" y="520" font-size="12" font-weight="bold" text-anchor="middle" fill="white">üì° Signaling Server</text>

            <rect x="520" y="480" width="180" height="70" rx="8" fill="#f87171" stroke="#dc2626" stroke-width="2"/>
            <text x="610" y="520" font-size="12" font-weight="bold" text-anchor="middle" fill="white">üì° Signaling Server</text>

            <path d="M 600 380 L 390 480" stroke="#6366f1" stroke-width="2" marker-end="url(#arrowhead)"/>
            <path d="M 600 380 L 610 480" stroke="#6366f1" stroke-width="2" marker-end="url(#arrowhead)"/>

            <!-- Media Servers (SFU) -->
            <text x="220" y="630" font-size="14" font-weight="bold" fill="#64748b">MEDIA SERVERS</text>
            <rect x="250" y="650" width="160" height="80" rx="8" fill="#84cc16" stroke="#4d7c0f" stroke-width="2"/>
            <text x="330" y="695" font-size="12" font-weight="bold" text-anchor="middle" fill="white">üé¨ SFU US-East</text>

            <rect x="440" y="650" width="160" height="80" rx="8" fill="#84cc16" stroke="#4d7c0f" stroke-width="2"/>
            <text x="520" y="695" font-size="12" font-weight="bold" text-anchor="middle" fill="white">üé¨ SFU EU</text>

            <rect x="630" y="650" width="160" height="80" rx="8" fill="#84cc16" stroke="#4d7c0f" stroke-width="2"/>
            <text x="710" y="695" font-size="12" font-weight="bold" text-anchor="middle" fill="white">üé¨ SFU APAC</text>

            <!-- TURN/STUN -->
            <rect x="250" y="760" width="160" height="60" rx="8" fill="#fcd34d" stroke="#f59e0b" stroke-width="2"/>
            <text x="330" y="795" font-size="12" font-weight="bold" text-anchor="middle" fill="#78350f">üåê STUN/TURN</text>

            <!-- Recording -->
            <text x="950" y="630" font-size="14" font-weight="bold" fill="#64748b">SERVICES</text>
            <rect x="950" y="650" width="180" height="70" rx="8" fill="#fb923c" stroke="#ea580c" stroke-width="2"/>
            <text x="1040" y="690" font-size="12" font-weight="bold" text-anchor="middle" fill="white">üéôÔ∏è Recording Service</text>

            <!-- Data Layer -->
            <text x="220" y="900" font-size="14" font-weight="bold" fill="#64748b">DATA LAYER</text>
            <rect x="250" y="920" width="160" height="70" rx="8" fill="#c084fc" stroke="#9333ea" stroke-width="2"/>
            <text x="330" y="960" font-size="12" font-weight="bold" text-anchor="middle" fill="white">üóÑÔ∏è PostgreSQL</text>

            <rect x="440" y="920" width="160" height="70" rx="8" fill="#ef4444" stroke="#dc2626" stroke-width="2"/>
            <text x="520" y="960" font-size="12" font-weight="bold" text-anchor="middle" fill="white">üíæ Redis Cache</text>

            <rect x="630" y="920" width="160" height="70" rx="8" fill="#38bdf8" stroke="#0284c7" stroke-width="2"/>
            <text x="710" y="960" font-size="12" font-weight="bold" text-anchor="middle" fill="white">‚òÅÔ∏è S3 (Recordings)</text>

            <!-- Monitoring -->
            <rect x="950" y="920" width="180" height="70" rx="8" fill="#2dd4bf" stroke="#14b8a6" stroke-width="2"/>
            <text x="1040" y="960" font-size="12" font-weight="bold" text-anchor="middle" fill="white">üìà Monitoring</text>

            <!-- Arrows showing data flow -->
            <path d="M 390 550 L 330 650" stroke="#6366f1" stroke-width="2" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>
            <path d="M 610 550 L 520 650" stroke="#6366f1" stroke-width="2" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>
            <path d="M 520 730 L 520 920" stroke="#6366f1" stroke-width="2" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>
        </svg>

        <div class="flow-description">
            <h3>üèóÔ∏è Full System Architecture</h3>
            <p style="margin-bottom: 15px; line-height: 1.8;">
                This shows all major components working together in a production video calling system like Zoom or Google Meet.
            </p>
            <strong>Component Responsibilities:</strong>
            <ul style="margin-left: 20px; line-height: 1.8;">
                <li><strong>Load Balancer:</strong> Routes to nearest region (latency optimization)</li>
                <li><strong>Signaling Servers:</strong> WebRTC offer/answer, ICE candidates</li>
                <li><strong>SFU Cluster:</strong> Regional deployment (US, EU, APAC) for low latency</li>
                <li><strong>TURN/STUN:</strong> NAT traversal, fallback relay</li>
                <li><strong>Recording Service:</strong> Cloud recording, transcription</li>
                <li><strong>PostgreSQL:</strong> Users, meetings, metadata</li>
                <li><strong>Redis:</strong> Active meetings, presence, rate limiting</li>
                <li><strong>S3:</strong> Recording storage + CDN delivery</li>
            </ul>
        </div>
    </div>
</div>

<script>
    function showDiagram(type) {
        document.querySelectorAll('.diagram-container').forEach(d => {
            d.classList.remove('active');
        });
        document.querySelectorAll('.tab').forEach(t => {
            t.classList.remove('active');
        });
        document.getElementById(type + '-diagram').classList.add('active');
        event.target.classList.add('active');
    }

    document.querySelectorAll('.component').forEach(comp => {
        comp.addEventListener('mouseenter', function() {
            this.style.filter = 'drop-shadow(0 0 15px rgba(99, 102, 241, 0.6))';
        });
        comp.addEventListener('mouseleave', function() {
            this.style.filter = 'none';
        });
    });
</script>
</body>
</html>
