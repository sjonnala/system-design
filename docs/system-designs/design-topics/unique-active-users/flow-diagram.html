<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unique Active Users Flow Diagrams</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            font-size: 2.5em;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: #e2e8f0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: #6366f1;
            color: white;
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .diagram-container {
            display: none;
            margin-top: 30px;
        }

        .diagram-container.active {
            display: block;
        }

        svg {
            width: 100%;
            height: auto;
        }

        .component {
            cursor: pointer;
            transition: all 0.3s;
        }

        .component:hover {
            filter: drop-shadow(0 0 10px rgba(99, 102, 241, 0.5));
        }

        .flow-arrow {
            animation: dash 20s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -1000;
            }
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            border: 2px solid #cbd5e0;
        }

        .metrics-panel {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde047 100%);
            border-radius: 15px;
            border: 2px solid #fbbf24;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #6366f1;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #6366f1;
        }

        .metric-label {
            font-size: 0.9em;
            color: #4a5568;
            margin-top: 5px;
        }

        .flow-description {
            background: #e0e7ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 5px solid #6366f1;
        }

        .flow-description h3 {
            color: #4338ca;
            margin-bottom: 10px;
        }

        .flow-description ol {
            margin-left: 20px;
            line-height: 2;
            color: #1e293b;
        }

        .flow-description ol li {
            margin: 8px 0;
        }

        .flow-description strong {
            color: #6366f1;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üìä Unique Active Users Flow Diagrams</h1>
        <p style="color: #64748b; margin-top: 10px;">Interactive Data Flow Visualization</p>

        <div class="tabs">
            <button class="tab active" onclick="showDiagram('ingestion')">üì• Event Ingestion Flow</button>
            <button class="tab" onclick="showDiagram('stream')">üåä Stream Processing Flow</button>
            <button class="tab" onclick="showDiagram('query')">üîç Query Flow</button>
            <button class="tab" onclick="showDiagram('full')">üèóÔ∏è Complete Data Pipeline</button>
        </div>
    </div>

    <!-- Event Ingestion Flow -->
    <div id="ingestion-diagram" class="diagram-container active">
        <svg viewBox="0 0 1400 1100" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#6366f1" />
                </marker>
                <linearGradient id="grad-client" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-gateway" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#22d3ee;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#06b6d4;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-ingestion" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#84cc16;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#65a30d;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-kafka" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#f87171;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#ef4444;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-redis" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#f472b6;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
                </linearGradient>
            </defs>

            <!-- Title -->
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Event Ingestion Flow
            </text>

            <!-- Client -->
            <g class="component">
                <rect x="600" y="60" width="200" height="80" rx="10" fill="url(#grad-client)" stroke="#2563eb" stroke-width="2"/>
                <text x="700" y="95" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üì± Mobile App</text>
                <text x="700" y="115" font-size="12" text-anchor="middle" fill="white">iOS / Android</text>
            </g>

            <!-- Arrow 1 -->
            <path d="M 700 140 L 700 180" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="165" font-size="11" fill="#4338ca" font-weight="600">analytics.track()</text>

            <!-- Event Example -->
            <g class="component">
                <rect x="900" y="60" width="400" height="140" rx="10" fill="#f8fafc" stroke="#cbd5e0" stroke-width="2"/>
                <text x="1100" y="85" font-size="13" font-weight="bold" text-anchor="middle" fill="#1e293b">Event JSON</text>
                <text x="920" y="110" font-size="11" font-family="monospace" fill="#475569">{</text>
                <text x="940" y="130" font-size="11" font-family="monospace" fill="#475569">"event_id": "evt_abc123",</text>
                <text x="940" y="145" font-size="11" font-family="monospace" fill="#475569">"user_id": "user_456",</text>
                <text x="940" y="160" font-size="11" font-family="monospace" fill="#475569">"event_type": "page_view",</text>
                <text x="940" y="175" font-size="11" font-family="monospace" fill="#475569">"timestamp": 1731628800000</text>
                <text x="920" y="190" font-size="11" font-family="monospace" fill="#475569">}</text>
            </g>

            <!-- API Gateway -->
            <g class="component">
                <rect x="600" y="180" width="200" height="80" rx="10" fill="url(#grad-gateway)" stroke="#0891b2" stroke-width="2"/>
                <text x="700" y="215" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üö™ API Gateway</text>
                <text x="700" y="235" font-size="12" text-anchor="middle" fill="white">Rate Limit Check</text>
            </g>

            <!-- Arrow 2 -->
            <path d="M 700 260 L 700 300" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="285" font-size="11" fill="#4338ca" font-weight="600">POST /events</text>

            <!-- Ingestion Service -->
            <g class="component">
                <rect x="550" y="300" width="300" height="120" rx="10" fill="url(#grad-ingestion)" stroke="#4d7c0f" stroke-width="2"/>
                <text x="700" y="335" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üì• Ingestion Service</text>
                <text x="700" y="355" font-size="11" text-anchor="middle" fill="white">1. Schema Validation (Protobuf)</text>
                <text x="700" y="375" font-size="11" text-anchor="middle" fill="white">2. Enrichment (GeoIP, User-Agent)</text>
                <text x="700" y="395" font-size="11" text-anchor="middle" fill="white">3. Deduplication Check</text>
            </g>

            <!-- Deduplication Check (Redis) -->
            <path d="M 850 360 L 1020 360" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>
            <text x="900" y="350" font-size="11" fill="#4338ca" font-weight="600">Check Duplicate</text>

            <!-- Redis (Dedup) -->
            <g class="component">
                <rect x="1020" y="300" width="200" height="120" rx="10" fill="url(#grad-redis)" stroke="#db2777" stroke-width="2"/>
                <text x="1120" y="335" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üíæ Redis</text>
                <text x="1120" y="355" font-size="11" text-anchor="middle" fill="white">Deduplication</text>
                <text x="1120" y="375" font-size="10" text-anchor="middle" fill="white">SET evt:abc123 1</text>
                <text x="1120" y="395" font-size="10" text-anchor="middle" fill="white">EX 3600 (1 hour TTL)</text>
            </g>

            <!-- Return arrow from Redis -->
            <path d="M 1020 380 L 850 380" stroke="#10b981" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
            <text x="900" y="400" font-size="11" fill="#059669" font-weight="600">‚úì Unique</text>

            <!-- Decision Diamond: Valid? -->
            <g class="component">
                <path d="M 700 460 L 800 520 L 700 580 L 600 520 Z" fill="#fef3c7" stroke="#f59e0b" stroke-width="3"/>
                <text x="700" y="515" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Valid &</text>
                <text x="700" y="533" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Unique?</text>
            </g>

            <!-- Invalid Path (Left) -->
            <path d="M 600 520 L 400 520" stroke="#ef4444" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>
            <text x="480" y="510" font-size="12" fill="#dc2626" font-weight="700">NO ‚úó</text>

            <g class="component">
                <rect x="200" y="470" width="200" height="100" rx="10" fill="#fee2e2" stroke="#dc2626" stroke-width="3"/>
                <text x="300" y="505" font-size="14" font-weight="bold" text-anchor="middle" fill="#991b1b">‚ùå Dead Letter Queue</text>
                <text x="300" y="525" font-size="11" text-anchor="middle" fill="#991b1b">Invalid events</text>
                <text x="300" y="545" font-size="11" text-anchor="middle" fill="#991b1b">For debugging</text>
            </g>

            <!-- Valid Path (Down) -->
            <path d="M 700 580 L 700 640" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>
            <text x="630" y="615" font-size="12" fill="#059669" font-weight="700">YES ‚úì</text>

            <!-- Batching -->
            <g class="component">
                <rect x="600" y="640" width="200" height="80" rx="10" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                <text x="700" y="675" font-size="14" font-weight="bold" text-anchor="middle" fill="#1e40af">üì¶ Batching</text>
                <text x="700" y="695" font-size="11" text-anchor="middle" fill="#1e40af">1000 events or 5 sec</text>
            </g>

            <!-- Arrow to Kafka -->
            <path d="M 700 720 L 700 780" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="755" font-size="11" fill="#4338ca" font-weight="600">Batch Write</text>

            <!-- Kafka -->
            <g class="component">
                <rect x="550" y="780" width="300" height="120" rx="10" fill="url(#grad-kafka)" stroke="#b91c1c" stroke-width="2"/>
                <text x="700" y="815" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üì¨ Apache Kafka</text>
                <text x="700" y="835" font-size="11" text-anchor="middle" fill="white">Topic: user-events</text>
                <text x="700" y="855" font-size="11" text-anchor="middle" fill="white">Partition: hash(user_id) % 100</text>
                <text x="700" y="875" font-size="11" text-anchor="middle" fill="white">Replication: 3x</text>
            </g>

            <!-- Fast Path to Redis -->
            <path d="M 850 840 L 950 840 L 950 600 L 1120 600" stroke="#9333ea" stroke-width="3" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>
            <text x="960" y="720" font-size="11" fill="#9333ea" font-weight="600">Fast Path</text>
            <text x="960" y="740" font-size="10" fill="#9333ea">(Last 24h)</text>

            <!-- Redis (Fast Path) -->
            <g class="component">
                <rect x="1020" y="560" width="200" height="120" rx="10" fill="url(#grad-redis)" stroke="#db2777" stroke-width="2"/>
                <text x="1120" y="595" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üíæ Redis HLL</text>
                <text x="1120" y="615" font-size="10" text-anchor="middle" fill="white">PFADD active:2025-11-15</text>
                <text x="1120" y="635" font-size="10" text-anchor="middle" fill="white">"user_456"</text>
                <text x="1120" y="655" font-size="10" text-anchor="middle" fill="white">Real-time DAU count</text>
            </g>

            <!-- Consumer Groups -->
            <path d="M 550 840 L 200 840" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
            <text x="350" y="830" font-size="11" fill="#4338ca" font-weight="600">Consumer Groups ‚Üí</text>

            <g class="component">
                <rect x="50" y="780" width="150" height="60" rx="10" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
                <text x="125" y="815" font-size="12" font-weight="bold" text-anchor="middle" fill="#4338ca">üåä Flink</text>
            </g>

            <g class="component">
                <rect x="50" y="860" width="150" height="60" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                <text x="125" y="895" font-size="12" font-weight="bold" text-anchor="middle" fill="#92400e">üì¶ Spark</text>
            </g>

            <g class="component">
                <rect x="50" y="940" width="150" height="60" rx="10" fill="#bae6fd" stroke="#0284c7" stroke-width="2"/>
                <text x="125" y="975" font-size="12" font-weight="bold" text-anchor="middle" fill="#075985">‚òÅÔ∏è S3 Sink</text>
            </g>

            <!-- Step Numbers -->
            <circle cx="700" cy="100" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="107" font-size="14" font-weight="bold" text-anchor="middle" fill="white">1</text>

            <circle cx="700" cy="220" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="227" font-size="14" font-weight="bold" text-anchor="middle" fill="white">2</text>

            <circle cx="700" cy="360" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="367" font-size="14" font-weight="bold" text-anchor="middle" fill="white">3</text>

            <circle cx="700" cy="680" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="687" font-size="14" font-weight="bold" text-anchor="middle" fill="white">4</text>

            <circle cx="700" cy="840" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="847" font-size="14" font-weight="bold" text-anchor="middle" fill="white">5</text>
        </svg>

        <div class="flow-description">
            <h3>üì• Event Ingestion Flow Steps</h3>
            <ol>
                <li><strong>Client Tracking:</strong> Mobile/web app calls <code>analytics.track()</code> SDK method with event data</li>
                <li><strong>API Gateway:</strong> Validates API key, applies rate limiting (1000 req/sec per client)</li>
                <li><strong>Ingestion Service:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li><strong>Schema Validation:</strong> Verify event matches Protobuf schema</li>
                        <li><strong>Enrichment:</strong> Add geo-location (GeoIP), parse user-agent (device, OS, browser)</li>
                        <li><strong>Deduplication:</strong> Check Redis for event_id (prevent duplicate processing)</li>
                    </ul>
                </li>
                <li><strong>Batching:</strong> Accumulate events (1000 events or 5 seconds, whichever comes first) for efficient Kafka writes</li>
                <li><strong>Kafka Write:</strong> Batch written to <code>user-events</code> topic, partitioned by <code>hash(user_id)</code></li>
                <li><strong>Fast Path (Parallel):</strong> For real-time dashboards, also update Redis HyperLogLog for immediate DAU counts</li>
                <li><strong>Consumer Groups:</strong> Multiple consumers read from Kafka:
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li><strong>Flink:</strong> Real-time stream processing</li>
                        <li><strong>Spark:</strong> Batch aggregations (hourly/daily)</li>
                        <li><strong>S3 Sink:</strong> Archive raw events to data lake</li>
                    </ul>
                </li>
            </ol>
            <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 5px;">
                <strong>üéØ Key Optimization:</strong> Batching reduces network overhead by 100√ó, enabling 150K events/sec throughput!
            </div>
        </div>
    </div>

    <!-- Stream Processing Flow -->
    <div id="stream-diagram" class="diagram-container">
        <svg viewBox="0 0 1400 1200" xmlns="http://www.w3.org/2000/svg">
            <!-- Title -->
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Stream Processing Flow (Apache Flink)
            </text>

            <!-- Kafka Source -->
            <g class="component">
                <rect x="600" y="60" width="200" height="80" rx="10" fill="url(#grad-kafka)" stroke="#b91c1c" stroke-width="2"/>
                <text x="700" y="95" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üì¨ Kafka Source</text>
                <text x="700" y="115" font-size="12" text-anchor="middle" fill="white">user-events topic</text>
            </g>

            <path d="M 700 140 L 700 180" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="165" font-size="11" fill="#4338ca" font-weight="600">Stream Events</text>

            <!-- Deserialization -->
            <g class="component">
                <rect x="600" y="180" width="200" height="80" rx="10" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                <text x="700" y="215" font-size="14" font-weight="bold" text-anchor="middle" fill="#1e40af">üîÑ Deserialize</text>
                <text x="700" y="235" font-size="11" text-anchor="middle" fill="#1e40af">Protobuf ‚Üí Objects</text>
            </g>

            <path d="M 700 260 L 700 300" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>

            <!-- Deduplication (Event Window) -->
            <g class="component">
                <rect x="550" y="300" width="300" height="100" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                <text x="700" y="335" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">üîç Deduplication</text>
                <text x="700" y="355" font-size="11" text-anchor="middle" fill="#92400e">KeyBy(event_id)</text>
                <text x="700" y="375" font-size="11" text-anchor="middle" fill="#92400e">Window: 1 hour (tumbling)</text>
            </g>

            <path d="M 700 400 L 700 440" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>

            <!-- KeyBy User Dimensions -->
            <g class="component">
                <rect x="550" y="440" width="300" height="120" rx="10" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
                <text x="700" y="475" font-size="14" font-weight="bold" text-anchor="middle" fill="#4338ca">üîë KeyBy Dimensions</text>
                <text x="700" y="495" font-size="11" text-anchor="middle" fill="#4338ca">Tuple(date, country, platform)</text>
                <text x="700" y="515" font-size="11" text-anchor="middle" fill="#4338ca">Partitions events by key</text>
                <text x="700" y="535" font-size="10" text-anchor="middle" fill="#4338ca">Example: (2025-11-15, US, ios)</text>
            </g>

            <path d="M 700 560 L 700 600" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>

            <!-- Windowing -->
            <g class="component">
                <rect x="550" y="600" width="300" height="120" rx="10" fill="#fce7f3" stroke="#db2777" stroke-width="2"/>
                <text x="700" y="635" font-size="14" font-weight="bold" text-anchor="middle" fill="#831843">‚è±Ô∏è Windowing</text>
                <text x="700" y="655" font-size="11" text-anchor="middle" fill="#831843">TumblingEventTime(5 minutes)</text>
                <text x="700" y="675" font-size="10" text-anchor="middle" fill="#831843">00:00-00:05, 00:05-00:10, ...</text>
                <text x="700" y="695" font-size="10" text-anchor="middle" fill="#831843">Watermark: 1 min late arrivals</text>
            </g>

            <path d="M 700 720 L 700 760" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>

            <!-- HyperLogLog Aggregation -->
            <g class="component">
                <rect x="500" y="760" width="400" height="160" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="3"/>
                <text x="700" y="795" font-size="16" font-weight="bold" text-anchor="middle" fill="#065f46">üìä HyperLogLog Aggregation</text>
                <text x="700" y="820" font-size="12" text-anchor="middle" fill="#065f46">aggregate(new HyperLogLogAggregator())</text>

                <text x="520" y="850" font-size="11" font-family="monospace" fill="#065f46">createAccumulator() ‚Üí new HLL(14)</text>
                <text x="520" y="870" font-size="11" font-family="monospace" fill="#065f46">add(event, hll) ‚Üí hll.offer(user_id)</text>
                <text x="520" y="890" font-size="11" font-family="monospace" fill="#065f46">merge(hll1, hll2) ‚Üí hll1.addAll(hll2)</text>
                <text x="520" y="910" font-size="11" font-family="monospace" fill="#065f46">getResult(hll) ‚Üí hll.cardinality()</text>
            </g>

            <path d="M 700 920 L 700 960" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>

            <!-- Output (Dual Sink) -->
            <g class="component">
                <rect x="550" y="960" width="300" height="80" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                <text x="700" y="995" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">üì§ Dual Output</text>
                <text x="700" y="1015" font-size="11" text-anchor="middle" fill="#92400e">Sink to ClickHouse + Redis</text>
            </g>

            <!-- ClickHouse Sink -->
            <path d="M 600 1040 L 300 1040 L 300 1100" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
            <text x="420" y="1030" font-size="11" fill="#4338ca" font-weight="600">Historical</text>

            <g class="component">
                <rect x="200" y="1100" width="200" height="80" rx="10" fill="#fed7aa" stroke="#ea580c" stroke-width="2"/>
                <text x="300" y="1135" font-size="14" font-weight="bold" text-anchor="middle" fill="#9a3412">üóÑÔ∏è ClickHouse</text>
                <text x="300" y="1155" font-size="11" text-anchor="middle" fill="#9a3412">DAU aggregates table</text>
            </g>

            <!-- Redis Sink -->
            <path d="M 800 1040 L 1100 1040 L 1100 1100" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
            <text x="920" y="1030" font-size="11" fill="#4338ca" font-weight="600">Real-time</text>

            <g class="component">
                <rect x="1000" y="1100" width="200" height="80" rx="10" fill="url(#grad-redis)" stroke="#db2777" stroke-width="2"/>
                <text x="1100" y="1135" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üíæ Redis</text>
                <text x="1100" y="1155" font-size="11" text-anchor="middle" fill="white">Recent DAU counts</text>
            </g>

            <!-- Checkpointing -->
            <g class="component">
                <rect x="950" y="300" width="250" height="120" rx="10" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
                <text x="1075" y="335" font-size="13" font-weight="bold" text-anchor="middle" fill="#991b1b">üìç Checkpointing</text>
                <text x="1075" y="355" font-size="10" text-anchor="middle" fill="#991b1b">Every 60 seconds</text>
                <text x="1075" y="375" font-size="10" text-anchor="middle" fill="#991b1b">State: S3 / HDFS</text>
                <text x="1075" y="395" font-size="10" text-anchor="middle" fill="#991b1b">For fault tolerance</text>
            </g>

            <path d="M 850 500 L 950 360" stroke="#dc2626" stroke-width="2" fill="none" stroke-dasharray="3,3"/>

            <!-- Step Numbers -->
            <circle cx="700" cy="100" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="107" font-size="14" font-weight="bold" text-anchor="middle" fill="white">1</text>

            <circle cx="700" cy="220" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="227" font-size="14" font-weight="bold" text-anchor="middle" fill="white">2</text>

            <circle cx="700" cy="350" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="357" font-size="14" font-weight="bold" text-anchor="middle" fill="white">3</text>

            <circle cx="700" cy="500" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="507" font-size="14" font-weight="bold" text-anchor="middle" fill="white">4</text>

            <circle cx="700" cy="660" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="667" font-size="14" font-weight="bold" text-anchor="middle" fill="white">5</text>

            <circle cx="700" cy="840" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="847" font-size="14" font-weight="bold" text-anchor="middle" fill="white">6</text>

            <circle cx="700" cy="1000" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="1007" font-size="14" font-weight="bold" text-anchor="middle" fill="white">7</text>
        </svg>

        <div class="flow-description">
            <h3>üåä Stream Processing Flow (Flink)</h3>
            <ol>
                <li><strong>Kafka Source:</strong> Flink consumes from <code>user-events</code> topic (100 partitions)</li>
                <li><strong>Deserialization:</strong> Convert Protobuf bytes to UserEvent objects</li>
                <li><strong>Deduplication:</strong> Group by event_id in 1-hour window, keep first occurrence</li>
                <li><strong>KeyBy Dimensions:</strong> Partition by (date, country, platform) for parallel processing</li>
                <li><strong>Windowing:</strong> 5-minute tumbling windows based on event time (not processing time)
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Watermark: Allow events up to 1 minute late</li>
                        <li>After watermark passes, trigger window computation</li>
                    </ul>
                </li>
                <li><strong>HyperLogLog Aggregation:</strong> Count unique users per window using HLL
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Precision: 14 (standard error 0.81%)</li>
                        <li>Memory: ~12 KB per window per key</li>
                        <li>Mergeable across windows for WAU/MAU</li>
                    </ul>
                </li>
                <li><strong>Dual Sink:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li><strong>ClickHouse:</strong> Batch insert for historical analytics (10K rows/batch)</li>
                        <li><strong>Redis:</strong> Update real-time counts (HSET for dashboard)</li>
                    </ul>
                </li>
                <li><strong>Checkpointing:</strong> Every 60 seconds, save state to S3 for fault tolerance</li>
            </ol>
            <div style="margin-top: 15px; padding: 15px; background: #d1fae5; border-left: 4px solid #10b981; border-radius: 5px;">
                <strong>‚ö° Performance:</strong> Flink processes 150K events/sec with <1 minute end-to-end latency!
            </div>
        </div>
    </div>

    <!-- Query Flow -->
    <div id="query-diagram" class="diagram-container">
        <svg viewBox="0 0 1400 1100" xmlns="http://www.w3.org/2000/svg">
            <!-- Title -->
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Query Flow (Dashboard Analytics)
            </text>

            <!-- Dashboard Client -->
            <g class="component">
                <rect x="600" y="60" width="200" height="80" rx="10" fill="url(#grad-client)" stroke="#2563eb" stroke-width="2"/>
                <text x="700" y="95" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üìà Dashboard</text>
                <text x="700" y="115" font-size="12" text-anchor="middle" fill="white">Grafana / React</text>
            </g>

            <path d="M 700 140 L 700 180" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="165" font-size="11" fill="#4338ca" font-weight="600">GraphQL Query</text>

            <!-- Query Example -->
            <g class="component">
                <rect x="900" y="60" width="420" height="200" rx="10" fill="#f8fafc" stroke="#cbd5e0" stroke-width="2"/>
                <text x="1110" y="85" font-size="13" font-weight="bold" text-anchor="middle" fill="#1e293b">GraphQL Query</text>
                <text x="920" y="110" font-size="10" font-family="monospace" fill="#475569">query {</text>
                <text x="940" y="130" font-size="10" font-family="monospace" fill="#475569">  analytics(</text>
                <text x="960" y="145" font-size="10" font-family="monospace" fill="#475569">    metrics: [DAU, WAU, MAU]</text>
                <text x="960" y="160" font-size="10" font-family="monospace" fill="#475569">    dimensions: [country, platform]</text>
                <text x="960" y="175" font-size="10" font-family="monospace" fill="#475569">    filters: {</text>
                <text x="980" y="190" font-size="10" font-family="monospace" fill="#475569">      dateRange: "2025-11-01" to "2025-11-15"</text>
                <text x="980" y="205" font-size="10" font-family="monospace" fill="#475569">      country: ["US", "IN"]</text>
                <text x="960" y="220" font-size="10" font-family="monospace" fill="#475569">    }</text>
                <text x="940" y="235" font-size="10" font-family="monospace" fill="#475569">  )</text>
                <text x="920" y="250" font-size="10" font-family="monospace" fill="#475569">}</text>
            </g>

            <!-- Query Service (GraphQL API) -->
            <g class="component">
                <rect x="600" y="180" width="200" height="80" rx="10" fill="url(#grad-gateway)" stroke="#0891b2" stroke-width="2"/>
                <text x="700" y="215" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üîç Query Service</text>
                <text x="700" y="235" font-size="12" text-anchor="middle" fill="white">GraphQL API</text>
            </g>

            <path d="M 700 260 L 700 300" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>

            <!-- Cache Check (Redis) -->
            <g class="component">
                <rect x="550" y="300" width="300" height="100" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                <text x="700" y="335" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">üíæ Check Cache (Redis)</text>
                <text x="700" y="355" font-size="11" text-anchor="middle" fill="#92400e">Key: query_hash</text>
                <text x="700" y="375" font-size="11" text-anchor="middle" fill="#92400e">TTL: 5 minutes</text>
            </g>

            <!-- Decision: Cache Hit? -->
            <g class="component">
                <path d="M 700 440 L 800 500 L 700 560 L 600 500 Z" fill="#fef3c7" stroke="#f59e0b" stroke-width="3"/>
                <text x="700" y="495" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Cache</text>
                <text x="700" y="513" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Hit?</text>
            </g>

            <!-- Cache Hit Path (Right) -->
            <path d="M 800 500 L 950 500" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>
            <text x="850" y="490" font-size="12" fill="#059669" font-weight="700">YES ‚úì (70%)</text>

            <g class="component">
                <rect x="950" y="450" width="180" height="100" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="3"/>
                <text x="1040" y="490" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">‚úÖ Cache Hit</text>
                <text x="1040" y="510" font-size="11" text-anchor="middle" fill="#065f46">Return cached result</text>
                <text x="1040" y="530" font-size="11" text-anchor="middle" fill="#065f46">Latency: ~10ms</text>
            </g>

            <path d="M 1040 450 L 1040 100 L 800 100" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="8,4"/>
            <text x="1060" y="280" font-size="12" fill="#059669" font-weight="700">Fast Return</text>

            <!-- Cache Miss Path (Down) -->
            <path d="M 700 560 L 700 620" stroke="#ef4444" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>
            <text x="630" y="595" font-size="12" fill="#dc2626" font-weight="700">NO ‚úó (30%)</text>

            <!-- Build ClickHouse Query -->
            <g class="component">
                <rect x="550" y="620" width="300" height="100" rx="10" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
                <text x="700" y="655" font-size="14" font-weight="bold" text-anchor="middle" fill="#4338ca">üî® Build SQL Query</text>
                <text x="700" y="675" font-size="10" text-anchor="middle" fill="#4338ca">SELECT uniqMerge(unique_users)</text>
                <text x="700" y="695" font-size="10" text-anchor="middle" fill="#4338ca">FROM dau WHERE ...</text>
            </g>

            <path d="M 700 720 L 700 780" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>

            <!-- ClickHouse Query -->
            <g class="component">
                <rect x="550" y="780" width="300" height="120" rx="10" fill="#fed7aa" stroke="#ea580c" stroke-width="2"/>
                <text x="700" y="815" font-size="16" font-weight="bold" text-anchor="middle" fill="#9a3412">üóÑÔ∏è ClickHouse Query</text>
                <text x="700" y="835" font-size="11" text-anchor="middle" fill="#9a3412">Distributed query across 10 nodes</text>
                <text x="700" y="855" font-size="11" text-anchor="middle" fill="#9a3412">Pre-aggregated DAU table</text>
                <text x="700" y="875" font-size="11" text-anchor="middle" fill="#9a3412">Latency: 0.5-2s (P95)</text>
            </g>

            <path d="M 700 900 L 700 940" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>

            <!-- Store in Cache -->
            <g class="component">
                <rect x="600" y="940" width="200" height="80" rx="10" fill="url(#grad-redis)" stroke="#db2777" stroke-width="2"/>
                <text x="700" y="975" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üíæ Cache Result</text>
                <text x="700" y="995" font-size="11" text-anchor="middle" fill="white">SET with 5 min TTL</text>
            </g>

            <!-- Return to Client -->
            <path d="M 600 980 L 400 980 L 400 220 L 600 220" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="8,4"/>
            <text x="320" y="600" font-size="12" fill="#059669" font-weight="700">‚Üê Response</text>
            <text x="320" y="620" font-size="11" fill="#059669">200 OK</text>
            <text x="320" y="635" font-size="11" fill="#059669">{dau: 100M, ...}</text>

            <!-- Optimization Note -->
            <g class="component">
                <rect x="100" y="300" width="350" height="160" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                <text x="275" y="330" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">üéØ Query Optimizations</text>
                <text x="120" y="360" font-size="11" fill="#92400e"><strong>1. Materialized Views:</strong></text>
                <text x="140" y="380" font-size="10" fill="#92400e">Pre-aggregated DAU by dimensions</text>
                <text x="120" y="405" font-size="11" fill="#92400e"><strong>2. Partition Pruning:</strong></text>
                <text x="140" y="425" font-size="10" fill="#92400e">Only scan date range partitions</text>
                <text x="120" y="450" font-size="11" fill="#92400e"><strong>3. Column Store:</strong></text>
                <text x="140" y="470" font-size="10" fill="#92400e">Read only needed columns (country, dau)</text>
            </g>

            <!-- Step Numbers -->
            <circle cx="700" cy="100" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="107" font-size="14" font-weight="bold" text-anchor="middle" fill="white">1</text>

            <circle cx="700" cy="220" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="227" font-size="14" font-weight="bold" text-anchor="middle" fill="white">2</text>

            <circle cx="700" cy="350" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="357" font-size="14" font-weight="bold" text-anchor="middle" fill="white">3</text>

            <circle cx="700" cy="670" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="677" font-size="14" font-weight="bold" text-anchor="middle" fill="white">4</text>

            <circle cx="700" cy="840" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="847" font-size="14" font-weight="bold" text-anchor="middle" fill="white">5</text>

            <circle cx="700" cy="980" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="987" font-size="14" font-weight="bold" text-anchor="middle" fill="white">6</text>
        </svg>

        <div class="flow-description">
            <h3>üîç Query Flow (Dashboard Analytics)</h3>
            <ol>
                <li><strong>Dashboard Request:</strong> User loads Grafana dashboard or custom React dashboard</li>
                <li><strong>GraphQL Query:</strong> Client sends query specifying metrics (DAU, WAU, MAU), dimensions, filters</li>
                <li><strong>Cache Check:</strong> Query Service checks Redis for cached result
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Key: MD5 hash of query + parameters</li>
                        <li>TTL: 5 minutes (balance freshness vs performance)</li>
                    </ul>
                </li>
                <li><strong>Cache Hit (70%):</strong> Return cached result immediately (~10ms latency)</li>
                <li><strong>Cache Miss (30%):</strong> Build SQL query for ClickHouse
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Use pre-aggregated <code>dau</code> table (not raw events)</li>
                        <li>Apply filters (date range, country, platform)</li>
                        <li>Merge HyperLogLog states with <code>uniqMerge()</code></li>
                    </ul>
                </li>
                <li><strong>ClickHouse Execution:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Distributed query across 10 nodes (parallel processing)</li>
                        <li>Partition pruning: Only scan relevant date partitions</li>
                        <li>Columnar access: Read only needed columns</li>
                        <li>Latency: 0.5-2s (P95)</li>
                    </ul>
                </li>
                <li><strong>Cache Result:</strong> Store in Redis with 5 min TTL for future queries</li>
                <li><strong>Return Response:</strong> JSON with DAU/WAU/MAU counts by dimensions</li>
            </ol>
            <div style="margin-top: 15px; padding: 15px; background: #d1fae5; border-left: 4px solid #10b981; border-radius: 5px;">
                <strong>üéØ Key Insight:</strong> 70% cache hit rate means most dashboard loads are <10ms, even with 100M DAU!
            </div>
        </div>
    </div>

    <!-- Full System Diagram -->
    <div id="full-diagram" class="diagram-container">
        <svg viewBox="0 0 1600 1000" xmlns="http://www.w3.org/2000/svg">
            <!-- Title -->
            <text x="800" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Complete Data Pipeline - Lambda Architecture
            </text>

            <!-- Client Layer -->
            <rect x="50" y="60" width="1500" height="100" rx="10" fill="#bfdbfe" stroke="#3b82f6" stroke-width="2" opacity="0.3"/>
            <text x="70" y="90" font-size="14" font-weight="bold" fill="#1e40af">CLIENT LAYER</text>

            <rect x="200" y="80" width="120" height="60" rx="8" fill="url(#grad-client)" stroke="#2563eb" stroke-width="2"/>
            <text x="260" y="115" font-size="12" font-weight="bold" text-anchor="middle" fill="white">Web App</text>

            <rect x="360" y="80" width="120" height="60" rx="8" fill="url(#grad-client)" stroke="#2563eb" stroke-width="2"/>
            <text x="420" y="115" font-size="12" font-weight="bold" text-anchor="middle" fill="white">Mobile App</text>

            <rect x="520" y="80" width="120" height="60" rx="8" fill="url(#grad-client)" stroke="#2563eb" stroke-width="2"/>
            <text x="580" y="115" font-size="12" font-weight="bold" text-anchor="middle" fill="white">Backend</text>

            <!-- Ingestion Layer -->
            <rect x="50" y="180" width="600" height="120" rx="10" fill="#d9f99d" stroke="#65a30d" stroke-width="2" opacity="0.3"/>
            <text x="70" y="210" font-size="14" font-weight="bold" fill="#4d7c0f">INGESTION</text>

            <rect x="100" y="220" width="200" height="60" rx="8" fill="url(#grad-gateway)" stroke="#0891b2" stroke-width="2"/>
            <text x="200" y="255" font-size="12" font-weight="bold" text-anchor="middle" fill="white">API Gateway</text>

            <rect x="350" y="220" width="250" height="60" rx="8" fill="url(#grad-ingestion)" stroke="#4d7c0f" stroke-width="2"/>
            <text x="475" y="255" font-size="12" font-weight="bold" text-anchor="middle" fill="white">Ingestion Service</text>

            <path d="M 420 140 L 420 220" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Kafka -->
            <rect x="50" y="320" width="600" height="100" rx="10" fill="#fecaca" stroke="#b91c1c" stroke-width="2" opacity="0.3"/>
            <text x="70" y="350" font-size="14" font-weight="bold" fill="#991b1b">MESSAGE QUEUE</text>

            <rect x="150" y="350" width="400" height="50" rx="8" fill="url(#grad-kafka)" stroke="#b91c1c" stroke-width="2"/>
            <text x="350" y="380" font-size="12" font-weight="bold" text-anchor="middle" fill="white">Apache Kafka (100 partitions)</text>

            <path d="M 475 280 L 350 350" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Lambda Architecture Split -->
            <text x="800" y="250" font-size="16" font-weight="bold" fill="#6366f1">LAMBDA ARCHITECTURE</text>

            <!-- Speed Layer -->
            <rect x="700" y="270" width="400" height="240" rx="10" fill="#c7d2fe" stroke="#6366f1" stroke-width="3" opacity="0.3"/>
            <text x="720" y="300" font-size="14" font-weight="bold" fill="#4338ca">‚ö° SPEED LAYER (Real-time)</text>

            <rect x="750" y="320" width="140" height="50" rx="8" fill="#818cf8" stroke="#4f46e5" stroke-width="2"/>
            <text x="820" y="350" font-size="11" font-weight="bold" text-anchor="middle" fill="white">Apache Flink</text>

            <rect x="750" y="390" width="140" height="50" rx="8" fill="url(#grad-redis)" stroke="#db2777" stroke-width="2"/>
            <text x="820" y="420" font-size="11" font-weight="bold" text-anchor="middle" fill="white">Redis (HLL)</text>

            <text x="920" y="360" font-size="10" fill="#4338ca">5-min windows</text>
            <text x="920" y="375" font-size="10" fill="#4338ca">Last 24 hours</text>
            <text x="920" y="390" font-size="10" fill="#4338ca">Latency: <1 min</text>

            <path d="M 550 375 L 750 345" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 820 370 L 820 390" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Batch Layer -->
            <rect x="700" y="530" width="400" height="240" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="3" opacity="0.3"/>
            <text x="720" y="560" font-size="14" font-weight="bold" fill="#92400e">üì¶ BATCH LAYER (Historical)</text>

            <rect x="750" y="580" width="140" height="50" rx="8" fill="#facc15" stroke="#ca8a04" stroke-width="2"/>
            <text x="820" y="610" font-size="11" font-weight="bold" text-anchor="middle" fill="white">Apache Spark</text>

            <rect x="750" y="650" width="140" height="50" rx="8" fill="#bae6fd" stroke="#0284c7" stroke-width="2"/>
            <text x="820" y="680" font-size="11" font-weight="bold" text-anchor="middle" fill="white">S3 Data Lake</text>

            <text x="920" y="620" font-size="10" fill="#92400e">Hourly/Daily jobs</text>
            <text x="920" y="635" font-size="10" fill="#92400e">> 24 hours</text>
            <text x="920" y="650" font-size="10" fill="#92400e">Latency: 1 hour</text>

            <path d="M 550 375 L 650 600 L 750 605" stroke="#f59e0b" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 820 630 L 820 650" stroke="#f59e0b" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Serving Layer -->
            <rect x="1150" y="270" width="400" height="500" rx="10" fill="#fed7aa" stroke="#ea580c" stroke-width="3" opacity="0.3"/>
            <text x="1170" y="300" font-size="14" font-weight="bold" fill="#9a3412">üóÑÔ∏è SERVING LAYER</text>

            <rect x="1200" y="330" width="300" height="70" rx="8" fill="#fb923c" stroke="#ea580c" stroke-width="2"/>
            <text x="1350" y="355" font-size="12" font-weight="bold" text-anchor="middle" fill="white">ClickHouse</text>
            <text x="1350" y="375" font-size="10" text-anchor="middle" fill="white">Pre-aggregated DAU/WAU/MAU</text>

            <rect x="1200" y="420" width="300" height="60" rx="8" fill="#22d3ee" stroke="#0891b2" stroke-width="2"/>
            <text x="1350" y="455" font-size="12" font-weight="bold" text-anchor="middle" fill="white">Query Service (GraphQL)</text>

            <rect x="1200" y="500" width="140" height="50" rx="8" fill="#d1fae5" stroke="#10b981" stroke-width="2"/>
            <text x="1270" y="530" font-size="11" font-weight="bold" text-anchor="middle" fill="#065f46">Grafana</text>

            <rect x="1360" y="500" width="140" height="50" rx="8" fill="#fecdd3" stroke="#fb7185" stroke-width="2"/>
            <text x="1430" y="530" font-size="11" font-weight="bold" text-anchor="middle" fill="#991b1b">Tableau</text>

            <!-- Arrows to Serving Layer -->
            <path d="M 890 415 L 1200 365" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 890 675 L 1200 365" stroke="#f59e0b" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 1350 400 L 1350 420" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 1270 480 L 1270 500" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 1430 480 L 1430 500" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Data Flow Labels -->
            <text x="600" y="390" font-size="11" fill="#6366f1" font-weight="600">150K events/sec ‚Üí</text>
            <text x="1000" y="400" font-size="11" fill="#6366f1" font-weight="600">Real-time</text>
            <text x="1000" y="660" font-size="11" fill="#f59e0b" font-weight="600">Historical</text>
        </svg>

        <div class="flow-description">
            <h3>üèóÔ∏è Complete Data Pipeline (Lambda Architecture)</h3>
            <p style="margin-bottom: 15px; line-height: 1.8;">
                This diagram shows the complete data flow from client tracking to dashboard visualization,
                implementing the <strong>Lambda Architecture</strong> pattern for both real-time and batch processing.
            </p>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px;">
                <div style="background: #e0e7ff; padding: 15px; border-radius: 10px; border-left: 4px solid #6366f1;">
                    <h4 style="color: #4338ca; margin-bottom: 8px;">‚ö° Speed Layer (Real-time)</h4>
                    <ul style="font-size: 0.9em; color: #1e293b; line-height: 1.6; margin-left: 20px;">
                        <li><strong>Purpose:</strong> Provide real-time insights (<1 min latency)</li>
                        <li><strong>Data:</strong> Last 24 hours of events</li>
                        <li><strong>Technology:</strong> Apache Flink + Redis HyperLogLog</li>
                        <li><strong>Use Case:</strong> Live dashboards, real-time alerts</li>
                    </ul>
                </div>
                <div style="background: #fef3c7; padding: 15px; border-radius: 10px; border-left: 4px solid #f59e0b;">
                    <h4 style="color: #92400e; margin-bottom: 8px;">üì¶ Batch Layer (Historical)</h4>
                    <ul style="font-size: 0.9em; color: #1e293b; line-height: 1.6; margin-left: 20px;">
                        <li><strong>Purpose:</strong> Accurate historical analytics</li>
                        <li><strong>Data:</strong> All historical events (years)</li>
                        <li><strong>Technology:</strong> Apache Spark + S3 + ClickHouse</li>
                        <li><strong>Use Case:</strong> Trend analysis, cohort retention, YoY comparisons</li>
                    </ul>
                </div>
            </div>
            <div style="margin-top: 20px; padding: 15px; background: #fed7aa; border-left: 4px solid #ea580c; border-radius: 5px;">
                <strong>üóÑÔ∏è Serving Layer:</strong> Merges results from both speed and batch layers. Recent queries hit Redis (fast path),
                historical queries use ClickHouse pre-aggregations. 70% cache hit rate ensures <2s query latency.
            </div>
        </div>
    </div>

    <!-- Metrics Panel -->
    <div class="metrics-panel">
        <h2 style="margin-bottom: 15px; color: #92400e;">‚ö° System Performance Metrics</h2>
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value">100M</div>
                <div class="metric-label">Daily Active Users</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">150K</div>
                <div class="metric-label">Peak EPS</div>
            </div>
            <div class="metric-card">
                <div class="metric-value"><1 min</div>
                <div class="metric-label">Real-time Latency</div>
            </div>
            <div class="metric-card">
                <div class="metric-value"><2s</div>
                <div class="metric-label">Query P95 Latency</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">70%</div>
                <div class="metric-label">Cache Hit Rate</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">0.81%</div>
                <div class="metric-label">HLL Error Rate</div>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #60a5fa, #3b82f6);"></div>
            <span>Client Layer</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #84cc16, #65a30d);"></div>
            <span>Ingestion</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #f87171, #ef4444);"></div>
            <span>Message Queue</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #818cf8, #6366f1);"></div>
            <span>Stream Processing</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #facc15, #eab308);"></div>
            <span>Batch Processing</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #fb923c, #f97316);"></div>
            <span>OLAP Database</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #f472b6, #ec4899);"></div>
            <span>Cache (Redis)</span>
        </div>
    </div>
</div>

<script>
    function showDiagram(type) {
        // Hide all diagrams
        document.querySelectorAll('.diagram-container').forEach(d => {
            d.classList.remove('active');
        });

        // Remove active from all tabs
        document.querySelectorAll('.tab').forEach(t => {
            t.classList.remove('active');
        });

        // Show selected diagram
        document.getElementById(type + '-diagram').classList.add('active');

        // Activate clicked tab
        event.target.classList.add('active');
    }

    // Add hover effects
    document.querySelectorAll('.component').forEach(comp => {
        comp.addEventListener('mouseenter', function() {
            this.style.filter = 'drop-shadow(0 0 15px rgba(99, 102, 241, 0.6))';
        });

        comp.addEventListener('mouseleave', function() {
            this.style.filter = 'none';
        });
    });
</script>
</body>
</html>
