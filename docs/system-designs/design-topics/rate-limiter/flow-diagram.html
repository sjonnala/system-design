<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rate Limiter Flow Diagrams</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            font-size: 2.5em;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 30px;
            background: #e2e8f0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: #6366f1;
            color: white;
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .diagram-container {
            display: none;
            margin-top: 30px;
        }

        .diagram-container.active {
            display: block;
        }

        svg {
            width: 100%;
            height: auto;
        }

        .component {
            cursor: pointer;
            transition: all 0.3s;
        }

        .component:hover {
            filter: drop-shadow(0 0 10px rgba(99, 102, 241, 0.5));
        }

        .component rect {
            transition: all 0.3s;
        }

        .component:hover rect {
            stroke-width: 3;
        }

        .flow-arrow {
            animation: dash 20s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -1000;
            }
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            border: 2px solid #cbd5e0;
        }

        .flow-description {
            background: #e0e7ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 5px solid #6366f1;
        }

        .flow-description h3 {
            color: #4338ca;
            margin-bottom: 10px;
        }

        .flow-description ol {
            margin-left: 20px;
            line-height: 2;
            color: #1e293b;
        }

        .flow-description ol li {
            margin: 8px 0;
        }

        .flow-description strong {
            color: #6366f1;
        }

        .metrics-panel {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde047 100%);
            border-radius: 15px;
            border: 2px solid #fbbf24;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #6366f1;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #6366f1;
        }

        .metric-label {
            font-size: 0.9em;
            color: #4a5568;
            margin-top: 5px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>‚è±Ô∏è Rate Limiter Flow Diagrams</h1>
        <p style="color: #64748b; margin-top: 10px;">Interactive Component Flow Visualization</p>

        <div class="tabs">
            <button class="tab active" onclick="showDiagram('token-bucket')">ü™£ Token Bucket Flow</button>
            <button class="tab" onclick="showDiagram('sliding-window')">üìä Sliding Window Flow</button>
            <button class="tab" onclick="showDiagram('distributed')">üåê Distributed Rate Limiting</button>
            <button class="tab" onclick="showDiagram('full')">üèóÔ∏è Full System Flow</button>
        </div>
    </div>

    <!-- Token Bucket Flow -->
    <div id="token-bucket-diagram" class="diagram-container active">
        <svg viewBox="0 0 1400 1200" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#6366f1" />
                </marker>
                <linearGradient id="grad-client" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-gateway" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#f87171;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#ef4444;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-limiter" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#84cc16;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#65a30d;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-redis" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#f472b6;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
                </linearGradient>
            </defs>

            <!-- Title -->
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Token Bucket Algorithm Flow
            </text>

            <!-- Client -->
            <g class="component">
                <rect x="600" y="60" width="200" height="80" rx="10" fill="url(#grad-client)" stroke="#2563eb" stroke-width="2"/>
                <text x="700" y="95" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üë§ Client</text>
                <text x="700" y="115" font-size="12" text-anchor="middle" fill="white">API Key: sk_123</text>
            </g>

            <!-- Arrow -->
            <path d="M 700 140 L 700 180" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="165" font-size="11" fill="#4338ca" font-weight="600">GET /api/users</text>

            <!-- API Gateway -->
            <g class="component">
                <rect x="600" y="180" width="200" height="80" rx="10" fill="url(#grad-gateway)" stroke="#dc2626" stroke-width="2"/>
                <text x="700" y="215" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üö™ API Gateway</text>
                <text x="700" y="235" font-size="12" text-anchor="middle" fill="white">Extract API Key</text>
            </g>

            <!-- Arrow to Rate Limiter -->
            <path d="M 700 260 L 700 300" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="285" font-size="11" fill="#4338ca" font-weight="600">Check Rate Limit</text>

            <!-- Rate Limiter Service -->
            <g class="component">
                <rect x="550" y="300" width="300" height="100" rx="10" fill="url(#grad-limiter)" stroke="#4d7c0f" stroke-width="2"/>
                <text x="700" y="335" font-size="16" font-weight="bold" text-anchor="middle" fill="white">‚è±Ô∏è Rate Limiter</text>
                <text x="700" y="355" font-size="12" text-anchor="middle" fill="white">Token Bucket Algorithm</text>
                <text x="700" y="375" font-size="11" text-anchor="middle" fill="white">Limit: 100 req/min, Burst: 20</text>
            </g>

            <!-- Arrow to Redis -->
            <path d="M 700 400 L 700 460" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="435" font-size="11" fill="#4338ca" font-weight="600">Query Bucket State</text>

            <!-- Redis with Token Bucket visualization -->
            <g class="component">
                <rect x="500" y="460" width="400" height="200" rx="10" fill="url(#grad-redis)" stroke="#db2777" stroke-width="2"/>
                <text x="700" y="495" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üíæ Redis - Token Bucket State</text>

                <!-- Bucket visualization -->
                <rect x="550" y="520" width="120" height="120" rx="5" fill="#fce7f3" stroke="#9f1239" stroke-width="2"/>
                <text x="610" y="550" font-size="14" font-weight="bold" text-anchor="middle" fill="#831843">Bucket</text>
                <text x="610" y="570" font-size="12" text-anchor="middle" fill="#831843">Capacity: 20</text>

                <!-- Tokens in bucket -->
                <circle cx="575" cy="590" r="8" fill="#22c55e"/>
                <circle cx="600" cy="590" r="8" fill="#22c55e"/>
                <circle cx="625" cy="590" r="8" fill="#22c55e"/>
                <circle cx="575" cy="610" r="8" fill="#22c55e"/>
                <circle cx="600" cy="610" r="8" fill="#22c55e"/>
                <circle cx="625" cy="610" r="8" fill="#22c55e"/>
                <text x="610" y="635" font-size="11" text-anchor="middle" fill="#831843">12 tokens available</text>

                <!-- Refill rate -->
                <text x="750" y="560" font-size="12" font-weight="bold" text-anchor="start" fill="white">State:</text>
                <text x="750" y="585" font-size="11" text-anchor="start" fill="white">‚Ä¢ tokens: 12</text>
                <text x="750" y="605" font-size="11" text-anchor="start" fill="white">‚Ä¢ capacity: 20</text>
                <text x="750" y="625" font-size="11" text-anchor="start" fill="white">‚Ä¢ refill_rate: 100/min</text>
                <text x="750" y="645" font-size="11" text-anchor="start" fill="white">‚Ä¢ last_refill: 1699999990</text>
            </g>

            <!-- Decision Diamond -->
            <g class="component">
                <path d="M 700 700 L 800 760 L 700 820 L 600 760 Z" fill="#fef3c7" stroke="#f59e0b" stroke-width="3"/>
                <text x="700" y="755" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Tokens</text>
                <text x="700" y="773" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Available?</text>
            </g>

            <!-- YES Path (Right) -->
            <path d="M 800 760 L 950 760" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>
            <text x="850" y="750" font-size="12" fill="#059669" font-weight="700">YES ‚úì</text>

            <g class="component">
                <rect x="950" y="710" width="200" height="100" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="3"/>
                <text x="1050" y="745" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">‚úÖ Allow Request</text>
                <text x="1050" y="765" font-size="12" text-anchor="middle" fill="#065f46">Decrement token</text>
                <text x="1050" y="785" font-size="11" text-anchor="middle" fill="#065f46">tokens: 12 ‚Üí 11</text>
            </g>

            <path d="M 1050 810 L 1050 880 L 800 880" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="8,4"/>
            <text x="930" y="900" font-size="12" fill="#059669" font-weight="700">200 OK + Data</text>

            <!-- NO Path (Left) -->
            <path d="M 600 760 L 450 760" stroke="#ef4444" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>
            <text x="500" y="750" font-size="12" fill="#dc2626" font-weight="700">NO ‚úó</text>

            <g class="component">
                <rect x="250" y="710" width="200" height="100" rx="10" fill="#fee2e2" stroke="#dc2626" stroke-width="3"/>
                <text x="350" y="745" font-size="14" font-weight="bold" text-anchor="middle" fill="#991b1b">‚ùå Reject Request</text>
                <text x="350" y="765" font-size="12" text-anchor="middle" fill="#991b1b">429 Too Many Requests</text>
                <text x="350" y="785" font-size="11" text-anchor="middle" fill="#991b1b">Retry-After: 30</text>
            </g>

            <path d="M 350 810 L 350 880 L 600 880" stroke="#ef4444" stroke-width="4" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="8,4"/>

            <!-- Background refill process -->
            <g class="component">
                <rect x="200" y="950" width="400" height="120" rx="10" fill="#e0f2fe" stroke="#0284c7" stroke-width="2"/>
                <text x="400" y="985" font-size="14" font-weight="bold" text-anchor="middle" fill="#075985">üîÑ Background Refill Process</text>
                <text x="400" y="1010" font-size="12" text-anchor="middle" fill="#075985">Runs every second</text>
                <text x="220" y="1035" font-size="11" text-anchor="start" fill="#075985">elapsed = now - last_refill</text>
                <text x="220" y="1055" font-size="11" text-anchor="start" fill="#075985">new_tokens = elapsed √ó refill_rate</text>
            </g>

            <path d="M 600 560 L 200 560 L 200 950" stroke="#0284c7" stroke-width="2" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>

            <!-- Algorithm Steps Box -->
            <g class="component">
                <rect x="900" y="950" width="400" height="180" rx="10" fill="#f0fdf4" stroke="#16a34a" stroke-width="2"/>
                <text x="1100" y="985" font-size="14" font-weight="bold" text-anchor="middle" fill="#166534">üìã Token Bucket Logic</text>
                <text x="920" y="1015" font-size="11" text-anchor="start" fill="#166534">1. Calculate elapsed time since last refill</text>
                <text x="920" y="1035" font-size="11" text-anchor="start" fill="#166534">2. Add new tokens: min(capacity, tokens + elapsed √ó rate)</text>
                <text x="920" y="1055" font-size="11" text-anchor="start" fill="#166534">3. Check if tokens ‚â• 1</text>
                <text x="920" y="1075" font-size="11" text-anchor="start" fill="#166534">4. If yes: decrement token, allow request</text>
                <text x="920" y="1095" font-size="11" text-anchor="start" fill="#166534">5. If no: reject with 429</text>
                <text x="920" y="1115" font-size="11" text-anchor="start" fill="#166534">6. Update last_refill timestamp</text>
            </g>

            <!-- Step Numbers -->
            <circle cx="700" cy="100" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="107" font-size="14" font-weight="bold" text-anchor="middle" fill="white">1</text>

            <circle cx="700" cy="220" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="227" font-size="14" font-weight="bold" text-anchor="middle" fill="white">2</text>

            <circle cx="700" cy="350" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="357" font-size="14" font-weight="bold" text-anchor="middle" fill="white">3</text>

            <circle cx="700" cy="560" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="567" font-size="14" font-weight="bold" text-anchor="middle" fill="white">4</text>

            <circle cx="700" cy="760" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="767" font-size="14" font-weight="bold" text-anchor="middle" fill="white">5</text>
        </svg>

        <div class="flow-description">
            <h3>ü™£ Token Bucket Algorithm Flow</h3>
            <ol>
                <li><strong>Client Request:</strong> Client sends request with API key to API endpoint</li>
                <li><strong>Gateway Routing:</strong> API Gateway extracts API key and routes to rate limiter</li>
                <li><strong>Rate Limiter Check:</strong> Token Bucket algorithm checks if request can be allowed
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Bucket has fixed capacity (burst size)</li>
                        <li>Tokens refill at constant rate (e.g., 100/minute)</li>
                        <li>Each request consumes 1 token</li>
                    </ul>
                </li>
                <li><strong>Query Redis:</strong> Fetch current bucket state from Redis
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Current token count</li>
                        <li>Last refill timestamp</li>
                        <li>Calculate new tokens based on elapsed time</li>
                    </ul>
                </li>
                <li><strong>Decision:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li><strong>Tokens Available (‚â•1):</strong> Allow request, decrement token, return 200 OK</li>
                        <li><strong>No Tokens (0):</strong> Reject request, return 429 Too Many Requests with Retry-After header</li>
                    </ul>
                </li>
                <li><strong>Background Refill:</strong> Tokens continuously refill at configured rate (async process)</li>
            </ol>
            <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 5px;">
                <strong>üéØ Key Advantage:</strong> Allows bursts! If no requests for 1 minute, bucket fills to capacity (20), allowing 20 rapid requests.
            </div>
        </div>
    </div>

    <!-- Sliding Window Flow -->
    <div id="sliding-window-diagram" class="diagram-container">
        <svg viewBox="0 0 1400 1000" xmlns="http://www.w3.org/2000/svg">
            <!-- Title -->
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Sliding Window Counter Algorithm
            </text>

            <!-- Timeline visualization -->
            <g class="component">
                <rect x="100" y="80" width="1200" height="250" rx="10" fill="#f0f9ff" stroke="#0284c7" stroke-width="2"/>
                <text x="700" y="110" font-size="16" font-weight="bold" text-anchor="middle" fill="#075985">Time Windows</text>

                <!-- Previous Window -->
                <rect x="150" y="140" width="500" height="160" rx="5" fill="#dbeafe" stroke="#0369a1" stroke-width="2"/>
                <text x="400" y="170" font-size="14" font-weight="bold" text-anchor="middle" fill="#0c4a6e">Previous Window</text>
                <text x="400" y="190" font-size="12" text-anchor="middle" fill="#0c4a6e">10:30:00 - 10:31:00</text>
                <text x="400" y="210" font-size="12" text-anchor="middle" fill="#0c4a6e">Count: 80 requests</text>

                <!-- Request dots in previous window -->
                <g id="prev-requests">
                    <!-- Draw multiple small circles representing requests -->
                    <circle cx="200" cy="240" r="5" fill="#3b82f6"/>
                    <circle cx="230" cy="250" r="5" fill="#3b82f6"/>
                    <circle cx="260" cy="235" r="5" fill="#3b82f6"/>
                    <circle cx="290" cy="255" r="5" fill="#3b82f6"/>
                    <circle cx="320" cy="245" r="5" fill="#3b82f6"/>
                    <circle cx="350" cy="240" r="5" fill="#3b82f6"/>
                    <circle cx="380" cy="260" r="5" fill="#3b82f6"/>
                    <circle cx="410" cy="250" r="5" fill="#3b82f6"/>
                    <circle cx="440" cy="245" r="5" fill="#3b82f6"/>
                    <circle cx="470" cy="255" r="5" fill="#3b82f6"/>
                    <circle cx="500" cy="240" r="5" fill="#3b82f6"/>
                    <circle cx="530" cy="265" r="5" fill="#3b82f6"/>
                    <circle cx="560" cy="250" r="5" fill="#3b82f6"/>
                    <circle cx="590" cy="260" r="5" fill="#3b82f6"/>
                    <circle cx="620" cy="245" r="5" fill="#3b82f6"/>
                </g>
                <text x="400" y="290" font-size="11" text-anchor="middle" fill="#0369a1">... (80 total requests)</text>

                <!-- Current Window -->
                <rect x="700" y="140" width="500" height="160" rx="5" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                <text x="950" y="170" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">Current Window</text>
                <text x="950" y="190" font-size="12" text-anchor="middle" fill="#92400e">10:31:00 - 10:32:00</text>
                <text x="950" y="210" font-size="12" text-anchor="middle" fill="#92400e">Count: 30 requests</text>

                <!-- Request dots in current window -->
                <circle cx="750" cy="240" r="5" fill="#f59e0b"/>
                <circle cx="800" cy="250" r="5" fill="#f59e0b"/>
                <circle cx="850" cy="245" r="5" fill="#f59e0b"/>
                <circle cx="900" cy="255" r="5" fill="#f59e0b"/>
                <circle cx="950" cy="240" r="5" fill="#f59e0b"/>
                <circle cx="1000" cy="260" r="5" fill="#f59e0b"/>
                <circle cx="1050" cy="250" r="5" fill="#f59e0b"/>
                <circle cx="1100" cy="245" r="5" fill="#f59e0b"/>
                <text x="950" y="290" font-size="11" text-anchor="middle" fill="#92400e">... (30 total requests)</text>

                <!-- Current time marker -->
                <line x1="1000" y1="140" x2="1000" y2="300" stroke="#ef4444" stroke-width="3" stroke-dasharray="5,5"/>
                <text x="1010" y="320" font-size="11" font-weight="bold" fill="#dc2626">NOW: 10:31:40 (40s into window)</text>
            </g>

            <!-- Calculation Box -->
            <g class="component">
                <rect x="200" y="380" width="400" height="200" rx="10" fill="#e0f2fe" stroke="#0284c7" stroke-width="2"/>
                <text x="400" y="415" font-size="16" font-weight="bold" text-anchor="middle" fill="#075985">üìä Weighted Average Calculation</text>

                <text x="220" y="450" font-size="12" text-anchor="start" fill="#0c4a6e">1. elapsed_in_window = 40 seconds</text>
                <text x="220" y="475" font-size="12" text-anchor="start" fill="#0c4a6e">2. weight = 40 / 60 = 0.67</text>
                <text x="220" y="500" font-size="12" text-anchor="start" fill="#0c4a6e">3. prev_contribution = 80 √ó (1 - 0.67) = 26.4</text>
                <text x="220" y="525" font-size="12" text-anchor="start" fill="#0c4a6e">4. curr_contribution = 30 √ó 1.0 = 30</text>
                <text x="220" y="550" font-size="13" font-weight="bold" text-anchor="start" fill="#0369a1">5. estimated_count = 26.4 + 30 = 56.4</text>
            </g>

            <!-- Decision Box -->
            <g class="component">
                <rect x="800" y="380" width="400" height="200" rx="10" fill="#f0fdf4" stroke="#16a34a" stroke-width="2"/>
                <text x="1000" y="415" font-size="16" font-weight="bold" text-anchor="middle" fill="#166534">‚úÖ Rate Limit Decision</text>

                <text x="820" y="450" font-size="12" text-anchor="start" fill="#166534">Limit: 100 requests per minute</text>
                <text x="820" y="475" font-size="12" text-anchor="start" fill="#166534">Current estimate: 56.4 requests</text>
                <text x="820" y="500" font-size="12" text-anchor="start" fill="#166534">Remaining: 100 - 56.4 = 43.6</text>
                <text x="820" y="530" font-size="14" font-weight="bold" text-anchor="start" fill="#15803d">Result: ALLOW ‚úì</text>
                <text x="820" y="555" font-size="11" text-anchor="start" fill="#166534">Increment current window counter</text>
            </g>

            <!-- Redis Commands -->
            <g class="component">
                <rect x="200" y="630" width="1000" height="180" rx="10" fill="#1e293b" stroke="#475569" stroke-width="2"/>
                <text x="700" y="665" font-size="16" font-weight="bold" text-anchor="middle" fill="#e2e8f0">üíæ Redis Commands</text>

                <text x="220" y="700" font-size="12" font-family="monospace" text-anchor="start" fill="#94a3b8"># Get counts for both windows</text>
                <text x="220" y="720" font-size="12" font-family="monospace" text-anchor="start" fill="#fbbf24">MGET</text>
                <text x="270" y="720" font-size="12" font-family="monospace" text-anchor="start" fill="#e2e8f0">rate:user123:1699999800 rate:user123:1699999860</text>

                <text x="220" y="745" font-size="12" font-family="monospace" text-anchor="start" fill="#94a3b8"># If under limit, increment current window</text>
                <text x="220" y="765" font-size="12" font-family="monospace" text-anchor="start" fill="#fbbf24">INCR</text>
                <text x="270" y="765" font-size="12" font-family="monospace" text-anchor="start" fill="#e2e8f0">rate:user123:1699999860</text>

                <text x="220" y="790" font-size="12" font-family="monospace" text-anchor="start" fill="#94a3b8"># Set expiration (cleanup old windows)</text>
                <text x="220" y="810" font-size="12" font-family="monospace" text-anchor="start" fill="#fbbf24">EXPIRE</text>
                <text x="290" y="810" font-size="12" font-family="monospace" text-anchor="start" fill="#e2e8f0">rate:user123:1699999860 120</text>
            </g>

            <!-- Advantages -->
            <g class="component">
                <rect x="200" y="860" width="450" height="100" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="2"/>
                <text x="425" y="895" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">‚úÖ Advantages</text>
                <text x="220" y="920" font-size="11" text-anchor="start" fill="#065f46">‚Ä¢ Memory efficient (2 counters)</text>
                <text x="220" y="940" font-size="11" text-anchor="start" fill="#065f46">‚Ä¢ No boundary spikes (smooth)</text>
            </g>

            <g class="component">
                <rect x="750" y="860" width="450" height="100" rx="10" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
                <text x="975" y="895" font-size="14" font-weight="bold" text-anchor="middle" fill="#991b1b">‚ö†Ô∏è Trade-offs</text>
                <text x="770" y="920" font-size="11" text-anchor="start" fill="#991b1b">‚Ä¢ Approximate (not exact)</text>
                <text x="770" y="940" font-size="11" text-anchor="start" fill="#991b1b">‚Ä¢ Can allow slightly over limit (~5%)</text>
            </g>
        </svg>

        <div class="flow-description">
            <h3>üìä Sliding Window Counter Algorithm</h3>
            <p style="margin-bottom: 15px; line-height: 1.8;">
                This algorithm combines the <strong>memory efficiency of fixed windows</strong> with the <strong>accuracy of sliding windows</strong>.
                It uses a weighted average of the previous and current window to estimate the request count.
            </p>
            <ol>
                <li><strong>Track Two Windows:</strong> Previous window (completed) and current window (in progress)</li>
                <li><strong>Calculate Position:</strong> Determine how far into the current window we are (0-100%)</li>
                <li><strong>Weighted Average:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>If 40 seconds into a 60-second window: weight = 40/60 = 0.67</li>
                        <li>Previous window contribution: count √ó (1 - weight)</li>
                        <li>Current window contribution: count √ó 1.0</li>
                    </ul>
                </li>
                <li><strong>Compare to Limit:</strong> If estimated count < limit, allow request</li>
                <li><strong>Update Counter:</strong> Increment current window counter in Redis</li>
            </ol>
            <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 5px;">
                <strong>üéØ Best For:</strong> Systems requiring smooth rate limiting without memory overhead. Used by Cloudflare, Redis Enterprise.
            </div>
        </div>
    </div>

    <!-- Distributed Rate Limiting Flow -->
    <div id="distributed-diagram" class="diagram-container">
        <svg viewBox="0 0 1600 1400" xmlns="http://www.w3.org/2000/svg">
            <!-- Title -->
            <text x="800" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Distributed Rate Limiting with Coordination
            </text>

            <!-- Multiple API Gateway Instances -->
            <g class="component">
                <rect x="200" y="80" width="180" height="80" rx="10" fill="url(#grad-gateway)" stroke="#dc2626" stroke-width="2"/>
                <text x="290" y="115" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Gateway 1</text>
                <text x="290" y="135" font-size="11" text-anchor="middle" fill="white">us-east-1a</text>
            </g>

            <g class="component">
                <rect x="450" y="80" width="180" height="80" rx="10" fill="url(#grad-gateway)" stroke="#dc2626" stroke-width="2"/>
                <text x="540" y="115" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Gateway 2</text>
                <text x="540" y="135" font-size="11" text-anchor="middle" fill="white">us-east-1b</text>
            </g>

            <g class="component">
                <rect x="700" y="80" width="180" height="80" rx="10" fill="url(#grad-gateway)" stroke="#dc2626" stroke-width="2"/>
                <text x="790" y="115" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Gateway 3</text>
                <text x="790" y="135" font-size="11" text-anchor="middle" fill="white">us-west-1a</text>
            </g>

            <!-- Arrows to Redis Cluster -->
            <path d="M 290 160 L 500 280" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 540 160 L 500 280" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 790 160 L 500 280" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <text x="350" y="220" font-size="10" fill="#4338ca">INCR key</text>
            <text x="450" y="220" font-size="10" fill="#4338ca">INCR key</text>
            <text x="650" y="220" font-size="10" fill="#4338ca">INCR key</text>

            <!-- Redis Cluster -->
            <g class="component">
                <rect x="300" y="280" width="400" height="250" rx="10" fill="url(#grad-redis)" stroke="#db2777" stroke-width="2"/>
                <text x="500" y="315" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üíæ Redis Cluster (Centralized State)</text>

                <!-- Master nodes -->
                <rect x="330" y="350" width="100" height="70" rx="5" fill="#fce7f3" stroke="#9f1239" stroke-width="2"/>
                <text x="380" y="375" font-size="12" font-weight="bold" text-anchor="middle" fill="#831843">Master 1</text>
                <text x="380" y="395" font-size="10" text-anchor="middle" fill="#831843">Slots:</text>
                <text x="380" y="410" font-size="10" text-anchor="middle" fill="#831843">0-5460</text>

                <rect x="450" y="350" width="100" height="70" rx="5" fill="#fce7f3" stroke="#9f1239" stroke-width="2"/>
                <text x="500" y="375" font-size="12" font-weight="bold" text-anchor="middle" fill="#831843">Master 2</text>
                <text x="500" y="395" font-size="10" text-anchor="middle" fill="#831843">Slots:</text>
                <text x="500" y="410" font-size="10" text-anchor="middle" fill="#831843">5461-10922</text>

                <rect x="570" y="350" width="100" height="70" rx="5" fill="#fce7f3" stroke="#9f1239" stroke-width="2"/>
                <text x="620" y="375" font-size="12" font-weight="bold" text-anchor="middle" fill="#831843">Master 3</text>
                <text x="620" y="395" font-size="10" text-anchor="middle" fill="#831843">Slots:</text>
                <text x="620" y="410" font-size="10" text-anchor="middle" fill="#831843">10923-16383</text>

                <!-- Replicas -->
                <rect x="330" y="445" width="100" height="60" rx="5" fill="#fbcfe8" stroke="#9f1239" stroke-width="1" stroke-dasharray="3,3"/>
                <text x="380" y="470" font-size="11" text-anchor="middle" fill="#831843">Replica 1</text>

                <rect x="450" y="445" width="100" height="60" rx="5" fill="#fbcfe8" stroke="#9f1239" stroke-width="1" stroke-dasharray="3,3"/>
                <text x="500" y="470" font-size="11" text-anchor="middle" fill="#831843">Replica 2</text>

                <rect x="570" y="445" width="100" height="60" rx="5" fill="#fbcfe8" stroke="#9f1239" stroke-width="1" stroke-dasharray="3,3"/>
                <text x="620" y="470" font-size="11" text-anchor="middle" fill="#831843">Replica 3</text>

                <!-- Replication arrows -->
                <path d="M 380 420 L 380 445" stroke="#9f1239" stroke-width="2" fill="none" stroke-dasharray="2,2"/>
                <path d="M 500 420 L 500 445" stroke="#9f1239" stroke-width="2" fill="none" stroke-dasharray="2,2"/>
                <path d="M 620 420 L 620 445" stroke="#9f1239" stroke-width="2" fill="none" stroke-dasharray="2,2"/>
            </g>

            <!-- Coordination Layer -->
            <g class="component">
                <rect x="850" y="280" width="300" height="160" rx="10" fill="#e9d5ff" stroke="#9333ea" stroke-width="2"/>
                <text x="1000" y="315" font-size="16" font-weight="bold" text-anchor="middle" fill="#6b21a8">ü§ù ZooKeeper / etcd</text>
                <text x="1000" y="335" font-size="12" text-anchor="middle" fill="#6b21a8">Distributed Coordination</text>

                <text x="870" y="365" font-size="11" text-anchor="start" fill="#6b21a8"><strong>Tasks:</strong></text>
                <text x="870" y="385" font-size="10" text-anchor="start" fill="#6b21a8">‚Ä¢ Leader election for quota reset</text>
                <text x="870" y="405" font-size="10" text-anchor="start" fill="#6b21a8">‚Ä¢ Config synchronization</text>
                <text x="870" y="425" font-size="10" text-anchor="start" fill="#6b21a8">‚Ä¢ Node discovery & health</text>
            </g>

            <!-- Challenge 1: Race Conditions -->
            <g class="component">
                <rect x="200" y="600" width="550" height="200" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                <text x="475" y="635" font-size="16" font-weight="bold" text-anchor="middle" fill="#92400e">‚ö†Ô∏è Challenge: Race Conditions</text>

                <text x="220" y="665" font-size="12" text-anchor="start" fill="#92400e">Scenario: Two gateways check limit simultaneously</text>

                <rect x="220" y="680" width="250" height="90" rx="5" fill="white" stroke="#f59e0b" stroke-width="1"/>
                <text x="345" y="705" font-size="11" font-weight="bold" text-anchor="middle" fill="#78350f">Gateway 1 (time: T)</text>
                <text x="240" y="725" font-size="10" text-anchor="start" fill="#78350f">1. Read count: 99</text>
                <text x="240" y="745" font-size="10" text-anchor="start" fill="#78350f">2. Check: 99 < 100 ‚úì</text>
                <text x="240" y="765" font-size="10" text-anchor="start" fill="#78350f">3. Write count: 100</text>

                <rect x="490" y="680" width="250" height="90" rx="5" fill="white" stroke="#f59e0b" stroke-width="1"/>
                <text x="615" y="705" font-size="11" font-weight="bold" text-anchor="middle" fill="#78350f">Gateway 2 (time: T+1ms)</text>
                <text x="510" y="725" font-size="10" text-anchor="start" fill="#78350f">1. Read count: 99</text>
                <text x="510" y="745" font-size="10" text-anchor="start" fill="#78350f">2. Check: 99 < 100 ‚úì</text>
                <text x="510" y="765" font-size="10" text-anchor="start" fill="#78350f">3. Write count: 100</text>

                <text x="475" y="790" font-size="11" font-weight="bold" text-anchor="middle" fill="#dc2626">‚ùå Problem: Both allowed, limit exceeded (101)</text>
            </g>

            <!-- Solution 1: Atomic Operations -->
            <g class="component">
                <rect x="850" y="600" width="550" height="200" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="2"/>
                <text x="1125" y="635" font-size="16" font-weight="bold" text-anchor="middle" fill="#065f46">‚úÖ Solution: Atomic Redis Operations</text>

                <rect x="870" y="660" width="510" height="120" rx="5" fill="#1e293b" stroke="#10b981" stroke-width="2"/>
                <text x="1125" y="685" font-size="12" font-family="monospace" text-anchor="middle" fill="#e2e8f0">Lua Script (Atomic Execution)</text>

                <text x="890" y="710" font-size="10" font-family="monospace" text-anchor="start" fill="#94a3b8">local current = redis.call('GET', KEYS[1])</text>
                <text x="890" y="730" font-size="10" font-family="monospace" text-anchor="start" fill="#94a3b8">if tonumber(current) < tonumber(ARGV[1]) then</text>
                <text x="910" y="750" font-size="10" font-family="monospace" text-anchor="start" fill="#22c55e">  redis.call('INCR', KEYS[1])</text>
                <text x="910" y="770" font-size="10" font-family="monospace" text-anchor="start" fill="#22c55e">  return 1  -- allowed</text>
                <text x="890" y="790" font-size="10" font-family="monospace" text-anchor="start" fill="#ef4444">else return 0 end  -- rejected</text>
            </g>

            <!-- Challenge 2: Global Quotas -->
            <g class="component">
                <rect x="200" y="850" width="550" height="180" rx="10" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
                <text x="475" y="885" font-size="16" font-weight="bold" text-anchor="middle" fill="#991b1b">‚ö†Ô∏è Challenge: Global Quota Enforcement</text>

                <text x="220" y="915" font-size="12" text-anchor="start" fill="#991b1b">Scenario: Enterprise customer with 1M requests/month across all regions</text>

                <text x="220" y="945" font-size="11" text-anchor="start" fill="#991b1b"><strong>Problem:</strong></text>
                <text x="220" y="965" font-size="10" text-anchor="start" fill="#991b1b">‚Ä¢ Each region tracks quota independently</text>
                <text x="220" y="985" font-size="10" text-anchor="start" fill="#991b1b">‚Ä¢ Cross-region coordination adds latency</text>
                <text x="220" y="1005" font-size="10" text-anchor="start" fill="#991b1b">‚Ä¢ Network partitions cause inconsistency</text>
            </g>

            <!-- Solution 2: Hierarchical Quotas -->
            <g class="component">
                <rect x="850" y="850" width="550" height="180" rx="10" fill="#dbeafe" stroke="#0284c7" stroke-width="2"/>
                <text x="1125" y="885" font-size="16" font-weight="bold" text-anchor="middle" fill="#075985">‚úÖ Solution: Hierarchical Quotas</text>

                <text x="870" y="915" font-size="11" text-anchor="start" fill="#075985"><strong>Strategy:</strong></text>
                <text x="870" y="935" font-size="10" text-anchor="start" fill="#075985">1. Allocate quota per region: 500K (us-east), 300K (us-west), 200K (eu)</text>
                <text x="870" y="955" font-size="10" text-anchor="start" fill="#075985">2. Local rate limiting within region (fast)</text>
                <text x="870" y="975" font-size="10" text-anchor="start" fill="#075985">3. Periodic sync with global coordinator (slow)</text>
                <text x="870" y="995" font-size="10" text-anchor="start" fill="#075985">4. Rebalance unused quota hourly</text>
                <text x="870" y="1015" font-size="11" font-weight="bold" text-anchor="start" fill="#0369a1">Trade-off: Slight over-quota (max 10%) for lower latency</text>
            </g>

            <!-- Best Practices -->
            <g class="component">
                <rect x="200" y="1080" width="1200" height="150" rx="10" fill="#f0fdf4" stroke="#16a34a" stroke-width="2"/>
                <text x="800" y="1115" font-size="16" font-weight="bold" text-anchor="middle" fill="#166534">üéØ Distributed Rate Limiting Best Practices</text>

                <text x="220" y="1145" font-size="11" text-anchor="start" fill="#166534"><strong>1. Consistency Model:</strong> Choose based on use case</text>
                <text x="240" y="1165" font-size="10" text-anchor="start" fill="#166534">‚Ä¢ Financial APIs: Strong consistency (Paxos/Raft)</text>
                <text x="240" y="1185" font-size="10" text-anchor="start" fill="#166534">‚Ä¢ Social media: Eventual consistency (faster, allow 5-10% overrun)</text>

                <text x="700" y="1145" font-size="11" text-anchor="start" fill="#166534"><strong>2. Failure Handling:</strong></text>
                <text x="720" y="1165" font-size="10" text-anchor="start" fill="#166534">‚Ä¢ Fail-open: Allow requests if Redis down (availability)</text>
                <text x="720" y="1185" font-size="10" text-anchor="start" fill="#166534">‚Ä¢ Fail-closed: Reject if unsure (security)</text>

                <text x="220" y="1210" font-size="11" text-anchor="start" fill="#166534"><strong>3. Observability:</strong> Monitor cross-region latency, consensus lag, quota utilization</text>
            </g>
        </svg>

        <div class="flow-description">
            <h3>üåê Distributed Rate Limiting Challenges & Solutions</h3>
            <p style="margin-bottom: 15px; line-height: 1.8;">
                In distributed systems, rate limiting becomes complex due to <strong>multiple nodes</strong> making independent decisions.
                Coordination is needed to ensure global limits are enforced accurately.
            </p>
            <ol>
                <li><strong>Race Conditions:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Problem: Two nodes read count=99, both allow request, limit exceeded</li>
                        <li>Solution: Use Redis Lua scripts for atomic read-check-increment</li>
                    </ul>
                </li>
                <li><strong>Clock Skew:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Problem: Different servers have different times</li>
                        <li>Solution: Use logical clocks (Lamport) or centralized time service</li>
                    </ul>
                </li>
                <li><strong>Network Partitions:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Problem: Region isolated from Redis, can't enforce limits</li>
                        <li>Solution: Local quotas + fail-open/fail-closed strategy</li>
                    </ul>
                </li>
                <li><strong>Global Quota Enforcement:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Problem: Cross-region coordination adds latency</li>
                        <li>Solution: Hierarchical quotas (allocate per region, sync periodically)</li>
                    </ul>
                </li>
            </ol>
            <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 5px;">
                <strong>üéØ CAP Theorem:</strong> Rate limiting favors Availability + Partition tolerance (AP), accepting eventual consistency for lower latency.
            </div>
        </div>
    </div>

    <!-- Full System Flow -->
    <div id="full-diagram" class="diagram-container">
        <svg viewBox="0 0 1600 1000" xmlns="http://www.w3.org/2000/svg">
            <!-- Title -->
            <text x="800" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Complete Distributed Rate Limiter System Flow
            </text>

            <!-- Request Flow -->
            <text x="100" y="80" font-size="14" font-weight="bold" fill="#64748b">REQUEST PATH</text>
            <line x1="100" y1="90" x2="1500" y2="90" stroke="#e2e8f0" stroke-width="2"/>

            <!-- Client -->
            <g class="component">
                <rect x="100" y="120" width="150" height="70" rx="10" fill="url(#grad-client)" stroke="#2563eb" stroke-width="2"/>
                <text x="175" y="150" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Client</text>
            </g>

            <path d="M 250 155 L 350 155" stroke="#6366f1" stroke-width="2" marker-end="url(#arrowhead)"/>

            <!-- API Gateway -->
            <g class="component">
                <rect x="350" y="120" width="150" height="70" rx="10" fill="url(#grad-gateway)" stroke="#dc2626" stroke-width="2"/>
                <text x="425" y="150" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Gateway</text>
            </g>

            <path d="M 500 155 L 600 155" stroke="#6366f1" stroke-width="2" marker-end="url(#arrowhead)"/>
            <text x="530" y="145" font-size="10" fill="#4338ca">Extract ID</text>

            <!-- Rate Limiter -->
            <g class="component">
                <rect x="600" y="120" width="200" height="70" rx="10" fill="url(#grad-limiter)" stroke="#4d7c0f" stroke-width="2"/>
                <text x="700" y="150" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Rate Limiter</text>
            </g>

            <path d="M 800 155 L 900 155" stroke="#6366f1" stroke-width="2" marker-end="url(#arrowhead)"/>
            <text x="830" y="145" font-size="10" fill="#4338ca">If allowed</text>

            <!-- Backend Service -->
            <g class="component">
                <rect x="900" y="120" width="150" height="70" rx="10" fill="#e0f2fe" stroke="#0284c7" stroke-width="2"/>
                <text x="975" y="150" font-size="14" font-weight="bold" text-anchor="middle" fill="#075985">Backend</text>
            </g>

            <!-- Storage Layer -->
            <text x="100" y="280" font-size="14" font-weight="bold" fill="#64748b">STORAGE & COORDINATION</text>
            <line x1="100" y1="290" x2="1500" y2="290" stroke="#e2e8f0" stroke-width="2"/>

            <!-- Redis -->
            <g class="component">
                <rect x="200" y="320" width="300" height="150" rx="10" fill="url(#grad-redis)" stroke="#db2777" stroke-width="2"/>
                <text x="350" y="355" font-size="16" font-weight="bold" text-anchor="middle" fill="white">Redis Cluster</text>
                <text x="220" y="385" font-size="11" text-anchor="start" fill="white">‚Ä¢ Atomic counters</text>
                <text x="220" y="405" font-size="11" text-anchor="start" fill="white">‚Ä¢ Sliding windows</text>
                <text x="220" y="425" font-size="11" text-anchor="start" fill="white">‚Ä¢ Token buckets</text>
                <text x="220" y="445" font-size="11" text-anchor="start" fill="white">‚Ä¢ Lua scripts</text>
            </g>

            <path d="M 700 190 L 350 320" stroke="#ec4899" stroke-width="2" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>
            <text x="500" y="250" font-size="10" fill="#9f1239">Query state</text>

            <!-- Configuration DB -->
            <g class="component">
                <rect x="600" y="320" width="250" height="150" rx="10" fill="#dbeafe" stroke="#0284c7" stroke-width="2"/>
                <text x="725" y="355" font-size="16" font-weight="bold" text-anchor="middle" fill="#075985">Config DB</text>
                <text x="620" y="385" font-size="11" text-anchor="start" fill="#075985">‚Ä¢ Rate limit rules</text>
                <text x="620" y="405" font-size="11" text-anchor="start" fill="#075985">‚Ä¢ Tenant quotas</text>
                <text x="620" y="425" font-size="11" text-anchor="start" fill="#075985">‚Ä¢ Algorithm configs</text>
            </g>

            <!-- ZooKeeper -->
            <g class="component">
                <rect x="950" y="320" width="250" height="150" rx="10" fill="#e9d5ff" stroke="#9333ea" stroke-width="2"/>
                <text x="1075" y="355" font-size="16" font-weight="bold" text-anchor="middle" fill="#6b21a8">ZooKeeper</text>
                <text x="970" y="385" font-size="11" text-anchor="start" fill="#6b21a8">‚Ä¢ Leader election</text>
                <text x="970" y="405" font-size="11" text-anchor="start" fill="#6b21a8">‚Ä¢ Node discovery</text>
                <text x="970" y="425" font-size="11" text-anchor="start" fill="#6b21a8">‚Ä¢ Config sync</text>
            </g>

            <!-- Analytics Layer -->
            <text x="100" y="550" font-size="14" font-weight="bold" fill="#64748b">ANALYTICS & MONITORING</text>
            <line x1="100" y1="560" x2="1500" y2="560" stroke="#e2e8f0" stroke-width="2"/>

            <!-- Kafka -->
            <g class="component">
                <rect x="200" y="590" width="250" height="120" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                <text x="325" y="625" font-size="16" font-weight="bold" text-anchor="middle" fill="#92400e">Kafka</text>
                <text x="220" y="655" font-size="11" text-anchor="start" fill="#92400e">Topics:</text>
                <text x="220" y="675" font-size="10" text-anchor="start" fill="#92400e">‚Ä¢ rate.limit.exceeded</text>
                <text x="220" y="695" font-size="10" text-anchor="start" fill="#92400e">‚Ä¢ quota.reset</text>
            </g>

            <path d="M 700 190 L 325 590" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>
            <text x="500" y="400" font-size="10" fill="#92400e">Publish events</text>

            <!-- TimescaleDB -->
            <g class="component">
                <rect x="550" y="590" width="250" height="120" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="2"/>
                <text x="675" y="625" font-size="16" font-weight="bold" text-anchor="middle" fill="#065f46">TimescaleDB</text>
                <text x="570" y="655" font-size="11" text-anchor="start" fill="#065f46">‚Ä¢ Historical data</text>
                <text x="570" y="675" font-size="11" text-anchor="start" fill="#065f46">‚Ä¢ Time-series metrics</text>
            </g>

            <path d="M 450 650 L 550 650" stroke="#10b981" stroke-width="2" marker-end="url(#arrowhead)"/>

            <!-- Grafana -->
            <g class="component">
                <rect x="900" y="590" width="250" height="120" rx="10" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
                <text x="1025" y="625" font-size="16" font-weight="bold" text-anchor="middle" fill="#991b1b">Grafana</text>
                <text x="920" y="655" font-size="11" text-anchor="start" fill="#991b1b">‚Ä¢ Real-time dashboards</text>
                <text x="920" y="675" font-size="11" text-anchor="start" fill="#991b1b">‚Ä¢ Alerting</text>
            </g>

            <path d="M 800 650 L 900 650" stroke="#dc2626" stroke-width="2" marker-end="url(#arrowhead)"/>

            <!-- Data Flow Annotations -->
            <text x="100" y="800" font-size="14" font-weight="bold" fill="#64748b">KEY DATA FLOWS</text>

            <g>
                <rect x="100" y="820" width="350" height="100" rx="10" fill="#f0f9ff" stroke="#0284c7" stroke-width="2"/>
                <text x="275" y="850" font-size="13" font-weight="bold" text-anchor="middle" fill="#075985">Request Flow</text>
                <text x="120" y="875" font-size="10" text-anchor="start" fill="#0c4a6e">1. Client ‚Üí Gateway (auth)</text>
                <text x="120" y="895" font-size="10" text-anchor="start" fill="#0c4a6e">2. Gateway ‚Üí Rate Limiter (check)</text>
                <text x="120" y="915" font-size="10" text-anchor="start" fill="#0c4a6e">3. Rate Limiter ‚Üí Redis (atomic op)</text>
            </g>

            <g>
                <rect x="500" y="820" width="350" height="100" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                <text x="675" y="850" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Config Sync Flow</text>
                <text x="520" y="875" font-size="10" text-anchor="start" fill="#92400e">1. Config DB ‚Üí ZooKeeper (publish)</text>
                <text x="520" y="895" font-size="10" text-anchor="start" fill="#92400e">2. ZooKeeper ‚Üí All nodes (broadcast)</text>
                <text x="520" y="915" font-size="10" text-anchor="start" fill="#92400e">3. Nodes ‚Üí Local cache (update)</text>
            </g>

            <g>
                <rect x="900" y="820" width="350" height="100" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="2"/>
                <text x="1075" y="850" font-size="13" font-weight="bold" text-anchor="middle" fill="#065f46">Analytics Flow</text>
                <text x="920" y="875" font-size="10" text-anchor="start" fill="#065f46">1. Rate Limiter ‚Üí Kafka (events)</text>
                <text x="920" y="895" font-size="10" text-anchor="start" fill="#065f46">2. Kafka ‚Üí TimescaleDB (consume)</text>
                <text x="920" y="915" font-size="10" text-anchor="start" fill="#065f46">3. Grafana ‚Üí Query & visualize</text>
            </g>
        </svg>

        <div class="flow-description">
            <h3>üèóÔ∏è Complete System Architecture Flow</h3>
            <p style="margin-bottom: 15px; line-height: 1.8;">
                This diagram shows how all components work together in a production-grade distributed rate limiter.
            </p>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px;">
                <div style="background: #f0f9ff; padding: 15px; border-radius: 10px; border-left: 4px solid #0284c7;">
                    <h4 style="color: #075985; margin-bottom: 8px;">üîµ Critical Path (Low Latency)</h4>
                    <p style="font-size: 0.9em; color: #0c4a6e; line-height: 1.6;">
                        Client ‚Üí Gateway ‚Üí Rate Limiter ‚Üí Redis ‚Üí Backend
                        <br><strong>Target:</strong> <5ms decision time
                    </p>
                </div>
                <div style="background: #fef3c7; padding: 15px; border-radius: 10px; border-left: 4px solid #f59e0b;">
                    <h4 style="color: #92400e; margin-bottom: 8px;">üü° Coordination Path (Eventual Consistency)</h4>
                    <p style="font-size: 0.9em; color: #92400e; line-height: 1.6;">
                        Config DB ‚Üí ZooKeeper ‚Üí All Nodes
                        <br><strong>Target:</strong> <100ms propagation
                    </p>
                </div>
                <div style="background: #d1fae5; padding: 15px; border-radius: 10px; border-left: 4px solid #10b981;">
                    <h4 style="color: #065f46; margin-bottom: 8px;">üü¢ Analytics Path (Asynchronous)</h4>
                    <p style="font-size: 0.9em; color: #064e3b; line-height: 1.6;">
                        Rate Limiter ‚Üí Kafka ‚Üí TimescaleDB ‚Üí Grafana
                        <br><strong>Target:</strong> Real-time dashboards
                    </p>
                </div>
                <div style="background: #fee2e2; padding: 15px; border-radius: 10px; border-left: 4px solid #dc2626;">
                    <h4 style="color: #991b1b; margin-bottom: 8px;">üî¥ Failure Handling</h4>
                    <p style="font-size: 0.9em; color: #7f1d1d; line-height: 1.6;">
                        Redis down ‚Üí Fail-open (allow) or Fail-closed (reject)
                        <br>ZooKeeper down ‚Üí Use cached config
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Metrics Panel -->
    <div class="metrics-panel">
        <h2 style="margin-bottom: 15px; color: #92400e;">‚ö° Rate Limiter Performance Metrics</h2>
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value">1M</div>
                <div class="metric-label">QPS Handled</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">&lt;5ms</div>
                <div class="metric-label">P99 Latency</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">99.999%</div>
                <div class="metric-label">Availability</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">100M</div>
                <div class="metric-label">Active Keys</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">&lt;100ms</div>
                <div class="metric-label">Config Sync Time</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">10TB</div>
                <div class="metric-label">Redis Memory</div>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #60a5fa, #3b82f6);"></div>
            <span>Client Layer</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #f87171, #ef4444);"></div>
            <span>Gateway</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #84cc16, #65a30d);"></div>
            <span>Rate Limiter</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #f472b6, #ec4899);"></div>
            <span>Redis</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #c084fc, #a855f7);"></div>
            <span>Coordination</span>
        </div>
    </div>
</div>

<script>
    function showDiagram(type) {
        // Hide all diagrams
        document.querySelectorAll('.diagram-container').forEach(d => {
            d.classList.remove('active');
        });

        // Remove active from all tabs
        document.querySelectorAll('.tab').forEach(t => {
            t.classList.remove('active');
        });

        // Show selected diagram
        document.getElementById(type + '-diagram').classList.add('active');

        // Activate clicked tab
        event.target.classList.add('active');
    }

    // Add hover effects
    document.querySelectorAll('.component').forEach(comp => {
        comp.addEventListener('mouseenter', function() {
            this.style.filter = 'drop-shadow(0 0 15px rgba(99, 102, 241, 0.6))';
        });

        comp.addEventListener('mouseleave', function() {
            this.style.filter = 'none';
        });
    });
</script>
</body>
</html>
