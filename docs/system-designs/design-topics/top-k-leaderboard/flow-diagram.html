<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top K Leaderboard Flow Diagrams</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #8b5cf6;
        }

        .header h1 {
            font-size: 2.5em;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .tab {
            padding: 12px 30px;
            background: #e2e8f0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: #8b5cf6;
            color: white;
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .diagram-container {
            display: none;
            margin-top: 30px;
        }

        .diagram-container.active {
            display: block;
        }

        svg {
            width: 100%;
            height: auto;
        }

        .component {
            cursor: pointer;
            transition: all 0.3s;
        }

        .component:hover {
            filter: drop-shadow(0 0 10px rgba(139, 92, 246, 0.5));
        }

        .component rect {
            transition: all 0.3s;
        }

        .component:hover rect {
            stroke-width: 3;
        }

        .flow-arrow {
            animation: dash 20s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -1000;
            }
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            border: 2px solid #cbd5e0;
        }

        .metrics-panel {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde047 100%);
            border-radius: 15px;
            border: 2px solid #fbbf24;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #8b5cf6;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #8b5cf6;
        }

        .metric-label {
            font-size: 0.9em;
            color: #4a5568;
            margin-top: 5px;
        }

        .flow-description {
            background: #e0e7ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 5px solid #8b5cf6;
        }

        .flow-description h3 {
            color: #5b21b6;
            margin-bottom: 10px;
        }

        .flow-description ol {
            margin-left: 20px;
            line-height: 2;
            color: #1e293b;
        }

        .flow-description ol li {
            margin: 8px 0;
        }

        .flow-description strong {
            color: #8b5cf6;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üèÜ Top K Leaderboard Flow Diagrams</h1>
        <p style="color: #64748b; margin-top: 10px;">Interactive Data Flow Visualization</p>

        <div class="tabs">
            <button class="tab active" onclick="showDiagram('update')">‚úçÔ∏è Score Update Flow</button>
            <button class="tab" onclick="showDiagram('query')">üîç Leaderboard Query Flow</button>
            <button class="tab" onclick="showDiagram('full')">üèóÔ∏è Complete System Flow</button>
        </div>
    </div>

    <!-- Score Update Flow Diagram -->
    <div id="update-diagram" class="diagram-container active">
        <svg viewBox="0 0 1400 1200" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#8b5cf6" />
                </marker>
                <linearGradient id="grad-client" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-lb" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#818cf8;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#6366f1;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-gateway" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#22d3ee;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#06b6d4;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-update" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#f87171;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#ef4444;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-redis" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#f472b6;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-kafka" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#fb923c;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#f97316;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-db" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#fbbf24;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#f59e0b;stop-opacity:1" />
                </linearGradient>
            </defs>

            <!-- Title -->
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Score Update Flow: Updating User's Score
            </text>

            <!-- Client -->
            <g class="component">
                <rect x="600" y="70" width="200" height="80" rx="10" fill="url(#grad-client)" stroke="#2563eb" stroke-width="2"/>
                <text x="700" y="105" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üë§ Mobile Client</text>
                <text x="700" y="125" font-size="12" text-anchor="middle" fill="white">Game App</text>
            </g>

            <!-- Arrow 1 -->
            <path d="M 700 150 L 700 200" stroke="#8b5cf6" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="180" font-size="11" fill="#5b21b6" font-weight="600">POST /scores</text>

            <!-- Load Balancer -->
            <g class="component">
                <rect x="600" y="200" width="200" height="80" rx="10" fill="url(#grad-lb)" stroke="#4f46e5" stroke-width="2"/>
                <text x="700" y="235" font-size="16" font-weight="bold" text-anchor="middle" fill="white">‚öñÔ∏è Load Balancer</text>
                <text x="700" y="255" font-size="12" text-anchor="middle" fill="white">ALB + Rate Limit</text>
            </g>

            <!-- Arrow 2 -->
            <path d="M 700 280 L 700 330" stroke="#8b5cf6" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="310" font-size="11" fill="#5b21b6" font-weight="600">Authorize</text>

            <!-- API Gateway -->
            <g class="component">
                <rect x="600" y="330" width="200" height="80" rx="10" fill="url(#grad-gateway)" stroke="#0891b2" stroke-width="2"/>
                <text x="700" y="365" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üö™ API Gateway</text>
                <text x="700" y="385" font-size="12" text-anchor="middle" fill="white">JWT Auth + Validate</text>
            </g>

            <!-- Arrow 3 -->
            <path d="M 700 410 L 700 460" stroke="#8b5cf6" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="440" font-size="11" fill="#5b21b6" font-weight="600">score_delta: +50</text>

            <!-- Update Service -->
            <g class="component">
                <rect x="550" y="460" width="300" height="100" rx="10" fill="url(#grad-update)" stroke="#dc2626" stroke-width="2"/>
                <text x="700" y="495" font-size="16" font-weight="bold" text-anchor="middle" fill="white">‚úçÔ∏è Score Update Service</text>
                <text x="700" y="515" font-size="12" text-anchor="middle" fill="white">Go Microservice</text>
                <text x="700" y="535" font-size="11" text-anchor="middle" fill="white">‚Ä¢ Validate Score ‚Ä¢ Anti-Cheat Check</text>
            </g>

            <!-- Arrow to Redis -->
            <path d="M 700 560 L 700 640" stroke="#8b5cf6" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="605" font-size="11" fill="#5b21b6" font-weight="600">ZINCRBY</text>

            <!-- Redis Sorted Set -->
            <g class="component">
                <rect x="550" y="640" width="300" height="120" rx="10" fill="url(#grad-redis)" stroke="#db2777" stroke-width="2"/>
                <text x="700" y="680" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üíæ Redis Sorted Set</text>
                <text x="700" y="700" font-size="12" text-anchor="middle" fill="white">global:alltime:world</text>
                <text x="700" y="720" font-size="11" text-anchor="middle" fill="white">ZINCRBY global:alltime:world 50 "user:12345"</text>
                <text x="700" y="740" font-size="10" text-anchor="middle" fill="white">O(log N) = ~27 operations for 100M users</text>
            </g>

            <!-- Get Rank Arrow -->
            <path d="M 850 700 L 1020 700" stroke="#10b981" stroke-width="3" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>
            <text x="900" y="690" font-size="11" fill="#059669" font-weight="600">ZREVRANK</text>

            <!-- Rank Response -->
            <g class="component">
                <rect x="1020" y="650" width="200" height="100" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="3"/>
                <text x="1120" y="685" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">‚úÖ New Rank</text>
                <text x="1120" y="705" font-size="12" text-anchor="middle" fill="#065f46">Rank: 2345</text>
                <text x="1120" y="725" font-size="11" text-anchor="middle" fill="#065f46">Score: 1550</text>
            </g>

            <!-- Arrow to Kafka -->
            <path d="M 550 510 L 250 510 L 250 820" stroke="#8b5cf6" stroke-width="3" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>
            <text x="350" y="660" font-size="11" fill="#5b21b6" font-weight="600">Async Event</text>

            <!-- Kafka -->
            <g class="component">
                <rect x="150" y="820" width="200" height="100" rx="10" fill="url(#grad-kafka)" stroke="#ea580c" stroke-width="2"/>
                <text x="250" y="855" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üì¨ Kafka Topic</text>
                <text x="250" y="875" font-size="11" text-anchor="middle" fill="white">score.updated</text>
                <text x="250" y="895" font-size="10" text-anchor="middle" fill="white">Event: {user, old, new, delta}</text>
            </g>

            <!-- Arrow to PostgreSQL -->
            <path d="M 250 920 L 250 1020" stroke="#8b5cf6" stroke-width="2" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>
            <text x="270" y="975" font-size="10" fill="#5b21b6">Persist</text>

            <!-- PostgreSQL -->
            <g class="component">
                <rect x="150" y="1020" width="200" height="80" rx="10" fill="url(#grad-db)" stroke="#d97706" stroke-width="2"/>
                <text x="250" y="1055" font-size="13" font-weight="bold" text-anchor="middle" fill="white">üóÑÔ∏è PostgreSQL</text>
                <text x="250" y="1075" font-size="10" text-anchor="middle" fill="white">score_history table</text>
            </g>

            <!-- Arrow to Analytics (from Kafka) -->
            <path d="M 350 870 L 520 870" stroke="#8b5cf6" stroke-width="2" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>
            <text x="410" y="860" font-size="10" fill="#5b21b6">Consume</text>

            <!-- Analytics -->
            <g class="component">
                <rect x="520" y="830" width="200" height="80" rx="10" fill="#e9d5ff" stroke="#a855f7" stroke-width="2"/>
                <text x="620" y="865" font-size="13" font-weight="bold" text-anchor="middle" fill="#7e22ce">üìä Analytics</text>
                <text x="620" y="885" font-size="10" text-anchor="middle" fill="#7e22ce">Real-time Stats</text>
            </g>

            <!-- Response Arrow -->
            <path d="M 1020 700 L 950 700 L 950 340 L 800 340" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="8,4"/>
            <text x="880" y="520" font-size="12" fill="#059669" font-weight="700">‚Üê Response</text>
            <text x="880" y="540" font-size="11" fill="#059669">200 OK</text>
            <text x="880" y="555" font-size="10" fill="#059669">{rank: 2345, score: 1550}</text>

            <!-- Step Numbers -->
            <circle cx="700" cy="110" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="117" font-size="14" font-weight="bold" text-anchor="middle" fill="white">1</text>

            <circle cx="700" cy="240" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="247" font-size="14" font-weight="bold" text-anchor="middle" fill="white">2</text>

            <circle cx="700" cy="370" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="377" font-size="14" font-weight="bold" text-anchor="middle" fill="white">3</text>

            <circle cx="700" cy="510" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="517" font-size="14" font-weight="bold" text-anchor="middle" fill="white">4</text>

            <circle cx="700" cy="700" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="707" font-size="14" font-weight="bold" text-anchor="middle" fill="white">5</text>

            <circle cx="1120" cy="700" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="1120" y="707" font-size="14" font-weight="bold" text-anchor="middle" fill="white">6</text>

            <circle cx="250" cy="870" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="250" y="877" font-size="14" font-weight="bold" text-anchor="middle" fill="white">7</text>
        </svg>

        <div class="flow-description">
            <h3>‚úçÔ∏è Score Update Flow Steps</h3>
            <ol>
                <li><strong>Client Request:</strong> User completes game level, app sends score update: <code>POST /api/v1/scores {"score_delta": 50}</code></li>
                <li><strong>Load Balancer:</strong> ALB performs rate limiting (50 req/sec/user) and routes to healthy Update Service instance</li>
                <li><strong>API Gateway:</strong> Validates JWT token, checks user quota, authorizes request</li>
                <li><strong>Update Service:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Anti-cheat validation: Is delta reasonable? (< 1000 points/min)</li>
                        <li>Statistical check: Is this 10x user's average increase?</li>
                        <li>If valid, proceed to Redis update</li>
                    </ul>
                </li>
                <li><strong>Redis ZINCRBY:</strong> Atomically increments user's score in sorted set
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li><code>ZINCRBY global:alltime:world 50 "user:12345"</code></li>
                        <li>Redis skip list ensures O(log N) = ~27 operations for 100M users</li>
                        <li>Automatic re-sorting maintains leaderboard order</li>
                    </ul>
                </li>
                <li><strong>Get New Rank:</strong> Immediately query user's new rank: <code>ZREVRANK global:alltime:world "user:12345"</code>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Also O(log N) - fast lookup</li>
                        <li>Returns 0-indexed rank (0 = #1 position)</li>
                    </ul>
                </li>
                <li><strong>Event Publishing:</strong> Asynchronously publish score update event to Kafka (non-blocking)
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Event consumed by Analytics service (real-time stats)</li>
                        <li>Event consumed by PostgreSQL writer (audit trail)</li>
                    </ul>
                </li>
                <li><strong>Response:</strong> Return new score and rank to client: <code>{"new_score": 1550, "rank": 2345}</code></li>
            </ol>
            <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 5px;">
                <strong>üéØ Performance:</strong> Total latency < 100ms (P95) - Redis in-memory operations are blazing fast! Anti-cheat validation adds < 20ms overhead.
            </div>
        </div>
    </div>

    <!-- Leaderboard Query Flow -->
    <div id="query-diagram" class="diagram-container">
        <svg viewBox="0 0 1400 1100" xmlns="http://www.w3.org/2000/svg">
            <!-- Title -->
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Leaderboard Query Flow: Get Top 100 Users
            </text>

            <!-- Client -->
            <g class="component">
                <rect x="600" y="70" width="200" height="80" rx="10" fill="url(#grad-client)" stroke="#2563eb" stroke-width="2"/>
                <text x="700" y="105" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üë§ Client</text>
                <text x="700" y="125" font-size="12" text-anchor="middle" fill="white">Web/Mobile App</text>
            </g>

            <!-- Arrow -->
            <path d="M 700 150 L 700 200" stroke="#8b5cf6" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="180" font-size="11" fill="#5b21b6" font-weight="600">GET /top?k=100</text>

            <!-- CDN Edge -->
            <g class="component">
                <rect x="550" y="200" width="300" height="100" rx="10" fill="url(#grad-gateway)" stroke="#0891b2" stroke-width="2"/>
                <text x="700" y="240" font-size="16" font-weight="bold" text-anchor="middle" fill="white">‚ö° CDN Edge Cache</text>
                <text x="700" y="260" font-size="12" text-anchor="middle" fill="white">CloudFront</text>
                <text x="700" y="280" font-size="11" text-anchor="middle" fill="white">Cache top 100 with 10-sec TTL</text>
            </g>

            <!-- Decision Diamond -->
            <g class="component">
                <path d="M 700 340 L 800 410 L 700 480 L 600 410 Z" fill="#fef3c7" stroke="#f59e0b" stroke-width="3"/>
                <text x="700" y="405" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">CDN</text>
                <text x="700" y="423" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Hit?</text>
            </g>

            <!-- CDN Hit Path (Right) -->
            <path d="M 800 410 L 950 410" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>
            <text x="850" y="400" font-size="12" fill="#059669" font-weight="700">YES ‚úì</text>

            <g class="component">
                <rect x="950" y="360" width="200" height="100" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="3"/>
                <text x="1050" y="395" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">‚úÖ CDN Response</text>
                <text x="1050" y="415" font-size="12" text-anchor="middle" fill="#065f46">Top 100 (cached)</text>
                <text x="1050" y="435" font-size="11" text-anchor="middle" fill="#065f46">Latency: ~10ms</text>
            </g>

            <path d="M 1050 360 L 1050 120 L 800 120" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="8,4"/>
            <text x="1070" y="240" font-size="12" fill="#059669" font-weight="700">Fast Path</text>

            <!-- CDN Miss Path (Bottom) -->
            <path d="M 700 480 L 700 550" stroke="#ef4444" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>
            <text x="630" y="520" font-size="12" fill="#dc2626" font-weight="700">NO ‚úó</text>

            <!-- Load Balancer -->
            <g class="component">
                <rect x="600" y="550" width="200" height="80" rx="10" fill="url(#grad-lb)" stroke="#4f46e5" stroke-width="2"/>
                <text x="700" y="585" font-size="16" font-weight="bold" text-anchor="middle" fill="white">‚öñÔ∏è Load Balancer</text>
                <text x="700" y="605" font-size="12" text-anchor="middle" fill="white">Route to Backend</text>
            </g>

            <!-- Arrow -->
            <path d="M 700 630 L 700 680" stroke="#8b5cf6" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>

            <!-- Query Service -->
            <g class="component">
                <rect x="550" y="680" width="300" height="100" rx="10" fill="#ddd6fe" stroke="#a78bfa" stroke-width="2"/>
                <text x="700" y="715" font-size="16" font-weight="bold" text-anchor="middle" fill="#5b21b6">üîç Query Service</text>
                <text x="700" y="735" font-size="12" text-anchor="middle" fill="#5b21b6">Leaderboard Read Service</text>
                <text x="700" y="755" font-size="11" text-anchor="middle" fill="#5b21b6">Check app cache ‚Üí Redis</text>
            </g>

            <!-- Application Cache Check -->
            <g class="component">
                <path d="M 700 820 L 800 890 L 700 960 L 600 890 Z" fill="#fef3c7" stroke="#f59e0b" stroke-width="3"/>
                <text x="700" y="885" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">App</text>
                <text x="700" y="903" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Cache?</text>
            </g>

            <!-- App Cache Hit (Right) -->
            <path d="M 800 890 L 950 890" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>
            <text x="850" y="880" font-size="12" fill="#059669" font-weight="700">YES ‚úì</text>

            <g class="component">
                <rect x="950" y="840" width="180" height="100" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="3"/>
                <text x="1040" y="875" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">‚úÖ Instant</text>
                <text x="1040" y="895" font-size="12" text-anchor="middle" fill="#065f46">Top 100</text>
                <text x="1040" y="915" font-size="11" text-anchor="middle" fill="#065f46">Latency: <5ms</text>
            </g>

            <!-- App Cache Miss (Bottom) -->
            <path d="M 700 960 L 700 1020" stroke="#ef4444" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>
            <text x="630" y="995" font-size="12" fill="#dc2626" font-weight="700">NO ‚úó</text>

            <!-- Redis Query -->
            <g class="component">
                <rect x="500" y="1020" width="400" height="100" rx="10" fill="url(#grad-redis)" stroke="#db2777" stroke-width="2"/>
                <text x="700" y="1055" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üíæ Redis ZREVRANGE</text>
                <text x="700" y="1075" font-size="12" text-anchor="middle" fill="white">ZREVRANGE global:alltime:world 0 99 WITHSCORES</text>
                <text x="700" y="1095" font-size="11" text-anchor="middle" fill="white">O(log N + K) = O(log 100M + 100) = ~27 + 100 = 127 ops</text>
            </g>

            <!-- Response with cache update -->
            <path d="M 500 1070 L 300 1070 L 300 730 L 550 730" stroke="#8b5cf6" stroke-width="3" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>
            <text x="380" y="900" font-size="11" fill="#5b21b6">Update app cache</text>

            <!-- Final Response -->
            <path d="M 1040 840 L 1040 590 L 800 590" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="8,4"/>

            <!-- Step Numbers -->
            <circle cx="700" cy="110" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="117" font-size="14" font-weight="bold" text-anchor="middle" fill="white">1</text>

            <circle cx="700" cy="250" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="257" font-size="14" font-weight="bold" text-anchor="middle" fill="white">2</text>

            <circle cx="700" cy="590" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="597" font-size="14" font-weight="bold" text-anchor="middle" fill="white">3</text>

            <circle cx="700" cy="730" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="737" font-size="14" font-weight="bold" text-anchor="middle" fill="white">4</text>

            <circle cx="700" cy="1070" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="1077" font-size="14" font-weight="bold" text-anchor="middle" fill="white">5</text>
        </svg>

        <div class="flow-description">
            <h3>üîç Leaderboard Query Flow Steps</h3>
            <ol>
                <li><strong>Client Request:</strong> User opens leaderboard screen: <code>GET /api/v1/leaderboard/top?k=100&type=global</code></li>
                <li><strong>CDN Edge Check:</strong> CloudFront checks if top 100 is cached at edge location
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li><strong>Cache Hit (70%):</strong> Returns cached result immediately (~10ms latency) ‚úÖ</li>
                        <li><strong>Cache Miss (30%):</strong> Forwards to origin servers ‚Üì</li>
                        <li>TTL: 10 seconds (balances freshness vs load reduction)</li>
                    </ul>
                </li>
                <li><strong>Load Balancer:</strong> Routes request to healthy Query Service instance (round robin)</li>
                <li><strong>Query Service & Application Cache:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Check in-process cache (Caffeine/Guava) with 10-sec TTL</li>
                        <li><strong>App Cache Hit (80%):</strong> Returns instantly (<5ms) ‚úÖ</li>
                        <li><strong>App Cache Miss (20%):</strong> Query Redis ‚Üì</li>
                    </ul>
                </li>
                <li><strong>Redis ZREVRANGE:</strong> Fetch top 100 users from sorted set
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li><code>ZREVRANGE global:alltime:world 0 99 WITHSCORES</code></li>
                        <li>Returns list of 100 users with scores, sorted descending</li>
                        <li>Time complexity: O(log N + K) = O(log 100M + 100) ‚âà 127 operations</li>
                        <li>Latency: ~20-30ms (in-memory lookup)</li>
                        <li>Update application cache with result</li>
                    </ul>
                </li>
                <li><strong>Response Enrichment:</strong> Query Service fetches user metadata (username, avatar) from cache/DB</li>
                <li><strong>Response:</strong> Returns top 100 with full user details:
                    <div style="background: #1e293b; color: #e2e8f0; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 0.85em; margin-top: 5px;">
{
  "leaderboard_type": "global",
  "total_users": 100000000,
  "top_users": [
    {"rank": 1, "user_id": "999", "username": "ProGamer", "score": 9850},
    {"rank": 2, "user_id": "777", "username": "ElitePlayer", "score": 9720},
    ...
  ]
}</div>
                </li>
            </ol>
            <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 5px;">
                <strong>üéØ Multi-Tier Caching Strategy:</strong>
                <ul style="margin-top: 5px;">
                    <li><strong>CDN (70% hit):</strong> ~10ms latency, reduces backend load by 70%</li>
                    <li><strong>App Cache (80% of CDN misses):</strong> ~5ms latency, reduces Redis load by 80%</li>
                    <li><strong>Redis (remaining 6%):</strong> ~30ms latency, still fast!</li>
                    <li><strong>Total:</strong> 94% of queries served in < 10ms! Only 6% hit Redis.</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Full System Flow -->
    <div id="full-diagram" class="diagram-container">
        <svg viewBox="0 0 1600 1000" xmlns="http://www.w3.org/2000/svg">
            <!-- Title -->
            <text x="800" y="35" font-size="28" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Complete Top K Leaderboard System Flow
            </text>

            <!-- Clients -->
            <g class="component">
                <rect x="300" y="80" width="150" height="70" rx="10" fill="url(#grad-client)" stroke="#2563eb" stroke-width="2"/>
                <text x="375" y="120" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Mobile Apps</text>
            </g>
            <g class="component">
                <rect x="500" y="80" width="150" height="70" rx="10" fill="url(#grad-client)" stroke="#2563eb" stroke-width="2"/>
                <text x="575" y="120" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Web Clients</text>
            </g>
            <g class="component">
                <rect x="700" y="80" width="150" height="70" rx="10" fill="url(#grad-client)" stroke="#2563eb" stroke-width="2"/>
                <text x="775" y="120" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Game Servers</text>
            </g>

            <!-- Arrows down -->
            <path d="M 375 150 L 375 210" stroke="#8b5cf6" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 575 150 L 575 210" stroke="#8b5cf6" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 775 150 L 775 210" stroke="#8b5cf6" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <!-- CDN -->
            <g class="component">
                <rect x="400" y="210" width="300" height="80" rx="10" fill="url(#grad-gateway)" stroke="#0891b2" stroke-width="2"/>
                <text x="550" y="250" font-size="14" font-weight="bold" text-anchor="middle" fill="white">‚ö° CDN + WAF</text>
                <text x="550" y="270" font-size="11" text-anchor="middle" fill="white">CloudFront + DDoS Protection</text>
            </g>

            <!-- Arrow down -->
            <path d="M 550 290 L 550 340" stroke="#8b5cf6" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Load Balancer + API Gateway -->
            <g class="component">
                <rect x="250" y="340" width="180" height="80" rx="10" fill="url(#grad-lb)" stroke="#4f46e5" stroke-width="2"/>
                <text x="340" y="375" font-size="13" font-weight="bold" text-anchor="middle" fill="white">‚öñÔ∏è Load Balancer</text>
                <text x="340" y="395" font-size="10" text-anchor="middle" fill="white">ALB + Rate Limit</text>
            </g>
            <g class="component">
                <rect x="470" y="340" width="180" height="80" rx="10" fill="url(#grad-gateway)" stroke="#0891b2" stroke-width="2"/>
                <text x="560" y="375" font-size="13" font-weight="bold" text-anchor="middle" fill="white">üö™ API Gateway</text>
                <text x="560" y="395" font-size="10" text-anchor="middle" fill="white">Auth + Validation</text>
            </g>

            <!-- Arrows to services -->
            <path d="M 340 420 L 300 480" stroke="#8b5cf6" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 560 420 L 560 480" stroke="#8b5cf6" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Microservices -->
            <g class="component">
                <rect x="220" y="480" width="160" height="80" rx="10" fill="url(#grad-update)" stroke="#dc2626" stroke-width="2"/>
                <text x="300" y="515" font-size="12" font-weight="bold" text-anchor="middle" fill="white">‚úçÔ∏è Update Service</text>
                <text x="300" y="535" font-size="9" text-anchor="middle" fill="white">Score Updates</text>
            </g>
            <g class="component">
                <rect x="420" y="480" width="160" height="80" rx="10" fill="#ddd6fe" stroke="#a78bfa" stroke-width="2"/>
                <text x="500" y="515" font-size="12" font-weight="bold" text-anchor="middle" fill="white">üîç Query Service</text>
                <text x="500" y="535" font-size="9" text-anchor="middle" fill="white">Top K, Rank Queries</text>
            </g>
            <g class="component">
                <rect x="620" y="480" width="160" height="80" rx="10" fill="#e9d5ff" stroke="#a855f7" stroke-width="2"/>
                <text x="700" y="515" font-size="11" font-weight="bold" text-anchor="middle" fill="#7e22ce">üìä Analytics</text>
                <text x="700" y="535" font-size="9" text-anchor="middle" fill="#7e22ce">Stats & Reports</text>
            </g>

            <!-- Arrows to Redis -->
            <path d="M 300 560 L 400 650" stroke="#8b5cf6" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 500 560 L 450 650" stroke="#8b5cf6" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Redis Cluster -->
            <g class="component">
                <rect x="250" y="650" width="400" height="120" rx="10" fill="url(#grad-redis)" stroke="#db2777" stroke-width="2"/>
                <text x="450" y="690" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üíæ Redis Cluster (Sorted Sets)</text>
                <text x="450" y="710" font-size="12" text-anchor="middle" fill="white">Shard 1: Global | Shard 2: Regional | Shard 3: Time-based</text>
                <text x="450" y="730" font-size="11" text-anchor="middle" fill="white">Master-Replica, AOF + RDB Persistence</text>
                <text x="450" y="750" font-size="10" text-anchor="middle" fill="white">40 GB memory, 10K QPS per shard</text>
            </g>

            <!-- PostgreSQL -->
            <g class="component">
                <rect x="250" y="810" width="180" height="100" rx="10" fill="url(#grad-db)" stroke="#d97706" stroke-width="2"/>
                <text x="340" y="850" font-size="13" font-weight="bold" text-anchor="middle" fill="white">üóÑÔ∏è PostgreSQL</text>
                <text x="340" y="870" font-size="10" text-anchor="middle" fill="white">Historical Data</text>
                <text x="340" y="890" font-size="9" text-anchor="middle" fill="white">5.2 TB (1 year)</text>
            </g>

            <!-- Kafka -->
            <g class="component">
                <rect x="470" y="810" width="180" height="100" rx="10" fill="url(#grad-kafka)" stroke="#ea580c" stroke-width="2"/>
                <text x="560" y="850" font-size="13" font-weight="bold" text-anchor="middle" fill="white">üì¨ Kafka</text>
                <text x="560" y="870" font-size="10" text-anchor="middle" fill="white">Event Streaming</text>
                <text x="560" y="890" font-size="9" text-anchor="middle" fill="white">score.updated topic</text>
            </g>

            <!-- Arrows from Redis to storage -->
            <path d="M 350 770 L 350 810" stroke="#8b5cf6" stroke-width="2" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>
            <path d="M 550 770 L 560 810" stroke="#8b5cf6" stroke-width="2" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>

            <!-- Monitoring (Right side) -->
            <g class="component">
                <rect x="900" y="480" width="250" height="90" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="2"/>
                <text x="1025" y="515" font-size="13" font-weight="bold" text-anchor="middle" fill="#065f46">üìà MONITORING</text>
                <text x="1025" y="535" font-size="10" text-anchor="middle" fill="#065f46">‚Ä¢ Prometheus + Grafana</text>
                <text x="1025" y="553" font-size="10" text-anchor="middle" fill="#065f46">‚Ä¢ Jaeger (Tracing)</text>
            </g>

            <g class="component">
                <rect x="900" y="600" width="250" height="90" rx="10" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
                <text x="1025" y="635" font-size="13" font-weight="bold" text-anchor="middle" fill="#991b1b">üõ°Ô∏è ANTI-CHEAT</text>
                <text x="1025" y="655" font-size="10" text-anchor="middle" fill="#991b1b">‚Ä¢ Score Validation</text>
                <text x="1025" y="673" font-size="10" text-anchor="middle" fill="#991b1b">‚Ä¢ Anomaly Detection</text>
            </g>

            <!-- Monitoring arrows -->
            <path d="M 780 520 L 900 520" stroke="#10b981" stroke-width="2" fill="none" stroke-dasharray="3,3"/>
            <path d="M 380 560 L 380 600 L 900 645" stroke="#dc2626" stroke-width="2" fill="none" stroke-dasharray="3,3"/>

            <!-- Labels -->
            <text x="450" y="620" font-size="12" fill="#8b5cf6" font-weight="600">‚Üê Write: ZADD, ZINCRBY</text>
            <text x="450" y="640" font-size="12" fill="#8b5cf6" font-weight="600">‚Üí Read: ZREVRANGE, ZREVRANK</text>
        </svg>

        <div class="flow-description">
            <h3>üèóÔ∏è Complete System Architecture Flow</h3>
            <p style="margin-bottom: 15px; line-height: 1.8;">
                This diagram shows the end-to-end data flow for the Top K Leaderboard system. The architecture is optimized for
                <strong>real-time performance</strong> with sub-50ms query latency and high write throughput (6K writes/sec peak).
            </p>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px;">
                <div style="background: #fef2f2; padding: 15px; border-radius: 10px; border-left: 4px solid #ef4444;">
                    <h4 style="color: #991b1b; margin-bottom: 8px;">‚úçÔ∏è Write Path (Score Updates)</h4>
                    <p style="font-size: 0.9em; color: #7f1d1d; line-height: 1.6;">
                        Client ‚Üí CDN/WAF ‚Üí LB ‚Üí API Gateway ‚Üí <strong>Update Service</strong> ‚Üí
                        Redis ZINCRBY (O(log N)) ‚Üí Kafka (async) ‚Üí PostgreSQL + Analytics
                    </p>
                    <p style="font-size: 0.85em; color: #991b1b; margin-top: 8px;">
                        <strong>Latency:</strong> <100ms P95 | <strong>Throughput:</strong> 6K writes/sec peak
                    </p>
                </div>
                <div style="background: #f0f9ff; padding: 15px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                    <h4 style="color: #1e40af; margin-bottom: 8px;">üîç Read Path (Queries)</h4>
                    <p style="font-size: 0.9em; color: #1e3a8a; line-height: 1.6;">
                        Client ‚Üí CDN (70% hit) ‚Üí LB ‚Üí <strong>Query Service</strong> ‚Üí
                        App Cache (80% hit) ‚Üí Redis ZREVRANGE (O(log N + K)) ‚Üí Response
                    </p>
                    <p style="font-size: 0.85em; color: #1e40af; margin-top: 8px;">
                        <strong>Latency:</strong> <50ms P95 | <strong>Cache Hit:</strong> 94% served in <10ms
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Metrics Panel -->
    <div class="metrics-panel">
        <h2 style="margin-bottom: 15px; color: #92400e;">‚ö° System Performance Characteristics</h2>
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value">O(log N)</div>
                <div class="metric-label">Time Complexity</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">~27</div>
                <div class="metric-label">Ops for 100M users</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">&lt;50ms</div>
                <div class="metric-label">P95 Query Latency</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">&lt;100ms</div>
                <div class="metric-label">P95 Update Latency</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">94%</div>
                <div class="metric-label">Cache Hit Rate</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">40 GB</div>
                <div class="metric-label">Redis Memory</div>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #60a5fa, #3b82f6);"></div>
            <span>Client Layer</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #22d3ee, #06b6d4);"></div>
            <span>Edge/Gateway</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #f87171, #ef4444);"></div>
            <span>Update Service</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #a78bfa, #8b5cf6);"></div>
            <span>Query Service</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #f472b6, #ec4899);"></div>
            <span>Redis (Primary)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #fb923c, #f97316);"></div>
            <span>Event Stream</span>
        </div>
    </div>
</div>

<script>
    function showDiagram(type) {
        // Hide all diagrams
        document.querySelectorAll('.diagram-container').forEach(d => {
            d.classList.remove('active');
        });

        // Remove active from all tabs
        document.querySelectorAll('.tab').forEach(t => {
            t.classList.remove('active');
        });

        // Show selected diagram
        document.getElementById(type + '-diagram').classList.add('active');

        // Activate clicked tab
        event.target.classList.add('active');
    }

    // Add hover effects
    document.querySelectorAll('.component').forEach(comp => {
        comp.addEventListener('mouseenter', function() {
            this.style.filter = 'drop-shadow(0 0 15px rgba(139, 92, 246, 0.6))';
        });

        comp.addEventListener('mouseleave', function() {
            this.style.filter = 'none';
        });
    });
</script>
</body>
</html>
