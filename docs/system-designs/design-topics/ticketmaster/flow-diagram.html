<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TicketMaster Architecture Flow Diagram</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #7c2d12 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #2563eb;
        }

        .header h1 {
            font-size: 2.5em;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 30px;
            background: #e2e8f0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: #2563eb;
            color: white;
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .diagram-container {
            display: none;
            margin-top: 30px;
        }

        .diagram-container.active {
            display: block;
        }

        svg {
            width: 100%;
            height: auto;
        }

        .component {
            cursor: pointer;
            transition: all 0.3s;
        }

        .component:hover {
            filter: drop-shadow(0 0 10px rgba(37, 99, 235, 0.5));
        }

        .component rect {
            transition: all 0.3s;
        }

        .component:hover rect {
            stroke-width: 3;
        }

        .flow-arrow {
            animation: dash 20s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -1000;
            }
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            border: 2px solid #cbd5e0;
        }

        .metrics-panel {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde047 100%);
            border-radius: 15px;
            border: 2px solid #fbbf24;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #2563eb;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #2563eb;
        }

        .metric-label {
            font-size: 0.9em;
            color: #4a5568;
            margin-top: 5px;
        }

        .flow-description {
            background: #e0e7ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 5px solid #2563eb;
        }

        .flow-description h3 {
            color: #1e3a8a;
            margin-bottom: 10px;
        }

        .flow-description ol {
            margin-left: 20px;
            line-height: 2;
            color: #1e293b;
        }

        .flow-description ol li {
            margin: 8px 0;
        }

        .flow-description strong {
            color: #2563eb;
        }

        .flow-description code {
            background: #1e293b;
            color: #fbbf24;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üé´ TicketMaster Architecture Flow Diagram</h1>
        <p style="color: #64748b; margin-top: 10px;">Interactive Component Flow Visualization</p>

        <div class="tabs">
            <button class="tab active" onclick="showDiagram('booking')">üéüÔ∏è Booking Flow</button>
            <button class="tab" onclick="showDiagram('payment')">üí≥ Payment Flow</button>
            <button class="tab" onclick="showDiagram('waitlist')">‚è≥ Waitlist & Queue Flow</button>
            <button class="tab" onclick="showDiagram('full')">üèóÔ∏è Full System Architecture</button>
        </div>
    </div>

    <!-- Booking Flow Diagram -->
    <div id="booking-diagram" class="diagram-container active">
        <svg viewBox="0 0 1400 1200" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#2563eb" />
                </marker>
                <linearGradient id="grad-user" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-search" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#f472b6;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-inventory" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#fb923c;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#f97316;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-booking" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#84cc16;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#65a30d;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-lock" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#f472b6;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-db" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#fb923c;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#f97316;stop-opacity:1" />
                </linearGradient>
            </defs>

            <!-- Title -->
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Booking Flow: Seat Reservation Process
            </text>

            <!-- User -->
            <g class="component">
                <rect x="600" y="60" width="200" height="80" rx="10" fill="url(#grad-user)" stroke="#2563eb" stroke-width="2"/>
                <text x="700" y="95" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üë§ User</text>
                <text x="700" y="115" font-size="12" text-anchor="middle" fill="white">Web/Mobile App</text>
            </g>

            <path d="M 700 140 L 700 180" stroke="#2563eb" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="165" font-size="11" fill="#1e3a8a" font-weight="600">Search Events</text>

            <!-- Search Service -->
            <g class="component">
                <rect x="600" y="180" width="200" height="80" rx="10" fill="url(#grad-search)" stroke="#db2777" stroke-width="2"/>
                <text x="700" y="210" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üîç Search Service</text>
                <text x="700" y="230" font-size="12" text-anchor="middle" fill="white">Elasticsearch</text>
            </g>

            <path d="M 700 260 L 700 300" stroke="#2563eb" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="285" font-size="11" fill="#1e3a8a" font-weight="600">Select Event</text>

            <!-- Event Details -->
            <g class="component">
                <rect x="600" y="300" width="200" height="80" rx="10" fill="url(#grad-inventory)" stroke="#ea580c" stroke-width="2"/>
                <text x="700" y="330" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üìä Event Details</text>
                <text x="700" y="350" font-size="12" text-anchor="middle" fill="white">Venue Map + Pricing</text>
            </g>

            <path d="M 700 380 L 700 420" stroke="#2563eb" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="405" font-size="11" fill="#1e3a8a" font-weight="600">Select Seats</text>

            <!-- Seat Selection -->
            <g class="component">
                <rect x="550" y="420" width="300" height="100" rx="10" fill="url(#grad-booking)" stroke="#4d7c0f" stroke-width="2"/>
                <text x="700" y="455" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üéüÔ∏è Seat Selection</text>
                <text x="700" y="475" font-size="12" text-anchor="middle" fill="white">User picks seats: A-101, A-102</text>
                <text x="700" y="495" font-size="11" text-anchor="middle" fill="white">Real-time availability check</text>
            </g>

            <path d="M 700 520 L 700 580" stroke="#2563eb" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="555" font-size="11" fill="#1e3a8a" font-weight="600">Reserve Seats</text>

            <!-- Booking Service -->
            <g class="component">
                <rect x="550" y="580" width="300" height="120" rx="10" fill="url(#grad-booking)" stroke="#4d7c0f" stroke-width="2"/>
                <text x="700" y="615" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üîß Booking Service</text>
                <text x="700" y="635" font-size="11" text-anchor="middle" fill="white">1. Acquire distributed lock (Redis)</text>
                <text x="700" y="653" font-size="11" text-anchor="middle" fill="white">2. Check seat availability (DB)</text>
                <text x="700" y="671" font-size="11" text-anchor="middle" fill="white">3. Mark RESERVED (10min timeout)</text>
            </g>

            <!-- Arrow to Redis Lock -->
            <path d="M 550 640 L 380 640" stroke="#2563eb" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="430" y="630" font-size="11" fill="#1e3a8a" font-weight="600">Acquire Lock</text>

            <!-- Redis Lock -->
            <g class="component">
                <rect x="200" y="600" width="180" height="80" rx="10" fill="url(#grad-lock)" stroke="#db2777" stroke-width="2"/>
                <text x="290" y="630" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üîí Redis Lock</text>
                <text x="290" y="650" font-size="11" text-anchor="middle" fill="white">SETNX lock:A-101</text>
                <text x="290" y="665" font-size="11" text-anchor="middle" fill="white">EX 30 (30s)</text>
            </g>

            <path d="M 380 650 L 550 650" stroke="#10b981" stroke-width="3" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>
            <text x="430" y="670" font-size="11" fill="#059669" font-weight="600">Lock Acquired ‚úì</text>

            <!-- Arrow to Database -->
            <path d="M 700 700 L 700 760" stroke="#2563eb" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="735" font-size="11" fill="#1e3a8a" font-weight="600">Update Status</text>

            <!-- Database -->
            <g class="component">
                <rect x="600" y="760" width="200" height="120" rx="10" fill="url(#grad-db)" stroke="#ea580c" stroke-width="2"/>
                <text x="700" y="800" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üóÑÔ∏è PostgreSQL</text>
                <text x="700" y="820" font-size="11" text-anchor="middle" fill="white">UPDATE seats</text>
                <text x="700" y="838" font-size="11" text-anchor="middle" fill="white">SET status='RESERVED',</text>
                <text x="700" y="856" font-size="11" text-anchor="middle" fill="white">reserved_until=NOW()+10m</text>
            </g>

            <!-- Timer -->
            <g class="component">
                <rect x="1020" y="580" width="180" height="100" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                <text x="1110" y="615" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">‚è∞ 10 Min Timer</text>
                <text x="1110" y="635" font-size="11" text-anchor="middle" fill="#92400e">Countdown: 10:00</text>
                <text x="1110" y="655" font-size="10" text-anchor="middle" fill="#92400e">User must complete</text>
                <text x="1110" y="670" font-size="10" text-anchor="middle" fill="#92400e">payment before expiry</text>
            </g>

            <path d="M 850 640 L 1020 640" stroke="#f59e0b" stroke-width="2" fill="none" stroke-dasharray="3,3"/>

            <!-- Booking Confirmation -->
            <g class="component">
                <rect x="600" y="920" width="200" height="100" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="3"/>
                <text x="700" y="955" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">‚úÖ Booking Created</text>
                <text x="700" y="975" font-size="11" text-anchor="middle" fill="#065f46">Booking ID: BKG-789</text>
                <text x="700" y="995" font-size="11" text-anchor="middle" fill="#065f46">Status: PENDING_PAYMENT</text>
            </g>

            <path d="M 700 880 L 700 920" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Response to User -->
            <path d="M 600 970 L 400 970 L 400 340 L 600 340" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="8,4"/>
            <text x="320" y="660" font-size="12" fill="#059669" font-weight="700">‚Üê Redirect to Payment</text>

            <!-- Step numbers -->
            <circle cx="700" cy="100" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="107" font-size="14" font-weight="bold" text-anchor="middle" fill="white">1</text>

            <circle cx="700" cy="220" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="227" font-size="14" font-weight="bold" text-anchor="middle" fill="white">2</text>

            <circle cx="700" cy="340" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="347" font-size="14" font-weight="bold" text-anchor="middle" fill="white">3</text>

            <circle cx="700" cy="470" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="477" font-size="14" font-weight="bold" text-anchor="middle" fill="white">4</text>

            <circle cx="700" cy="640" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="647" font-size="14" font-weight="bold" text-anchor="middle" fill="white">5</text>

            <circle cx="700" cy="820" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="827" font-size="14" font-weight="bold" text-anchor="middle" fill="white">6</text>

            <circle cx="700" cy="970" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="977" font-size="14" font-weight="bold" text-anchor="middle" fill="white">7</text>
        </svg>

        <div class="flow-description">
            <h3>üéüÔ∏è Booking Flow Steps</h3>
            <ol>
                <li><strong>Search Events:</strong> User searches for concerts/sports events via Elasticsearch full-text search with filters (location, date, category)</li>
                <li><strong>Browse Results:</strong> Display events with images, dates, venues, and starting prices. Cached at CDN for fast load times</li>
                <li><strong>View Event Details:</strong> Load interactive venue map, seat availability (color-coded: green=available, yellow=few left, red=sold out), dynamic pricing</li>
                <li><strong>Select Seats:</strong> User clicks seats A-101, A-102. Real-time check via WebSocket to prevent race conditions. Show "Someone else is viewing this seat" warning</li>
                <li><strong>Reserve Seats:</strong> Booking Service acquires Redis distributed lock (Redlock algorithm) to ensure only one user can reserve. CRITICAL: This prevents double booking
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Lock timeout: 30 seconds (operation should complete in <5s)</li>
                        <li>Database transaction: Update seat status to RESERVED with reserved_until timestamp</li>
                        <li>Return booking reference to user</li>
                    </ul>
                </li>
                <li><strong>Database Update:</strong> PostgreSQL transaction updates seat status to <code>RESERVED</code> with 10-minute expiry. Uses row-level locking for consistency</li>
                <li><strong>Booking Confirmation:</strong> Return booking ID and redirect to payment page. Start 10-minute countdown timer (WebSocket updates)</li>
                <li><strong>Background Job:</strong> Cron job runs every minute to release expired reservations (status=RESERVED AND reserved_until < NOW())</li>
            </ol>
            <div style="margin-top: 15px; padding: 15px; background: #fee2e2; border-left: 4px solid #dc2626; border-radius: 5px;">
                <strong>‚ö†Ô∏è Critical Concurrency Pattern:</strong> Distributed lock + Database transaction ensures ACID properties and prevents double booking even under 100K concurrent users!
            </div>
        </div>
    </div>

    <!-- Payment Flow Diagram -->
    <div id="payment-diagram" class="diagram-container">
        <svg viewBox="0 0 1400 1100" xmlns="http://www.w3.org/2000/svg">
            <!-- Title -->
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Payment Flow: Ticket Purchase Confirmation
            </text>

            <!-- User with Booking -->
            <g class="component">
                <rect x="550" y="60" width="300" height="100" rx="10" fill="url(#grad-user)" stroke="#2563eb" stroke-width="2"/>
                <text x="700" y="95" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üë§ User (Payment Page)</text>
                <text x="700" y="115" font-size="12" text-anchor="middle" fill="white">Booking: BKG-789</text>
                <text x="700" y="135" font-size="12" text-anchor="middle" fill="white">Timer: 8:42 remaining</text>
            </g>

            <path d="M 700 160 L 700 200" stroke="#2563eb" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="185" font-size="11" fill="#1e3a8a" font-weight="600">Submit Payment</text>

            <!-- Payment Service -->
            <g class="component">
                <rect x="550" y="200" width="300" height="100" rx="10" fill="#fde047" stroke="#ca8a04" stroke-width="2"/>
                <text x="700" y="235" font-size="16" font-weight="bold" text-anchor="middle" fill="#92400e">üí≥ Payment Service</text>
                <text x="700" y="255" font-size="11" text-anchor="middle" fill="#92400e">Validate booking not expired</text>
                <text x="700" y="273" font-size="11" text-anchor="middle" fill="#92400e">Create payment intent</text>
            </g>

            <path d="M 700 300 L 700 340" stroke="#2563eb" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="325" font-size="11" fill="#1e3a8a" font-weight="600">Call Stripe API</text>

            <!-- Stripe Payment Gateway -->
            <g class="component">
                <rect x="550" y="340" width="300" height="100" rx="10" fill="#c7d2fe" stroke="#6366f1" stroke-width="2"/>
                <text x="700" y="375" font-size="16" font-weight="bold" text-anchor="middle" fill="#4338ca">üè¶ Stripe Gateway</text>
                <text x="700" y="395" font-size="11" text-anchor="middle" fill="#4338ca">3D Secure Authentication</text>
                <text x="700" y="413" font-size="11" text-anchor="middle" fill="#4338ca">Charge: $150.00</text>
            </g>

            <!-- Decision Diamond -->
            <g class="component">
                <path d="M 700 480 L 800 540 L 700 600 L 600 540 Z" fill="#fef3c7" stroke="#f59e0b" stroke-width="3"/>
                <text x="700" y="535" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Payment</text>
                <text x="700" y="553" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Success?</text>
            </g>

            <!-- Success Path (Right) -->
            <path d="M 800 540 L 1020 540" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>
            <text x="870" y="530" font-size="12" fill="#059669" font-weight="700">YES ‚úì</text>

            <g class="component">
                <rect x="1020" y="490" width="250" height="100" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="3"/>
                <text x="1145" y="525" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">‚úÖ Confirm Booking</text>
                <text x="1145" y="545" font-size="11" text-anchor="middle" fill="#065f46">1. Update seats: SOLD</text>
                <text x="1145" y="563" font-size="11" text-anchor="middle" fill="#065f46">2. Generate QR ticket</text>
                <text x="1145" y="580" font-size="11" text-anchor="middle" fill="#065f46">3. Send email/SMS</text>
            </g>

            <!-- Failure Path (Bottom) -->
            <path d="M 700 600 L 700 680" stroke="#ef4444" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>
            <text x="630" y="645" font-size="12" fill="#dc2626" font-weight="700">NO ‚úó</text>

            <g class="component">
                <rect x="550" y="680" width="300" height="100" rx="10" fill="#fee2e2" stroke="#dc2626" stroke-width="3"/>
                <text x="700" y="715" font-size="14" font-weight="bold" text-anchor="middle" fill="#991b1b">‚ùå Payment Failed</text>
                <text x="700" y="735" font-size="11" text-anchor="middle" fill="#991b1b">1. Release seats (AVAILABLE)</text>
                <text x="700" y="753" font-size="11" text-anchor="middle" fill="#991b1b">2. Notify waitlist</text>
                <text x="700" y="770" font-size="11" text-anchor="middle" fill="#991b1b">3. Retry prompt (3 attempts)</text>
            </g>

            <!-- Kafka Event Publishing -->
            <path d="M 1145 590 L 1145 720" stroke="#9333ea" stroke-width="3" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>
            <text x="1165" y="660" font-size="11" fill="#9333ea" font-weight="600">Publish Event</text>

            <g class="component">
                <rect x="1020" y="720" width="250" height="100" rx="10" fill="#e9d5ff" stroke="#9333ea" stroke-width="2"/>
                <text x="1145" y="755" font-size="14" font-weight="bold" text-anchor="middle" fill="#6b21a8">üì¨ Kafka Topics</text>
                <text x="1145" y="775" font-size="11" text-anchor="middle" fill="#6b21a8">booking.confirmed</text>
                <text x="1145" y="793" font-size="11" text-anchor="middle" fill="#6b21a8">payment.completed</text>
                <text x="1145" y="810" font-size="11" text-anchor="middle" fill="#6b21a8">notification.send</text>
            </g>

            <!-- Notification Service -->
            <path d="M 1145 820 L 1145 900" stroke="#2563eb" stroke-width="3" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>

            <g class="component">
                <rect x="1020" y="900" width="250" height="100" rx="10" fill="#99f6e4" stroke="#2dd4bf" stroke-width="2"/>
                <text x="1145" y="935" font-size="14" font-weight="bold" text-anchor="middle" fill="#134e4a">üìß Notification Service</text>
                <text x="1145" y="955" font-size="11" text-anchor="middle" fill="#134e4a">Email: Ticket PDF + QR code</text>
                <text x="1145" y="973" font-size="11" text-anchor="middle" fill="#134e4a">SMS: "Booking confirmed!"</text>
                <text x="1145" y="990" font-size="11" text-anchor="middle" fill="#134e4a">Push: Mobile notification</text>
            </g>

            <!-- Ticket Generation -->
            <g class="component">
                <rect x="200" y="490" width="250" height="120" rx="10" fill="#bae6fd" stroke="#0284c7" stroke-width="2"/>
                <text x="325" y="530" font-size="14" font-weight="bold" text-anchor="middle" fill="#075985">üé´ Ticket Generator</text>
                <text x="325" y="550" font-size="11" text-anchor="middle" fill="#075985">Generate QR code</text>
                <text x="325" y="568" font-size="11" text-anchor="middle" fill="#075985">Create PDF ticket</text>
                <text x="325" y="586" font-size="11" text-anchor="middle" fill="#075985">Upload to S3</text>
            </g>

            <path d="M 1020 540 L 450 540" stroke="#0284c7" stroke-width="2" fill="none" stroke-dasharray="3,3"/>

            <!-- Step numbers -->
            <circle cx="700" cy="110" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="117" font-size="14" font-weight="bold" text-anchor="middle" fill="white">1</text>

            <circle cx="700" cy="250" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="257" font-size="14" font-weight="bold" text-anchor="middle" fill="white">2</text>

            <circle cx="700" cy="390" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="397" font-size="14" font-weight="bold" text-anchor="middle" fill="white">3</text>

            <circle cx="1145" cy="540" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="1145" y="547" font-size="14" font-weight="bold" text-anchor="middle" fill="white">4</text>

            <circle cx="1145" cy="770" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="1145" y="777" font-size="14" font-weight="bold" text-anchor="middle" fill="white">5</text>
        </svg>

        <div class="flow-description">
            <h3>üí≥ Payment Flow Steps</h3>
            <ol>
                <li><strong>Payment Page:</strong> User enters credit card details. Frontend validates card format, shows 10-minute countdown timer</li>
                <li><strong>Payment Service:</strong> Validates booking hasn't expired (check <code>reserved_until</code> timestamp). Creates Stripe payment intent with amount $150.00</li>
                <li><strong>Stripe Processing:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>3D Secure authentication (SMS/app verification)</li>
                        <li>Charge card via payment gateway</li>
                        <li>Return success/failure status + transaction ID</li>
                    </ul>
                </li>
                <li><strong>Success Path:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Database transaction: Update seats status to <code>SOLD</code>, remove <code>reserved_until</code></li>
                        <li>Update booking: status = <code>CONFIRMED</code>, payment_id = transaction ID</li>
                        <li>Trigger async ticket generation (QR code with booking reference)</li>
                        <li>Publish <code>booking.confirmed</code> event to Kafka</li>
                    </ul>
                </li>
                <li><strong>Failure Path:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Release seats: Update status to <code>AVAILABLE</code>, clear <code>reserved_until</code></li>
                        <li>Notify waitlist users (if any)</li>
                        <li>Show retry UI to user (max 3 attempts)</li>
                        <li>Log failure reason for analytics (insufficient funds, card declined, etc.)</li>
                    </ul>
                </li>
                <li><strong>Notification:</strong> Kafka consumers process events:
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Email Service: Send confirmation email with PDF ticket attachment</li>
                        <li>SMS Service: Send "Booking confirmed" SMS via Twilio</li>
                        <li>Push Notification: Mobile app push notification</li>
                    </ul>
                </li>
                <li><strong>Ticket Generation:</strong> Background worker creates QR code (contains: booking ID + event ID + seat numbers + encrypted hash), generates PDF, uploads to S3 with signed URL (expires in 7 days)</li>
            </ol>
            <div style="margin-top: 15px; padding: 15px; background: #dbeafe; border-left: 4px solid #2563eb; border-radius: 5px;">
                <strong>üîí Idempotency:</strong> All payment operations use idempotency keys to prevent duplicate charges if user clicks "Pay" multiple times!
            </div>
        </div>
    </div>

    <!-- Waitlist & Queue Flow -->
    <div id="waitlist-diagram" class="diagram-container">
        <svg viewBox="0 0 1400 900" xmlns="http://www.w3.org/2000/svg">
            <!-- Title -->
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Virtual Waiting Room & Waitlist Flow
            </text>

            <!-- High Demand Event Release -->
            <g class="component">
                <rect x="550" y="60" width="300" height="100" rx="10" fill="#fca5a5" stroke="#dc2626" stroke-width="3"/>
                <text x="700" y="95" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üî• High-Demand Event</text>
                <text x="700" y="115" font-size="12" text-anchor="middle" fill="white">Taylor Swift Concert</text>
                <text x="700" y="133" font-size="12" text-anchor="middle" fill="white">Expected: 100K users</text>
            </g>

            <path d="M 700 160 L 700 200" stroke="#dc2626" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>

            <!-- Queue System -->
            <g class="component">
                <rect x="500" y="200" width="400" height="150" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="3"/>
                <text x="700" y="235" font-size="18" font-weight="bold" text-anchor="middle" fill="#92400e">‚è≥ Virtual Waiting Room</text>
                <text x="700" y="260" font-size="12" text-anchor="middle" fill="#92400e">Users assigned random queue positions</text>
                <text x="700" y="280" font-size="11" text-anchor="middle" fill="#92400e">Position #1,234 ‚Üí You're in line!</text>
                <text x="700" y="298" font-size="11" text-anchor="middle" fill="#92400e">Estimated wait: 15 minutes</text>
                <text x="700" y="316" font-size="11" text-anchor="middle" fill="#92400e">Real-time updates via WebSocket</text>
            </g>

            <path d="M 700 350 L 700 400" stroke="#2563eb" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="380" font-size="11" fill="#1e3a8a" font-weight="600">Throttled Release</text>
            <text x="720" y="395" font-size="11" fill="#1e3a8a" font-weight="600">1000 users/min</text>

            <!-- Admitted Users -->
            <g class="component">
                <rect x="550" y="400" width="300" height="100" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="3"/>
                <text x="700" y="435" font-size="16" font-weight="bold" text-anchor="middle" fill="#065f46">‚úÖ Admitted to Booking</text>
                <text x="700" y="455" font-size="11" text-anchor="middle" fill="#065f46">Session token valid for 15 min</text>
                <text x="700" y="473" font-size="11" text-anchor="middle" fill="#065f46">Proceed to seat selection</text>
            </g>

            <path d="M 700 500 L 700 540" stroke="#10b981" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Booking Attempt -->
            <g class="component">
                <rect x="550" y="540" width="300" height="80" rx="10" fill="url(#grad-booking)" stroke="#4d7c0f" stroke-width="2"/>
                <text x="700" y="575" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üéüÔ∏è Try to Book Seats</text>
                <text x="700" y="595" font-size="11" text-anchor="middle" fill="white">High contention expected</text>
            </g>

            <!-- Decision: Sold Out? -->
            <g class="component">
                <path d="M 700 660 L 800 720 L 700 780 L 600 720 Z" fill="#fef3c7" stroke="#f59e0b" stroke-width="3"/>
                <text x="700" y="715" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Seats</text>
                <text x="700" y="733" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Available?</text>
            </g>

            <!-- Available Path -->
            <path d="M 800 720 L 1020 720" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>
            <text x="870" y="710" font-size="12" fill="#059669" font-weight="700">YES ‚úì</text>

            <g class="component">
                <rect x="1020" y="670" width="200" height="100" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="3"/>
                <text x="1120" y="705" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">‚úÖ Proceed</text>
                <text x="1120" y="725" font-size="11" text-anchor="middle" fill="#065f46">Reserve seats</text>
                <text x="1120" y="743" font-size="11" text-anchor="middle" fill="#065f46">‚Üí Payment flow</text>
            </g>

            <!-- Sold Out Path -->
            <path d="M 600 720 L 380 720" stroke="#ef4444" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>
            <text x="520" y="710" font-size="12" fill="#dc2626" font-weight="700">NO ‚úó</text>

            <g class="component">
                <rect x="180" y="670" width="200" height="100" rx="10" fill="#fee2e2" stroke="#dc2626" stroke-width="3"/>
                <text x="280" y="705" font-size="14" font-weight="bold" text-anchor="middle" fill="#991b1b">‚ùå Sold Out</text>
                <text x="280" y="725" font-size="11" text-anchor="middle" fill="#991b1b">Join Waitlist?</text>
                <text x="280" y="743" font-size="11" text-anchor="middle" fill="#991b1b">Get notified if available</text>
            </g>

            <!-- Waitlist -->
            <path d="M 280 770 L 280 820" stroke="#f59e0b" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <g class="component">
                <rect x="180" y="820" width="200" height="60" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                <text x="280" y="845" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">üìã Waitlist Queue</text>
                <text x="280" y="863" font-size="11" text-anchor="middle" fill="#92400e">Position: #523</text>
            </g>

            <!-- Cancellation Event -->
            <g class="component">
                <rect x="950" y="100" width="250" height="80" rx="10" fill="#c7d2fe" stroke="#6366f1" stroke-width="2"/>
                <text x="1075" y="130" font-size="14" font-weight="bold" text-anchor="middle" fill="#4338ca">üîÑ Seat Released</text>
                <text x="1075" y="150" font-size="11" text-anchor="middle" fill="#4338ca">User cancelled or timeout</text>
            </g>

            <path d="M 1075 180 L 1075 300 L 380 300 L 380 820" stroke="#9333ea" stroke-width="2" fill="none" stroke-dasharray="5,5"/>
            <text x="1095" y="240" font-size="11" fill="#9333ea" font-weight="600">Notify Waitlist</text>

            <!-- Notification -->
            <g class="component">
                <rect x="480" y="820" width="200" height="60" rx="10" fill="#99f6e4" stroke="#2dd4bf" stroke-width="2"/>
                <text x="580" y="845" font-size="12" font-weight="bold" text-anchor="middle" fill="#134e4a">üìß SMS Alert</text>
                <text x="580" y="863" font-size="10" text-anchor="middle" fill="#134e4a">"Seats available now!"</text>
            </g>

            <path d="M 380 850 L 480 850" stroke="#2dd4bf" stroke-width="2" fill="none" stroke-dasharray="3,3"/>
        </svg>

        <div class="flow-description">
            <h3>‚è≥ Virtual Waiting Room & Waitlist Flow</h3>
            <ol>
                <li><strong>High-Demand Event Opens:</strong> When a popular event (Taylor Swift, Olympics) goes on sale, expect 100K+ concurrent users</li>
                <li><strong>Virtual Waiting Room Activation:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Users assigned random queue position (prevents bots from grabbing early spots)</li>
                        <li>Display estimated wait time: <code>position / admission_rate</code></li>
                        <li>WebSocket connection sends real-time position updates every 10 seconds</li>
                        <li>Queue state stored in Redis (position, user_id, timestamp)</li>
                    </ul>
                </li>
                <li><strong>Throttled Admission:</strong> System admits users at controlled rate (1000/min) to prevent overwhelming booking service. Prevents thundering herd problem</li>
                <li><strong>Session Token:</strong> Admitted users receive time-limited token (15 min) to access booking flow. After expiry, must rejoin queue</li>
                <li><strong>Booking Attempt:</strong> User tries to book seats. High contention expected - many users competing for same seats</li>
                <li><strong>Sold Out Scenario:</strong> If all seats sold:
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Offer waitlist option</li>
                        <li>User provides email/SMS for notifications</li>
                        <li>Added to FIFO waitlist queue (Redis sorted set by timestamp)</li>
                    </ul>
                </li>
                <li><strong>Seat Released Event:</strong> When a booking times out (10 min expired) or user cancels:
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Publish <code>seat.released</code> event to Kafka</li>
                        <li>Waitlist service consumes event</li>
                        <li>Notify top N users in waitlist (N = number of seats released)</li>
                        <li>Send SMS/push notification: "Seats available for [event name]!"</li>
                    </ul>
                </li>
                <li><strong>Waitlist Notification:</strong> User has 5 minutes to claim seat after notification, otherwise moves to next person in queue</li>
            </ol>
            <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 5px;">
                <strong>üéØ Queue Fairness:</strong> Random position assignment + CAPTCHA verification prevents bot scalpers from dominating ticket sales!
            </div>
        </div>
    </div>

    <!-- Full System Diagram -->
    <div id="full-diagram" class="diagram-container">
        <div style="text-align: center; padding: 40px; background: #f0f9ff; border-radius: 15px; border: 2px solid #2563eb;">
            <h2 style="color: #1e3a8a; margin-bottom: 20px;">üèóÔ∏è Complete TicketMaster System Architecture</h2>
            <p style="color: #475569; font-size: 1.1em; line-height: 1.8; max-width: 900px; margin: 0 auto;">
                The complete TicketMaster architecture combines all flows into an event-driven microservices system.
                See the <strong>architecture.html</strong> file for the detailed component-level diagram showing:
            </p>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 30px; text-align: left;">
                <div style="background: white; padding: 20px; border-radius: 10px; border-left: 4px solid #2563eb;">
                    <h4 style="color: #2563eb; margin-bottom: 10px;">üéüÔ∏è Booking Path</h4>
                    <p style="color: #475569; font-size: 0.95em; line-height: 1.6;">
                        User ‚Üí CDN ‚Üí Virtual Queue ‚Üí API Gateway ‚Üí Booking Service ‚Üí Redis Lock ‚Üí PostgreSQL ‚Üí Kafka ‚Üí Notifications
                    </p>
                </div>
                <div style="background: white; padding: 20px; border-radius: 10px; border-left: 4px solid #10b981;">
                    <h4 style="color: #10b981; margin-bottom: 10px;">üí≥ Payment Path</h4>
                    <p style="color: #475569; font-size: 0.95em; line-height: 1.6;">
                        Payment Service ‚Üí Stripe API ‚Üí Database Update ‚Üí Ticket Generator ‚Üí Email/SMS ‚Üí User Confirmation
                    </p>
                </div>
                <div style="background: white; padding: 20px; border-radius: 10px; border-left: 4px solid #f59e0b;">
                    <h4 style="color: #f59e0b; margin-bottom: 10px;">üîç Search Path</h4>
                    <p style="color: #475569; font-size: 0.95em; line-height: 1.6;">
                        User Query ‚Üí Elasticsearch ‚Üí Faceted Results ‚Üí Cached at CDN ‚Üí Fast Response
                    </p>
                </div>
                <div style="background: white; padding: 20px; border-radius: 10px; border-left: 4px solid #ec4899;">
                    <h4 style="color: #ec4899; margin-bottom: 10px;">üìä Analytics Path</h4>
                    <p style="color: #475569; font-size: 0.95em; line-height: 1.6;">
                        Events ‚Üí Kafka ‚Üí Flink (Real-time) ‚Üí Cassandra ‚Üí Snowflake (Batch) ‚Üí BI Dashboards
                    </p>
                </div>
            </div>
            <div style="margin-top: 30px; padding: 20px; background: #dbeafe; border-radius: 10px;">
                <h3 style="color: #1e3a8a; margin-bottom: 15px;">Key Architecture Principles</h3>
                <ul style="color: #1e40af; text-align: left; max-width: 700px; margin: 0 auto; line-height: 2;">
                    <li><strong>Event-Driven:</strong> Kafka for async processing and loose coupling</li>
                    <li><strong>ACID Guarantees:</strong> Distributed locks + database transactions prevent double booking</li>
                    <li><strong>Horizontal Scalability:</strong> Auto-scaling, database sharding, Redis clustering</li>
                    <li><strong>Fault Tolerance:</strong> Circuit breakers, retries, multi-AZ deployment</li>
                    <li><strong>Observability:</strong> Distributed tracing, metrics, centralized logging</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Metrics Panel -->
    <div class="metrics-panel">
        <h2 style="margin-bottom: 15px; color: #92400e;">‚ö° System Performance Metrics</h2>
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value">100K</div>
                <div class="metric-label">Peak Concurrent Users</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">10K</div>
                <div class="metric-label">Bookings/min (peak)</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">&lt;200ms</div>
                <div class="metric-label">P95 Latency</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">0%</div>
                <div class="metric-label">Double Booking Rate</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">99.95%</div>
                <div class="metric-label">Availability SLA</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">10 min</div>
                <div class="metric-label">Seat Reservation Timeout</div>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #60a5fa, #3b82f6);"></div>
            <span>User/Client</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #f472b6, #ec4899);"></div>
            <span>Search/Cache</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #84cc16, #65a30d);"></div>
            <span>Booking Service</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #fde047, #facc15);"></div>
            <span>Payment</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #fb923c, #f97316);"></div>
            <span>Database</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #c084fc, #a855f7);"></div>
            <span>Analytics/Events</span>
        </div>
    </div>
</div>

<script>
    function showDiagram(type) {
        // Hide all diagrams
        document.querySelectorAll('.diagram-container').forEach(d => {
            d.classList.remove('active');
        });

        // Remove active from all tabs
        document.querySelectorAll('.tab').forEach(t => {
            t.classList.remove('active');
        });

        // Show selected diagram
        document.getElementById(type + '-diagram').classList.add('active');

        // Activate clicked tab
        event.target.classList.add('active');
    }

    // Add hover effects
    document.querySelectorAll('.component').forEach(comp => {
        comp.addEventListener('mouseenter', function() {
            this.style.filter = 'drop-shadow(0 0 15px rgba(37, 99, 235, 0.6))';
        });

        comp.addEventListener('mouseleave', function() {
            this.style.filter = 'none';
        });
    });
</script>
</body>
</html>
