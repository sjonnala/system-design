<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification Service Flow Diagrams</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            font-size: 2.5em;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 30px;
            background: #e2e8f0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: #6366f1;
            color: white;
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .diagram-container {
            display: none;
            margin-top: 30px;
        }

        .diagram-container.active {
            display: block;
        }

        svg {
            width: 100%;
            height: auto;
        }

        .component {
            cursor: pointer;
            transition: all 0.3s;
        }

        .component:hover {
            filter: drop-shadow(0 0 10px rgba(99, 102, 241, 0.5));
        }

        .flow-arrow {
            animation: dash 20s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -1000;
            }
        }

        .flow-description {
            background: #e0e7ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 5px solid #6366f1;
        }

        .flow-description h3 {
            color: #4338ca;
            margin-bottom: 10px;
        }

        .flow-description ol {
            margin-left: 20px;
            line-height: 2;
            color: #1e293b;
        }

        .flow-description ol li {
            margin: 8px 0;
        }

        .flow-description strong {
            color: #6366f1;
        }

        .metrics-panel {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde047 100%);
            border-radius: 15px;
            border: 2px solid #fbbf24;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #6366f1;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #6366f1;
        }

        .metric-label {
            font-size: 0.9em;
            color: #4a5568;
            margin-top: 5px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üîî Notification Service Flow Diagrams</h1>
        <p style="color: #64748b; margin-top: 10px;">Interactive Multi-Channel Notification Architecture</p>

        <div class="tabs">
            <button class="tab active" onclick="showDiagram('send')">üì§ Send Notification Flow</button>
            <button class="tab" onclick="showDiagram('multichannel')">üì° Multi-Channel Delivery</button>
            <button class="tab" onclick="showDiagram('retry')">üîÑ Retry & Failure Handling</button>
        </div>
    </div>

    <!-- Send Notification Flow -->
    <div id="send-diagram" class="diagram-container active">
        <svg viewBox="0 0 1400 1300" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#6366f1" />
                </marker>
                <linearGradient id="grad-client" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-api" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#f87171;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#ef4444;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-orchestrator" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#facc15;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#eab308;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-queue" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#ef4444;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#dc2626;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-worker" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#84cc16;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#65a30d;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-provider" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#f472b6;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-db" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#fb923c;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#f97316;stop-opacity:1" />
                </linearGradient>
            </defs>

            <!-- Title -->
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Send Notification Flow
            </text>

            <!-- Client Application -->
            <g class="component">
                <rect x="600" y="60" width="200" height="80" rx="10" fill="url(#grad-client)" stroke="#2563eb" stroke-width="2"/>
                <text x="700" y="95" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üì± Client App</text>
                <text x="700" y="115" font-size="12" text-anchor="middle" fill="white">Order Service</text>
            </g>

            <!-- Arrow 1 -->
            <path d="M 700 140 L 700 180" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="165" font-size="11" fill="#4338ca" font-weight="600">POST /notify</text>

            <!-- API Gateway -->
            <g class="component">
                <rect x="550" y="180" width="300" height="100" rx="10" fill="url(#grad-api)" stroke="#dc2626" stroke-width="2"/>
                <text x="700" y="215" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üö™ Notification API</text>
                <text x="700" y="235" font-size="11" text-anchor="middle" fill="white">Validate ‚Ä¢ Authenticate ‚Ä¢ Rate Limit</text>
                <text x="700" y="255" font-size="10" text-anchor="middle" fill="white">Request ID: notif_abc123</text>
            </g>

            <!-- Arrow 2 -->
            <path d="M 700 280 L 700 320" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="305" font-size="11" fill="#4338ca" font-weight="600">Enrich & Route</text>

            <!-- Orchestrator -->
            <g class="component">
                <rect x="550" y="320" width="300" height="120" rx="10" fill="url(#grad-orchestrator)" stroke="#ca8a04" stroke-width="2"/>
                <text x="700" y="360" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üéØ Orchestrator</text>
                <text x="700" y="380" font-size="11" text-anchor="middle" fill="white">1. Check user preferences</text>
                <text x="700" y="398" font-size="11" text-anchor="middle" fill="white">2. Apply deduplication</text>
                <text x="700" y="416" font-size="11" text-anchor="middle" fill="white">3. Select channels (email, SMS, push)</text>
            </g>

            <!-- Check Preferences (left branch) -->
            <path d="M 550 380 L 350 380" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>
            <text x="420" y="370" font-size="10" fill="#4338ca">Check cache</text>

            <g class="component">
                <rect x="200" y="340" width="150" height="80" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                <text x="275" y="370" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">üíæ Redis</text>
                <text x="275" y="390" font-size="10" text-anchor="middle" fill="#92400e">User Preferences</text>
                <text x="275" y="405" font-size="9" text-anchor="middle" fill="#92400e">email: ‚úì sms: ‚úó</text>
            </g>

            <!-- Arrow 3 -->
            <path d="M 700 440 L 700 480" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="465" font-size="11" fill="#4338ca" font-weight="600">Publish to queues</text>

            <!-- Message Queues -->
            <g class="component">
                <rect x="200" y="480" width="180" height="90" rx="10" fill="url(#grad-queue)" stroke="#b91c1c" stroke-width="2"/>
                <text x="290" y="515" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üì¨ Email Queue</text>
                <text x="290" y="535" font-size="10" text-anchor="middle" fill="white">Kafka: email-notifications</text>
                <text x="290" y="553" font-size="9" text-anchor="middle" fill="white">Partition: user_id % 10</text>
            </g>

            <g class="component">
                <rect x="410" y="480" width="180" height="90" rx="10" fill="url(#grad-queue)" stroke="#b91c1c" stroke-width="2"/>
                <text x="500" y="515" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üì¨ SMS Queue</text>
                <text x="500" y="535" font-size="10" text-anchor="middle" fill="white">Kafka: sms-notifications</text>
                <text x="500" y="553" font-size="9" text-anchor="middle" fill="white">Priority: high</text>
            </g>

            <g class="component">
                <rect x="620" y="480" width="180" height="90" rx="10" fill="url(#grad-queue)" stroke="#b91c1c" stroke-width="2"/>
                <text x="710" y="515" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üì¨ Push Queue</text>
                <text x="710" y="535" font-size="10" text-anchor="middle" fill="white">Kafka: push-notifications</text>
                <text x="710" y="553" font-size="9" text-anchor="middle" fill="white">FCM/APNS</text>
            </g>

            <!-- Arrows to queues -->
            <path d="M 650 440 L 290 480" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 700 440 L 500 480" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 750 440 L 710 480" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Workers -->
            <g class="component">
                <rect x="200" y="600" width="180" height="80" rx="10" fill="url(#grad-worker)" stroke="#4d7c0f" stroke-width="2"/>
                <text x="290" y="630" font-size="13" font-weight="bold" text-anchor="middle" fill="white">üîß Email Worker</text>
                <text x="290" y="650" font-size="10" text-anchor="middle" fill="white">10 instances</text>
                <text x="290" y="665" font-size="9" text-anchor="middle" fill="white">Process rate: 1K/sec</text>
            </g>

            <g class="component">
                <rect x="410" y="600" width="180" height="80" rx="10" fill="url(#grad-worker)" stroke="#4d7c0f" stroke-width="2"/>
                <text x="500" y="630" font-size="13" font-weight="bold" text-anchor="middle" fill="white">üîß SMS Worker</text>
                <text x="500" y="650" font-size="10" text-anchor="middle" fill="white">5 instances</text>
                <text x="500" y="665" font-size="9" text-anchor="middle" fill="white">Process rate: 500/sec</text>
            </g>

            <g class="component">
                <rect x="620" y="600" width="180" height="80" rx="10" fill="url(#grad-worker)" stroke="#4d7c0f" stroke-width="2"/>
                <text x="710" y="630" font-size="13" font-weight="bold" text-anchor="middle" fill="white">üîß Push Worker</text>
                <text x="710" y="650" font-size="10" text-anchor="middle" fill="white">20 instances</text>
                <text x="710" y="665" font-size="9" text-anchor="middle" fill="white">Process rate: 5K/sec</text>
            </g>

            <!-- Arrows from queues to workers -->
            <path d="M 290 570 L 290 600" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 500 570 L 500 600" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 710 570 L 710 600" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Third-party providers -->
            <g class="component">
                <rect x="200" y="710" width="180" height="80" rx="10" fill="url(#grad-provider)" stroke="#db2777" stroke-width="2"/>
                <text x="290" y="740" font-size="13" font-weight="bold" text-anchor="middle" fill="white">üìß SendGrid</text>
                <text x="290" y="760" font-size="10" text-anchor="middle" fill="white">Email Provider</text>
                <text x="290" y="775" font-size="9" text-anchor="middle" fill="white">Fallback: AWS SES</text>
            </g>

            <g class="component">
                <rect x="410" y="710" width="180" height="80" rx="10" fill="url(#grad-provider)" stroke="#db2777" stroke-width="2"/>
                <text x="500" y="740" font-size="13" font-weight="bold" text-anchor="middle" fill="white">üí¨ Twilio</text>
                <text x="500" y="760" font-size="10" text-anchor="middle" fill="white">SMS Provider</text>
                <text x="500" y="775" font-size="9" text-anchor="middle" fill="white">Fallback: Vonage</text>
            </g>

            <g class="component">
                <rect x="620" y="710" width="180" height="80" rx="10" fill="url(#grad-provider)" stroke="#db2777" stroke-width="2"/>
                <text x="710" y="740" font-size="13" font-weight="bold" text-anchor="middle" fill="white">üì± FCM/APNS</text>
                <text x="710" y="760" font-size="10" text-anchor="middle" fill="white">Push Provider</text>
                <text x="710" y="775" font-size="9" text-anchor="middle" fill="white">Google/Apple</text>
            </g>

            <!-- Arrows to providers -->
            <path d="M 290 680 L 290 710" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 500 680 L 500 710" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 710 680 L 710 710" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Database logging -->
            <g class="component">
                <rect x="950" y="500" width="220" height="100" rx="10" fill="url(#grad-db)" stroke="#ea580c" stroke-width="2"/>
                <text x="1060" y="535" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üóÑÔ∏è PostgreSQL</text>
                <text x="1060" y="555" font-size="11" text-anchor="middle" fill="white">Notification Log</text>
                <text x="1060" y="573" font-size="10" text-anchor="middle" fill="white">Status: queued ‚Üí sent</text>
                <text x="1060" y="588" font-size="10" text-anchor="middle" fill="white">‚Üí delivered/failed</text>
            </g>

            <!-- Async logging arrows -->
            <path d="M 850 380 L 950 550" stroke="#9333ea" stroke-width="2" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>
            <text x="880" y="465" font-size="10" fill="#9333ea">Async log</text>

            <!-- End user devices -->
            <g class="component">
                <rect x="200" y="820" width="180" height="80" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="2"/>
                <text x="290" y="850" font-size="13" font-weight="bold" text-anchor="middle" fill="#065f46">üìß User Inbox</text>
                <text x="290" y="870" font-size="10" text-anchor="middle" fill="#065f46">Email delivered</text>
                <text x="290" y="885" font-size="9" text-anchor="middle" fill="#065f46">Latency: 2-5 sec</text>
            </g>

            <g class="component">
                <rect x="410" y="820" width="180" height="80" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="2"/>
                <text x="500" y="850" font-size="13" font-weight="bold" text-anchor="middle" fill="#065f46">üì± User Phone</text>
                <text x="500" y="870" font-size="10" text-anchor="middle" fill="#065f46">SMS delivered</text>
                <text x="500" y="885" font-size="9" text-anchor="middle" fill="#065f46">Latency: 5-10 sec</text>
            </g>

            <g class="component">
                <rect x="620" y="820" width="180" height="80" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="2"/>
                <text x="710" y="850" font-size="13" font-weight="bold" text-anchor="middle" fill="#065f46">üì≤ User Device</text>
                <text x="710" y="870" font-size="10" text-anchor="middle" fill="#065f46">Push delivered</text>
                <text x="710" y="885" font-size="9" text-anchor="middle" fill="#065f46">Latency: <1 sec</text>
            </g>

            <!-- Final arrows -->
            <path d="M 290 790 L 290 820" stroke="#10b981" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 500 790 L 500 820" stroke="#10b981" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 710 790 L 710 820" stroke="#10b981" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Delivery receipts -->
            <path d="M 380 750 L 950 600" stroke="#10b981" stroke-width="2" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>
            <text x="650" y="670" font-size="10" fill="#059669">Delivery receipts</text>

            <!-- Step numbers -->
            <circle cx="700" cy="100" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="107" font-size="14" font-weight="bold" text-anchor="middle" fill="white">1</text>

            <circle cx="700" cy="230" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="237" font-size="14" font-weight="bold" text-anchor="middle" fill="white">2</text>

            <circle cx="700" cy="380" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="387" font-size="14" font-weight="bold" text-anchor="middle" fill="white">3</text>

            <circle cx="500" cy="525" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="500" y="532" font-size="14" font-weight="bold" text-anchor="middle" fill="white">4</text>

            <circle cx="500" cy="640" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="500" y="647" font-size="14" font-weight="bold" text-anchor="middle" fill="white">5</text>

            <circle cx="500" cy="750" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="500" y="757" font-size="14" font-weight="bold" text-anchor="middle" fill="white">6</text>

            <circle cx="500" cy="860" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="500" y="867" font-size="14" font-weight="bold" text-anchor="middle" fill="white">7</text>
        </svg>

        <div class="flow-description">
            <h3>üì§ Send Notification Flow Steps</h3>
            <ol>
                <li><strong>Client Trigger:</strong> Application service (e.g., Order Service) sends notification request via REST API</li>
                <li><strong>API Gateway:</strong> Validates request, authenticates API key, applies rate limiting (1000 req/min)</li>
                <li><strong>Orchestrator:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Checks user preferences from Redis cache (email enabled, SMS opted out)</li>
                        <li>Applies deduplication logic (prevent sending same notification twice)</li>
                        <li>Selects appropriate channels based on priority and user settings</li>
                        <li>Enriches notification with template data</li>
                    </ul>
                </li>
                <li><strong>Queue Publishing:</strong> Publishes to Kafka topics (email-notifications, push-notifications) with partitioning by user_id for ordering</li>
                <li><strong>Worker Processing:</strong> Dedicated workers (10-50 instances per channel) consume from queues and prepare for delivery</li>
                <li><strong>Provider Delivery:</strong> Sends via third-party providers (SendGrid for email, Twilio for SMS, FCM/APNS for push) with automatic fallback</li>
                <li><strong>User Receives:</strong> Notification delivered to user's device/inbox with tracking for delivery receipts and engagement</li>
            </ol>
            <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 5px;">
                <strong>‚ö° Performance:</strong> End-to-end latency: <5 seconds for high-priority notifications, <1 minute for standard notifications
            </div>
        </div>
    </div>

    <!-- Multi-Channel Delivery Flow -->
    <div id="multichannel-diagram" class="diagram-container">
        <svg viewBox="0 0 1400 900" xmlns="http://www.w3.org/2000/svg">
            <!-- Title -->
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Multi-Channel Delivery Strategy
            </text>

            <!-- Central Orchestrator -->
            <g class="component">
                <rect x="550" y="100" width="300" height="150" rx="15" fill="url(#grad-orchestrator)" stroke="#ca8a04" stroke-width="3"/>
                <text x="700" y="145" font-size="18" font-weight="bold" text-anchor="middle" fill="white">üéØ Channel Selector</text>
                <text x="700" y="170" font-size="12" text-anchor="middle" fill="white">Decision Engine</text>
                <text x="700" y="195" font-size="11" text-anchor="middle" fill="white">Event: "Order Shipped"</text>
                <text x="700" y="215" font-size="11" text-anchor="middle" fill="white">Priority: High | User: user123</text>
            </g>

            <!-- Decision logic -->
            <g class="component">
                <path d="M 700 280 L 800 340 L 700 400 L 600 340 Z" fill="#fef3c7" stroke="#f59e0b" stroke-width="3"/>
                <text x="700" y="330" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">User</text>
                <text x="700" y="350" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Preference?</text>
            </g>

            <!-- Email channel -->
            <path d="M 600 340 L 200 500" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
            <text x="350" y="410" font-size="11" fill="#4338ca" font-weight="600">Email enabled ‚úì</text>

            <g class="component">
                <rect x="100" y="500" width="200" height="120" rx="10" fill="url(#grad-worker)" stroke="#4d7c0f" stroke-width="2"/>
                <text x="200" y="535" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üìß Email Channel</text>
                <text x="200" y="560" font-size="11" text-anchor="middle" fill="white">‚úì Best for: Rich content</text>
                <text x="200" y="578" font-size="11" text-anchor="middle" fill="white">‚úì Delivery time: 2-5 sec</text>
                <text x="200" y="596" font-size="11" text-anchor="middle" fill="white">‚úì Cost: Low ($0.001/email)</text>
            </g>

            <!-- SMS channel -->
            <path d="M 700 400 L 700 500" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
            <text x="720" y="450" font-size="11" fill="#4338ca" font-weight="600">SMS opted out ‚úó</text>

            <g class="component">
                <rect x="600" y="500" width="200" height="120" rx="10" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
                <text x="700" y="535" font-size="16" font-weight="bold" text-anchor="middle" fill="#991b1b">üí¨ SMS Channel</text>
                <text x="700" y="560" font-size="11" text-anchor="middle" fill="#991b1b">‚úó User opted out</text>
                <text x="700" y="578" font-size="11" text-anchor="middle" fill="#991b1b">Skipped</text>
            </g>

            <!-- Push channel -->
            <path d="M 800 340 L 1200 500" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
            <text x="1050" y="410" font-size="11" fill="#4338ca" font-weight="600">Push enabled ‚úì</text>

            <g class="component">
                <rect x="1100" y="500" width="200" height="120" rx="10" fill="url(#grad-worker)" stroke="#4d7c0f" stroke-width="2"/>
                <text x="1200" y="535" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üì± Push Channel</text>
                <text x="1200" y="560" font-size="11" text-anchor="middle" fill="white">‚úì Best for: Real-time</text>
                <text x="1200" y="578" font-size="11" text-anchor="middle" fill="white">‚úì Delivery time: <1 sec</text>
                <text x="1200" y="596" font-size="11" text-anchor="middle" fill="white">‚úì Cost: Free</text>
            </g>

            <!-- Results -->
            <g class="component">
                <rect x="100" y="650" width="200" height="80" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="2"/>
                <text x="200" y="680" font-size="13" font-weight="bold" text-anchor="middle" fill="#065f46">‚úÖ Email Sent</text>
                <text x="200" y="700" font-size="10" text-anchor="middle" fill="#065f46">Delivered to inbox</text>
                <text x="200" y="715" font-size="9" text-anchor="middle" fill="#065f46">Open rate tracked</text>
            </g>

            <g class="component">
                <rect x="1100" y="650" width="200" height="80" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="2"/>
                <text x="1200" y="680" font-size="13" font-weight="bold" text-anchor="middle" fill="#065f46">‚úÖ Push Sent</text>
                <text x="1200" y="700" font-size="10" text-anchor="middle" fill="#065f46">Delivered to device</text>
                <text x="1200" y="715" font-size="9" text-anchor="middle" fill="#065f46">Click tracked</text>
            </g>

            <!-- Arrows to results -->
            <path d="M 200 620 L 200 650" stroke="#10b981" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 1200 620 L 1200 650" stroke="#10b981" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Intelligence layer -->
            <g class="component">
                <rect x="950" y="100" width="400" height="120" rx="10" fill="#e0f2fe" stroke="#0284c7" stroke-width="2"/>
                <text x="1150" y="135" font-size="15" font-weight="bold" text-anchor="middle" fill="#075985">ü§ñ ML-Powered Optimizations</text>
                <text x="1150" y="158" font-size="11" text-anchor="middle" fill="#075985">‚Ä¢ Send-time optimization (best time per user)</text>
                <text x="1150" y="175" font-size="11" text-anchor="middle" fill="#075985">‚Ä¢ Channel preference learning</text>
                <text x="1150" y="192" font-size="11" text-anchor="middle" fill="#075985">‚Ä¢ Content personalization</text>
                <text x="1150" y="209" font-size="11" text-anchor="middle" fill="#075985">‚Ä¢ Churn prediction (reduce fatigue)</text>
            </g>

            <!-- Connection to orchestrator -->
            <path d="M 950 160 L 850 175" stroke="#0284c7" stroke-width="2" fill="none" stroke-dasharray="5,5"/>
        </svg>

        <div class="flow-description">
            <h3>üì° Multi-Channel Strategy</h3>
            <p style="margin-bottom: 15px;">The orchestrator intelligently selects channels based on:</p>
            <ol>
                <li><strong>User Preferences:</strong> Honor opt-out settings and channel preferences stored in Redis cache</li>
                <li><strong>Content Type:</strong> Rich HTML emails for detailed updates, push for time-sensitive alerts</li>
                <li><strong>Cost Optimization:</strong> Prefer free channels (push, in-app) over paid (SMS: $0.0075 each)</li>
                <li><strong>Delivery Speed:</strong> Critical alerts ‚Üí Push (<1s), Marketing ‚Üí Email (batched)</li>
                <li><strong>ML Insights:</strong> Historical engagement data guides channel selection for maximum impact</li>
            </ol>
            <div style="margin-top: 15px; padding: 15px; background: #e0f2fe; border-left: 4px solid #0284c7; border-radius: 5px;">
                <strong>üí° Smart Example:</strong> User typically opens emails in the evening but clicks push notifications immediately. ML model sends critical alerts via push, digests via email scheduled for 7 PM.
            </div>
        </div>
    </div>

    <!-- Retry & Failure Handling -->
    <div id="retry-diagram" class="diagram-container">
        <svg viewBox="0 0 1400 1000" xmlns="http://www.w3.org/2000/svg">
            <!-- Title -->
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Retry Logic & Failure Handling
            </text>

            <!-- Initial send attempt -->
            <g class="component">
                <rect x="550" y="60" width="300" height="80" rx="10" fill="url(#grad-worker)" stroke="#4d7c0f" stroke-width="2"/>
                <text x="700" y="95" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üîß Notification Worker</text>
                <text x="700" y="115" font-size="12" text-anchor="middle" fill="white">Attempt 1: Send via SendGrid</text>
            </g>

            <!-- First attempt -->
            <path d="M 700 140 L 700 180" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <g class="component">
                <rect x="550" y="180" width="300" height="80" rx="10" fill="url(#grad-provider)" stroke="#db2777" stroke-width="2"/>
                <text x="700" y="215" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üìß SendGrid API</text>
                <text x="700" y="235" font-size="12" text-anchor="middle" fill="white">Status: 503 Service Unavailable</text>
            </g>

            <!-- Decision diamond -->
            <path d="M 700 260 L 700 300" stroke="#ef4444" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <g class="component">
                <path d="M 700 300 L 800 360 L 700 420 L 600 360 Z" fill="#fee2e2" stroke="#dc2626" stroke-width="3"/>
                <text x="700" y="355" font-size="13" font-weight="bold" text-anchor="middle" fill="#991b1b">Retry</text>
                <text x="700" y="373" font-size="13" font-weight="bold" text-anchor="middle" fill="#991b1b">Logic</text>
            </g>

            <!-- Exponential backoff -->
            <g class="component">
                <rect x="900" y="280" width="450" height="160" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                <text x="1125" y="310" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">‚è±Ô∏è Exponential Backoff Strategy</text>
                <text x="1125" y="335" font-size="11" text-anchor="middle" fill="#92400e">Attempt 1: Immediate (0s)</text>
                <text x="1125" y="355" font-size="11" text-anchor="middle" fill="#92400e">Attempt 2: Wait 2s (with jitter: 1.5-2.5s)</text>
                <text x="1125" y="375" font-size="11" text-anchor="middle" fill="#92400e">Attempt 3: Wait 4s (with jitter: 3-5s)</text>
                <text x="1125" y="395" font-size="11" text-anchor="middle" fill="#92400e">Attempt 4: Wait 8s (with jitter: 6-10s)</text>
                <text x="1125" y="415" font-size="11" text-anchor="middle" fill="#92400e">Max attempts: 5 | Max wait: 16s</text>
            </g>

            <!-- Retry attempt 2 -->
            <path d="M 700 420 L 700 460" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <text x="720" y="445" font-size="11" fill="#4338ca" font-weight="600">Wait 2s, retry</text>

            <g class="component">
                <rect x="550" y="460" width="300" height="80" rx="10" fill="url(#grad-provider)" stroke="#db2777" stroke-width="2"/>
                <text x="700" y="495" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üìß SendGrid API</text>
                <text x="700" y="515" font-size="12" text-anchor="middle" fill="white">Status: Still failing (503)</text>
            </g>

            <!-- Fallback decision -->
            <path d="M 700 540 L 700 580" stroke="#ef4444" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <g class="component">
                <path d="M 700 580 L 800 640 L 700 700 L 600 640 Z" fill="#fef3c7" stroke="#f59e0b" stroke-width="3"/>
                <text x="700" y="635" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Circuit</text>
                <text x="700" y="653" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Breaker</text>
            </g>

            <!-- Fallback path -->
            <path d="M 800 640 L 1000 640" stroke="#f59e0b" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
            <text x="880" y="630" font-size="12" fill="#92400e" font-weight="700">Fallback provider</text>

            <g class="component">
                <rect x="1000" y="600" width="300" height="80" rx="10" fill="url(#grad-provider)" stroke="#10b981" stroke-width="3"/>
                <text x="1150" y="635" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üìß AWS SES (Backup)</text>
                <text x="1150" y="655" font-size="12" text-anchor="middle" fill="white">Status: 200 OK ‚úì</text>
            </g>

            <!-- Success -->
            <path d="M 1150 680 L 1150 730" stroke="#10b981" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <g class="component">
                <rect x="1000" y="730" width="300" height="80" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="3"/>
                <text x="1150" y="765" font-size="16" font-weight="bold" text-anchor="middle" fill="#065f46">‚úÖ Notification Delivered</text>
                <text x="1150" y="785" font-size="11" text-anchor="middle" fill="#065f46">Total latency: ~6 seconds (with retries)</text>
            </g>

            <!-- Permanent failure path -->
            <path d="M 600 640 L 200 640" stroke="#dc2626" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
            <text x="350" y="630" font-size="11" fill="#991b1b" font-weight="700">All attempts failed</text>

            <g class="component">
                <rect x="50" y="600" width="150" height="80" rx="10" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
                <text x="125" y="630" font-size="13" font-weight="bold" text-anchor="middle" fill="#991b1b">üíÄ DLQ</text>
                <text x="125" y="650" font-size="10" text-anchor="middle" fill="#991b1b">Dead Letter</text>
                <text x="125" y="665" font-size="10" text-anchor="middle" fill="#991b1b">Queue</text>
            </g>

            <!-- Manual review -->
            <path d="M 125 680 L 125 730" stroke="#9333ea" stroke-width="2" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>

            <g class="component">
                <rect x="25" y="730" width="200" height="80" rx="10" fill="#fce7f3" stroke="#db2777" stroke-width="2"/>
                <text x="125" y="760" font-size="12" font-weight="bold" text-anchor="middle" fill="#831843">üë®‚Äçüíº Manual Review</text>
                <text x="125" y="780" font-size="10" text-anchor="middle" fill="#831843">Alert ops team</text>
                <text x="125" y="795" font-size="9" text-anchor="middle" fill="#831843">Investigate + Requeue</text>
            </g>

            <!-- Monitoring -->
            <g class="component">
                <rect x="50" y="460" width="420" height="100" rx="10" fill="#e0f2fe" stroke="#0284c7" stroke-width="2"/>
                <text x="260" y="490" font-size="14" font-weight="bold" text-anchor="middle" fill="#075985">üìä Monitoring & Alerts</text>
                <text x="260" y="513" font-size="11" text-anchor="middle" fill="#075985">‚Ä¢ Track retry attempts per provider</text>
                <text x="260" y="530" font-size="11" text-anchor="middle" fill="#075985">‚Ä¢ Alert if failure rate > 5% for 5 min</text>
                <text x="260" y="547" font-size="11" text-anchor="middle" fill="#075985">‚Ä¢ Circuit breaker dashboard (open/closed state)</text>
            </g>
        </svg>

        <div class="flow-description">
            <h3>üîÑ Retry & Failure Handling Strategy</h3>
            <ol>
                <li><strong>Initial Attempt:</strong> Worker tries to send via primary provider (SendGrid)</li>
                <li><strong>Transient Failure Detection:</strong> Receives 503 error (server overload, temporary)</li>
                <li><strong>Exponential Backoff:</strong> Waits 2s ‚Üí 4s ‚Üí 8s ‚Üí 16s between attempts with random jitter to prevent thundering herd</li>
                <li><strong>Circuit Breaker:</strong> After 3 consecutive failures (5-failure threshold), circuit opens and routes to fallback provider (AWS SES)</li>
                <li><strong>Fallback Success:</strong> Secondary provider delivers successfully, notification sent with minimal delay</li>
                <li><strong>Dead Letter Queue (DLQ):</strong> If all providers fail after max retries, message goes to DLQ for manual investigation</li>
                <li><strong>Auto-Recovery:</strong> Circuit breaker closes after 30s cooldown period, allowing primary provider to recover</li>
            </ol>
            <div style="margin-top: 15px; padding: 15px; background: #fee2e2; border-left: 4px solid #dc2626; border-radius: 5px;">
                <strong>‚ö†Ô∏è Critical:</strong> Non-retriable errors (invalid recipient, malformed content) bypass retry logic and go straight to DLQ to prevent wasted attempts
            </div>
            <div style="margin-top: 10px; padding: 15px; background: #d1fae5; border-left: 4px solid #10b981; border-radius: 5px;">
                <strong>‚úÖ Resilience Benefits:</strong> 99.9% delivery rate even during provider outages. Average recovery time: 6 seconds
            </div>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="metrics-panel">
        <h2 style="margin-bottom: 15px; color: #92400e;">‚ö° System Performance Metrics</h2>
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value">100K</div>
                <div class="metric-label">Messages/sec throughput</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">&lt;5s</div>
                <div class="metric-label">P95 delivery latency</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">99.9%</div>
                <div class="metric-label">Delivery success rate</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">3-5</div>
                <div class="metric-label">Max retry attempts</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">30s</div>
                <div class="metric-label">Circuit breaker timeout</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">99.99%</div>
                <div class="metric-label">System availability</div>
            </div>
        </div>
    </div>
</div>

<script>
    function showDiagram(type) {
        // Hide all diagrams
        document.querySelectorAll('.diagram-container').forEach(d => {
            d.classList.remove('active');
        });

        // Remove active from all tabs
        document.querySelectorAll('.tab').forEach(t => {
            t.classList.remove('active');
        });

        // Show selected diagram
        document.getElementById(type + '-diagram').classList.add('active');

        // Activate clicked tab
        event.target.classList.add('active');
    }

    // Add hover effects
    document.querySelectorAll('.component').forEach(comp => {
        comp.addEventListener('mouseenter', function() {
            this.style.filter = 'drop-shadow(0 0 15px rgba(99, 102, 241, 0.6))';
        });

        comp.addEventListener('mouseleave', function() {
            this.style.filter = 'none';
        });
    });
</script>
</body>
</html>
