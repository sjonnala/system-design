<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messaging System Flow Diagram</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            font-size: 2.5em;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 30px;
            background: #e2e8f0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: #6366f1;
            color: white;
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .diagram-container {
            display: none;
            margin-top: 30px;
        }

        .diagram-container.active {
            display: block;
        }

        svg {
            width: 100%;
            height: auto;
        }

        .component {
            cursor: pointer;
            transition: all 0.3s;
        }

        .component:hover {
            filter: drop-shadow(0 0 10px rgba(99, 102, 241, 0.5));
        }

        .component rect {
            transition: all 0.3s;
        }

        .component:hover rect {
            stroke-width: 3;
        }

        .flow-arrow {
            animation: dash 20s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -1000;
            }
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            border: 2px solid #cbd5e0;
        }

        .metrics-panel {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde047 100%);
            border-radius: 15px;
            border: 2px solid #fbbf24;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #6366f1;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #6366f1;
        }

        .metric-label {
            font-size: 0.9em;
            color: #4a5568;
            margin-top: 5px;
        }

        .flow-description {
            background: #e0e7ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 5px solid #6366f1;
        }

        .flow-description h3 {
            color: #4338ca;
            margin-bottom: 10px;
        }

        .flow-description ol {
            margin-left: 20px;
            line-height: 2;
            color: #1e293b;
        }

        .flow-description ol li {
            margin: 8px 0;
        }

        .flow-description strong {
            color: #6366f1;
        }

        .flow-description ul {
            margin-left: 20px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸ’¬ Messaging System Flow Diagram</h1>
        <p style="color: #64748b; margin-top: 10px;">Interactive Component Flow Visualization</p>

        <div class="tabs">
            <button class="tab active" onclick="showDiagram('send')">ğŸ“¤ Send Message Flow</button>
            <button class="tab" onclick="showDiagram('receive')">ğŸ“¥ Receive Message Flow</button>
            <button class="tab" onclick="showDiagram('group')">ğŸ‘¥ Group Message Flow</button>
            <button class="tab" onclick="showDiagram('full')">ğŸ—ï¸ Full System Architecture</button>
        </div>
    </div>

    <!-- Send Message Flow Diagram -->
    <div id="send-diagram" class="diagram-container active">
        <svg viewBox="0 0 1400 1200" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#6366f1" />
                </marker>
                <linearGradient id="grad-sender" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-ws" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#f87171;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#ef4444;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-service" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#84cc16;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#65a30d;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-db" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#fb923c;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#f97316;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-receiver" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#818cf8;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#6366f1;stop-opacity:1" />
                </linearGradient>
            </defs>

            <!-- Title -->
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Send Message Flow: Real-Time Delivery
            </text>

            <!-- Sender Client -->
            <g class="component">
                <rect x="200" y="70" width="200" height="80" rx="10" fill="url(#grad-sender)" stroke="#2563eb" stroke-width="2"/>
                <text x="300" y="105" font-size="16" font-weight="bold" text-anchor="middle" fill="white">ğŸ“± Sender</text>
                <text x="300" y="125" font-size="12" text-anchor="middle" fill="white">Mobile Client</text>
            </g>

            <!-- Arrow 1 -->
            <path d="M 300 150 L 300 200" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="320" y="180" font-size="11" fill="#4338ca" font-weight="600">WebSocket msg</text>

            <!-- WebSocket Gateway -->
            <g class="component">
                <rect x="200" y="200" width="200" height="100" rx="10" fill="url(#grad-ws)" stroke="#dc2626" stroke-width="2"/>
                <text x="300" y="240" font-size="16" font-weight="bold" text-anchor="middle" fill="white">ğŸ”Œ WebSocket Gateway</text>
                <text x="300" y="260" font-size="12" text-anchor="middle" fill="white">Node.js Server</text>
                <text x="300" y="280" font-size="11" text-anchor="middle" fill="white">Validates & Routes</text>
            </g>

            <!-- Arrow 2 -->
            <path d="M 400 250 L 600 250" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="470" y="240" font-size="11" fill="#4338ca" font-weight="600">HTTP POST</text>

            <!-- Message Service -->
            <g class="component">
                <rect x="600" y="200" width="250" height="100" rx="10" fill="url(#grad-service)" stroke="#4d7c0f" stroke-width="2"/>
                <text x="725" y="235" font-size="16" font-weight="bold" text-anchor="middle" fill="white">ğŸ”§ Message Service</text>
                <text x="725" y="255" font-size="12" text-anchor="middle" fill="white">Spring Boot</text>
                <text x="725" y="275" font-size="11" text-anchor="middle" fill="white">â€¢ E2E Encrypt â€¢ Validate</text>
            </g>

            <!-- Arrow to Database -->
            <path d="M 725 300 L 725 380" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="745" y="345" font-size="11" fill="#4338ca" font-weight="600">Store msg</text>

            <!-- Database -->
            <g class="component">
                <rect x="625" y="380" width="200" height="100" rx="10" fill="url(#grad-db)" stroke="#ea580c" stroke-width="2"/>
                <text x="725" y="415" font-size="16" font-weight="bold" text-anchor="middle" fill="white">ğŸ—„ï¸ Cassandra</text>
                <text x="725" y="435" font-size="12" text-anchor="middle" fill="white">Messages Table</text>
                <text x="725" y="455" font-size="11" text-anchor="middle" fill="white">chat_id â†’ message</text>
            </g>

            <!-- Check Recipient Online -->
            <path d="M 850 250 L 1000 250" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="890" y="240" font-size="11" fill="#4338ca" font-weight="600">Check status</text>

            <!-- Presence Service (Decision) -->
            <g class="component">
                <path d="M 1100 200 L 1200 250 L 1100 300 L 1000 250 Z" fill="#fef3c7" stroke="#f59e0b" stroke-width="3"/>
                <text x="1100" y="245" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Recipient</text>
                <text x="1100" y="263" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Online?</text>
            </g>

            <!-- Online Path (Right) -->
            <path d="M 1200 250 L 1000 450" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>
            <text x="1130" y="340" font-size="12" fill="#059669" font-weight="700">YES âœ“</text>

            <!-- Receiver WebSocket -->
            <g class="component">
                <rect x="900" y="450" width="200" height="100" rx="10" fill="url(#grad-receiver)" stroke="#4f46e5" stroke-width="2"/>
                <text x="1000" y="490" font-size="14" font-weight="bold" text-anchor="middle" fill="white">ğŸ”Œ Receiver WS</text>
                <text x="1000" y="510" font-size="11" text-anchor="middle" fill="white">Push via WebSocket</text>
                <text x="1000" y="530" font-size="11" text-anchor="middle" fill="white">Latency: ~50ms</text>
            </g>

            <!-- Receiver Client -->
            <g class="component">
                <rect x="900" y="580" width="200" height="80" rx="10" fill="url(#grad-receiver)" stroke="#4f46e5" stroke-width="2"/>
                <text x="1000" y="615" font-size="16" font-weight="bold" text-anchor="middle" fill="white">ğŸ“± Receiver</text>
                <text x="1000" y="635" font-size="12" text-anchor="middle" fill="white">Message Delivered</text>
            </g>

            <path d="M 1000 550 L 1000 580" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Offline Path (Down) -->
            <path d="M 1100 300 L 1100 450" stroke="#ef4444" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>
            <text x="1030" y="380" font-size="12" fill="#dc2626" font-weight="700">NO âœ— (Offline)</text>

            <!-- Push Notification Service -->
            <g class="component">
                <rect x="1000" y="450" width="200" height="100" rx="10" fill="#fcd34d" stroke="#f59e0b" stroke-width="2"/>
                <text x="1100" y="490" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">ğŸ”” Push Service</text>
                <text x="1100" y="510" font-size="11" text-anchor="middle" fill="#92400e">FCM / APNS</text>
                <text x="1100" y="530" font-size="11" text-anchor="middle" fill="#92400e">Queue for delivery</text>
            </g>

            <path d="M 1100 550 L 1100 580" stroke="#ef4444" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Kafka Queue -->
            <g class="component">
                <rect x="200" y="380" width="200" height="100" rx="10" fill="#fca5a5" stroke="#ef4444" stroke-width="2"/>
                <text x="300" y="420" font-size="14" font-weight="bold" text-anchor="middle" fill="white">ğŸ“¬ Kafka Queue</text>
                <text x="300" y="440" font-size="11" text-anchor="middle" fill="white">message.sent event</text>
            </g>

            <path d="M 625 430 L 400 430" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>
            <text x="480" y="420" font-size="11" fill="#4338ca" font-weight="600">Publish event</text>

            <!-- Delivery Receipt Path -->
            <path d="M 900 620 L 300 620 L 300 150" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="8,4"/>
            <text x="550" y="610" font-size="12" fill="#059669" font-weight="700">â† Delivery Receipt</text>

            <!-- Step numbers -->
            <circle cx="300" cy="110" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="300" y="117" font-size="14" font-weight="bold" text-anchor="middle" fill="white">1</text>

            <circle cx="300" cy="250" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="300" y="257" font-size="14" font-weight="bold" text-anchor="middle" fill="white">2</text>

            <circle cx="725" cy="250" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="725" y="257" font-size="14" font-weight="bold" text-anchor="middle" fill="white">3</text>

            <circle cx="725" cy="430" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="725" y="437" font-size="14" font-weight="bold" text-anchor="middle" fill="white">4</text>

            <circle cx="1100" cy="250" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="1100" y="257" font-size="14" font-weight="bold" text-anchor="middle" fill="white">5</text>

            <circle cx="1000" cy="500" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="1000" y="507" font-size="14" font-weight="bold" text-anchor="middle" fill="white">6</text>
        </svg>

        <div class="flow-description">
            <h3>ğŸ“¤ Send Message Flow Steps</h3>
            <ol>
                <li><strong>Sender Creates Message:</strong> User types message in client app, clicks send</li>
                <li><strong>WebSocket Gateway:</strong> Message sent over persistent WebSocket connection to gateway server
                    <ul>
                        <li>Gateway validates message format</li>
                        <li>Authenticates sender using JWT token</li>
                        <li>Routes to Message Service</li>
                    </ul>
                </li>
                <li><strong>Message Service Processing:</strong>
                    <ul>
                        <li>Applies End-to-End encryption (Signal Protocol)</li>
                        <li>Validates recipient exists</li>
                        <li>Generates unique message ID (TIMEUUID)</li>
                        <li>Checks message content (spam, abuse detection)</li>
                    </ul>
                </li>
                <li><strong>Database Storage:</strong> Stores encrypted message in Cassandra
                    <ul>
                        <li>Indexed by chat_id for fast retrieval</li>
                        <li>Replication factor: 3 for durability</li>
                        <li>Async write for performance</li>
                    </ul>
                </li>
                <li><strong>Recipient Status Check:</strong> Query Redis/Presence service
                    <ul>
                        <li><strong>Online:</strong> Recipient has active WebSocket connection â†’ Go to step 6a</li>
                        <li><strong>Offline:</strong> Recipient not connected â†’ Go to step 6b</li>
                    </ul>
                </li>
                <li><strong>Message Delivery:</strong>
                    <ul>
                        <li><strong>6a (Online):</strong> Push message through WebSocket connection (~50ms delivery)</li>
                        <li><strong>6b (Offline):</strong> Queue push notification via FCM/APNS (delivery when user opens app)</li>
                    </ul>
                </li>
                <li><strong>Delivery Receipt:</strong> Receiver client acknowledges receipt, sender gets "delivered" status (double checkmark)</li>
                <li><strong>Read Receipt (Optional):</strong> When receiver views message, "read" status sent back (blue checkmarks)</li>
            </ol>
        </div>
    </div>

    <!-- Receive Message Flow -->
    <div id="receive-diagram" class="diagram-container">
        <svg viewBox="0 0 1400 900" xmlns="http://www.w3.org/2000/svg">
            <!-- Title -->
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Receive Message Flow: Client Perspective
            </text>

            <!-- WebSocket Connection -->
            <g class="component">
                <rect x="300" y="80" width="250" height="100" rx="10" fill="url(#grad-receiver)" stroke="#4f46e5" stroke-width="2"/>
                <text x="425" y="120" font-size="16" font-weight="bold" text-anchor="middle" fill="white">ğŸ”Œ Active WebSocket</text>
                <text x="425" y="140" font-size="12" text-anchor="middle" fill="white">Persistent Connection</text>
                <text x="425" y="160" font-size="11" text-anchor="middle" fill="white">Heartbeat every 30s</text>
            </g>

            <!-- Incoming Message -->
            <path d="M 550 130 L 700 130" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="600" y="120" font-size="11" fill="#059669" font-weight="600">New Message</text>

            <!-- Client App -->
            <g class="component">
                <rect x="700" y="80" width="250" height="100" rx="10" fill="url(#grad-sender)" stroke="#2563eb" stroke-width="2"/>
                <text x="825" y="120" font-size="16" font-weight="bold" text-anchor="middle" fill="white">ğŸ“± Client App</text>
                <text x="825" y="140" font-size="12" text-anchor="middle" fill="white">Message Handler</text>
                <text x="825" y="160" font-size="11" text-anchor="middle" fill="white">Decryption & Display</text>
            </g>

            <!-- Processing Steps -->
            <path d="M 825 180 L 825 240" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <g class="component">
                <rect x="700" y="240" width="250" height="180" rx="10" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
                <text x="825" y="270" font-size="14" font-weight="bold" text-anchor="middle" fill="#4338ca">Message Processing</text>
                <text x="720" y="300" font-size="12" text-anchor="start" fill="#1e293b">1. Decrypt with private key</text>
                <text x="720" y="325" font-size="12" text-anchor="start" fill="#1e293b">2. Verify message integrity (HMAC)</text>
                <text x="720" y="350" font-size="12" text-anchor="start" fill="#1e293b">3. Store in local SQLite DB</text>
                <text x="720" y="375" font-size="12" text-anchor="start" fill="#1e293b">4. Update UI (conversation list)</text>
                <text x="720" y="400" font-size="12" text-anchor="start" fill="#1e293b">5. Show notification (if app in background)</text>
            </g>

            <!-- Send Receipt -->
            <path d="M 700 330 L 550 330" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="8,4"/>
            <text x="580" y="320" font-size="12" fill="#059669" font-weight="700">â† Delivery Receipt</text>

            <!-- Offline Scenario -->
            <g class="component">
                <rect x="100" y="500" width="300" height="120" rx="10" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
                <text x="250" y="535" font-size="16" font-weight="bold" text-anchor="middle" fill="#991b1b">ğŸ“´ Offline Scenario</text>
                <text x="120" y="565" font-size="12" text-anchor="start" fill="#7f1d1d">1. WebSocket disconnected</text>
                <text x="120" y="585" font-size="12" text-anchor="start" fill="#7f1d1d">2. Push notification via FCM/APNS</text>
                <text x="120" y="605" font-size="12" text-anchor="start" fill="#7f1d1d">3. Message queued on server</text>
            </g>

            <!-- Reconnection -->
            <g class="component">
                <rect x="450" y="500" width="300" height="120" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="2"/>
                <text x="600" y="535" font-size="16" font-weight="bold" text-anchor="middle" fill="#065f46">ğŸ”„ On Reconnect</text>
                <text x="470" y="565" font-size="12" text-anchor="start" fill="#064e3b">1. Sync missed messages</text>
                <text x="470" y="585" font-size="12" text-anchor="start" fill="#064e3b">2. Fetch from server (last_message_id)</text>
                <text x="470" y="605" font-size="12" text-anchor="start" fill="#064e3b">3. Update local database</text>
            </g>

            <!-- Read Receipt -->
            <g class="component">
                <rect x="800" y="500" width="300" height="120" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                <text x="950" y="535" font-size="16" font-weight="bold" text-anchor="middle" fill="#92400e">âœ“âœ“ Read Receipt</text>
                <text x="820" y="565" font-size="12" text-anchor="start" fill="#78350f">1. User views message in chat</text>
                <text x="820" y="585" font-size="12" text-anchor="start" fill="#78350f">2. Client sends read event</text>
                <text x="820" y="605" font-size="12" text-anchor="start" fill="#78350f">3. Sender sees blue checkmarks</text>
            </g>

            <!-- Arrows -->
            <path d="M 250 420 L 250 500" stroke="#ef4444" stroke-width="3" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>
            <path d="M 600 420 L 600 500" stroke="#10b981" stroke-width="3" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>
            <path d="M 950 420 L 950 500" stroke="#f59e0b" stroke-width="3" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>
        </svg>

        <div class="flow-description">
            <h3>ğŸ“¥ Receive Message Flow</h3>
            <p style="margin-bottom: 15px; line-height: 1.8;">
                Message reception in modern messaging apps involves persistent WebSocket connections for real-time delivery,
                with fallback to push notifications when users are offline.
            </p>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px;">
                <div style="background: #f0f9ff; padding: 15px; border-radius: 10px; border-left: 4px solid #0284c7;">
                    <h4 style="color: #075985; margin-bottom: 8px;">ğŸŸ¢ Online Flow</h4>
                    <p style="font-size: 0.9em; color: #0c4a6e; line-height: 1.6;">
                        WebSocket connection active â†’ Message pushed instantly â†’ Decrypted on client â†’
                        Displayed in UI â†’ Delivery receipt sent back â†’ Read receipt when viewed
                    </p>
                </div>
                <div style="background: #fef2f2; padding: 15px; border-radius: 10px; border-left: 4px solid #dc2626;">
                    <h4 style="color: #991b1b; margin-bottom: 8px;">ğŸ”´ Offline Flow</h4>
                    <p style="font-size: 0.9em; color: #7f1d1d; line-height: 1.6;">
                        No WebSocket â†’ Push notification sent â†’ Message queued on server â†’
                        On reconnect: Sync missed messages â†’ Update local DB
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Group Message Flow -->
    <div id="group-diagram" class="diagram-container">
        <svg viewBox="0 0 1400 1000" xmlns="http://www.w3.org/2000/svg">
            <!-- Title -->
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Group Message Flow: Fan-Out Delivery
            </text>

            <!-- Sender -->
            <g class="component">
                <rect x="300" y="80" width="200" height="80" rx="10" fill="url(#grad-sender)" stroke="#2563eb" stroke-width="2"/>
                <text x="400" y="115" font-size="16" font-weight="bold" text-anchor="middle" fill="white">ğŸ“± Sender</text>
                <text x="400" y="135" font-size="12" text-anchor="middle" fill="white">Posts to group</text>
            </g>

            <!-- Message Service -->
            <g class="component">
                <rect x="575" y="80" width="250" height="80" rx="10" fill="url(#grad-service)" stroke="#4d7c0f" stroke-width="2"/>
                <text x="700" y="115" font-size="16" font-weight="bold" text-anchor="middle" fill="white">ğŸ‘¥ Group Service</text>
                <text x="700" y="135" font-size="12" text-anchor="middle" fill="white">Fan-out processor</text>
            </g>

            <path d="M 500 120 L 575 120" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>

            <!-- Fan-out Logic -->
            <g class="component">
                <rect x="575" y="200" width="250" height="120" rx="10" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
                <text x="700" y="230" font-size="14" font-weight="bold" text-anchor="middle" fill="#4338ca">Fan-Out Logic</text>
                <text x="600" y="255" font-size="11" text-anchor="start" fill="#1e293b">1. Fetch group members (max 256)</text>
                <text x="600" y="275" font-size="11" text-anchor="start" fill="#1e293b">2. For each member:</text>
                <text x="615" y="295" font-size="11" text-anchor="start" fill="#1e293b">   - Create message copy</text>
                <text x="615" y="315" font-size="11" text-anchor="start" fill="#1e293b">   - Check online status</text>
            </g>

            <path d="M 700 160 L 700 200" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Recipients -->
            <g class="component">
                <rect x="200" y="400" width="180" height="100" rx="10" fill="url(#grad-receiver)" stroke="#4f46e5" stroke-width="2"/>
                <text x="290" y="440" font-size="14" font-weight="bold" text-anchor="middle" fill="white">ğŸ“± Member 1</text>
                <text x="290" y="460" font-size="11" text-anchor="middle" fill="white">Online</text>
                <text x="290" y="480" font-size="11" text-anchor="middle" fill="white">â†’ WebSocket</text>
            </g>

            <g class="component">
                <rect x="410" y="400" width="180" height="100" rx="10" fill="url(#grad-receiver)" stroke="#4f46e5" stroke-width="2"/>
                <text x="500" y="440" font-size="14" font-weight="bold" text-anchor="middle" fill="white">ğŸ“± Member 2</text>
                <text x="500" y="460" font-size="11" text-anchor="middle" fill="white">Offline</text>
                <text x="500" y="480" font-size="11" text-anchor="middle" fill="white">â†’ Push Notif</text>
            </g>

            <g class="component">
                <rect x="620" y="400" width="180" height="100" rx="10" fill="url(#grad-receiver)" stroke="#4f46e5" stroke-width="2"/>
                <text x="710" y="440" font-size="14" font-weight="bold" text-anchor="middle" fill="white">ğŸ“± Member 3</text>
                <text x="710" y="460" font-size="11" text-anchor="middle" fill="white">Online</text>
                <text x="710" y="480" font-size="11" text-anchor="middle" fill="white">â†’ WebSocket</text>
            </g>

            <g class="component">
                <rect x="830" y="400" width="180" height="100" rx="10" fill="url(#grad-receiver)" stroke="#4f46e5" stroke-width="2"/>
                <text x="920" y="440" font-size="14" font-weight="bold" text-anchor="middle" fill="white">ğŸ“± Member N</text>
                <text x="920" y="460" font-size="11" text-anchor="middle" fill="white">Online</text>
                <text x="920" y="480" font-size="11" text-anchor="middle" fill="white">â†’ WebSocket</text>
            </g>

            <!-- Arrows to members -->
            <path d="M 575 320 L 290 400" stroke="#10b981" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 650 320 L 500 400" stroke="#ef4444" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 725 320 L 710 400" stroke="#10b981" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 825 320 L 920 400" stroke="#10b981" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <text x="700" y="360" font-size="13" fill="#6366f1" font-weight="700" text-anchor="middle">Parallel Delivery</text>

            <!-- Optimization Box -->
            <g class="component">
                <rect x="200" y="600" width="800" height="180" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                <text x="600" y="635" font-size="16" font-weight="bold" text-anchor="middle" fill="#92400e">âš¡ Optimization Strategies</text>

                <text x="220" y="670" font-size="13" font-weight="bold" text-anchor="start" fill="#78350f">1. Batch Processing</text>
                <text x="240" y="690" font-size="11" text-anchor="start" fill="#78350f">â€¢ Group members into batches of 50</text>
                <text x="240" y="710" font-size="11" text-anchor="start" fill="#78350f">â€¢ Process in parallel using thread pool</text>

                <text x="540" y="670" font-size="13" font-weight="bold" text-anchor="start" fill="#78350f">2. Message Deduplication</text>
                <text x="560" y="690" font-size="11" text-anchor="start" fill="#78350f">â€¢ Store once, reference multiple times</text>
                <text x="560" y="710" font-size="11" text-anchor="start" fill="#78350f">â€¢ Reduce storage by ~99%</text>

                <text x="220" y="745" font-size="13" font-weight="bold" text-anchor="start" fill="#78350f">3. Read Receipts</text>
                <text x="240" y="765" font-size="11" text-anchor="start" fill="#78350f">â€¢ Aggregate read counts (not per-user)</text>

                <text x="540" y="745" font-size="13" font-weight="bold" text-anchor="start" fill="#78350f">4. Large Groups (>100)</text>
                <text x="560" y="765" font-size="11" text-anchor="start" fill="#78350f">â€¢ Disable typing indicators, read receipts</text>
            </g>
        </svg>

        <div class="flow-description">
            <h3>ğŸ‘¥ Group Message Flow</h3>
            <p style="margin-bottom: 15px; line-height: 1.8;">
                Group messaging requires efficient fan-out delivery to potentially hundreds of recipients while maintaining performance.
            </p>
            <strong>Key Challenges:</strong>
            <ul>
                <li><strong>Scalability:</strong> Delivering to 256 members requires 256 individual operations</li>
                <li><strong>Storage:</strong> Storing duplicate messages wastes space â†’ Solution: Reference counting</li>
                <li><strong>Delivery:</strong> Mix of online/offline users requires different delivery paths</li>
                <li><strong>Receipts:</strong> Individual read receipts don't scale â†’ Aggregate counts instead</li>
            </ul>
        </div>
    </div>

    <!-- Full System Architecture -->
    <div id="full-diagram" class="diagram-container">
        <svg viewBox="0 0 1600 1200" xmlns="http://www.w3.org/2000/svg">
            <!-- Title -->
            <text x="800" y="35" font-size="28" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Complete Messaging System Architecture
            </text>

            <!-- Layers -->
            <text x="50" y="100" font-size="14" font-weight="bold" fill="#64748b">CLIENT</text>
            <text x="50" y="260" font-size="14" font-weight="bold" fill="#64748b">EDGE</text>
            <text x="50" y="400" font-size="14" font-weight="bold" fill="#64748b">APPLICATION</text>
            <text x="50" y="750" font-size="14" font-weight="bold" fill="#64748b">DATA</text>
            <text x="50" y="1050" font-size="14" font-weight="bold" fill="#64748b">SERVICES</text>

            <!-- Dividers -->
            <line x1="200" y1="200" x2="1550" y2="200" stroke="#e2e8f0" stroke-width="2" stroke-dasharray="10,5"/>
            <line x1="200" y1="330" x2="1550" y2="330" stroke="#e2e8f0" stroke-width="2" stroke-dasharray="10,5"/>
            <line x1="200" y1="680" x2="1550" y2="680" stroke="#e2e8f0" stroke-width="2" stroke-dasharray="10,5"/>
            <line x1="200" y1="1000" x2="1550" y2="1000" stroke="#e2e8f0" stroke-width="2" stroke-dasharray="10,5"/>

            <!-- CLIENT LAYER -->
            <g class="component">
                <rect x="300" y="80" width="140" height="70" rx="10" fill="url(#grad-sender)" stroke="#2563eb" stroke-width="2"/>
                <text x="370" y="115" font-size="13" font-weight="bold" text-anchor="middle" fill="white">ğŸ“± iOS</text>
            </g>
            <g class="component">
                <rect x="480" y="80" width="140" height="70" rx="10" fill="url(#grad-sender)" stroke="#2563eb" stroke-width="2"/>
                <text x="550" y="115" font-size="13" font-weight="bold" text-anchor="middle" fill="white">ğŸ¤– Android</text>
            </g>
            <g class="component">
                <rect x="660" y="80" width="140" height="70" rx="10" fill="url(#grad-sender)" stroke="#2563eb" stroke-width="2"/>
                <text x="730" y="115" font-size="13" font-weight="bold" text-anchor="middle" fill="white">ğŸ’» Web</text>
            </g>

            <!-- Arrows -->
            <path d="M 370 150 L 370 260" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 550 150 L 550 260" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 730 150 L 730 260" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <!-- EDGE LAYER -->
            <g class="component">
                <rect x="250" y="260" width="200" height="60" rx="10" fill="#a5f3fc" stroke="#0891b2" stroke-width="2"/>
                <text x="350" y="295" font-size="12" font-weight="bold" text-anchor="middle" fill="#164e63">âš¡ CDN</text>
            </g>
            <g class="component">
                <rect x="490" y="260" width="200" height="60" rx="10" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
                <text x="590" y="295" font-size="12" font-weight="bold" text-anchor="middle" fill="#991b1b">ğŸ›¡ï¸ DDoS</text>
            </g>
            <g class="component">
                <rect x="730" y="260" width="200" height="60" rx="10" fill="url(#grad-ws)" stroke="#dc2626" stroke-width="2"/>
                <text x="830" y="295" font-size="12" font-weight="bold" text-anchor="middle" fill="white">âš–ï¸ LB</text>
            </g>

            <path d="M 590 320 L 590 400" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <!-- APPLICATION LAYER -->
            <g class="component">
                <rect x="250" y="400" width="200" height="80" rx="10" fill="url(#grad-ws)" stroke="#dc2626" stroke-width="2"/>
                <text x="350" y="440" font-size="13" font-weight="bold" text-anchor="middle" fill="white">ğŸ”Œ WebSocket</text>
                <text x="350" y="460" font-size="10" text-anchor="middle" fill="white">Connection Pool</text>
            </g>
            <g class="component">
                <rect x="480" y="400" width="180" height="80" rx="10" fill="url(#grad-service)" stroke="#4d7c0f" stroke-width="2"/>
                <text x="570" y="435" font-size="12" font-weight="bold" text-anchor="middle" fill="white">ğŸ’¬ Message</text>
                <text x="570" y="455" font-size="10" text-anchor="middle" fill="white">Service</text>
            </g>
            <g class="component">
                <rect x="690" y="400" width="180" height="80" rx="10" fill="url(#grad-service)" stroke="#4d7c0f" stroke-width="2"/>
                <text x="780" y="435" font-size="12" font-weight="bold" text-anchor="middle" fill="white">ğŸ‘¥ Group</text>
                <text x="780" y="455" font-size="10" text-anchor="middle" fill="white">Service</text>
            </g>
            <g class="component">
                <rect x="900" y="400" width="180" height="80" rx="10" fill="url(#grad-service)" stroke="#4d7c0f" stroke-width="2"/>
                <text x="990" y="435" font-size="12" font-weight="bold" text-anchor="middle" fill="white">ğŸ‘¤ User</text>
                <text x="990" y="455" font-size="10" text-anchor="middle" fill="white">Service</text>
            </g>

            <!-- Supporting Services -->
            <g class="component">
                <rect x="250" y="520" width="150" height="60" rx="10" fill="#fde047" stroke="#facc15" stroke-width="2"/>
                <text x="325" y="555" font-size="11" font-weight="bold" text-anchor="middle" fill="#78350f">ğŸ‘ï¸ Presence</text>
            </g>
            <g class="component">
                <rect x="430" y="520" width="150" height="60" rx="10" fill="#fcd34d" stroke="#f59e0b" stroke-width="2"/>
                <text x="505" y="555" font-size="11" font-weight="bold" text-anchor="middle" fill="#78350f">ğŸ”” Push</text>
            </g>
            <g class="component">
                <rect x="610" y="520" width="150" height="60" rx="10" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
                <text x="685" y="555" font-size="11" font-weight="bold" text-anchor="middle" fill="#4338ca">ğŸ–¼ï¸ Media</text>
            </g>

            <!-- Queue -->
            <g class="component">
                <rect x="250" y="600" width="510" height="60" rx="10" fill="#fca5a5" stroke="#ef4444" stroke-width="2"/>
                <text x="505" y="635" font-size="13" font-weight="bold" text-anchor="middle" fill="white">ğŸ“¬ Kafka / RabbitMQ</text>
            </g>

            <path d="M 350 480 L 350 600" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>
            <path d="M 570 480 L 570 600" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>

            <!-- Arrows to data layer -->
            <path d="M 350 480 L 400 750" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 570 480 L 520 750" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 570 480 L 850 750" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <!-- DATA LAYER -->
            <g class="component">
                <rect x="250" y="750" width="220" height="100" rx="10" fill="url(#grad-db)" stroke="#ea580c" stroke-width="2"/>
                <text x="360" y="790" font-size="13" font-weight="bold" text-anchor="middle" fill="white">ğŸ—„ï¸ Cassandra</text>
                <text x="360" y="810" font-size="10" text-anchor="middle" fill="white">Messages (Time-series)</text>
            </g>
            <g class="component">
                <rect x="500" y="750" width="200" height="100" rx="10" fill="#fed7aa" stroke="#ea580c" stroke-width="2"/>
                <text x="600" y="790" font-size="12" font-weight="bold" text-anchor="middle" fill="#9a3412">ğŸ˜ PostgreSQL</text>
                <text x="600" y="810" font-size="10" text-anchor="middle" fill="#9a3412">Users, Groups</text>
            </g>
            <g class="component">
                <rect x="730" y="750" width="200" height="100" rx="10" fill="#fbcfe8" stroke="#f472b6" stroke-width="2"/>
                <text x="830" y="790" font-size="13" font-weight="bold" text-anchor="middle" fill="white">ğŸ’¾ Redis</text>
                <text x="830" y="810" font-size="10" text-anchor="middle" fill="white">Cache, Presence</text>
            </g>
            <g class="component">
                <rect x="960" y="750" width="200" height="100" rx="10" fill="#bae6fd" stroke="#0284c7" stroke-width="2"/>
                <text x="1060" y="790" font-size="12" font-weight="bold" text-anchor="middle" fill="#075985">â˜ï¸ S3</text>
                <text x="1060" y="810" font-size="10" text-anchor="middle" fill="#075985">Media Files</text>
            </g>

            <!-- SERVICES LAYER -->
            <g class="component">
                <rect x="250" y="1050" width="250" height="80" rx="10" fill="#c084fc" stroke="#9333ea" stroke-width="2"/>
                <text x="375" y="1090" font-size="13" font-weight="bold" text-anchor="middle" fill="white">ğŸ“Š Analytics</text>
            </g>
            <g class="component">
                <rect x="530" y="1050" width="250" height="80" rx="10" fill="#99f6e4" stroke="#2dd4bf" stroke-width="2"/>
                <text x="655" y="1090" font-size="13" font-weight="bold" text-anchor="middle" fill="#134e4a">ğŸ“ˆ Monitoring</text>
            </g>
            <g class="component">
                <rect x="810" y="1050" width="250" height="80" rx="10" fill="#fca5a5" stroke="#ef4444" stroke-width="2"/>
                <text x="935" y="1090" font-size="13" font-weight="bold" text-anchor="middle" fill="white">ğŸš¨ Alerting</text>
            </g>

            <path d="M 505 660 L 505 1050" stroke="#9333ea" stroke-width="2" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>
        </svg>

        <div class="flow-description">
            <h3>ğŸ—ï¸ Full System Architecture Overview</h3>
            <p style="margin-bottom: 15px; line-height: 1.8;">
                This diagram shows the complete messaging system with all layers working together.
                The architecture follows a <strong>microservices pattern</strong> optimized for real-time communication
                with <strong>WebSocket-based persistent connections</strong>.
            </p>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px;">
                <div style="background: #f0f9ff; padding: 15px; border-radius: 10px; border-left: 4px solid #0284c7;">
                    <h4 style="color: #075985; margin-bottom: 8px;">ğŸ“¤ Send Path</h4>
                    <p style="font-size: 0.9em; color: #0c4a6e; line-height: 1.6;">
                        Client â†’ WebSocket â†’ Message Service â†’ Cassandra â†’ Kafka â†’ Recipient
                    </p>
                </div>
                <div style="background: #f0fdf4; padding: 15px; border-radius: 10px; border-left: 4px solid #10b981;">
                    <h4 style="color: #065f46; margin-bottom: 8px;">ğŸ“¥ Receive Path</h4>
                    <p style="font-size: 0.9em; color: #064e3b; line-height: 1.6;">
                        Sender â†’ Service â†’ Check Presence â†’ WebSocket (online) OR Push (offline)
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Metrics Panel -->
    <div class="metrics-panel">
        <h2 style="margin-bottom: 15px; color: #92400e;">âš¡ System Performance Metrics</h2>
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value">1M</div>
                <div class="metric-label">msg/sec Peak</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">50ms</div>
                <div class="metric-label">P95 Latency</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">100K</div>
                <div class="metric-label">Connections/Server</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">10 PB</div>
                <div class="metric-label">Message Storage</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">99.99%</div>
                <div class="metric-label">Availability</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">95%</div>
                <div class="metric-label">Cache Hit Rate</div>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #60a5fa, #3b82f6);"></div>
            <span>Client Layer</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #f87171, #ef4444);"></div>
            <span>WebSocket/Gateway</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #84cc16, #65a30d);"></div>
            <span>Services</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #f472b6, #ec4899);"></div>
            <span>Cache</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #fb923c, #f97316);"></div>
            <span>Database</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #c084fc, #a855f7);"></div>
            <span>Analytics</span>
        </div>
    </div>
</div>

<script>
    function showDiagram(type) {
        document.querySelectorAll('.diagram-container').forEach(d => {
            d.classList.remove('active');
        });

        document.querySelectorAll('.tab').forEach(t => {
            t.classList.remove('active');
        });

        document.getElementById(type + '-diagram').classList.add('active');
        event.target.classList.add('active');
    }

    document.querySelectorAll('.component').forEach(comp => {
        comp.addEventListener('mouseenter', function() {
            this.style.filter = 'drop-shadow(0 0 15px rgba(99, 102, 241, 0.6))';
        });

        comp.addEventListener('mouseleave', function() {
            this.style.filter = 'none';
        });
    });
</script>
</body>
</html>
