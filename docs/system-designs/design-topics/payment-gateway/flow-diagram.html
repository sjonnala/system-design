<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Gateway Flow Diagrams</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #7c3aed;
        }

        .header h1 {
            font-size: 2.5em;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 30px;
            background: #e2e8f0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: #7c3aed;
            color: white;
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .diagram-container {
            display: none;
            margin-top: 30px;
        }

        .diagram-container.active {
            display: block;
        }

        .flow-description {
            background: #e0e7ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 5px solid #7c3aed;
        }

        .flow-description h3 {
            color: #4338ca;
            margin-bottom: 10px;
        }

        .flow-description ol {
            margin-left: 20px;
            line-height: 2;
            color: #1e293b;
        }

        .flow-description ol li {
            margin: 8px 0;
        }

        .flow-description strong {
            color: #7c3aed;
        }

        .metrics-panel {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #dcfce7 0%, #86efac 100%);
            border-radius: 15px;
            border: 2px solid #10b981;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #7c3aed;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #7c3aed;
        }

        .metric-label {
            font-size: 0.9em;
            color: #4a5568;
            margin-top: 5px;
        }

        svg {
            width: 100%;
            height: auto;
        }

        .component {
            cursor: pointer;
            transition: all 0.3s;
        }

        .component:hover {
            filter: drop-shadow(0 0 10px rgba(124, 58, 237, 0.5));
        }

        .flow-arrow {
            animation: dash 20s linear infinite;
        }

        @keyframes dash {
            to { stroke-dashoffset: -1000; }
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            border: 2px solid #cbd5e0;
        }

        .code-box {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            margin-top: 10px;
        }

        .highlight {
            color: #fbbf24;
            font-weight: 600;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸ’³ Payment Gateway Flow Diagrams</h1>
        <p style="color: #64748b; margin-top: 10px;">Interactive Payment Processing Flows</p>

        <div class="tabs">
            <button class="tab active" onclick="showDiagram('authorization')">ğŸ’° Authorization Flow</button>
            <button class="tab" onclick="showDiagram('3ds')">ğŸ” 3DS Authentication</button>
            <button class="tab" onclick="showDiagram('refund')">â†©ï¸ Refund Flow</button>
            <button class="tab" onclick="showDiagram('full')">ğŸ—ï¸ Full System Flow</button>
        </div>
    </div>

    <!-- Authorization Flow -->
    <div id="authorization-diagram" class="diagram-container active">
        <div style="background: white; padding: 30px; border-radius: 15px; border: 2px solid #e2e8f0;">
            <h2 style="color: #2d3748; text-align: center; margin-bottom: 20px;">ğŸ’° Payment Authorization & Capture Flow</h2>

            <div style="font-family: monospace; font-size: 0.9em; line-height: 2;">
<pre style="color: #1e293b;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Merchant   â”‚ Creates payment intent
â”‚ Application â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ POST /v1/payment-intents
       â”‚ {amount: 1999, currency: "usd", payment_method: "pm_xxx"}
       â”‚ Idempotency-Key: uuid-v4
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       API Gateway                    â”‚
â”‚  1. Validate API key                 â”‚
â”‚  2. Check idempotency key            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Rate limit check (1000/min)      â”‚        â”‚ Redis Cache
â”‚  4. Request schema validation        â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”˜ GET idempotency:uuid
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ â†’ Return cached if exists
       â”‚                                         â”‚ â†’ Continue if new
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Payment Service (Core Engine)     â”‚
â”‚                                      â”‚
â”‚  Step 1: Create Payment Intent      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  â€¢ Generate UUID                     â”‚
â”‚  â€¢ Set status = PENDING              â”‚
â”‚  â€¢ Store in PostgreSQL               â”‚
â”‚                                      â”‚
â”‚  Step 2: Fraud Check (Async)        â”‚â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚       â”‚
â”‚  â€¢ Enqueue fraud.check event         â”‚       â–¼
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                  â”‚ Fraud Service   â”‚
       â”‚                                  â”‚ â€¢ Velocity checkâ”‚
       â”‚                                  â”‚ â€¢ ML model      â”‚
       â”‚                                  â”‚ â€¢ Risk score    â”‚
       â”‚                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Return payment_intent                    â”‚
       â”‚ {id: pi_xxx, status: "requires_confirmation"}
       â–¼                                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚  Merchant   â”‚ Display payment UI                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
       â”‚ Customer enters card details             â”‚
       â”‚ (Tokenized by Stripe.js - PCI compliant) â”‚
       â”‚                                           â”‚
       â”‚ POST /v1/payment-intents/{id}/confirm    â”‚
       â”‚ {payment_method: "pm_card_visa"}         â”‚
       â–¼                                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚    Payment Service                   â”‚          â”‚
â”‚                                      â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  Step 3: Authorize Payment           â”‚ Fraud result (risk_score: 0.15)
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  â€¢ Validate fraud score (< 0.5)      â”‚
â”‚  â€¢ Update status = AUTHORIZING       â”‚
â”‚  â€¢ Call processor API                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Payment Processor Adapter           â”‚
â”‚  (Circuit Breaker Pattern)           â”‚
â”‚                                      â”‚
â”‚  â€¢ Timeout: 10s connect, 30s read    â”‚
â”‚  â€¢ Retry: 3 attempts with jitter     â”‚
â”‚  â€¢ Fallback: Route to backup         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Stripe API                   â”‚
â”‚  POST /v1/charges                    â”‚
â”‚                                      â”‚
â”‚  â€¢ Validate card (Luhn algorithm)    â”‚
â”‚  â€¢ Check available balance           â”‚
â”‚  â€¢ Contact issuing bank              â”‚
â”‚  â€¢ Reserve funds (authorization)     â”‚
â”‚  â€¢ Return authorization code         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Response: {status: "succeeded", auth_code: "123456"}
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Payment Service                   â”‚
â”‚                                      â”‚
â”‚  Step 4: Update Transaction (ACID)  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;
â”‚                                      â”‚
â”‚  UPDATE payment_transactions SET     â”‚
â”‚    status = 'AUTHORIZED',            â”‚
â”‚    authorized_amount = 19.99,        â”‚
â”‚    authorization_code = '123456',    â”‚
â”‚    authorization_expires_at = NOW() + INTERVAL '7 days',
â”‚    version = version + 1             â”‚
â”‚  WHERE                               â”‚
â”‚    id = 'pi_xxx'                     â”‚
â”‚    AND status = 'PENDING'            â”‚
â”‚    AND version = 1;                  â”‚
â”‚                                      â”‚
â”‚  INSERT INTO transaction_events (...); -- Audit log
â”‚                                      â”‚
â”‚  COMMIT;                             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Enqueue webhook event
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Kafka                        â”‚
â”‚  Topic: payment.authorized           â”‚
â”‚  {id: pi_xxx, status: "authorized"}  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚          â”‚
       â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Webhook    â”‚              â”‚   Analytics     â”‚
â”‚   Service    â”‚              â”‚   Consumer      â”‚
â”‚              â”‚              â”‚                 â”‚
â”‚ â€¢ Deliver to â”‚              â”‚ â€¢ Store in      â”‚
â”‚   merchant   â”‚              â”‚   ClickHouse    â”‚
â”‚ â€¢ Retry 5x   â”‚              â”‚ â€¢ Update metricsâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PHASE 2: CAPTURE (Transfer Funds)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[Time passes: Hours to days later]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Merchant   â”‚ Ready to capture funds (ship product)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ POST /v1/payment-intents/{id}/capture
       â”‚ {amount: 1999}  // Optional: can capture less
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Payment Service                   â”‚
â”‚                                      â”‚
â”‚  Step 1: Validate Can Capture        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  â€¢ Check status = AUTHORIZED         â”‚
â”‚  â€¢ Check not expired (< 7 days)      â”‚
â”‚  â€¢ Check amount <= authorized_amount â”‚
â”‚  â€¢ Check version (optimistic lock)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Payment Processor (Stripe)          â”‚
â”‚  POST /v1/charges/{ch_xxx}/capture   â”‚
â”‚                                      â”‚
â”‚  â€¢ Transfer reserved funds           â”‚
â”‚  â€¢ Debit customer account            â”‚
â”‚  â€¢ Credit merchant account           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Response: {status: "succeeded", captured: true}
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Payment Service (ACID Update)     â”‚
â”‚                                      â”‚
â”‚  BEGIN TRANSACTION;                  â”‚
â”‚                                      â”‚
â”‚  UPDATE payment_transactions SET     â”‚
â”‚    status = 'CAPTURED',              â”‚
â”‚    captured_amount = 19.99,          â”‚
â”‚    captured_at = NOW(),              â”‚
â”‚    version = version + 1             â”‚
â”‚  WHERE                               â”‚
â”‚    id = 'pi_xxx'                     â”‚
â”‚    AND status = 'AUTHORIZED'         â”‚
â”‚    AND version = 2;                  â”‚
â”‚                                      â”‚
â”‚  INSERT INTO transaction_events (...); -- Audit
â”‚                                      â”‚
â”‚  COMMIT;                             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Send webhook: payment_intent.succeeded
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Merchant   â”‚ Receive confirmation, fulfill order
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

</pre>
            </div>
        </div>

        <div class="flow-description">
            <h3>ğŸ’° Authorization & Capture Flow Explanation</h3>
            <ol>
                <li><strong>Payment Intent Creation:</strong> Merchant creates a payment intent with amount and currency. API Gateway validates the request, checks idempotency key in Redis to prevent duplicates.</li>
                <li><strong>Fraud Detection:</strong> Async fraud check runs in parallel using ML model + rule engine. Risk score calculated based on velocity, geography, amount anomalies.</li>
                <li><strong>Authorization:</strong> Payment service calls Stripe API which contacts issuing bank to reserve funds on customer's card. Funds are held for 7 days.</li>
                <li><strong>ACID Transaction Update:</strong> PostgreSQL transaction updates payment status to AUTHORIZED with authorization code. Uses optimistic locking (version field) to prevent race conditions.</li>
                <li><strong>Webhook Notification:</strong> Kafka event published, webhook service delivers async notification to merchant with retry logic (exponential backoff).</li>
                <li><strong>Capture Phase:</strong> When merchant is ready to ship product, they call capture endpoint. This transfers the reserved funds from customer to merchant.</li>
                <li><strong>Settlement:</strong> Captured payments are batched daily and settled to merchant's bank account (T+2 settlement cycle).</li>
            </ol>
            <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 5px;">
                <strong>ğŸ¯ Key Insight:</strong> Two-phase commit (authorize then capture) allows merchants to validate orders before charging. Authorization can be voided if order is canceled, preventing unnecessary refunds.
            </div>
        </div>
    </div>

    <!-- 3DS Authentication Flow -->
    <div id="3ds-diagram" class="diagram-container">
        <div style="background: white; padding: 30px; border-radius: 15px; border: 2px solid #e2e8f0;">
            <h2 style="color: #2d3748; text-align: center; margin-bottom: 20px;">ğŸ” 3D Secure (3DS) Authentication Flow</h2>

            <div style="font-family: monospace; font-size: 0.9em; line-height: 2;">
<pre style="color: #1e293b;">
3DS 2.0: Strong Customer Authentication (SCA) - Required by PSD2 in EU

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Customer   â”‚ Initiates payment
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Payment Service                   â”‚
â”‚                                      â”‚
â”‚  â€¢ Create payment intent             â”‚
â”‚  â€¢ Determine if 3DS required         â”‚
â”‚    - Transaction amount > â‚¬30        â”‚
â”‚    - Card issuer requires 3DS        â”‚
â”‚    - Merchant risk settings          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3DS Required
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    3DS Server (Stripe/Adyen)         â”‚
â”‚                                      â”‚
â”‚  Step 1: Method URL Call             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  â€¢ Collect browser fingerprint       â”‚
â”‚  â€¢ Device info, timezone, screen res â”‚
â”‚  â€¢ Send to card issuer ACS           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Card Issuer ACS (Access Control)    â”‚
â”‚  (Bank's authentication server)      â”‚
â”‚                                      â”‚
â”‚  â€¢ Perform frictionless risk check   â”‚
â”‚  â€¢ Analyze transaction patterns      â”‚
â”‚  â€¢ Determine challenge required?     â”‚
â”‚    - Low risk: Approve (frictionless)â”‚
â”‚    - High risk: Challenge customer   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ Low Risk        â”‚ High Risk    â”‚
       â–¼                 â–¼              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”
â”‚ Frictionless â”‚  â”‚  Challenge Flow           â”‚
â”‚ Approval     â”‚  â”‚                           â”‚
â”‚ (85% cases)  â”‚  â”‚  â€¢ Customer redirected    â”‚
â”‚              â”‚  â”‚  â€¢ Bank's mobile app      â”‚
â”‚              â”‚  â”‚  â€¢ Enter OTP/PIN/biometricâ”‚
â”‚              â”‚  â”‚  â€¢ Verify identity        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                       â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Card Issuer Response                â”‚
â”‚                                      â”‚
â”‚  {                                   â”‚
â”‚    "authentication_status": "Y",     â”‚  // Y = Success
â”‚    "eci": "05",                      â”‚  // E-commerce Indicator
â”‚    "cavv": "base64_encoded",         â”‚  // Auth value
â”‚    "xid": "transaction_id"           â”‚
â”‚  }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Payment Service                   â”‚
â”‚                                      â”‚
â”‚  â€¢ Receive 3DS result                â”‚
â”‚  â€¢ Attach auth data to payment       â”‚
â”‚  â€¢ Proceed with authorization        â”‚
â”‚  â€¢ Liability shift to issuer!        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Payment Processor (Stripe)          â”‚
â”‚  POST /v1/charges                    â”‚
â”‚  {                                   â”‚
â”‚    "three_d_secure": {               â”‚
â”‚      "authenticated": true,          â”‚
â”‚      "eci": "05",                    â”‚
â”‚      "cavv": "..."                   â”‚
â”‚    }                                 â”‚
â”‚  }                                   â”‚
â”‚                                      â”‚
â”‚  â€¢ Lower interchange fees            â”‚
â”‚  â€¢ Reduced fraud liability           â”‚
â”‚  â€¢ Higher authorization rate         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


KEY BENEFITS OF 3DS 2.0:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… Liability Shift: Fraud chargebacks â†’ Issuing bank (not merchant)
âœ… Lower Fees: Interchange fees reduced for authenticated transactions
âœ… Better UX: Frictionless flow for 85% of transactions (vs 3DS 1.0)
âœ… SCA Compliance: Required by PSD2 for EU transactions
âœ… Higher Auth Rate: Banks approve more 3DS-authenticated payments

EXEMPTIONS (Can skip 3DS):
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â€¢ Low value: < â‚¬30
â€¢ Recurring payments (subscription after first auth)
â€¢ Trusted beneficiary (customer whitelisted merchant)
â€¢ Low-risk transaction (based on fraud scoring)
â€¢ Corporate cards
â€¢ Merchant-initiated transactions (MIT)
</pre>
            </div>
        </div>

        <div class="flow-description">
            <h3>ğŸ” 3D Secure Authentication Explanation</h3>
            <ol>
                <li><strong>3DS Trigger:</strong> Payment service determines if 3DS is required based on amount (>â‚¬30), card issuer rules, or merchant settings for SCA compliance.</li>
                <li><strong>Frictionless Flow (85%):</strong> Bank analyzes device fingerprint, transaction patterns, and risk signals to approve without customer action. Seamless UX!</li>
                <li><strong>Challenge Flow (15%):</strong> For high-risk transactions, customer is redirected to bank's page/app to enter OTP, PIN, or biometric authentication.</li>
                <li><strong>Liability Shift:</strong> Once 3DS authentication succeeds, fraud liability shifts from merchant to issuing bank. Massive risk reduction!</li>
                <li><strong>Lower Fees:</strong> Authenticated transactions qualify for lower interchange fees from card networks (Visa/Mastercard).</li>
                <li><strong>Higher Authorization Rate:</strong> Banks approve 3DS-authenticated transactions at higher rates (95%+ vs 85% for non-3DS).</li>
            </ol>
            <div style="margin-top: 15px; padding: 15px; background: #dcfce7; border-left: 4px solid #10b981; border-radius: 5px;">
                <strong>ğŸ’¡ Pro Tip:</strong> Implement adaptive 3DS - only trigger when required by regulation or fraud rules. Over-using 3DS reduces conversion (7-10% drop in checkout completion).
            </div>
        </div>
    </div>

    <!-- Refund Flow -->
    <div id="refund-diagram" class="diagram-container">
        <div style="background: white; padding: 30px; border-radius: 15px; border: 2px solid #e2e8f0;">
            <h2 style="color: #2d3748; text-align: center; margin-bottom: 20px;">â†©ï¸ Refund Processing Flow</h2>

            <div style="font-family: monospace; font-size: 0.9em; line-height: 2;">
<pre style="color: #1e293b;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Merchant   â”‚ Customer requests refund
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ POST /v1/refunds
       â”‚ {
       â”‚   "payment_intent": "pi_xxx",
       â”‚   "amount": 1999,  // Full or partial
       â”‚   "reason": "requested_by_customer"
       â”‚ }
       â”‚ Idempotency-Key: uuid-v4
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       API Gateway                    â”‚
â”‚  â€¢ Validate API key & idempotency    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Refund Service                    â”‚
â”‚                                      â”‚
â”‚  Step 1: Validation                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  â€¢ Payment exists & captured?        â”‚
â”‚  â€¢ Refund amount valid?              â”‚
â”‚  â€¢ Not already fully refunded?       â”‚
â”‚                                      â”‚
â”‚  SELECT                              â”‚
â”‚    status,                           â”‚
â”‚    captured_amount,                  â”‚
â”‚    refunded_amount                   â”‚
â”‚  FROM payment_transactions           â”‚
â”‚  WHERE id = 'pi_xxx';                â”‚
â”‚                                      â”‚
â”‚  Validation checks:                  â”‚
â”‚  âœ“ status = 'CAPTURED'               â”‚
â”‚  âœ“ refund_amount <= (captured - refunded)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Payment Processor (Stripe)          â”‚
â”‚  POST /v1/refunds                    â”‚
â”‚                                      â”‚
â”‚  â€¢ Initiate refund with card network â”‚
â”‚  â€¢ Debit merchant account            â”‚
â”‚  â€¢ Credit customer account           â”‚
â”‚  â€¢ Returns refund ID                 â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Response: {id: re_xxx, status: "succeeded"}
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Refund Service (ACID Update)      â”‚
â”‚                                      â”‚
â”‚  BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;
â”‚                                      â”‚
â”‚  -- Update original payment          â”‚
â”‚  UPDATE payment_transactions SET     â”‚
â”‚    refunded_amount = refunded_amount + 19.99,
â”‚    status = CASE                     â”‚
â”‚      WHEN (refunded_amount + 19.99) = captured_amount
â”‚        THEN 'REFUNDED'               â”‚
â”‚      ELSE 'PARTIALLY_REFUNDED'       â”‚
â”‚    END,                              â”‚
â”‚    version = version + 1             â”‚
â”‚  WHERE                               â”‚
â”‚    id = 'pi_xxx'                     â”‚
â”‚    AND status IN ('CAPTURED', 'PARTIALLY_REFUNDED')
â”‚    AND version = 3                   â”‚
â”‚    AND (refunded_amount + 19.99) <= captured_amount;  -- Safety!
â”‚                                      â”‚
â”‚  IF @@ROWCOUNT = 0 THEN              â”‚
â”‚    ROLLBACK;                         â”‚
â”‚    RAISE 'Concurrent modification or invalid refund amount';
â”‚  END IF;                             â”‚
â”‚                                      â”‚
â”‚  -- Create refund record             â”‚
â”‚  INSERT INTO refunds (               â”‚
â”‚    id, payment_transaction_id,       â”‚
â”‚    amount, reason, status            â”‚
â”‚  ) VALUES (                          â”‚
â”‚    're_xxx', 'pi_xxx',               â”‚
â”‚    19.99, 'requested_by_customer', 'SUCCEEDED'
â”‚  );                                  â”‚
â”‚                                      â”‚
â”‚  -- Audit log                        â”‚
â”‚  INSERT INTO transaction_events (    â”‚
â”‚    transaction_id, event_type, event_data
â”‚  ) VALUES (                          â”‚
â”‚    'pi_xxx', 'refund.created', {...} â”‚
â”‚  );                                  â”‚
â”‚                                      â”‚
â”‚  COMMIT;                             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Publish event
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Kafka                        â”‚
â”‚  Topic: payment.refunded             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚              â”‚                â”‚
       â–¼              â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Webhook  â”‚  â”‚ Analytics â”‚  â”‚ Settlement  â”‚
â”‚ Service  â”‚  â”‚ Service   â”‚  â”‚ Service     â”‚
â”‚          â”‚  â”‚           â”‚  â”‚             â”‚
â”‚ Notify   â”‚  â”‚ Track     â”‚  â”‚ Adjust next â”‚
â”‚ merchant â”‚  â”‚ refund    â”‚  â”‚ payout      â”‚
â”‚          â”‚  â”‚ metrics   â”‚  â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


REFUND TIMELINE:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â€¢ Instant: Refund initiated in system
â€¢ 5-10 seconds: Card network processes
â€¢ 5-10 days: Customer sees credit on statement
  (Varies by issuing bank)


PARTIAL REFUND EXAMPLE:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Original charge: $99.99

Refund #1: $20.00
  â†’ Status: PARTIALLY_REFUNDED
  â†’ Refunded amount: $20.00
  â†’ Remaining: $79.99

Refund #2: $79.99
  â†’ Status: REFUNDED (fully refunded)
  â†’ Refunded amount: $99.99
  â†’ Remaining: $0.00


REFUND CONSTRAINTS (Enforced in DB):
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ“ Can only refund CAPTURED payments
âœ“ Total refunds <= captured amount
âœ“ Refund window: 180 days from capture
âœ— Cannot refund AUTHORIZED (use void instead)
âœ— Cannot exceed captured amount
</pre>
            </div>
        </div>

        <div class="flow-description">
            <h3>â†©ï¸ Refund Flow Explanation</h3>
            <ol>
                <li><strong>Refund Request:</strong> Merchant initiates refund with payment intent ID and amount (full or partial). Idempotency key prevents duplicate refunds.</li>
                <li><strong>Validation:</strong> System checks payment is captured, not already fully refunded, and refund amount doesn't exceed remaining balance.</li>
                <li><strong>Processor Call:</strong> Stripe API debits merchant account and credits customer's card through card network.</li>
                <li><strong>ACID Update:</strong> Database transaction atomically updates refunded amount and payment status (PARTIALLY_REFUNDED or REFUNDED). Optimistic locking prevents race conditions.</li>
                <li><strong>Settlement Adjustment:</strong> If refund happens before settlement, it's netted from the batch. If after, merchant's next payout is reduced.</li>
                <li><strong>Customer Timeline:</strong> Customer sees refund on their statement in 5-10 business days (bank-dependent, not instant).</li>
            </ol>
            <div style="margin-top: 15px; padding: 15px; background: #fee2e2; border-left: 4px solid #ef4444; border-radius: 5px;">
                <strong>âš ï¸ Important:</strong> Refunds have a 180-day window from capture. After that, must issue credit/store credit. Also, refunds incur processor fees even though money is returned!
            </div>
        </div>
    </div>

    <!-- Full System Flow -->
    <div id="full-diagram" class="diagram-container">
        <div style="background: white; padding: 30px; border-radius: 15px; border: 2px solid #e2e8f0;">
            <h2 style="color: #2d3748; text-align: center; margin-bottom: 20px;">ğŸ—ï¸ Complete Payment Gateway System Flow</h2>

            <div style="font-family: monospace; font-size: 0.85em; line-height: 1.8;">
<pre style="color: #1e293b;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PAYMENT GATEWAY ECOSYSTEM                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

LAYER 1: CLIENT & EDGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Web App    â”‚  â”‚ Mobile App â”‚  â”‚ Server API â”‚
â”‚ (React)    â”‚  â”‚ (iOS/And.) â”‚  â”‚ (Node.js)  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚               â”‚               â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ HTTPS POST
                      â”‚ Authorization: Bearer sk_live_...
                      â”‚ Idempotency-Key: uuid-v4
                      â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   CloudFlare CDN / WAF     â”‚
         â”‚  â€¢ DDoS protection         â”‚
         â”‚  â€¢ TLS termination         â”‚
         â”‚  â€¢ Rate limiting (L7)      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   API Gateway (Kong)       â”‚
         â”‚  â€¢ API key validation      â”‚
         â”‚  â€¢ JWT verification        â”‚
         â”‚  â€¢ Request validation      â”‚
         â”‚  â€¢ Rate limiting (merchant)â”‚
         â”‚  â€¢ Circuit breaker         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼


LAYER 2: CORE SERVICES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚               â”‚                â”‚
      â–¼               â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Payment  â”‚   â”‚  Fraud   â”‚    â”‚  Webhook  â”‚
â”‚ Service  â”‚â”€â”€â–¶â”‚ Service  â”‚    â”‚  Service  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚                 â”‚
     â”‚         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”            â”‚
     â”‚         â”‚   ML    â”‚            â”‚
     â”‚         â”‚  Model  â”‚            â”‚
     â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
     â”‚                                â”‚
     â–¼                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ Payment Processor Adapter      â”‚   â”‚
â”‚  â€¢ Circuit breaker             â”‚   â”‚
â”‚  â€¢ Retry with jitter           â”‚   â”‚
â”‚  â€¢ Smart routing               â”‚   â”‚
â”‚  â€¢ Timeout handling            â”‚   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
     â”‚                                â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â–¼         â–¼          â–¼          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ Stripe â”‚ â”‚ Visa â”‚  â”‚ PayPal â”‚     â”‚
â”‚  (80%) â”‚ â”‚Directâ”‚  â”‚  (15%) â”‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
     â”‚         â”‚          â”‚          â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼


LAYER 3: DATA & MESSAGING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                         â”‚
     â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PostgreSQL   â”‚      â”‚     Redis      â”‚
â”‚ (Primary)    â”‚      â”‚    Cluster     â”‚
â”‚              â”‚      â”‚                â”‚
â”‚ â€¢ ACID       â”‚      â”‚ â€¢ Idempotency  â”‚
â”‚ â€¢ Txn events â”‚      â”‚ â€¢ Rate limits  â”‚
â”‚ â€¢ SERIALIZED â”‚      â”‚ â€¢ Sessions     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Replication
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Read Replicasâ”‚â—€â”€â”   â”‚     Kafka      â”‚
â”‚   (3x)       â”‚  â”‚   â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚ Topics:        â”‚
                  â”‚   â”‚ â€¢ payment.*    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚ â€¢ fraud.*      â”‚
â”‚   Backups    â”‚â—€â”€â”˜   â”‚ â€¢ webhook.*    â”‚
â”‚              â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â€¢ Daily snap â”‚               â”‚
â”‚ â€¢ WAL archiveâ”‚               â”‚
â”‚ â€¢ PITR       â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                     â”‚
                    â–¼                     â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  ClickHouse â”‚      â”‚  Settlement â”‚
           â”‚    (OLAP)   â”‚      â”‚   Service   â”‚
           â”‚             â”‚      â”‚             â”‚
           â”‚ â€¢ Analytics â”‚      â”‚ â€¢ Daily     â”‚
           â”‚ â€¢ Metrics   â”‚      â”‚   batches   â”‚
           â”‚ â€¢ Dashboardsâ”‚      â”‚ â€¢ Reconcile â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


LAYER 4: OBSERVABILITY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Prometheus    â”‚  â”‚     Jaeger     â”‚  â”‚  ELK Stack     â”‚
â”‚   + Grafana    â”‚  â”‚   (Tracing)    â”‚  â”‚   (Logs)       â”‚
â”‚                â”‚  â”‚                â”‚  â”‚                â”‚
â”‚ â€¢ Metrics      â”‚  â”‚ â€¢ Distributed  â”‚  â”‚ â€¢ Centralized  â”‚
â”‚ â€¢ Alerts       â”‚  â”‚   traces       â”‚  â”‚   logging      â”‚
â”‚ â€¢ Dashboards   â”‚  â”‚ â€¢ Performance  â”‚  â”‚ â€¢ PII redacted â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


CRITICAL DATA FLOWS:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. HAPPY PATH (Authorization):
   Client â†’ API GW â†’ Payment Service â†’ Fraud Check (OK)
   â†’ Stripe â†’ PostgreSQL (ACID) â†’ Kafka â†’ Webhook â†’ Merchant

2. FRAUD DETECTED:
   Client â†’ API GW â†’ Payment Service â†’ Fraud Check (HIGH RISK)
   â†’ Decline payment â†’ Kafka â†’ Analytics (fraud metrics)

3. PROCESSOR FAILOVER:
   Client â†’ API GW â†’ Payment Service â†’ Stripe (DOWN)
   â†’ Circuit breaker OPEN â†’ Route to PayPal â†’ Success

4. IDEMPOTENCY HIT:
   Client â†’ API GW â†’ Redis check (key exists)
   â†’ Return cached response (no processing)

5. SETTLEMENT:
   Daily cron (2 AM UTC) â†’ Settlement Service
   â†’ Batch captured payments â†’ Reconcile with processor
   â†’ Initiate ACH payout â†’ Update merchant balance


KEY PATTERNS IMPLEMENTED:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ ACID Transactions      (PostgreSQL SERIALIZABLE)
âœ“ Idempotency            (Redis cache + SHA-256)
âœ“ Circuit Breaker        (Hystrix pattern)
âœ“ Retry with Backoff     (Exponential jitter)
âœ“ Event Sourcing         (Immutable transaction_events)
âœ“ CQRS                   (Write to PG, Read from replicas)
âœ“ Saga Pattern           (Authorization â†’ Capture)
âœ“ Two-Phase Commit       (Auth + Capture phases)
âœ“ Optimistic Locking     (Version field)
âœ“ Rate Limiting          (Token bucket in Redis)
âœ“ Smart Routing          (Health-based processor selection)
âœ“ Async Webhooks         (Kafka + retry queue)
</pre>
            </div>
        </div>

        <div class="flow-description">
            <h3>ğŸ—ï¸ Full System Architecture Explanation</h3>
            <ol>
                <li><strong>Edge Layer:</strong> CloudFlare provides DDoS protection, TLS termination, and L7 rate limiting. API Gateway (Kong) handles authentication, validation, and circuit breaking.</li>
                <li><strong>Core Services:</strong> Payment service orchestrates the payment flow. Fraud service runs ML model + rules. Webhook service delivers async notifications with retry.</li>
                <li><strong>Processor Integration:</strong> Adapter pattern abstracts different processors. Smart routing based on health checks. Circuit breaker prevents cascading failures.</li>
                <li><strong>Data Layer:</strong> PostgreSQL with SERIALIZABLE isolation for ACID guarantees. Redis for idempotency, rate limiting, sessions. Read replicas for analytics queries.</li>
                <li><strong>Event Streaming:</strong> Kafka decouples services. Consumers for webhooks, analytics, settlement. Replay capability for debugging.</li>
                <li><strong>Observability:</strong> Prometheus for metrics, Jaeger for distributed tracing, ELK for centralized logging with PII redaction.</li>
                <li><strong>Settlement:</strong> Daily batch job reconciles captured payments, calculates fees, initiates ACH payouts to merchants.</li>
            </ol>
            <div style="margin-top: 15px; padding: 15px; background: #dcfce7; border-left: 4px solid #10b981; border-radius: 5px;">
                <strong>ğŸ’¡ Architecture Principles:</strong> This design prioritizes financial integrity (ACID), fault tolerance (circuit breakers), observability (full tracing), and scalability (event-driven, stateless services).
            </div>
        </div>
    </div>

    <!-- Metrics Panel -->
    <div class="metrics-panel">
        <h2 style="margin-bottom: 15px; color: #065f46;">âš¡ Payment Processing Performance</h2>
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value">&lt;500ms</div>
                <div class="metric-label">P95 Authorization</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">99.95%</div>
                <div class="metric-label">Authorization Success</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">0.5%</div>
                <div class="metric-label">False Positive Fraud</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">85%</div>
                <div class="metric-label">Frictionless 3DS</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">T+2</div>
                <div class="metric-label">Settlement Cycle</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">99.99%</div>
                <div class="metric-label">Uptime SLA</div>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: #10b981;"></div>
            <span>Success Path</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ef4444;"></div>
            <span>Error/Decline</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #f59e0b;"></div>
            <span>Async Process</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #7c3aed;"></div>
            <span>External Service</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #06b6d4;"></div>
            <span>Database/Cache</span>
        </div>
    </div>
</div>

<script>
    function showDiagram(type) {
        // Hide all diagrams
        document.querySelectorAll('.diagram-container').forEach(d => {
            d.classList.remove('active');
        });

        // Remove active from all tabs
        document.querySelectorAll('.tab').forEach(t => {
            t.classList.remove('active');
        });

        // Show selected diagram
        document.getElementById(type + '-diagram').classList.add('active');

        // Activate clicked tab
        event.target.classList.add('active');
    }
</script>
</body>
</html>
