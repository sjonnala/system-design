<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distributed Locking Flow Diagrams</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            font-size: 2.5em;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 25px;
            background: #e2e8f0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: #6366f1;
            color: white;
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .diagram-container {
            display: none;
            margin-top: 30px;
        }

        .diagram-container.active {
            display: block;
        }

        svg {
            width: 100%;
            height: auto;
        }

        .component {
            cursor: pointer;
            transition: all 0.3s;
        }

        .component:hover {
            filter: drop-shadow(0 0 10px rgba(99, 102, 241, 0.5));
        }

        .flow-arrow {
            animation: dash 20s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -1000;
            }
        }

        .flow-description {
            background: #e0e7ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 5px solid #6366f1;
        }

        .flow-description h3 {
            color: #4338ca;
            margin-bottom: 15px;
        }

        .flow-description ol {
            margin-left: 20px;
            line-height: 2;
            color: #1e293b;
        }

        .flow-description ol li {
            margin: 10px 0;
        }

        .flow-description strong {
            color: #6366f1;
        }

        .flow-description code {
            background: #1e293b;
            color: #fbbf24;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .metrics-panel {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde047 100%);
            border-radius: 15px;
            border: 2px solid #fbbf24;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #6366f1;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #6366f1;
        }

        .metric-label {
            font-size: 0.9em;
            color: #4a5568;
            margin-top: 5px;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            border: 2px solid #cbd5e0;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üîí Distributed Locking Flow Diagrams</h1>
        <p style="color: #64748b; margin-top: 10px;">Interactive Lock Lifecycle Visualization</p>

        <div class="tabs">
            <button class="tab active" onclick="showDiagram('acquire')">üîê Lock Acquisition</button>
            <button class="tab" onclick="showDiagram('release')">üîì Lock Release</button>
            <button class="tab" onclick="showDiagram('renewal')">‚ôªÔ∏è Lock Renewal</button>
            <button class="tab" onclick="showDiagram('failure')">‚ùå Failure Scenarios</button>
            <button class="tab" onclick="showDiagram('consensus')">‚öñÔ∏è Raft Consensus</button>
        </div>
    </div>

    <!-- Lock Acquisition Flow -->
    <div id="acquire-diagram" class="diagram-container active">
        <svg viewBox="0 0 1400 1200" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#6366f1" />
                </marker>
                <linearGradient id="grad-client" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-manager" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#f87171;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#ef4444;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-consensus" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#facc15;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#eab308;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-storage" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#fb923c;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#f97316;stop-opacity:1" />
                </linearGradient>
            </defs>

            <!-- Title -->
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Lock Acquisition Flow (Success Path)
            </text>

            <!-- Client -->
            <g class="component">
                <rect x="600" y="60" width="200" height="80" rx="10" fill="url(#grad-client)" stroke="#2563eb" stroke-width="2"/>
                <text x="700" y="95" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üë§ Client</text>
                <text x="700" y="115" font-size="12" text-anchor="middle" fill="white">Microservice Instance</text>
            </g>

            <path d="M 700 140 L 700 180" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="165" font-size="11" fill="#4338ca" font-weight="600">AcquireLock(resource, owner, ttl)</text>

            <!-- Lock Manager -->
            <g class="component">
                <rect x="550" y="180" width="300" height="100" rx="10" fill="url(#grad-manager)" stroke="#dc2626" stroke-width="2"/>
                <text x="700" y="215" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üîê Lock Manager</text>
                <text x="700" y="235" font-size="12" text-anchor="middle" fill="white">Check if lock exists</text>
                <text x="700" y="255" font-size="11" text-anchor="middle" fill="white">Generate fencing token</text>
            </g>

            <!-- Decision Diamond -->
            <g class="component">
                <path d="M 700 320 L 800 380 L 700 440 L 600 380 Z" fill="#fef3c7" stroke="#f59e0b" stroke-width="3"/>
                <text x="700" y="375" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Lock</text>
                <text x="700" y="393" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Exists?</text>
            </g>

            <!-- Lock Exists Path (Right) -->
            <path d="M 800 380 L 950 380" stroke="#ef4444" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>
            <text x="850" y="370" font-size="12" fill="#dc2626" font-weight="700">YES</text>

            <g class="component">
                <rect x="950" y="330" width="200" height="100" rx="10" fill="#fee2e2" stroke="#dc2626" stroke-width="3"/>
                <text x="1050" y="365" font-size="14" font-weight="bold" text-anchor="middle" fill="#991b1b">‚ùå Lock Denied</text>
                <text x="1050" y="385" font-size="11" text-anchor="middle" fill="#991b1b">Return LOCK_HELD</text>
                <text x="1050" y="405" font-size="11" text-anchor="middle" fill="#991b1b">Owner: {ownerId}</text>
            </g>

            <!-- Lock Available Path (Bottom) -->
            <path d="M 700 440 L 700 500" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>
            <text x="630" y="475" font-size="12" fill="#059669" font-weight="700">NO (Available)</text>

            <!-- Consensus Layer -->
            <g class="component">
                <rect x="550" y="500" width="300" height="100" rx="10" fill="url(#grad-consensus)" stroke="#ca8a04" stroke-width="2"/>
                <text x="700" y="535" font-size="16" font-weight="bold" text-anchor="middle" fill="white">‚öñÔ∏è Raft Consensus</text>
                <text x="700" y="555" font-size="12" text-anchor="middle" fill="white">Propose lock to cluster</text>
                <text x="700" y="575" font-size="11" text-anchor="middle" fill="white">Wait for quorum (3/5 nodes)</text>
            </g>

            <path d="M 700 600 L 700 660" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="635" font-size="11" fill="#4338ca" font-weight="600">Commit to log</text>

            <!-- Storage -->
            <g class="component">
                <rect x="550" y="660" width="300" height="100" rx="10" fill="url(#grad-storage)" stroke="#ea580c" stroke-width="2"/>
                <text x="700" y="695" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üíæ Persistent Storage</text>
                <text x="700" y="715" font-size="12" text-anchor="middle" fill="white">Write lock to database</text>
                <text x="700" y="735" font-size="11" text-anchor="middle" fill="white">Cache in Redis</text>
            </g>

            <path d="M 700 760 L 700 820" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="795" font-size="11" fill="#4338ca" font-weight="600">Success</text>

            <!-- Response -->
            <g class="component">
                <rect x="550" y="820" width="300" height="120" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="3"/>
                <text x="700" y="855" font-size="16" font-weight="bold" text-anchor="middle" fill="#065f46">‚úÖ Lock Acquired</text>
                <text x="700" y="880" font-size="12" text-anchor="middle" fill="#065f46">fencingToken: 12345</text>
                <text x="700" y="900" font-size="12" text-anchor="middle" fill="#065f46">expiresAt: now + 30s</text>
                <text x="700" y="920" font-size="11" text-anchor="middle" fill="#065f46">Start heartbeat (every 15s)</text>
            </g>

            <path d="M 550 880 L 400 880 L 400 100 L 600 100" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="8,4"/>
            <text x="320" y="500" font-size="12" fill="#059669" font-weight="700">‚Üê Response</text>

            <!-- Step numbers -->
            <circle cx="700" cy="100" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="107" font-size="14" font-weight="bold" text-anchor="middle" fill="white">1</text>

            <circle cx="700" cy="230" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="237" font-size="14" font-weight="bold" text-anchor="middle" fill="white">2</text>

            <circle cx="700" cy="550" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="557" font-size="14" font-weight="bold" text-anchor="middle" fill="white">3</text>

            <circle cx="700" cy="710" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="717" font-size="14" font-weight="bold" text-anchor="middle" fill="white">4</text>

            <circle cx="700" cy="880" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="887" font-size="14" font-weight="bold" text-anchor="middle" fill="white">5</text>
        </svg>

        <div class="flow-description">
            <h3>üîê Lock Acquisition Flow Steps</h3>
            <ol>
                <li><strong>Client Request:</strong> Client calls <code>AcquireLock("payment:user:123", "instance-42", 30s)</code></li>
                <li><strong>Lock Manager Check:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Check if lock exists in cache/storage</li>
                        <li>If exists and NOT expired ‚Üí Return LOCK_HELD with current owner</li>
                        <li>If exists and expired ‚Üí Auto-cleanup and proceed</li>
                        <li>If NOT exists ‚Üí Generate monotonically increasing fencing token</li>
                    </ul>
                </li>
                <li><strong>Raft Consensus:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Leader proposes lock operation to cluster</li>
                        <li>Appends to local log</li>
                        <li>Replicates to followers (parallel)</li>
                        <li>Waits for quorum acknowledgment (3 out of 5 nodes)</li>
                        <li>Commits log entry once quorum reached</li>
                    </ul>
                </li>
                <li><strong>Persist Lock:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Write to database: <code>{resource, owner, fencingToken, expiresAt}</code></li>
                        <li>Cache in Redis for fast lookups: <code>SET lock:payment:user:123 {owner, token} EX 30</code></li>
                    </ul>
                </li>
                <li><strong>Success Response:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Return <code>LockResponse{success: true, fencingToken: 12345, expiresAt: timestamp}</code></li>
                        <li>Client starts heartbeat timer (renew every TTL/2 = 15s)</li>
                        <li>Client performs critical section work with fencing token</li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <!-- Lock Release Flow -->
    <div id="release-diagram" class="diagram-container">
        <svg viewBox="0 0 1400 900" xmlns="http://www.w3.org/2000/svg">
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Lock Release Flow
            </text>

            <!-- Client with Lock -->
            <g class="component">
                <rect x="600" y="60" width="200" height="80" rx="10" fill="url(#grad-client)" stroke="#2563eb" stroke-width="2"/>
                <text x="700" y="95" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üë§ Client (Owner)</text>
                <text x="700" y="115" font-size="12" text-anchor="middle" fill="white">Holds lock, work done</text>
            </g>

            <path d="M 700 140 L 700 180" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="165" font-size="11" fill="#4338ca" font-weight="600">ReleaseLock(resource, owner)</text>

            <!-- Lock Manager -->
            <g class="component">
                <rect x="550" y="180" width="300" height="100" rx="10" fill="url(#grad-manager)" stroke="#dc2626" stroke-width="2"/>
                <text x="700" y="215" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üîê Lock Manager</text>
                <text x="700" y="235" font-size="12" text-anchor="middle" fill="white">Verify ownership</text>
                <text x="700" y="255" font-size="11" text-anchor="middle" fill="white">Check owner == requester</text>
            </g>

            <!-- Ownership Check -->
            <g class="component">
                <path d="M 700 320 L 800 380 L 700 440 L 600 380 Z" fill="#fef3c7" stroke="#f59e0b" stroke-width="3"/>
                <text x="700" y="375" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Owner</text>
                <text x="700" y="393" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Match?</text>
            </g>

            <!-- Wrong Owner (Right) -->
            <path d="M 800 380 L 950 380" stroke="#ef4444" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>
            <text x="850" y="370" font-size="12" fill="#dc2626" font-weight="700">NO</text>

            <g class="component">
                <rect x="950" y="330" width="200" height="100" rx="10" fill="#fee2e2" stroke="#dc2626" stroke-width="3"/>
                <text x="1050" y="365" font-size="14" font-weight="bold" text-anchor="middle" fill="#991b1b">‚ùå Release Denied</text>
                <text x="1050" y="385" font-size="11" text-anchor="middle" fill="#991b1b">Unauthorized</text>
                <text x="1050" y="405" font-size="11" text-anchor="middle" fill="#991b1b">Only owner can release</text>
            </g>

            <!-- Correct Owner (Bottom) -->
            <path d="M 700 440 L 700 500" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>
            <text x="630" y="475" font-size="12" fill="#059669" font-weight="700">YES (Owner)</text>

            <!-- Consensus -->
            <g class="component">
                <rect x="550" y="500" width="300" height="100" rx="10" fill="url(#grad-consensus)" stroke="#ca8a04" stroke-width="2"/>
                <text x="700" y="535" font-size="16" font-weight="bold" text-anchor="middle" fill="white">‚öñÔ∏è Raft Consensus</text>
                <text x="700" y="555" font-size="12" text-anchor="middle" fill="white">Propose lock deletion</text>
                <text x="700" y="575" font-size="11" text-anchor="middle" fill="white">Quorum commit</text>
            </g>

            <path d="M 700 600 L 700 660" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>

            <!-- Delete Lock -->
            <g class="component">
                <rect x="550" y="660" width="300" height="100" rx="10" fill="url(#grad-storage)" stroke="#ea580c" stroke-width="2"/>
                <text x="700" y="695" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üóëÔ∏è Delete Lock</text>
                <text x="700" y="715" font-size="12" text-anchor="middle" fill="white">Remove from storage</text>
                <text x="700" y="735" font-size="11" text-anchor="middle" fill="white">Invalidate cache</text>
            </g>

            <path d="M 550 710 L 400 710 L 400 100 L 600 100" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="8,4"/>
            <text x="320" y="420" font-size="12" fill="#059669" font-weight="700">‚Üê Released</text>

            <!-- Notify Waiters -->
            <path d="M 850 710 L 1020 710" stroke="#9333ea" stroke-width="3" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>
            <text x="900" y="700" font-size="11" fill="#9333ea" font-weight="600">Notify</text>

            <g class="component">
                <rect x="1020" y="660" width="200" height="100" rx="10" fill="#e9d5ff" stroke="#9333ea" stroke-width="2"/>
                <text x="1120" y="695" font-size="14" font-weight="bold" text-anchor="middle" fill="#6b21a8">üì¢ Wake Waiters</text>
                <text x="1120" y="715" font-size="11" text-anchor="middle" fill="#6b21a8">Notify waiting clients</text>
                <text x="1120" y="735" font-size="11" text-anchor="middle" fill="#6b21a8">FIFO queue processing</text>
            </g>

            <!-- Step numbers -->
            <circle cx="700" cy="100" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="107" font-size="14" font-weight="bold" text-anchor="middle" fill="white">1</text>

            <circle cx="700" cy="230" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="237" font-size="14" font-weight="bold" text-anchor="middle" fill="white">2</text>

            <circle cx="700" cy="550" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="557" font-size="14" font-weight="bold" text-anchor="middle" fill="white">3</text>

            <circle cx="700" cy="710" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="717" font-size="14" font-weight="bold" text-anchor="middle" fill="white">4</text>
        </svg>

        <div class="flow-description">
            <h3>üîì Lock Release Flow Steps</h3>
            <ol>
                <li><strong>Release Request:</strong> Client calls <code>ReleaseLock("payment:user:123", "instance-42")</code> after completing critical section</li>
                <li><strong>Ownership Verification:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Lock Manager retrieves current lock owner from cache/storage</li>
                        <li>Compares requester with actual owner</li>
                        <li>If mismatch ‚Üí Return UNAUTHORIZED (prevents rogue releases)</li>
                        <li>If match ‚Üí Proceed with release</li>
                    </ul>
                </li>
                <li><strong>Consensus Commit:</strong> Propose lock deletion to Raft cluster, wait for quorum ACK</li>
                <li><strong>Cleanup & Notification:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Delete from database</li>
                        <li>Invalidate Redis cache: <code>DEL lock:payment:user:123</code></li>
                        <li>Notify waiting clients in FIFO queue (if any)</li>
                        <li>Publish <code>lock.released</code> event to analytics</li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <!-- Lock Renewal Flow -->
    <div id="renewal-diagram" class="diagram-container">
        <svg viewBox="0 0 1400 800" xmlns="http://www.w3.org/2000/svg">
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Lock Renewal Flow (Heartbeat Mechanism)
            </text>

            <!-- Timeline -->
            <line x1="200" y1="100" x2="1200" y2="100" stroke="#cbd5e0" stroke-width="3"/>
            <text x="200" y="90" font-size="12" fill="#64748b">t=0s</text>
            <text x="700" y="90" font-size="12" fill="#64748b">t=15s</text>
            <text x="1200" y="90" font-size="12" fill="#64748b">t=30s</text>

            <!-- Lock Acquired -->
            <circle cx="200" cy="100" r="15" fill="#10b981" stroke="#065f46" stroke-width="2"/>
            <text x="200" y="140" font-size="13" font-weight="bold" text-anchor="middle" fill="#065f46">üîê Lock Acquired</text>
            <text x="200" y="160" font-size="11" text-anchor="middle" fill="#4a5568">TTL: 30s</text>

            <!-- Heartbeat at t=15s -->
            <circle cx="700" cy="100" r="15" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="140" font-size="13" font-weight="bold" text-anchor="middle" fill="#f59e0b">‚ôªÔ∏è Heartbeat</text>
            <text x="700" y="160" font-size="11" text-anchor="middle" fill="#4a5568">Renew at TTL/2</text>

            <!-- Expiry at t=30s -->
            <circle cx="1200" cy="100" r="15" fill="#ef4444" stroke="#dc2626" stroke-width="2"/>
            <text x="1200" y="140" font-size="13" font-weight="bold" text-anchor="middle" fill="#dc2626">‚è∞ Would Expire</text>
            <text x="1200" y="160" font-size="11" text-anchor="middle" fill="#4a5568">If not renewed</text>

            <!-- Renewal Process -->
            <g class="component">
                <rect x="500" y="250" width="400" height="150" rx="10" fill="#e0f2fe" stroke="#0284c7" stroke-width="2"/>
                <text x="700" y="285" font-size="16" font-weight="bold" text-anchor="middle" fill="#075985">Renewal Process</text>

                <text x="520" y="315" font-size="13" fill="#0c4a6e" font-weight="600">1. Client Timer Fires (t=15s)</text>
                <text x="540" y="340" font-size="12" fill="#4a5568">‚Üí Call <tspan fill="#6366f1">RenewLock(resource, owner, newTTL)</tspan></text>

                <text x="520" y="365" font-size="13" fill="#0c4a6e" font-weight="600">2. Lock Manager Validates</text>
                <text x="540" y="385" font-size="12" fill="#4a5568">‚Üí Check ownership, ensure not expired</text>
            </g>

            <g class="component">
                <rect x="200" y="450" width="450" height="120" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="2"/>
                <text x="425" y="485" font-size="15" font-weight="bold" text-anchor="middle" fill="#065f46">‚úÖ Renewal Success</text>
                <text x="425" y="510" font-size="12" text-anchor="middle" fill="#4a5568">Update expiresAt = now + 30s</text>
                <text x="425" y="530" font-size="12" text-anchor="middle" fill="#4a5568">Lock extended, critical work continues</text>
                <text x="425" y="550" font-size="12" text-anchor="middle" fill="#4a5568">Next heartbeat at t=30s</text>
            </g>

            <g class="component">
                <rect x="700" y="450" width="450" height="120" rx="10" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
                <text x="925" y="485" font-size="15" font-weight="bold" text-anchor="middle" fill="#991b1b">‚ùå Renewal Failure</text>
                <text x="925" y="510" font-size="12" text-anchor="middle" fill="#4a5568">Scenarios: Network partition, manager down</text>
                <text x="925" y="530" font-size="12" text-anchor="middle" fill="#4a5568">Client MUST release resources</text>
                <text x="925" y="550" font-size="12" text-anchor="middle" fill="#4a5568">Lock will auto-expire at t=30s</text>
            </g>

            <!-- Arrows -->
            <path d="M 700 200 L 425 450" stroke="#10b981" stroke-width="3" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>
            <text x="530" y="320" font-size="11" fill="#059669" font-weight="600">Success Path</text>

            <path d="M 700 200 L 925 450" stroke="#ef4444" stroke-width="3" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>
            <text x="780" y="320" font-size="11" fill="#dc2626" font-weight="600">Failure Path</text>
        </svg>

        <div class="flow-description">
            <h3>‚ôªÔ∏è Lock Renewal (Heartbeat) Mechanism</h3>
            <ol>
                <li><strong>Why Renewal?</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Long-running tasks may exceed initial TTL</li>
                        <li>Prevents lock expiry while client is still working</li>
                        <li>Detects crashed clients (failed heartbeat ‚Üí auto-expire)</li>
                    </ul>
                </li>
                <li><strong>Renewal Frequency:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Best Practice: Renew at <code>TTL / 2</code> interval</li>
                        <li>Example: 30s TTL ‚Üí renew every 15s</li>
                        <li>Provides buffer for network hiccups (15s grace period)</li>
                    </ul>
                </li>
                <li><strong>Renewal Protocol:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Client: <code>RenewLock(resource, owner, 30s)</code></li>
                        <li>Manager: Validate ownership (same as release)</li>
                        <li>Manager: Update <code>expiresAt = currentTime + 30s</code></li>
                        <li>Manager: Increment <code>renewalCount</code> metric</li>
                    </ul>
                </li>
                <li><strong>Failure Handling:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>If renewal fails, client MUST assume lock lost</li>
                        <li>Stop critical work immediately</li>
                        <li>Use fencing tokens to protect against stale operations</li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <!-- Failure Scenarios -->
    <div id="failure-diagram" class="diagram-container">
        <svg viewBox="0 0 1400 1000" xmlns="http://www.w3.org/2000/svg">
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Failure Scenarios & Recovery
            </text>

            <!-- Scenario 1: Client Crash -->
            <g class="component">
                <rect x="50" y="70" width="400" height="200" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                <text x="250" y="100" font-size="15" font-weight="bold" text-anchor="middle" fill="#92400e">üî¥ Scenario 1: Client Crash</text>

                <text x="70" y="130" font-size="12" fill="#4a5568">Problem:</text>
                <text x="90" y="150" font-size="11" fill="#4a5568">‚Ä¢ Client acquires lock, then crashes</text>
                <text x="90" y="170" font-size="11" fill="#4a5568">‚Ä¢ Cannot release lock manually</text>

                <text x="70" y="200" font-size="12" fill="#065f46" font-weight="600">Solution: TTL Auto-Expiry</text>
                <text x="90" y="220" font-size="11" fill="#4a5568">‚Ä¢ Lock expires after 30s (no heartbeat)</text>
                <text x="90" y="240" font-size="11" fill="#4a5568">‚Ä¢ Automatically becomes available</text>
                <text x="90" y="260" font-size="11" fill="#4a5568">‚Ä¢ No manual intervention needed ‚úÖ</text>
            </g>

            <!-- Scenario 2: Network Partition -->
            <g class="component">
                <rect x="500" y="70" width="400" height="200" rx="10" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
                <text x="700" y="100" font-size="15" font-weight="bold" text-anchor="middle" fill="#991b1b">üåê Scenario 2: Network Partition</text>

                <text x="520" y="130" font-size="12" fill="#4a5568">Problem:</text>
                <text x="540" y="150" font-size="11" fill="#4a5568">‚Ä¢ Client isolated from lock manager</text>
                <text x="540" y="170" font-size="11" fill="#4a5568">‚Ä¢ Cannot renew, but still working</text>

                <text x="520" y="200" font-size="12" fill="#065f46" font-weight="600">Solution: Fencing Tokens</text>
                <text x="540" y="220" font-size="11" fill="#4a5568">‚Ä¢ Lock expires, another client acquires</text>
                <text x="540" y="240" font-size="11" fill="#4a5568">‚Ä¢ New client gets higher fencing token</text>
                <text x="540" y="260" font-size="11" fill="#4a5568">‚Ä¢ Resource rejects stale token ‚úÖ</text>
            </g>

            <!-- Scenario 3: Lock Manager Crash -->
            <g class="component">
                <rect x="950" y="70" width="400" height="200" rx="10" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                <text x="1150" y="100" font-size="15" font-weight="bold" text-anchor="middle" fill="#1e40af">üí• Scenario 3: Manager Crash</text>

                <text x="970" y="130" font-size="12" fill="#4a5568">Problem:</text>
                <text x="990" y="150" font-size="11" fill="#4a5568">‚Ä¢ Lock manager node fails</text>
                <text x="990" y="170" font-size="11" fill="#4a5568">‚Ä¢ Locks become inaccessible</text>

                <text x="970" y="200" font-size="12" fill="#065f46" font-weight="600">Solution: Raft Consensus</text>
                <text x="990" y="220" font-size="11" fill="#4a5568">‚Ä¢ Follower elected as new leader (&lt;1s)</text>
                <text x="990" y="240" font-size="11" fill="#4a5568">‚Ä¢ Lock state preserved in quorum</text>
                <text x="990" y="260" font-size="11" fill="#4a5568">‚Ä¢ Zero data loss, minimal downtime ‚úÖ</text>
            </g>

            <!-- Scenario 4: Split Brain -->
            <g class="component">
                <rect x="50" y="320" width="400" height="250" rx="10" fill="#fce7f3" stroke="#ec4899" stroke-width="2"/>
                <text x="250" y="350" font-size="15" font-weight="bold" text-anchor="middle" fill="#831843">üß† Scenario 4: Split Brain</text>

                <text x="70" y="380" font-size="12" fill="#4a5568">Problem:</text>
                <text x="90" y="400" font-size="11" fill="#4a5568">‚Ä¢ Network split: 2 nodes + 3 nodes</text>
                <text x="90" y="420" font-size="11" fill="#4a5568">‚Ä¢ Both partitions think they're leader?</text>

                <text x="70" y="450" font-size="12" fill="#065f46" font-weight="600">Solution: Quorum Requirement</text>
                <text x="90" y="470" font-size="11" fill="#4a5568">‚Ä¢ 5-node cluster needs 3 votes</text>
                <text x="90" y="490" font-size="11" fill="#4a5568">‚Ä¢ Minority (2 nodes) CANNOT elect leader</text>
                <text x="90" y="510" font-size="11" fill="#4a5568">‚Ä¢ Majority (3 nodes) continues service</text>
                <text x="90" y="530" font-size="11" fill="#4a5568">‚Ä¢ Safety preserved (only 1 active leader) ‚úÖ</text>
                <text x="90" y="550" font-size="11" fill="#4a5568">‚Ä¢ Availability sacrificed for consistency (CP)</text>
            </g>

            <!-- Scenario 5: Clock Skew -->
            <g class="component">
                <rect x="500" y="320" width="400" height="250" rx="10" fill="#e9d5ff" stroke="#9333ea" stroke-width="2"/>
                <text x="700" y="350" font-size="15" font-weight="bold" text-anchor="middle" fill="#6b21a8">‚è∞ Scenario 5: Clock Skew</text>

                <text x="520" y="380" font-size="12" fill="#4a5568">Problem:</text>
                <text x="540" y="400" font-size="11" fill="#4a5568">‚Ä¢ Server clocks drift apart</text>
                <text x="540" y="420" font-size="11" fill="#4a5568">‚Ä¢ Lock TTL calculation inconsistent</text>

                <text x="520" y="450" font-size="12" fill="#065f46" font-weight="600">Solution: NTP + Logical Clocks</text>
                <text x="540" y="470" font-size="11" fill="#4a5568">‚Ä¢ Use NTP to sync clocks (max drift 100ms)</text>
                <text x="540" y="490" font-size="11" fill="#4a5568">‚Ä¢ Redlock adds clock drift factor (5-10ms)</text>
                <text x="540" y="510" font-size="11" fill="#4a5568">‚Ä¢ Fencing tokens (logical order) for safety</text>
                <text x="540" y="530" font-size="11" fill="#4a5568">‚Ä¢ Monitor clock drift with alerts ‚úÖ</text>
                <text x="540" y="550" font-size="11" fill="#4a5568">‚Ä¢ Alert if drift &gt; 50ms</text>
            </g>

            <!-- Scenario 6: Thundering Herd -->
            <g class="component">
                <rect x="950" y="320" width="400" height="250" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="2"/>
                <text x="1150" y="350" font-size="15" font-weight="bold" text-anchor="middle" fill="#065f46">üêÇ Scenario 6: Thundering Herd</text>

                <text x="970" y="380" font-size="12" fill="#4a5568">Problem:</text>
                <text x="990" y="400" font-size="11" fill="#4a5568">‚Ä¢ Lock released, 1000 clients waiting</text>
                <text x="990" y="420" font-size="11" fill="#4a5568">‚Ä¢ All try to acquire simultaneously</text>

                <text x="970" y="450" font-size="12" fill="#065f46" font-weight="600">Solution: FIFO Wait Queue</text>
                <text x="990" y="470" font-size="11" fill="#4a5568">‚Ä¢ Waiting clients added to queue</text>
                <text x="990" y="490" font-size="11" fill="#4a5568">‚Ä¢ Lock release notifies ONLY first waiter</text>
                <text x="990" y="510" font-size="11" fill="#4a5568">‚Ä¢ Prevents stampede, reduces contention ‚úÖ</text>
                <text x="990" y="530" font-size="11" fill="#4a5568">‚Ä¢ Fair ordering (FIFO)</text>
                <text x="990" y="550" font-size="11" fill="#4a5568">‚Ä¢ Lower load on lock manager</text>
            </g>

            <!-- Recovery Time Metrics -->
            <g class="component">
                <rect x="50" y="620" width="1300" height="100" rx="10" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
                <text x="700" y="655" font-size="16" font-weight="bold" text-anchor="middle" fill="#4338ca">‚è±Ô∏è Recovery Time Objectives (RTO)</text>

                <text x="70" y="685" font-size="13" fill="#4a5568">
                    ‚Ä¢ Client Crash: <tspan fill="#059669" font-weight="700">0s (immediate)</tspan> - TTL auto-expiry
                    ‚Ä¢ Manager Crash: <tspan fill="#059669" font-weight="700">&lt;1s</tspan> - Raft election
                    ‚Ä¢ Network Partition: <tspan fill="#059669" font-weight="700">&lt;5s</tspan> - Client detects via heartbeat failure
                    ‚Ä¢ Split Brain: <tspan fill="#059669" font-weight="700">0s (prevented)</tspan> - Quorum requirement
                    ‚Ä¢ Full Cluster Failure: <tspan fill="#f59e0b" font-weight="700">1-5min</tspan> - Manual intervention + restore from snapshot
                </text>
            </g>

            <!-- Availability Calculation -->
            <g class="component">
                <rect x="50" y="760" width="1300" height="100" rx="10" fill="#fef3c7" stroke="#fbbf24" stroke-width="2"/>
                <text x="700" y="795" font-size="16" font-weight="bold" text-anchor="middle" fill="#92400e">üìä Availability Calculation (5-Node Raft)</text>

                <text x="70" y="825" font-size="13" fill="#4a5568">
                    Single Node Availability: <tspan fill="#6366f1" font-weight="700">99.9%</tspan> (8.76 hours downtime/year)
                    ‚Üí Cluster Availability (tolerates 2 failures): <tspan fill="#059669" font-weight="700">99.999%</tspan> (5.26 minutes downtime/year)
                    ‚Üí With Multi-Region: <tspan fill="#059669" font-weight="700">99.9999%</tspan> (31.5 seconds downtime/year)
                </text>
            </g>
        </svg>

        <div class="flow-description">
            <h3>‚ùå Failure Scenarios Summary</h3>
            <p style="margin-bottom: 10px;">Distributed locking systems must handle various failure modes gracefully. The combination of <strong>TTL expiry</strong>, <strong>fencing tokens</strong>, <strong>consensus quorum</strong>, and <strong>FIFO queuing</strong> provides comprehensive fault tolerance.</p>
            <p><strong>Key Insight:</strong> Design assumes failures are the norm, not the exception. Systems that can't handle these scenarios will cause data corruption or deadlocks in production.</p>
        </div>
    </div>

    <!-- Raft Consensus Flow -->
    <div id="consensus-diagram" class="diagram-container">
        <svg viewBox="0 0 1400 1100" xmlns="http://www.w3.org/2000/svg">
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Raft Consensus Algorithm for Lock Operations
            </text>

            <!-- Raft Cluster -->
            <text x="700" y="70" font-size="16" font-weight="600" text-anchor="middle" fill="#64748b">5-Node Raft Cluster</text>

            <!-- Leader -->
            <g class="component">
                <rect x="600" y="100" width="200" height="100" rx="10" fill="#fbbf24" stroke="#f59e0b" stroke-width="3"/>
                <text x="700" y="135" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üëë Leader (Node 1)</text>
                <text x="700" y="155" font-size="12" text-anchor="middle" fill="white">Term: 5</text>
                <text x="700" y="175" font-size="11" text-anchor="middle" fill="white">Handles all writes</text>
            </g>

            <!-- Followers -->
            <g class="component">
                <rect x="250" y="250" width="150" height="80" rx="10" fill="#93c5fd" stroke="#3b82f6" stroke-width="2"/>
                <text x="325" y="280" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Follower 2</text>
                <text x="325" y="300" font-size="11" text-anchor="middle" fill="white">Term: 5</text>
            </g>

            <g class="component">
                <rect x="450" y="250" width="150" height="80" rx="10" fill="#93c5fd" stroke="#3b82f6" stroke-width="2"/>
                <text x="525" y="280" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Follower 3</text>
                <text x="525" y="300" font-size="11" text-anchor="middle" fill="white">Term: 5</text>
            </g>

            <g class="component">
                <rect x="800" y="250" width="150" height="80" rx="10" fill="#93c5fd" stroke="#3b82f6" stroke-width="2"/>
                <text x="875" y="280" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Follower 4</text>
                <text x="875" y="300" font-size="11" text-anchor="middle" fill="white">Term: 5</text>
            </g>

            <g class="component">
                <rect x="1000" y="250" width="150" height="80" rx="10" fill="#93c5fd" stroke="#3b82f6" stroke-width="2"/>
                <text x="1075" y="280" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Follower 5</text>
                <text x="1075" y="300" font-size="11" text-anchor="middle" fill="white">Term: 5</text>
            </g>

            <!-- Step 1: Client Request -->
            <path d="M 700 50 L 700 100" stroke="#10b981" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
            <text x="720" y="80" font-size="11" fill="#059669" font-weight="600">Lock Request</text>

            <!-- Step 2: Leader Appends to Log -->
            <g class="component">
                <rect x="550" y="230" width="300" height="60" rx="10" fill="#e0f2fe" stroke="#0284c7" stroke-width="2"/>
                <text x="700" y="255" font-size="13" font-weight="bold" text-anchor="middle" fill="#075985">Log Entry: [idx:100] AcquireLock(...)</text>
                <text x="700" y="275" font-size="11" text-anchor="middle" fill="#4a5568">Uncommitted (pending quorum)</text>
            </g>

            <!-- Step 3: Replicate to Followers -->
            <path d="M 650 300 L 400 250" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <path d="M 675 300 L 600 250" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <path d="M 725 300 L 800 250" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <path d="M 750 300 L 1000 250" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>

            <text x="700" y="320" font-size="12" fill="#4338ca" font-weight="700" text-anchor="middle">AppendEntries RPC (Parallel)</text>

            <!-- Step 4: Followers ACK -->
            <path d="M 400 330 L 650 380" stroke="#10b981" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 600 330 L 675 380" stroke="#10b981" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
            <path d="M 800 330 L 725 380" stroke="#10b981" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Follower 5 Failure -->
            <line x1="1075" y1="340" x2="1075" y2="400" stroke="#ef4444" stroke-width="4" stroke-dasharray="10,5"/>
            <text x="1095" y="370" font-size="11" fill="#dc2626" font-weight="600">Network</text>
            <text x="1095" y="385" font-size="11" fill="#dc2626" font-weight="600">Partition</text>

            <text x="550" y="410" font-size="12" fill="#059669" font-weight="700">3/5 ACKs received ‚Üí Quorum!</text>

            <!-- Step 5: Commit -->
            <g class="component">
                <rect x="550" y="430" width="300" height="60" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="3"/>
                <text x="700" y="455" font-size="13" font-weight="bold" text-anchor="middle" fill="#065f46">Log Entry: [idx:100] ‚úÖ COMMITTED</text>
                <text x="700" y="475" font-size="11" text-anchor="middle" fill="#4a5568">Apply to state machine</text>
            </g>

            <!-- Step 6: Apply to State Machine -->
            <path d="M 700 490 L 700 550" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>

            <g class="component">
                <rect x="550" y="550" width="300" height="100" rx="10" fill="#fed7aa" stroke="#f97316" stroke-width="2"/>
                <text x="700" y="585" font-size="15" font-weight="bold" text-anchor="middle" fill="#9a3412">üóÑÔ∏è State Machine</text>
                <text x="700" y="610" font-size="12" text-anchor="middle" fill="#4a5568">locks["payment:user:123"] = {</text>
                <text x="700" y="630" font-size="11" text-anchor="middle" fill="#4a5568">owner: "instance-42", token: 12345</text>
                <text x="700" y="645" font-size="12" text-anchor="middle" fill="#4a5568">}</text>
            </g>

            <!-- Step 7: Response to Client -->
            <path d="M 550 600 L 400 600 L 400 150 L 600 150" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="8,4"/>
            <text x="320" y="400" font-size="12" fill="#059669" font-weight="700">‚Üê Lock Acquired</text>

            <!-- Consensus Properties -->
            <g class="component">
                <rect x="50" y="700" width="650" height="280" rx="10" fill="#fef3c7" stroke="#fbbf24" stroke-width="2"/>
                <text x="375" y="730" font-size="16" font-weight="bold" text-anchor="middle" fill="#92400e">‚öñÔ∏è Raft Guarantees</text>

                <text x="70" y="760" font-size="13" fill="#4a5568" font-weight="600">1. Leader Election:</text>
                <text x="90" y="780" font-size="12" fill="#4a5568">‚Ä¢ Only one leader per term (no split brain)</text>
                <text x="90" y="800" font-size="12" fill="#4a5568">‚Ä¢ Election timeout: 150-300ms (randomized)</text>
                <text x="90" y="820" font-size="12" fill="#4a5568">‚Ä¢ Candidate needs majority votes (3/5)</text>

                <text x="70" y="850" font-size="13" fill="#4a5568" font-weight="600">2. Log Replication:</text>
                <text x="90" y="870" font-size="12" fill="#4a5568">‚Ä¢ Entries replicated in order (sequential log)</text>
                <text x="90" y="890" font-size="12" fill="#4a5568">‚Ä¢ Commit when majority ACK (quorum = 3)</text>
                <text x="90" y="910" font-size="12" fill="#4a5568">‚Ä¢ Safety: Committed entries never lost</text>

                <text x="70" y="940" font-size="13" fill="#4a5568" font-weight="600">3. State Machine Safety:</text>
                <text x="90" y="960" font-size="12" fill="#4a5568">‚Ä¢ All nodes apply same operations in same order</text>
            </g>

            <!-- Performance Metrics -->
            <g class="component">
                <rect x="750" y="700" width="600" height="280" rx="10" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
                <text x="1050" y="730" font-size="16" font-weight="bold" text-anchor="middle" fill="#4338ca">üìä Performance Characteristics</text>

                <text x="770" y="760" font-size="13" fill="#4a5568" font-weight="600">Latency (P99):</text>
                <text x="790" y="780" font-size="12" fill="#4a5568">‚Ä¢ Local quorum (same DC): <tspan fill="#059669" font-weight="700">&lt;10ms</tspan></text>
                <text x="790" y="800" font-size="12" fill="#4a5568">‚Ä¢ Cross-region quorum: <tspan fill="#f59e0b" font-weight="700">50-100ms</tspan></text>

                <text x="770" y="830" font-size="13" fill="#4a5568" font-weight="600">Throughput:</text>
                <text x="790" y="850" font-size="12" fill="#4a5568">‚Ä¢ Writes: <tspan fill="#059669" font-weight="700">10,000 QPS</tspan> (leader bottleneck)</text>
                <text x="790" y="870" font-size="12" fill="#4a5568">‚Ä¢ Reads: <tspan fill="#059669" font-weight="700">100,000 QPS</tspan> (can read from followers)</text>

                <text x="770" y="900" font-size="13" fill="#4a5568" font-weight="600">Availability:</text>
                <text x="790" y="920" font-size="12" fill="#4a5568">‚Ä¢ Tolerates: <tspan fill="#059669" font-weight="700">2 node failures</tspan> (5-node cluster)</text>
                <text x="790" y="940" font-size="12" fill="#4a5568">‚Ä¢ Recovery time: <tspan fill="#059669" font-weight="700">&lt;1 second</tspan> (new leader election)</text>

                <text x="770" y="970" font-size="13" fill="#4a5568" font-weight="600">Consistency:</text>
                <text x="790" y="990" font-size="12" fill="#4a5568">‚Ä¢ Model: <tspan fill="#059669" font-weight="700">Linearizability</tspan> (strongest guarantee)</text>
            </g>
        </svg>

        <div class="flow-description">
            <h3>‚öñÔ∏è Raft Consensus for Distributed Locks</h3>
            <ol>
                <li><strong>Why Raft?</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Provides strong consistency (linearizability) for lock state</li>
                        <li>Tolerates node failures (up to N/2 failures in N-node cluster)</li>
                        <li>Simpler than Paxos, easier to implement and reason about</li>
                        <li>Used in production: etcd (Kubernetes), Consul, CockroachDB</li>
                    </ul>
                </li>
                <li><strong>Lock Operation Flow:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Client sends <code>AcquireLock</code> to any node (redirected to leader)</li>
                        <li>Leader appends to local log (uncommitted state)</li>
                        <li>Leader replicates to all followers in parallel (AppendEntries RPC)</li>
                        <li>Followers ACK if log consistent (term + index match)</li>
                        <li>Once quorum ACKs (3/5), leader commits entry</li>
                        <li>Apply to state machine, return success to client</li>
                        <li>Leader eventually notifies followers to commit (async)</li>
                    </ul>
                </li>
                <li><strong>Failure Handling:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Leader crash ‚Üí Election (150-300ms), new leader has all committed entries</li>
                        <li>Follower crash ‚Üí Leader retries AppendEntries, catch-up on recovery</li>
                        <li>Network partition ‚Üí Minority partition cannot commit (safety preserved)</li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <!-- Metrics Panel -->
    <div class="metrics-panel">
        <h2 style="margin-bottom: 15px; color: #92400e;">‚ö° Distributed Locking Performance Metrics</h2>
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value">&lt;10ms</div>
                <div class="metric-label">P99 Lock Acquisition</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">10K</div>
                <div class="metric-label">QPS Throughput</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">99.99%</div>
                <div class="metric-label">Availability</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">30s</div>
                <div class="metric-label">Default Lock TTL</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">&lt;1s</div>
                <div class="metric-label">Leader Election Time</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">0</div>
                <div class="metric-label">Data Loss (CP system)</div>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #60a5fa, #3b82f6);"></div>
            <span>Client</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #f87171, #ef4444);"></div>
            <span>Lock Manager</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #facc15, #eab308);"></div>
            <span>Consensus Layer</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #fb923c, #f97316);"></div>
            <span>Storage</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #10b981;"></div>
            <span>Success</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ef4444;"></div>
            <span>Failure</span>
        </div>
    </div>
</div>

<script>
    function showDiagram(type) {
        // Hide all diagrams
        document.querySelectorAll('.diagram-container').forEach(d => {
            d.classList.remove('active');
        });

        // Remove active from all tabs
        document.querySelectorAll('.tab').forEach(t => {
            t.classList.remove('active');
        });

        // Show selected diagram
        document.getElementById(type + '-diagram').classList.add('active');

        // Activate clicked tab
        event.target.classList.add('active');
    }

    // Add hover effects
    document.querySelectorAll('.component').forEach(comp => {
        comp.addEventListener('mouseenter', function() {
            this.style.filter = 'drop-shadow(0 0 15px rgba(99, 102, 241, 0.6))';
        });

        comp.addEventListener('mouseleave', function() {
            this.style.filter = 'none';
        });
    });
</script>
</body>
</html>
