<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Priority Queue Flow Diagrams</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            font-size: 2.5em;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .tab {
            padding: 12px 30px;
            background: #e2e8f0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: #6366f1;
            color: white;
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .diagram-container {
            display: none;
            margin-top: 30px;
        }

        .diagram-container.active {
            display: block;
        }

        svg {
            width: 100%;
            height: auto;
        }

        .component {
            cursor: pointer;
            transition: all 0.3s;
        }

        .component:hover {
            filter: drop-shadow(0 0 10px rgba(99, 102, 241, 0.5));
        }

        .component rect {
            transition: all 0.3s;
        }

        .component:hover rect {
            stroke-width: 3;
        }

        .flow-arrow {
            animation: dash 20s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -1000;
            }
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            border: 2px solid #cbd5e0;
        }

        .metrics-panel {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde047 100%);
            border-radius: 15px;
            border: 2px solid #fbbf24;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #6366f1;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #6366f1;
        }

        .metric-label {
            font-size: 0.9em;
            color: #4a5568;
            margin-top: 5px;
        }

        .flow-description {
            background: #e0e7ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 5px solid #6366f1;
        }

        .flow-description h3 {
            color: #4338ca;
            margin-bottom: 10px;
        }

        .flow-description ol {
            margin-left: 20px;
            line-height: 2;
            color: #1e293b;
        }

        .flow-description ol li {
            margin: 8px 0;
        }

        .flow-description strong {
            color: #6366f1;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üîÑ Priority Queue Flow Diagrams</h1>
        <p style="color: #64748b; margin-top: 10px;">Interactive Component Flow Visualization</p>

        <div class="tabs">
            <button class="tab active" onclick="showDiagram('enqueue')">üì§ Enqueue Flow</button>
            <button class="tab" onclick="showDiagram('dequeue')">üì• Dequeue Flow</button>
            <button class="tab" onclick="showDiagram('full')">üèóÔ∏è Full System Architecture</button>
        </div>
    </div>

    <!-- Enqueue Flow Diagram -->
    <div id="enqueue-diagram" class="diagram-container active">
        <svg viewBox="0 0 1400 1200" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#6366f1" />
                </marker>
                <linearGradient id="grad-producer" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-gateway" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#22d3ee;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#06b6d4;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-lb" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#818cf8;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#6366f1;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-queue-service" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#84cc16;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#65a30d;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-postgres" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#fb923c;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#f97316;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad-redis" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#f472b6;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
                </linearGradient>
            </defs>

            <!-- Title -->
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Enqueue Flow: Adding Message to Priority Queue
            </text>

            <!-- Producer -->
            <g class="component">
                <rect x="600" y="60" width="200" height="80" rx="10" fill="url(#grad-producer)" stroke="#2563eb" stroke-width="2"/>
                <text x="700" y="95" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üì§ Producer</text>
                <text x="700" y="115" font-size="12" text-anchor="middle" fill="white">Microservice / API</text>
            </g>

            <path d="M 700 140 L 700 180" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="165" font-size="11" fill="#4338ca" font-weight="600">POST /enqueue</text>

            <!-- API Gateway -->
            <g class="component">
                <rect x="600" y="180" width="200" height="80" rx="10" fill="url(#grad-gateway)" stroke="#0891b2" stroke-width="2"/>
                <text x="700" y="215" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üö™ API Gateway</text>
                <text x="700" y="235" font-size="12" text-anchor="middle" fill="white">Auth + Rate Limit</text>
            </g>

            <path d="M 700 260 L 700 300" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="285" font-size="11" fill="#4338ca" font-weight="600">Validate + Forward</text>

            <!-- Load Balancer -->
            <g class="component">
                <rect x="600" y="300" width="200" height="80" rx="10" fill="url(#grad-lb)" stroke="#4f46e5" stroke-width="2"/>
                <text x="700" y="335" font-size="16" font-weight="bold" text-anchor="middle" fill="white">‚öñÔ∏è Load Balancer</text>
                <text x="700" y="355" font-size="12" text-anchor="middle" fill="white">Consistent Hashing</text>
            </g>

            <path d="M 700 380 L 700 420" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>

            <!-- Queue Service -->
            <g class="component">
                <rect x="550" y="420" width="300" height="120" rx="10" fill="url(#grad-queue-service)" stroke="#4d7c0f" stroke-width="2"/>
                <text x="700" y="455" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üîß Queue Service</text>
                <text x="700" y="475" font-size="12" text-anchor="middle" fill="white">Enqueue Handler</text>
                <text x="700" y="495" font-size="11" text-anchor="middle" fill="white">‚Ä¢ Validate message</text>
                <text x="700" y="513" font-size="11" text-anchor="middle" fill="white">‚Ä¢ Generate message_id</text>
                <text x="700" y="530" font-size="11" text-anchor="middle" fill="white">‚Ä¢ Check idempotency</text>
            </g>

            <!-- Arrow to PostgreSQL -->
            <path d="M 700 540 L 700 620" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="585" font-size="11" fill="#4338ca" font-weight="600">Store Message</text>

            <!-- PostgreSQL -->
            <g class="component">
                <rect x="550" y="620" width="300" height="120" rx="10" fill="url(#grad-postgres)" stroke="#ea580c" stroke-width="2"/>
                <text x="700" y="655" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üóÑÔ∏è PostgreSQL</text>
                <text x="700" y="675" font-size="12" text-anchor="middle" fill="white">Durable Message Storage</text>
                <text x="700" y="695" font-size="10" text-anchor="middle" fill="white">INSERT INTO messages (...)</text>
                <text x="700" y="713" font-size="10" text-anchor="middle" fill="white">VALUES (msg_id, priority, payload, 'READY')</text>
            </g>

            <!-- Arrow to Redis -->
            <path d="M 850 680 L 1020 680" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="900" y="670" font-size="11" fill="#4338ca" font-weight="600">Add to Priority Queue</text>

            <!-- Redis -->
            <g class="component">
                <rect x="1020" y="620" width="280" height="120" rx="10" fill="url(#grad-redis)" stroke="#db2777" stroke-width="2"/>
                <text x="1160" y="655" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üíæ Redis</text>
                <text x="1160" y="675" font-size="12" text-anchor="middle" fill="white">Priority Queue (Sorted Set)</text>
                <text x="1160" y="695" font-size="10" text-anchor="middle" fill="white">ZADD queue:orders:priority:8</text>
                <text x="1160" y="713" font-size="10" text-anchor="middle" fill="white">score=timestamp value=msg_id</text>
            </g>

            <!-- Update Stats -->
            <path d="M 1160 740 L 1160 820" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>
            <text x="1180" y="785" font-size="11" fill="#4338ca" font-weight="600">Update Stats</text>

            <g class="component">
                <rect x="1020" y="820" width="280" height="80" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="2"/>
                <text x="1160" y="855" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">üìä Queue Metrics</text>
                <text x="1160" y="875" font-size="11" text-anchor="middle" fill="#065f46">HINCRBY queue:orders:stats enqueued 1</text>
            </g>

            <!-- Response Path -->
            <path d="M 550 680 L 300 680 L 300 340 L 600 340" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="8,4"/>
            <text x="220" y="520" font-size="12" fill="#059669" font-weight="700">‚Üê Response</text>
            <text x="220" y="540" font-size="11" fill="#059669">201 Created</text>
            <text x="220" y="555" font-size="11" fill="#059669">{message_id: "..."}</text>

            <!-- Idempotency Check (Side path) -->
            <g class="component">
                <rect x="200" y="420" width="200" height="100" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                <text x="300" y="455" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">üîë Idempotency</text>
                <text x="300" y="475" font-size="11" text-anchor="middle" fill="#92400e">Check Redis cache:</text>
                <text x="300" y="493" font-size="10" text-anchor="middle" fill="#92400e">GET idempotency:{key}</text>
                <text x="300" y="510" font-size="10" text-anchor="middle" fill="#92400e">If exists ‚Üí return cached</text>
            </g>

            <path d="M 400 470 L 550 470" stroke="#f59e0b" stroke-width="2" fill="none" stroke-dasharray="3,3"/>

            <!-- Step Numbers -->
            <circle cx="700" cy="100" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="107" font-size="14" font-weight="bold" text-anchor="middle" fill="white">1</text>

            <circle cx="700" cy="220" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="227" font-size="14" font-weight="bold" text-anchor="middle" fill="white">2</text>

            <circle cx="700" cy="340" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="347" font-size="14" font-weight="bold" text-anchor="middle" fill="white">3</text>

            <circle cx="700" cy="480" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="487" font-size="14" font-weight="bold" text-anchor="middle" fill="white">4</text>

            <circle cx="700" cy="680" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="687" font-size="14" font-weight="bold" text-anchor="middle" fill="white">5</text>

            <circle cx="1160" cy="680" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="1160" y="687" font-size="14" font-weight="bold" text-anchor="middle" fill="white">6</text>

            <circle cx="1160" cy="860" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="1160" y="867" font-size="14" font-weight="bold" text-anchor="middle" fill="white">7</text>
        </svg>

        <div class="flow-description">
            <h3>üì§ Enqueue Flow Steps</h3>
            <ol>
                <li><strong>Producer:</strong> Microservice sends POST request to enqueue message with priority 8:
                    <code>POST /queues/orders/messages {"priority": 8, "payload": {...}}</code>
                </li>
                <li><strong>API Gateway:</strong> Validates JWT token, checks rate limits (1000 req/min), validates message size (&lt;256 KB)</li>
                <li><strong>Load Balancer:</strong> Routes request using consistent hashing by queue_name to appropriate Queue Service instance</li>
                <li><strong>Queue Service:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Generates unique message_id (UUID v4)</li>
                        <li>Checks idempotency cache (if duplicate key ‚Üí return cached response)</li>
                        <li>Validates message schema and priority (1-10)</li>
                    </ul>
                </li>
                <li><strong>PostgreSQL Write:</strong> Durably stores message with status='READY':
                    <code>INSERT INTO messages (message_id, queue_name, priority, payload, created_at, visible_at, status)</code>
                </li>
                <li><strong>Redis ZADD:</strong> Adds message to sorted set for fast priority-based retrieval:
                    <code>ZADD queue:orders:priority:8 {timestamp} {message_id}</code>
                </li>
                <li><strong>Update Metrics:</strong> Increments enqueue counter, updates queue depth gauge</li>
                <li><strong>Response:</strong> Returns 201 Created with message_id and enqueued_at timestamp</li>
            </ol>
            <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 5px;">
                <strong>‚ö° Performance:</strong> Enqueue latency P95 &lt;50ms (Redis ZADD is O(log N), PostgreSQL INSERT with prepared statements ~5-10ms)
            </div>
        </div>
    </div>

    <!-- Dequeue Flow Diagram -->
    <div id="dequeue-diagram" class="diagram-container">
        <svg viewBox="0 0 1400 1300" xmlns="http://www.w3.org/2000/svg">
            <!-- Title -->
            <text x="700" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Dequeue Flow: Retrieving Highest Priority Message
            </text>

            <!-- Consumer -->
            <g class="component">
                <rect x="600" y="60" width="200" height="80" rx="10" fill="url(#grad-producer)" stroke="#2563eb" stroke-width="2"/>
                <text x="700" y="95" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üë∑ Consumer</text>
                <text x="700" y="115" font-size="12" text-anchor="middle" fill="white">Worker Pool</text>
            </g>

            <path d="M 700 140 L 700 180" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="720" y="165" font-size="11" fill="#4338ca" font-weight="600">POST /dequeue</text>

            <!-- Load Balancer -->
            <g class="component">
                <rect x="600" y="180" width="200" height="80" rx="10" fill="url(#grad-lb)" stroke="#4f46e5" stroke-width="2"/>
                <text x="700" y="215" font-size="16" font-weight="bold" text-anchor="middle" fill="white">‚öñÔ∏è Load Balancer</text>
            </g>

            <path d="M 700 260 L 700 300" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>

            <!-- Queue Service -->
            <g class="component">
                <rect x="550" y="300" width="300" height="100" rx="10" fill="url(#grad-queue-service)" stroke="#4d7c0f" stroke-width="2"/>
                <text x="700" y="335" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üîß Queue Service</text>
                <text x="700" y="355" font-size="12" text-anchor="middle" fill="white">Dequeue Handler</text>
                <text x="700" y="375" font-size="11" text-anchor="middle" fill="white">Iterate priorities: 10 ‚Üí 9 ‚Üí 8 ‚Üí ... ‚Üí 1</text>
            </g>

            <!-- Arrow to Redis -->
            <path d="M 850 350 L 1020 350" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)" class="flow-arrow" stroke-dasharray="5,5"/>
            <text x="900" y="340" font-size="11" fill="#4338ca" font-weight="600">Query by Priority</text>

            <!-- Redis Query -->
            <g class="component">
                <rect x="1020" y="300" width="280" height="100" rx="10" fill="url(#grad-redis)" stroke="#db2777" stroke-width="2"/>
                <text x="1160" y="335" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üíæ Redis Query</text>
                <text x="1160" y="355" font-size="11" text-anchor="middle" fill="white">ZRANGE queue:orders:priority:10 0 0</text>
                <text x="1160" y="373" font-size="11" text-anchor="middle" fill="white">Get oldest message at this priority</text>
            </g>

            <!-- Decision Diamond -->
            <g class="component">
                <path d="M 700 440 L 800 500 L 700 560 L 600 500 Z" fill="#fef3c7" stroke="#f59e0b" stroke-width="3"/>
                <text x="700" y="495" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Message</text>
                <text x="700" y="513" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Found?</text>
            </g>

            <!-- YES path -->
            <path d="M 800 500 L 900 500" stroke="#10b981" stroke-width="4" fill="none"/>
            <text x="830" y="490" font-size="12" fill="#059669" font-weight="700">YES ‚úì</text>

            <!-- NO path (try next priority) -->
            <path d="M 600 500 L 400 500 L 400 350 L 550 350" stroke="#ef4444" stroke-width="3" fill="none" stroke-dasharray="5,5"/>
            <text x="420" y="425" font-size="11" fill="#dc2626" font-weight="600">NO ‚Üí Next Priority</text>

            <!-- Claim Message -->
            <g class="component">
                <rect x="900" y="450" width="200" height="100" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="2"/>
                <text x="1000" y="485" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">‚úÖ Claim Message</text>
                <text x="1000" y="505" font-size="10" text-anchor="middle" fill="#065f46">ZREM (atomic remove)</text>
                <text x="1000" y="523" font-size="10" text-anchor="middle" fill="#065f46">Returns 1 if successful</text>
            </g>

            <path d="M 1000 550 L 1000 620" stroke="#10b981" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Update PostgreSQL -->
            <g class="component">
                <rect x="850" y="620" width="300" height="120" rx="10" fill="url(#grad-postgres)" stroke="#ea580c" stroke-width="2"/>
                <text x="1000" y="655" font-size="16" font-weight="bold" text-anchor="middle" fill="white">üóÑÔ∏è PostgreSQL Update</text>
                <text x="1000" y="675" font-size="11" text-anchor="middle" fill="white">UPDATE messages SET</text>
                <text x="1000" y="693" font-size="11" text-anchor="middle" fill="white">status = 'IN_FLIGHT',</text>
                <text x="1000" y="711" font-size="11" text-anchor="middle" fill="white">visible_at = NOW() + 30s,</text>
                <text x="1000" y="729" font-size="11" text-anchor="middle" fill="white">receive_count = receive_count + 1</text>
            </g>

            <!-- Check Max Receive Count -->
            <g class="component">
                <path d="M 700 790 L 800 850 L 700 910 L 600 850 Z" fill="#fef3c7" stroke="#f59e0b" stroke-width="3"/>
                <text x="700" y="845" font-size="12" font-weight="bold" text-anchor="middle" fill="#92400e">receive_count</text>
                <text x="700" y="863" font-size="12" font-weight="bold" text-anchor="middle" fill="#92400e">&gt; max (5)?</text>
            </g>

            <path d="M 1000 740 L 1000 850 L 800 850" stroke="#6366f1" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <!-- Move to DLQ (YES path) -->
            <path d="M 700 910 L 700 1000" stroke="#ef4444" stroke-width="4" fill="none" marker-end="url(#arrowhead)"/>
            <text x="630" y="960" font-size="12" fill="#dc2626" font-weight="700">YES ‚Üí DLQ</text>

            <g class="component">
                <rect x="550" y="1000" width="300" height="80" rx="10" fill="#fecaca" stroke="#dc2626" stroke-width="2"/>
                <text x="700" y="1035" font-size="14" font-weight="bold" text-anchor="middle" fill="#991b1b">‚ò†Ô∏è Dead Letter Queue</text>
                <text x="700" y="1055" font-size="11" text-anchor="middle" fill="#991b1b">INSERT INTO dead_letter_queue (...)</text>
            </g>

            <!-- Return Message (NO path) -->
            <path d="M 600 850 L 400 850 L 400 220 L 600 220" stroke="#10b981" stroke-width="4" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="8,4"/>
            <text x="320" y="550" font-size="12" fill="#059669" font-weight="700">‚Üê Response</text>
            <text x="320" y="570" font-size="11" fill="#059669">200 OK</text>
            <text x="320" y="585" font-size="11" fill="#059669">{message, receipt_handle}</text>

            <!-- Add to In-Flight Tracker -->
            <g class="component">
                <rect x="200" y="620" width="220" height="100" rx="10" fill="#fbcfe8" stroke="#db2777" stroke-width="2"/>
                <text x="310" y="655" font-size="14" font-weight="bold" text-anchor="middle" fill="#831843">‚è±Ô∏è In-Flight Tracker</text>
                <text x="310" y="675" font-size="10" text-anchor="middle" fill="#831843">HSET inflight:msg_id</text>
                <text x="310" y="693" font-size="10" text-anchor="middle" fill="#831843">consumer_id worker-5</text>
                <text x="310" y="710" font-size="10" text-anchor="middle" fill="#831843">EXPIRE 60</text>
            </g>

            <path d="M 420 670 L 850 670" stroke="#ec4899" stroke-width="2" fill="none" stroke-dasharray="3,3"/>

            <!-- Step Numbers -->
            <circle cx="700" cy="100" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="107" font-size="14" font-weight="bold" text-anchor="middle" fill="white">1</text>

            <circle cx="700" cy="220" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="227" font-size="14" font-weight="bold" text-anchor="middle" fill="white">2</text>

            <circle cx="700" cy="350" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="700" y="357" font-size="14" font-weight="bold" text-anchor="middle" fill="white">3</text>

            <circle cx="1160" cy="350" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="1160" y="357" font-size="14" font-weight="bold" text-anchor="middle" fill="white">4</text>

            <circle cx="1000" cy="500" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="1000" y="507" font-size="14" font-weight="bold" text-anchor="middle" fill="white">5</text>

            <circle cx="1000" cy="680" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="1000" y="687" font-size="14" font-weight="bold" text-anchor="middle" fill="white">6</text>

            <circle cx="310" cy="670" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
            <text x="310" y="677" font-size="14" font-weight="bold" text-anchor="middle" fill="white">7</text>
        </svg>

        <div class="flow-description">
            <h3>üì• Dequeue Flow Steps</h3>
            <ol>
                <li><strong>Consumer Request:</strong> Worker sends dequeue request:
                    <code>POST /queues/orders/dequeue {"visibility_timeout": 30, "wait_time": 20}</code>
                </li>
                <li><strong>Load Balancer:</strong> Routes to Queue Service instance</li>
                <li><strong>Priority Iteration:</strong> Queue Service iterates through priority levels from highest (10) to lowest (1):
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Check priority 10 queue first</li>
                        <li>If empty, check priority 9</li>
                        <li>Continue until message found or all priorities exhausted</li>
                    </ul>
                </li>
                <li><strong>Redis Query:</strong> For current priority level:
                    <code>ZRANGE queue:orders:priority:10 0 0</code> (get oldest message)
                </li>
                <li><strong>Atomic Claim:</strong> <code>ZREM queue:orders:priority:10 {message_id}</code>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Returns 1 if successful (message claimed)</li>
                        <li>Returns 0 if already claimed by another consumer ‚Üí try next message</li>
                    </ul>
                </li>
                <li><strong>PostgreSQL Update:</strong> Mark message as IN_FLIGHT:
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Set <code>visible_at = NOW() + 30 seconds</code> (visibility timeout)</li>
                        <li>Increment <code>receive_count</code></li>
                        <li>Record <code>consumer_id</code></li>
                    </ul>
                </li>
                <li><strong>DLQ Check:</strong> If <code>receive_count > 5</code>:
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Move message to Dead Letter Queue</li>
                        <li>Alert operations team</li>
                        <li>Try next message</li>
                    </ul>
                </li>
                <li><strong>In-Flight Tracking:</strong> Add to Redis hash with TTL for visibility timeout monitoring</li>
                <li><strong>Response:</strong> Return message to consumer with <code>receipt_handle</code> for acknowledgment</li>
            </ol>
            <div style="margin-top: 15px; padding: 15px; background: #e0f2fe; border-left: 4px solid #0284c7; border-radius: 5px;">
                <strong>üîí Concurrency Safety:</strong> ZREM is atomic in Redis - only one consumer can successfully claim a message, preventing duplicate processing
            </div>
        </div>
    </div>

    <!-- Full System Architecture -->
    <div id="full-diagram" class="diagram-container">
        <svg viewBox="0 0 1600 1000" xmlns="http://www.w3.org/2000/svg">
            <!-- Title -->
            <text x="800" y="35" font-size="28" font-weight="bold" text-anchor="middle" fill="#2d3748">
                Complete Priority Queue System Architecture
            </text>

            <!-- Layer Labels -->
            <text x="50" y="100" font-size="14" font-weight="bold" fill="#64748b">PRODUCERS</text>
            <text x="50" y="240" font-size="14" font-weight="bold" fill="#64748b">GATEWAY</text>
            <text x="50" y="380" font-size="14" font-weight="bold" fill="#64748b">QUEUE SERVICE</text>
            <text x="50" y="620" font-size="14" font-weight="bold" fill="#64748b">DATA LAYER</text>
            <text x="50" y="860" font-size="14" font-weight="bold" fill="#64748b">CONSUMERS</text>

            <!-- Horizontal Dividers -->
            <line x1="200" y1="180" x2="1550" y2="180" stroke="#e2e8f0" stroke-width="2" stroke-dasharray="10,5"/>
            <line x1="200" y1="330" x2="1550" y2="330" stroke="#e2e8f0" stroke-width="2" stroke-dasharray="10,5"/>
            <line x1="200" y1="550" x2="1550" y2="550" stroke="#e2e8f0" stroke-width="2" stroke-dasharray="10,5"/>
            <line x1="200" y1="800" x2="1550" y2="800" stroke="#e2e8f0" stroke-width="2" stroke-dasharray="10,5"/>

            <!-- PRODUCERS -->
            <g class="component">
                <rect x="250" y="70" width="180" height="80" rx="10" fill="url(#grad-producer)" stroke="#2563eb" stroke-width="2"/>
                <text x="340" y="105" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üì§ Microservices</text>
                <text x="340" y="125" font-size="11" text-anchor="middle" fill="white">Order/Payment/Notify</text>
            </g>
            <g class="component">
                <rect x="470" y="70" width="180" height="80" rx="10" fill="url(#grad-producer)" stroke="#2563eb" stroke-width="2"/>
                <text x="560" y="105" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üîå API Clients</text>
            </g>
            <g class="component">
                <rect x="690" y="70" width="180" height="80" rx="10" fill="url(#grad-producer)" stroke="#2563eb" stroke-width="2"/>
                <text x="780" y="105" font-size="14" font-weight="bold" text-anchor="middle" fill="white">‚è∞ Schedulers</text>
            </g>

            <!-- Arrows down -->
            <path d="M 560 150 L 560 210" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <!-- GATEWAY -->
            <g class="component">
                <rect x="350" y="210" width="200" height="90" rx="10" fill="url(#grad-gateway)" stroke="#0891b2" stroke-width="2"/>
                <text x="450" y="245" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üö™ API Gateway</text>
                <text x="450" y="265" font-size="10" text-anchor="middle" fill="white">Auth, Rate Limit, Validation</text>
            </g>
            <g class="component">
                <rect x="590" y="210" width="200" height="90" rx="10" fill="url(#grad-lb)" stroke="#4f46e5" stroke-width="2"/>
                <text x="690" y="245" font-size="14" font-weight="bold" text-anchor="middle" fill="white">‚öñÔ∏è Load Balancer</text>
                <text x="690" y="265" font-size="10" text-anchor="middle" fill="white">Consistent Hashing</text>
            </g>

            <!-- Arrows down -->
            <path d="M 560 300 L 560 360" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <!-- QUEUE SERVICE LAYER -->
            <g class="component">
                <rect x="250" y="360" width="150" height="100" rx="10" fill="url(#grad-queue-service)" stroke="#4d7c0f" stroke-width="2"/>
                <text x="325" y="395" font-size="13" font-weight="bold" text-anchor="middle" fill="white">üîß Queue Svc 1</text>
                <text x="325" y="415" font-size="10" text-anchor="middle" fill="white">Enqueue/Dequeue</text>
            </g>
            <g class="component">
                <rect x="430" y="360" width="150" height="100" rx="10" fill="url(#grad-queue-service)" stroke="#4d7c0f" stroke-width="2"/>
                <text x="505" y="395" font-size="13" font-weight="bold" text-anchor="middle" fill="white">üîß Queue Svc 2</text>
            </g>
            <g class="component">
                <rect x="610" y="360" width="150" height="100" rx="10" fill="url(#grad-queue-service)" stroke="#4d7c0f" stroke-width="2"/>
                <text x="685" y="395" font-size="13" font-weight="bold" text-anchor="middle" fill="white">üîß Queue Svc 3</text>
            </g>

            <!-- Supporting Services -->
            <g class="component">
                <rect x="250" y="480" width="180" height="60" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                <text x="340" y="505" font-size="12" font-weight="bold" text-anchor="middle" fill="#92400e">‚è±Ô∏è Visibility Handler</text>
                <text x="340" y="525" font-size="9" text-anchor="middle" fill="#92400e">Background Worker</text>
            </g>
            <g class="component">
                <rect x="460" y="480" width="180" height="60" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                <text x="550" y="505" font-size="11" font-weight="bold" text-anchor="middle" fill="#92400e">üìÖ Scheduled Processor</text>
            </g>

            <!-- Coordination (Right side) -->
            <g class="component">
                <rect x="1200" y="360" width="280" height="100" rx="10" fill="#fde047" stroke="#ca8a04" stroke-width="2"/>
                <text x="1340" y="395" font-size="14" font-weight="bold" text-anchor="middle" fill="#713f12">ü§ù Zookeeper/etcd</text>
                <text x="1340" y="415" font-size="11" text-anchor="middle" fill="#713f12">‚Ä¢ Leader Election</text>
                <text x="1340" y="433" font-size="11" text-anchor="middle" fill="#713f12">‚Ä¢ Service Discovery</text>
                <text x="1340" y="451" font-size="11" text-anchor="middle" fill="#713f12">‚Ä¢ Config Management</text>
            </g>

            <path d="M 760 410 L 1200 410" stroke="#ca8a04" stroke-width="2" fill="none" stroke-dasharray="3,3"/>

            <!-- Arrows to Data Layer -->
            <path d="M 505 460 L 505 620" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <!-- DATA LAYER -->
            <g class="component">
                <rect x="250" y="620" width="200" height="120" rx="10" fill="url(#grad-postgres)" stroke="#ea580c" stroke-width="2"/>
                <text x="350" y="655" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üóÑÔ∏è PostgreSQL</text>
                <text x="350" y="675" font-size="11" text-anchor="middle" fill="white">Primary + Replicas</text>
                <text x="350" y="693" font-size="10" text-anchor="middle" fill="white">Durable Storage</text>
                <text x="350" y="711" font-size="10" text-anchor="middle" fill="white">16 Shards by queue_name</text>
            </g>

            <g class="component">
                <rect x="480" y="620" width="200" height="120" rx="10" fill="url(#grad-redis)" stroke="#db2777" stroke-width="2"/>
                <text x="580" y="655" font-size="14" font-weight="bold" text-anchor="middle" fill="white">üíæ Redis Cluster</text>
                <text x="580" y="675" font-size="11" text-anchor="middle" fill="white">Priority Queue</text>
                <text x="580" y="693" font-size="10" text-anchor="middle" fill="white">Sorted Sets</text>
                <text x="580" y="711" font-size="10" text-anchor="middle" fill="white">6 nodes (3M + 3R)</text>
            </g>

            <g class="component">
                <rect x="710" y="620" width="200" height="120" rx="10" fill="#bae6fd" stroke="#0284c7" stroke-width="2"/>
                <text x="810" y="655" font-size="13" font-weight="bold" text-anchor="middle" fill="#075985">‚òÅÔ∏è S3 / Blob</text>
                <text x="810" y="675" font-size="10" text-anchor="middle" fill="#075985">Large Payloads</text>
                <text x="810" y="693" font-size="10" text-anchor="middle" fill="#075985">Message Archives</text>
            </g>

            <!-- Replication arrow -->
            <path d="M 450 680 L 480 680" stroke="#f97316" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
            <text x="465" y="670" font-size="9" fill="#9a3412">sync</text>

            <!-- DLQ -->
            <g class="component">
                <rect x="940" y="620" width="200" height="120" rx="10" fill="#fecaca" stroke="#dc2626" stroke-width="2"/>
                <text x="1040" y="655" font-size="13" font-weight="bold" text-anchor="middle" fill="#991b1b">‚ò†Ô∏è Dead Letter Queue</text>
                <text x="1040" y="675" font-size="10" text-anchor="middle" fill="#991b1b">Failed Messages</text>
                <text x="1040" y="693" font-size="10" text-anchor="middle" fill="#991b1b">Manual Review</text>
            </g>

            <!-- Arrows to Consumers -->
            <path d="M 580 740 L 580 830" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

            <!-- CONSUMERS -->
            <g class="component">
                <rect x="250" y="830" width="180" height="90" rx="10" fill="#99f6e4" stroke="#14b8a6" stroke-width="2"/>
                <text x="340" y="865" font-size="13" font-weight="bold" text-anchor="middle" fill="#134e4a">üë∑ Order Workers</text>
                <text x="340" y="885" font-size="10" text-anchor="middle" fill="#134e4a">50 workers</text>
                <text x="340" y="903" font-size="10" text-anchor="middle" fill="#134e4a">Priority 8-10</text>
            </g>
            <g class="component">
                <rect x="460" y="830" width="180" height="90" rx="10" fill="#99f6e4" stroke="#14b8a6" stroke-width="2"/>
                <text x="550" y="865" font-size="13" font-weight="bold" text-anchor="middle" fill="#134e4a">‚úâÔ∏è Email Workers</text>
                <text x="550" y="885" font-size="10" text-anchor="middle" fill="#134e4a">20 workers</text>
                <text x="550" y="903" font-size="10" text-anchor="middle" fill="#134e4a">Priority 4-6</text>
            </g>
            <g class="component">
                <rect x="670" y="830" width="180" height="90" rx="10" fill="#99f6e4" stroke="#14b8a6" stroke-width="2"/>
                <text x="760" y="865" font-size="13" font-weight="bold" text-anchor="middle" fill="#134e4a">üîÑ Batch Workers</text>
                <text x="760" y="885" font-size="10" text-anchor="middle" fill="#134e4a">10 workers</text>
                <text x="760" y="903" font-size="10" text-anchor="middle" fill="#134e4a">Priority 1-3</text>
            </g>

            <!-- MONITORING (Right side) -->
            <g class="component">
                <rect x="1200" y="620" width="280" height="80" rx="10" fill="#d1fae5" stroke="#10b981" stroke-width="2"/>
                <text x="1340" y="655" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">üìà MONITORING</text>
                <text x="1340" y="675" font-size="11" text-anchor="middle" fill="#065f46">Prometheus + Grafana</text>
            </g>

            <g class="component">
                <rect x="1200" y="720" width="280" height="80" rx="10" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
                <text x="1340" y="755" font-size="14" font-weight="bold" text-anchor="middle" fill="#991b1b">üö® ALERTING</text>
                <text x="1340" y="775" font-size="11" text-anchor="middle" fill="#991b1b">PagerDuty</text>
            </g>

            <!-- Monitoring arrows -->
            <path d="M 760 680 L 1200 660" stroke="#10b981" stroke-width="2" fill="none" stroke-dasharray="3,3"/>
            <path d="M 760 680 L 1200 760" stroke="#dc2626" stroke-width="2" fill="none" stroke-dasharray="3,3"/>
        </svg>

        <div class="flow-description">
            <h3>üèóÔ∏è Full System Architecture Overview</h3>
            <p style="margin-bottom: 15px; line-height: 1.8;">
                This diagram shows the complete priority queue system implementing <strong>distributed consensus</strong>
                for coordination, <strong>multi-tier storage</strong> for durability and performance, and
                <strong>horizontal scaling</strong> across all layers.
            </p>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px;">
                <div style="background: #f0f9ff; padding: 15px; border-radius: 10px; border-left: 4px solid #0284c7;">
                    <h4 style="color: #075985; margin-bottom: 8px;">üì§ Enqueue Path</h4>
                    <p style="font-size: 0.9em; color: #0c4a6e; line-height: 1.6;">
                        Producer ‚Üí API Gateway ‚Üí LB ‚Üí <strong>Queue Service</strong> ‚Üí
                        PostgreSQL (durable) + Redis (fast retrieval) ‚Üí Response
                    </p>
                </div>
                <div style="background: #f0fdf4; padding: 15px; border-radius: 10px; border-left: 4px solid #10b981;">
                    <h4 style="color: #065f46; margin-bottom: 8px;">üì• Dequeue Path</h4>
                    <p style="font-size: 0.9em; color: #064e3b; line-height: 1.6;">
                        Consumer ‚Üí LB ‚Üí <strong>Queue Service</strong> ‚Üí Redis (priority query) ‚Üí
                        PostgreSQL (mark in-flight) ‚Üí Consumer (with receipt_handle)
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Metrics Panel -->
    <div class="metrics-panel">
        <h2 style="margin-bottom: 15px; color: #92400e;">‚ö° System Performance Metrics</h2>
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value">100K+</div>
                <div class="metric-label">Messages/sec</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">&lt;50ms</div>
                <div class="metric-label">P95 Enqueue</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">&lt;100ms</div>
                <div class="metric-label">P95 Dequeue</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">99.99%</div>
                <div class="metric-label">Availability</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">10</div>
                <div class="metric-label">Priority Levels</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">At-Least-Once</div>
                <div class="metric-label">Delivery Guarantee</div>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #60a5fa, #3b82f6);"></div>
            <span>Producer/Consumer</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #22d3ee, #06b6d4);"></div>
            <span>Gateway</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #84cc16, #65a30d);"></div>
            <span>Queue Service</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #f472b6, #ec4899);"></div>
            <span>Redis</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #fb923c, #f97316);"></div>
            <span>PostgreSQL</span>
        </div>
    </div>
</div>

<script>
    function showDiagram(type) {
        // Hide all diagrams
        document.querySelectorAll('.diagram-container').forEach(d => {
            d.classList.remove('active');
        });

        // Remove active from all tabs
        document.querySelectorAll('.tab').forEach(t => {
            t.classList.remove('active');
        });

        // Show selected diagram
        document.getElementById(type + '-diagram').classList.add('active');

        // Activate clicked tab
        event.target.classList.add('active');
    }

    // Add hover effects
    document.querySelectorAll('.component').forEach(comp => {
        comp.addEventListener('mouseenter', function() {
            this.style.filter = 'drop-shadow(0 0 15px rgba(99, 102, 241, 0.6))';
        });

        comp.addEventListener('mouseleave', function() {
            this.style.filter = 'none';
        });
    });
</script>
</body>
</html>
